var tl=Object.defineProperty,nl=Object.defineProperties;var il=Object.getOwnPropertyDescriptors;var ho=Object.getOwnPropertySymbols;var ba=Object.prototype.hasOwnProperty,ya=Object.prototype.propertyIsEnumerable;var fa=(r,e,t)=>e in r?tl(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,v=(r,e)=>{for(var t in e||(e={}))ba.call(e,t)&&fa(r,t,e[t]);if(ho)for(var t of ho(e))ya.call(e,t)&&fa(r,t,e[t]);return r},q=(r,e)=>nl(r,il(e));var Ee=(r,e)=>{var t={};for(var n in r)ba.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&ho)for(var n of ho(r))e.indexOf(n)<0&&ya.call(r,n)&&(t[n]=r[n]);return t};import{merge as df}from"lodash";import iu from"axios";import{PublicKey as Pa}from"@solana/web3.js";import{get as ga,set as ol}from"lodash";var Gr=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Aa={},rl={};function fe(r){let e=ga(Aa,r);if(!e){let t=ga(rl,r);e=new Gr({name:r,logLevel:t}),ol(Aa,r,e)}return e}import{MINT_SIZE as sl,TOKEN_PROGRAM_ID as al,getTransferFeeConfig as ul,unpackMint as cl}from"@solana/spl-token";var Xr=fe("Raydium_accountInfo_util");async function Et(r,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:o=100}=v({batchRequest:!1},t),s=Qr(e,o),a=new Array(s.length).fill([]);if(n){let c=s.map(m=>{let d=r._buildArgs([m.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=Qr(c,10);a=(await(await Promise.all(u.map(async m=>await r._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&Xr.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:f,lamports:b,owner:y,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&Xr.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:f,lamports:b,owner:new Pa(y),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>r.getMultipleAccountsInfo(c,i)))}catch(c){c instanceof Error&&Xr.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Oe(r,e,t){let n=await Et(r,e.map(i=>i.pubkey),t);return e.map((i,o)=>q(v({},i),{accountInfo:n[o]}))}async function $n({connection:r,mints:e,config:t}){var o,s,a;if(e.length===0)return{};let n=await Oe(r,e.map(c=>({pubkey:at(c)})),t),i={};for(let c of n){if(!c.accountInfo||c.accountInfo.data.length<sl){console.log("invalid mint account",c.pubkey.toBase58());continue}let u=cl(c.pubkey,c.accountInfo,(o=c.accountInfo)==null?void 0:o.owner);i[c.pubkey.toString()]=q(v({},u),{programId:((s=c.accountInfo)==null?void 0:s.owner)||al,feeConfig:(a=ul(u))!=null?a:void 0})}return i[Pa.default.toBase58()]=i[Z.toBase58()],i}import Zt from"bn.js";var Jn=9e15,yn=1e9,zr="0123456789abcdef",Io="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Bo="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",jr={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Jn,maxE:Jn,crypto:!1},Ta,on,ue=!0,xo="[DecimalError] ",bn=xo+"Invalid argument: ",Ia=xo+"Precision limit exceeded",Ba=xo+"crypto unavailable",Sa="[object Decimal]",ut=Math.floor,Ye=Math.pow,ll=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,ml=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,dl=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,xa=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Ft=1e7,te=7,pl=9007199254740991,fl=Io.length-1,Hr=Bo.length-1,W={toStringTag:Sa};W.absoluteValue=W.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),J(r)};W.ceil=function(){return J(new this.constructor(this),this.e+1,2)};W.clampedTo=W.clamp=function(r,e){var t,n=this,i=n.constructor;if(r=new i(r),e=new i(e),!r.s||!e.s)return new i(NaN);if(r.gt(e))throw Error(bn+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new i(n)};W.comparedTo=W.cmp=function(r){var e,t,n,i,o=this,s=o.d,a=(r=new o.constructor(r)).d,c=o.s,u=r.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(o.e!==r.e)return o.e>r.e^c<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===i?0:n>i^c<0?1:-1};W.cosine=W.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+te,n.rounding=1,t=bl(n,Na(n,t)),n.precision=r,n.rounding=e,J(on==2||on==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};W.cubeRoot=W.cbrt=function(){var r,e,t,n,i,o,s,a,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(ue=!1,o=l.s*Ye(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=nt(l.d),r=l.e,(o=(r-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=Ye(t,1/3),r=ut((r+1)/3)-(r%3==(r<0?-1:2)),o==1/0?t="5e"+r:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new m(t),n.s=l.s):n=new m(o.toString()),s=(r=m.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Ke(u.plus(l).times(a),u.plus(c),s+2,1),nt(a.d).slice(0,s)===(t=nt(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(J(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(J(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return ue=!0,J(n,r,m.rounding,e)};W.decimalPlaces=W.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-ut(this.e/te))*te,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};W.dividedBy=W.div=function(r){return Ke(this,new this.constructor(r))};W.dividedToIntegerBy=W.divToInt=function(r){var e=this,t=e.constructor;return J(Ke(e,new t(r),0,1,1),t.precision,t.rounding)};W.equals=W.eq=function(r){return this.cmp(r)===0};W.floor=function(){return J(new this.constructor(this),this.e+1,3)};W.greaterThan=W.gt=function(r){return this.cmp(r)>0};W.greaterThanOrEqualTo=W.gte=function(r){var e=this.cmp(r);return e==1||e===0};W.hyperbolicCosine=W.cosh=function(){var r,e,t,n,i,o=this,s=o.constructor,a=new s(1);if(!o.isFinite())return new s(o.s?1/0:NaN);if(o.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(o.e,o.sd())+4,s.rounding=1,i=o.d.length,i<32?(r=Math.ceil(i/3),e=(1/Co(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),o=ei(s,1,o.times(e),new s(1),!0);for(var c,u=r,l=new s(8);u--;)c=o.times(o),o=a.minus(c.times(l.minus(c.times(l))));return J(o,s.precision=t,s.rounding=n,!0)};W.hyperbolicSine=W.sinh=function(){var r,e,t,n,i=this,o=i.constructor;if(!i.isFinite()||i.isZero())return new o(i);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(i.e,i.sd())+4,o.rounding=1,n=i.d.length,n<3)i=ei(o,2,i,i,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,i=i.times(1/Co(5,r)),i=ei(o,2,i,i,!0);for(var s,a=new o(5),c=new o(16),u=new o(20);r--;)s=i.times(i),i=i.times(a.plus(s.times(c.times(s).plus(u))))}return o.precision=e,o.rounding=t,J(i,e,t,!0)};W.hyperbolicTangent=W.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,Ke(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};W.inverseCosine=W.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?Vt(t,i,o):new t(0):new t(NaN):e.isZero()?Vt(t,i+4,o).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),r=Vt(t,i+4,o).times(.5),t.precision=i,t.rounding=o,r.minus(e))};W.inverseHyperbolicCosine=W.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,ue=!1,t=t.times(t).minus(1).sqrt().plus(t),ue=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};W.inverseHyperbolicSine=W.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,ue=!1,t=t.times(t).plus(1).sqrt().plus(t),ue=!0,n.precision=r,n.rounding=e,t.ln())};W.inverseHyperbolicTangent=W.atanh=function(){var r,e,t,n,i=this,o=i.constructor;return i.isFinite()?i.e>=0?new o(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(r=o.precision,e=o.rounding,n=i.sd(),Math.max(n,r)<2*-i.e-1?J(new o(i),r,e,!0):(o.precision=t=n-i.e,i=Ke(i.plus(1),new o(1).minus(i),t+r,1),o.precision=r+4,o.rounding=1,i=i.ln(),o.precision=r,o.rounding=e,i.times(.5))):new o(NaN)};W.inverseSine=W.asin=function(){var r,e,t,n,i=this,o=i.constructor;return i.isZero()?new o(i):(e=i.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(r=Vt(o,t+4,n).times(.5),r.s=i.s,r):new o(NaN):(o.precision=t+6,o.rounding=1,i=i.div(new o(1).minus(i.times(i)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,i.times(2)))};W.inverseTangent=W.atan=function(){var r,e,t,n,i,o,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=Hr)return s=Vt(l,m+4,d).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(m+4<=Hr)return s=Vt(l,m+4,d).times(.5),s.s=u.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/te+2|0),r=t;r;--r)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(ue=!1,e=Math.ceil(a/te),n=1,c=u.times(u),s=new l(u),i=u;r!==-1;)if(i=i.times(c),o=s.minus(i.div(n+=2)),i=i.times(c),s=o.plus(i.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===o.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),ue=!0,J(s,l.precision=m,l.rounding=d,!0)};W.isFinite=function(){return!!this.d};W.isInteger=W.isInt=function(){return!!this.d&&ut(this.e/te)>this.d.length-2};W.isNaN=function(){return!this.s};W.isNegative=W.isNeg=function(){return this.s<0};W.isPositive=W.isPos=function(){return this.s>0};W.isZero=function(){return!!this.d&&this.d[0]===0};W.lessThan=W.lt=function(r){return this.cmp(r)<0};W.lessThanOrEqualTo=W.lte=function(r){return this.cmp(r)<1};W.logarithm=W.log=function(r){var e,t,n,i,o,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(i=t[0];i%10===0;)i/=10;o=i!==1}if(ue=!1,a=m+p,s=fn(u,a),n=e?So(l,a+10):fn(r,a),c=Ke(s,n,a,1),gi(c.d,i=m,d))do if(a+=10,s=fn(u,a),n=e?So(l,a+10):fn(r,a),c=Ke(s,n,a,1),!o){+nt(c.d).slice(i+1,i+15)+1==1e14&&(c=J(c,m+1,0));break}while(gi(c.d,i+=10,d));return ue=!0,J(c,m,d)};W.minus=W.sub=function(r){var e,t,n,i,o,s,a,c,u,l,m,d,p=this,f=p.constructor;if(r=new f(r),!p.d||!r.d)return!p.s||!r.s?r=new f(NaN):p.d?r.s=-r.s:r=new f(r.d||p.s!==r.s?p:NaN),r;if(p.s!=r.s)return r.s=-r.s,p.plus(r);if(u=p.d,d=r.d,a=f.precision,c=f.rounding,!u[0]||!d[0]){if(d[0])r.s=-r.s;else if(u[0])r=new f(p);else return new f(c===3?-0:0);return ue?J(r,a,c):r}if(t=ut(r.e/te),l=ut(p.e/te),u=u.slice(),o=l-t,o){for(m=o<0,m?(e=u,o=-o,s=d.length):(e=d,t=l,s=u.length),n=Math.max(Math.ceil(a/te),s)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}o=0}for(m&&(e=u,u=d,d=e,r.s=-r.s),s=u.length,n=d.length-s;n>0;--n)u[s++]=0;for(n=d.length;n>o;){if(u[--n]<d[n]){for(i=n;i&&u[--i]===0;)u[i]=Ft-1;--u[i],u[n]+=Ft}u[n]-=d[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(r.d=u,r.e=Ko(u,t),ue?J(r,a,c):r):new f(c===3?-0:0)};W.modulo=W.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?J(new n(t),n.precision,n.rounding):(ue=!1,n.modulo==9?(e=Ke(t,r.abs(),0,3,1),e.s*=r.s):e=Ke(t,r,0,n.modulo,1),e=e.times(r),ue=!0,t.minus(e))};W.naturalExponential=W.exp=function(){return Yr(this)};W.naturalLogarithm=W.ln=function(){return fn(this)};W.negated=W.neg=function(){var r=new this.constructor(this);return r.s=-r.s,J(r)};W.plus=W.add=function(r){var e,t,n,i,o,s,a,c,u,l,m=this,d=m.constructor;if(r=new d(r),!m.d||!r.d)return!m.s||!r.s?r=new d(NaN):m.d||(r=new d(r.d||m.s===r.s?m:NaN)),r;if(m.s!=r.s)return r.s=-r.s,m.minus(r);if(u=m.d,l=r.d,a=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(r=new d(m)),ue?J(r,a,c):r;if(o=ut(m.e/te),n=ut(r.e/te),u=u.slice(),i=o-n,i){for(i<0?(t=u,i=-i,s=l.length):(t=l,n=o,s=u.length),o=Math.ceil(a/te),s=o>s?o+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=u.length,i=l.length,s-i<0&&(i=s,t=l,l=u,u=t),e=0;i;)e=(u[--i]=u[i]+l[i]+e)/Ft|0,u[i]%=Ft;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return r.d=u,r.e=Ko(u,n),ue?J(r,a,c):r};W.precision=W.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(bn+r);return t.d?(e=Ka(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};W.round=function(){var r=this,e=r.constructor;return J(new e(r),r.e+1,e.rounding)};W.sine=W.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+te,n.rounding=1,t=gl(n,Na(n,t)),n.precision=r,n.rounding=e,J(on>2?t.neg():t,r,e,!0)):new n(NaN)};W.squareRoot=W.sqrt=function(){var r,e,t,n,i,o,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(ue=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=nt(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=ut((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(o=n,n=o.plus(Ke(s,o,t+2,1)).times(.5),nt(o.d).slice(0,t)===(e=nt(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(J(o,c+1,0),o.times(o).eq(s))){n=o;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(J(n,c+1,1),r=!n.times(n).eq(s));break}return ue=!0,J(n,c,l.rounding,r)};W.tangent=W.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=Ke(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,J(on==2||on==4?t.neg():t,r,e,!0)):new n(NaN)};W.times=W.mul=function(r){var e,t,n,i,o,s,a,c,u,l=this,m=l.constructor,d=l.d,p=(r=new m(r)).d;if(r.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!r.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?r.s/0:r.s*0);for(t=ut(l.e/te)+ut(r.e/te),c=d.length,u=p.length,c<u&&(o=d,d=p,p=o,s=c,c=u,u=s),o=[],s=c+u,n=s;n--;)o.push(0);for(n=u;--n>=0;){for(e=0,i=c+n;i>n;)a=o[i]+p[n]*d[i-n-1]+e,o[i--]=a%Ft|0,e=a/Ft|0;o[i]=(o[i]+e)%Ft|0}for(;!o[--s];)o.pop();return e?++t:o.shift(),r.d=o,r.e=Ko(o,t),ue?J(r,m.precision,m.rounding):r};W.toBinary=function(r,e){return $r(this,2,r,e)};W.toDecimalPlaces=W.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(At(r,0,yn),e===void 0?e=n.rounding:At(e,0,8),J(t,r+t.e+1,e))};W.toExponential=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=Yt(n,!0):(At(r,0,yn),e===void 0?e=i.rounding:At(e,0,8),n=J(new i(n),r+1,e),t=Yt(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toFixed=function(r,e){var t,n,i=this,o=i.constructor;return r===void 0?t=Yt(i):(At(r,0,yn),e===void 0?e=o.rounding:At(e,0,8),n=J(new o(i),r+i.e+1,e),t=Yt(n,!1,r+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};W.toFraction=function(r){var e,t,n,i,o,s,a,c,u,l,m,d,p=this,f=p.d,b=p.constructor;if(!f)return new b(p);if(u=t=new b(1),n=c=new b(0),e=new b(n),o=e.e=Ka(f)-p.e-1,s=o%te,e.d[0]=Ye(10,s<0?te+s:s),r==null)r=o>0?e:u;else{if(a=new b(r),!a.isInt()||a.lt(u))throw Error(bn+a);r=a.gt(e)?o>0?e:u:a}for(ue=!1,a=new b(nt(f)),l=b.precision,b.precision=o=f.length*te*2;m=Ke(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(r)!=1;)t=n,n=i,i=u,u=c.plus(m.times(i)),c=i,i=e,e=a.minus(m.times(i)),a=i;return i=Ke(r.minus(t),n,0,1,1),c=c.plus(i.times(u)),t=t.plus(i.times(n)),c.s=u.s=p.s,d=Ke(u,n,o,1).minus(p).abs().cmp(Ke(c,t,o,1).minus(p).abs())<1?[u,n]:[c,t],b.precision=l,ue=!0,d};W.toHexadecimal=W.toHex=function(r,e){return $r(this,16,r,e)};W.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:At(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(ue=!1,t=Ke(t,r,0,e,1).times(r),ue=!0,J(t)):(r.s=t.s,t=r),t};W.toNumber=function(){return+this};W.toOctal=function(r,e){return $r(this,8,r,e)};W.toPower=W.pow=function(r){var e,t,n,i,o,s,a=this,c=a.constructor,u=+(r=new c(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new c(Ye(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,o=c.rounding,r.eq(1))return J(a,n,o);if(e=ut(r.e/te),e>=r.d.length-1&&(t=u<0?-u:u)<=pl)return i=Ca(c,a,t,n),r.s<0?new c(1).div(i):J(i,n,o);if(s=a.s,s<0){if(e<r.d.length-1)return new c(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Ye(+a,u),e=t==0||!isFinite(t)?ut(u*(Math.log("0."+nt(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(ue=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),i=Yr(r.times(fn(a,n+t)),n),i.d&&(i=J(i,n+5,1),gi(i.d,n,o)&&(e=n+10,i=J(Yr(r.times(fn(a,e+t)),e),e+5,1),+nt(i.d).slice(n+1,n+15)+1==1e14&&(i=J(i,n+1,0)))),i.s=s,ue=!0,c.rounding=o,J(i,n,o))};W.toPrecision=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=Yt(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(At(r,1,yn),e===void 0?e=i.rounding:At(e,0,8),n=J(new i(n),r,e),t=Yt(n,r<=n.e||n.e<=i.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toSignificantDigits=W.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(At(r,1,yn),e===void 0?e=n.rounding:At(e,0,8)),J(new n(t),r,e)};W.toString=function(){var r=this,e=r.constructor,t=Yt(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};W.truncated=W.trunc=function(){return J(new this.constructor(this),this.e+1,1)};W.valueOf=W.toJSON=function(){var r=this,e=r.constructor,t=Yt(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function nt(r){var e,t,n,i=r.length-1,o="",s=r[0];if(i>0){for(o+=s,e=1;e<i;e++)n=r[e]+"",t=te-n.length,t&&(o+=pn(t)),o+=n;s=r[e],n=s+"",t=te-n.length,t&&(o+=pn(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return o+s}function At(r,e,t){if(r!==~~r||r<e||r>t)throw Error(bn+r)}function gi(r,e,t,n){var i,o,s,a;for(o=r[0];o>=10;o/=10)--e;return--e<0?(e+=te,i=0):(i=Math.ceil((e+1)/te),e%=te),o=Ye(10,te-e),a=r[i]%o|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==o||t>3&&a+1==o/2)&&(r[i+1]/o/100|0)==Ye(10,e-2)-1||(a==o/2||a==0)&&(r[i+1]/o/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==o||!n&&t>3&&a+1==o/2)&&(r[i+1]/o/1e3|0)==Ye(10,e-3)-1,s}function To(r,e,t){for(var n,i=[0],o,s=0,a=r.length;s<a;){for(o=i.length;o--;)i[o]*=e;for(i[0]+=zr.indexOf(r.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function bl(r,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/Co(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),r.precision+=t,e=ei(r,1,e.times(i),new r(1));for(var o=t;o--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var Ke=function(){function r(n,i,o){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*i+a,n[c]=s%o|0,a=s/o|0;return a&&n.unshift(a),n}function e(n,i,o,s){var a,c;if(o!=s)c=o>s?1:-1;else for(a=c=0;a<o;a++)if(n[a]!=i[a]){c=n[a]>i[a]?1:-1;break}return c}function t(n,i,o,s){for(var a=0;o--;)n[o]-=a,a=n[o]<i[o]?1:0,n[o]=a*s+n[o]-i[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,o,s,a,c){var u,l,m,d,p,f,b,y,g,A,w,h,T,k,x,S,K,I,C,L,R=n.constructor,_=n.s==i.s?1:-1,M=n.d,V=i.d;if(!M||!M[0]||!V||!V[0])return new R(!n.s||!i.s||(M?V&&M[0]==V[0]:!V)?NaN:M&&M[0]==0||!V?_*0:_/0);for(c?(p=1,l=n.e-i.e):(c=Ft,p=te,l=ut(n.e/p)-ut(i.e/p)),C=V.length,K=M.length,g=new R(_),A=g.d=[],m=0;V[m]==(M[m]||0);m++);if(V[m]>(M[m]||0)&&l--,o==null?(k=o=R.precision,s=R.rounding):a?k=o+(n.e-i.e)+1:k=o,k<0)A.push(1),f=!0;else{if(k=k/p+2|0,m=0,C==1){for(d=0,V=V[0],k++;(m<K||d)&&k--;m++)x=d*c+(M[m]||0),A[m]=x/V|0,d=x%V|0;f=d||m<K}else{for(d=c/(V[0]+1)|0,d>1&&(V=r(V,d,c),M=r(M,d,c),C=V.length,K=M.length),S=C,w=M.slice(0,C),h=w.length;h<C;)w[h++]=0;L=V.slice(),L.unshift(0),I=V[0],V[1]>=c/2&&++I;do d=0,u=e(V,w,C,h),u<0?(T=w[0],C!=h&&(T=T*c+(w[1]||0)),d=T/I|0,d>1?(d>=c&&(d=c-1),b=r(V,d,c),y=b.length,h=w.length,u=e(b,w,y,h),u==1&&(d--,t(b,C<y?L:V,y,c))):(d==0&&(u=d=1),b=V.slice()),y=b.length,y<h&&b.unshift(0),t(w,b,h,c),u==-1&&(h=w.length,u=e(V,w,C,h),u<1&&(d++,t(w,C<h?L:V,h,c))),h=w.length):u===0&&(d++,w=[0]),A[m++]=d,u&&w[0]?w[h++]=M[S]||0:(w=[M[S]],h=1);while((S++<K||w[0]!==void 0)&&k--);f=w[0]!==void 0}A[0]||A.shift()}if(p==1)g.e=l,Ta=f;else{for(m=1,d=A[0];d>=10;d/=10)m++;g.e=m+l*p-1,J(g,a?o+g.e+1:o,s,f)}return g}}();function J(r,e,t,n){var i,o,s,a,c,u,l,m,d,p=r.constructor;e:if(e!=null){if(m=r.d,!m)return r;for(i=1,a=m[0];a>=10;a/=10)i++;if(o=e-i,o<0)o+=te,s=e,l=m[d=0],c=l/Ye(10,i-s-1)%10|0;else if(d=Math.ceil((o+1)/te),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=c=0,i=1,o%=te,s=o-te+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;o%=te,s=o-te+i,c=s<0?0:l/Ye(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Ye(10,i-s-1)),u=t<4?(c||n)&&(t==0||t==(r.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(o>0?s>0?l/Ye(10,i-s):0:m[d-1])%10&1||t==(r.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=r.e+1,m[0]=Ye(10,(te-e%te)%te),r.e=-e||0):m[0]=r.e=0,r;if(o==0?(m.length=d,a=1,d--):(m.length=d+1,a=Ye(10,te-o),m[d]=s>0?(l/Ye(10,i-s)%Ye(10,s)|0)*a:0),u)for(;;)if(d==0){for(o=1,s=m[0];s>=10;s/=10)o++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;o!=a&&(r.e++,m[0]==Ft&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Ft)break;m[d--]=0,a=1}for(o=m.length;m[--o]===0;)m.pop()}return ue&&(r.e>p.maxE?(r.d=null,r.e=NaN):r.e<p.minE&&(r.e=0,r.d=[0])),r}function Yt(r,e,t){if(!r.isFinite())return Ra(r);var n,i=r.e,o=nt(r.d),s=o.length;return e?(t&&(n=t-s)>0?o=o.charAt(0)+"."+o.slice(1)+pn(n):s>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(r.e<0?"e":"e+")+r.e):i<0?(o="0."+pn(-i-1)+o,t&&(n=t-s)>0&&(o+=pn(n))):i>=s?(o+=pn(i+1-s),t&&(n=t-i-1)>0&&(o=o+"."+pn(n))):((n=i+1)<s&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(o+="."),o+=pn(n))),o}function Ko(r,e){var t=r[0];for(e*=te;t>=10;t/=10)e++;return e}function So(r,e,t){if(e>fl)throw ue=!0,t&&(r.precision=t),Error(Ia);return J(new r(Io),e,1,!0)}function Vt(r,e,t){if(e>Hr)throw Error(Ia);return J(new r(Bo),e,t,!0)}function Ka(r){var e=r.length-1,t=e*te+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function pn(r){for(var e="";r--;)e+="0";return e}function Ca(r,e,t,n){var i,o=new r(1),s=Math.ceil(n/te+4);for(ue=!1;;){if(t%2&&(o=o.times(e),ka(o.d,s)&&(i=!0)),t=ut(t/2),t===0){t=o.d.length-1,i&&o.d[t]===0&&++o.d[t];break}e=e.times(e),ka(e.d,s)}return ue=!0,o}function wa(r){return r.d[r.d.length-1]&1}function La(r,e,t){for(var n,i=new r(e[0]),o=0;++o<e.length;)if(n=new r(e[o]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function Yr(r,e){var t,n,i,o,s,a,c,u=0,l=0,m=0,d=r.constructor,p=d.rounding,f=d.precision;if(!r.d||!r.d[0]||r.e>17)return new d(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(ue=!1,c=f):c=e,a=new d(.03125);r.e>-2;)r=r.times(a),m+=5;for(n=Math.log(Ye(2,m))/Math.LN10*2+5|0,c+=n,t=o=s=new d(1),d.precision=c;;){if(o=J(o.times(r),c,1),t=t.times(++l),a=s.plus(Ke(o,t,c,1)),nt(a.d).slice(0,c)===nt(s.d).slice(0,c)){for(i=m;i--;)s=J(s.times(s),c,1);if(e==null)if(u<3&&gi(s.d,c-n,p,u))d.precision=c+=10,t=o=a=new d(1),l=0,u++;else return J(s,d.precision=f,p,ue=!0);else return d.precision=f,s}s=a}}function fn(r,e){var t,n,i,o,s,a,c,u,l,m,d,p=1,f=10,b=r,y=b.d,g=b.constructor,A=g.rounding,w=g.precision;if(b.s<0||!y||!y[0]||!b.e&&y[0]==1&&y.length==1)return new g(y&&!y[0]?-1/0:b.s!=1?NaN:y?0:b);if(e==null?(ue=!1,l=w):l=e,g.precision=l+=f,t=nt(y),n=t.charAt(0),Math.abs(o=b.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)b=b.times(r),t=nt(b.d),n=t.charAt(0),p++;o=b.e,n>1?(b=new g("0."+t),o++):b=new g(n+"."+t.slice(1))}else return u=So(g,l+2,w).times(o+""),b=fn(new g(n+"."+t.slice(1)),l-f).plus(u),g.precision=w,e==null?J(b,w,A,ue=!0):b;for(m=b,c=s=b=Ke(b.minus(1),b.plus(1),l,1),d=J(b.times(b),l,1),i=3;;){if(s=J(s.times(d),l,1),u=c.plus(Ke(s,new g(i),l,1)),nt(u.d).slice(0,l)===nt(c.d).slice(0,l))if(c=c.times(2),o!==0&&(c=c.plus(So(g,l+2,w).times(o+""))),c=Ke(c,new g(p),l,1),e==null)if(gi(c.d,l-f,A,a))g.precision=l+=f,u=s=b=Ke(m.minus(1),m.plus(1),l,1),d=J(b.times(b),l,1),i=a=1;else return J(c,g.precision=w,A,ue=!0);else return g.precision=w,c;c=u,i+=2}}function Ra(r){return String(r.s*r.s/0)}function Zr(r,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%te,t<0&&(n+=te),n<i){for(n&&r.d.push(+e.slice(0,n)),i-=te;n<i;)r.d.push(+e.slice(n,n+=te));e=e.slice(n),n=te-e.length}else n-=i;for(;n--;)e+="0";r.d.push(+e),ue&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function yl(r,e){var t,n,i,o,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),xa.test(e))return Zr(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(ml.test(e))t=16,e=e.toLowerCase();else if(ll.test(e))t=2;else if(dl.test(e))t=8;else throw Error(bn+e);for(o=e.search(/p/i),o>0?(c=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),s=o>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,o=a-o,i=Ca(n,new n(t),o,o*2)),u=To(e,t,Ft),l=u.length-1,o=l;u[o]===0;--o)u.pop();return o<0?new n(r.s*0):(r.e=Ko(u,l),r.d=u,ue=!1,s&&(r=Ke(r,i,a*4)),c&&(r=r.times(Math.abs(c)<54?Ye(2,c):Ai.pow(2,c))),ue=!0,r)}function gl(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:ei(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Co(5,t)),e=ei(r,2,e,e);for(var i,o=new r(5),s=new r(16),a=new r(20);t--;)i=e.times(e),e=e.times(o.plus(i.times(s.times(i).minus(a))));return e}function ei(r,e,t,n,i){var o,s,a,c,u=1,l=r.precision,m=Math.ceil(l/te);for(ue=!1,c=t.times(t),a=new r(n);;){if(s=Ke(a.times(c),new r(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=Ke(s.times(c),new r(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(o=m;s.d[o]===a.d[o]&&o--;);if(o==-1)break}o=a,a=n,n=s,s=o,u++}return ue=!0,s.d.length=m+1,s}function Co(r,e){for(var t=r;--e;)t*=r;return t}function Na(r,e){var t,n=e.s<0,i=Vt(r,r.precision,1),o=i.times(.5);if(e=e.abs(),e.lte(o))return on=n?4:1,e;if(t=e.divToInt(i),t.isZero())on=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(o))return on=wa(t)?n?2:3:n?4:1,e;on=wa(t)?n?1:4:n?3:2}return e.minus(i).abs()}function $r(r,e,t,n){var i,o,s,a,c,u,l,m,d,p=r.constructor,f=t!==void 0;if(f?(At(t,1,yn),n===void 0?n=p.rounding:At(n,0,8)):(t=p.precision,n=p.rounding),!r.isFinite())l=Ra(r);else{for(l=Yt(r),s=l.indexOf("."),f?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=To(Yt(d),10,i),d.e=d.d.length),m=To(l,10,i),o=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=f?"0p+0":"0";else{if(s<0?o--:(r=new p(r),r.d=m,r.e=o,r=Ke(r,d,t,n,0,i),m=r.d,o=r.e,u=Ta),s=m[t],a=i/2,u=u||m[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&m[t-1]&1||n===(r.s<0?8:7)),m.length=t,u)for(;++m[--t]>i-1;)m[t]=0,t||(++o,m.unshift(1));for(c=m.length;!m[c-1];--c);for(s=0,l="";s<c;s++)l+=zr.charAt(m[s]);if(f){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(m=To(l,i,e),c=m.length;!m[c-1];--c);for(s=1,l="1.";s<c;s++)l+=zr.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>c)for(o-=c;o--;)l+="0";else o<c&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function ka(r,e){if(r.length>e)return r.length=e,!0}function Al(r){return new this(r).abs()}function Pl(r){return new this(r).acos()}function wl(r){return new this(r).acosh()}function kl(r,e){return new this(r).plus(e)}function hl(r){return new this(r).asin()}function Tl(r){return new this(r).asinh()}function Il(r){return new this(r).atan()}function Bl(r){return new this(r).atanh()}function Sl(r,e){r=new this(r),e=new this(e);var t,n=this.precision,i=this.rounding,o=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=Vt(this,o,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?Vt(this,n,i):new this(0),t.s=r.s):!r.d||e.isZero()?(t=Vt(this,o,1).times(.5),t.s=r.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(Ke(r,e,o,1)),e=Vt(this,o,1),this.precision=n,this.rounding=i,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(Ke(r,e,o,1)),t}function xl(r){return new this(r).cbrt()}function Kl(r){return J(r=new this(r),r.e+1,2)}function Cl(r,e,t){return new this(r).clamp(e,t)}function Ll(r){if(!r||typeof r!="object")throw Error(xo+"Object expected");var e,t,n,i=r.defaults===!0,o=["precision",1,yn,"rounding",0,8,"toExpNeg",-Jn,0,"toExpPos",0,Jn,"maxE",0,Jn,"minE",-Jn,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],i&&(this[t]=jr[t]),(n=r[t])!==void 0)if(ut(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(bn+t+": "+n);if(t="crypto",i&&(this[t]=jr[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(Ba);else this[t]=!1;else throw Error(bn+t+": "+n);return this}function Rl(r){return new this(r).cos()}function Nl(r){return new this(r).cosh()}function Oa(r){var e,t,n;function i(o){var s,a,c,u=this;if(!(u instanceof i))return new i(o);if(u.constructor=i,ha(o)){u.s=o.s,ue?!o.d||o.e>i.maxE?(u.e=NaN,u.d=null):o.e<i.minE?(u.e=0,u.d=[0]):(u.e=o.e,u.d=o.d.slice()):(u.e=o.e,u.d=o.d?o.d.slice():o.d);return}if(c=typeof o,c==="number"){if(o===0){u.s=1/o<0?-1:1,u.e=0,u.d=[0];return}if(o<0?(o=-o,u.s=-1):u.s=1,o===~~o&&o<1e7){for(s=0,a=o;a>=10;a/=10)s++;ue?s>i.maxE?(u.e=NaN,u.d=null):s<i.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[o]):(u.e=s,u.d=[o]);return}else if(o*0!==0){o||(u.s=NaN),u.e=NaN,u.d=null;return}return Zr(u,o.toString())}else if(c!=="string")throw Error(bn+o);return(a=o.charCodeAt(0))===45?(o=o.slice(1),u.s=-1):(a===43&&(o=o.slice(1)),u.s=1),xa.test(o)?Zr(u,o):yl(u,o)}if(i.prototype=W,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Ll,i.clone=Oa,i.isDecimal=ha,i.abs=Al,i.acos=Pl,i.acosh=wl,i.add=kl,i.asin=hl,i.asinh=Tl,i.atan=Il,i.atanh=Bl,i.atan2=Sl,i.cbrt=xl,i.ceil=Kl,i.clamp=Cl,i.cos=Rl,i.cosh=Nl,i.div=Ol,i.exp=vl,i.floor=Ml,i.hypot=_l,i.ln=El,i.log=Vl,i.log10=Dl,i.log2=Fl,i.max=Wl,i.min=ql,i.mod=Ul,i.mul=Gl,i.pow=Xl,i.random=Ql,i.round=zl,i.sign=jl,i.sin=Hl,i.sinh=Yl,i.sqrt=Zl,i.sub=$l,i.sum=Jl,i.tan=em,i.tanh=tm,i.trunc=nm,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return i.config(r),i}function Ol(r,e){return new this(r).div(e)}function vl(r){return new this(r).exp()}function Ml(r){return J(r=new this(r),r.e+1,3)}function _l(){var r,e,t=new this(0);for(ue=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return ue=!0,new this(1/0);t=e}return ue=!0,t.sqrt()}function ha(r){return r instanceof Ai||r&&r.toStringTag===Sa||!1}function El(r){return new this(r).ln()}function Vl(r,e){return new this(r).log(e)}function Fl(r){return new this(r).log(2)}function Dl(r){return new this(r).log(10)}function Wl(){return La(this,arguments,"lt")}function ql(){return La(this,arguments,"gt")}function Ul(r,e){return new this(r).mod(e)}function Gl(r,e){return new this(r).mul(e)}function Xl(r,e){return new this(r).pow(e)}function Ql(r){var e,t,n,i,o=0,s=new this(1),a=[];if(r===void 0?r=this.precision:At(r,1,yn),n=Math.ceil(r/te),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)i=e[o],i>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:a[o++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)i=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,o):(a.push(i%1e7),o+=4);o=n/4}else throw Error(Ba);else for(;o<n;)a[o++]=Math.random()*1e7|0;for(n=a[--o],r%=te,n&&r&&(i=Ye(10,te-r),a[o]=(n/i|0)*i);a[o]===0;o--)a.pop();if(o<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=te)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<te&&(t-=te-n)}return s.e=t,s.d=a,s}function zl(r){return J(r=new this(r),r.e+1,this.rounding)}function jl(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function Hl(r){return new this(r).sin()}function Yl(r){return new this(r).sinh()}function Zl(r){return new this(r).sqrt()}function $l(r,e){return new this(r).sub(e)}function Jl(){var r=0,e=arguments,t=new this(e[r]);for(ue=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return ue=!0,J(t,this.precision,this.rounding)}function em(r){return new this(r).tan()}function tm(r){return new this(r).tanh()}function nm(r){return J(r=new this(r),r.e+1,1)}W[Symbol.for("nodejs.util.inspect.custom")]=W.toString;W[Symbol.toStringTag]="Decimal";var Ai=W.constructor=Oa(jr);Io=new Ai(Io);Bo=new Ai(Bo);var O=Ai;import lm from"big.js";import No from"bn.js";import im from"toformat";var om=im,Pi=om;import Ro from"big.js";import sm from"bn.js";import am from"decimal.js-light";import wi from"bn.js";var va=9007199254740991;function $(r){let e=fe("Raydium_parseBigNumberish");if(r instanceof wi)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new wi(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=va||r<=-va)&&e.logWithError(`BigNumberish number overflow: ${r}`),new wi(String(r))):typeof r=="bigint"?new wi(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new wi(0))}var Lo=fe("module/fraction"),Jr=Pi(Ro),ki=Pi(am),um={[0]:ki.ROUND_DOWN,[1]:ki.ROUND_HALF_UP,[2]:ki.ROUND_UP},cm={[0]:Ro.roundDown,[1]:Ro.roundHalfUp,[2]:Ro.roundUp},we=class{constructor(e,t=new sm(1)){this.numerator=$(e),this.denominator=$(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new we(this.denominator,this.numerator)}add(e){let t=e instanceof we?e:new we($(e));return this.denominator.eq(t.denominator)?new we(this.numerator.add(t.numerator),this.denominator):new we(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof we?e:new we($(e));return this.denominator.eq(t.denominator)?new we(this.numerator.sub(t.numerator),this.denominator):new we(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof we?e:new we($(e));return new we(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof we?e:new we($(e));return new we(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Lo.logWithError(`${e} is not an integer.`),e<=0&&Lo.logWithError(`${e} is not positive.`),ki.set({precision:e+1,rounding:um[n]});let i=new ki(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Lo.logWithError(`${e} is not an integer.`),e<0&&Lo.logWithError(`${e} is negative.`),Jr.DP=e,Jr.RM=cm[n]||1,new Jr(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var mm=fe("Raydium_amount"),Ma=Pi(lm);function dm(r,e){let t="0",n="0";if(r.includes(".")){let i=r.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):mm.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var he=class extends we{constructor(t,n,i=!0,o){let s=new No(0),a=es.pow(new No(t.decimals));if(i)s=$(n);else{let c=new No(0),u=new No(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=dm(n.toString(),t.decimals);c=$(l),u=$(m)}c=c.mul(a),s=c.add(u)}super(s,a);this.logger=fe(o||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new he(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new he(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return Ma.DP=this.token.decimals,new Ma(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as pm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as _a}from"@solana/spl-token";var gn={chainId:101,address:pm.default.toBase58(),programId:_a.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},ct={chainId:101,address:"So11111111111111111111111111111111111111112",programId:_a.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as rs}from"@solana/web3.js";import{PublicKey as ve,SystemProgram as Ea,SYSVAR_RENT_PUBKEY as fm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as bm}from"@solana/spl-token";function B({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var ts=[B({pubkey:bm,isWritable:!1}),B({pubkey:Ea.programId,isWritable:!1}),B({pubkey:fm,isWritable:!1})];function ns({publicKey:r,transformSol:e}){let t=is(r.toString());if(t instanceof ve)return e&&t.equals($e)?Z:t;if(e&&t.toString()===$e.toBase58())return Z;if(typeof t=="string"){if(t===ve.default.toBase58())return ve.default;try{return new ve(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function is(r){try{return new ve(r)}catch{return r}}var Oo=new ve("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),An=new ve("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),it=new ve("SysvarRent111111111111111111111111111111111"),Va=new ve("SysvarC1ock11111111111111111111111111111111"),Dt=new ve("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),ym=new ve("Sysvar1nstructions1111111111111111111111111"),os=Ea.programId,tb=new ve("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),nb=new ve("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),ib=new ve("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),ob=new ve("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),rb=new ve("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),sb=new ve("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ab=new ve("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),ub=new ve("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),cb=new ve("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),lb=new ve("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),mb=new ve("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),Z=new ve("So11111111111111111111111111111111111111112"),$e=ve.default;function at(r){return ns({publicKey:r,transformSol:!0})}var ss=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:o=!1,isToken2022:s=!1}){if(e===$e.toBase58()||e instanceof rs&&$e.equals(e)){this.decimals=ct.decimals,this.symbol=ct.symbol,this.name=ct.name,this.mint=new rs(ct.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=o?rs.default:ns({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Me=ss;Me.WSOL=new ss(q(v({},ct),{mint:ct.address}));var as=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},vo=as;vo.SOL=new as(gn);import gm from"bn.js";var Fa=new we(new gm(100)),Je=class extends we{toSignificant(e=5,t,n){return this.mul(Fa).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Fa).toFixed(e,t,n)}};var Am=fe("Raydium_price"),Pt=class extends we{constructor(t){let{baseToken:n,quoteToken:i,numerator:o,denominator:s}=t;super(o,s);this.baseToken=n,this.quoteToken=i,this.scalar=new we(us(n.decimals),us(i.decimals))}get raw(){return new we(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new Pt({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Am.logWithError("mul token not equals");let n=super.mul(t);return new Pt({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};import{PublicKey as Pm}from"@solana/web3.js";import wm from"bn.js";function Da(r){return typeof r=="object"&&r!==null&&![Me,he,Pm,we,wm,Pt,Je].some(e=>typeof e=="object"&&r instanceof e)}function ot(r){return typeof r=="string"?is(r):Array.isArray(r)?r.map(e=>ot(e)):Da(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>[e,ot(t)])):r}var wt=new Zt(0),Wa=new Zt(1),sy=new Zt(2),ay=new Zt(3),uy=new Zt(5),es=new Zt(10),cy=new Zt(100),ly=new Zt(1e3),my=new Zt(1e4);function us(r){return es.pow($(r))}function Mo(r,e){let t=r.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function _o(r,e,t){return r.mul(e).add(t).sub(new Zt(1)).div(t)}function cs(r,e,t){return r.mul(e).div(t)}function Qr(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Wt=class{constructor(e){this._owner=e}get publicKey(){return Wt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Wt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Wt.isKeyPair(this._owner)}get isPublicKey(){return Wt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Wt.isKeyPair(e)}};import{PublicKey as Sm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as xm}from"@solana/spl-token";import{ComputeBudgetProgram as qa,Keypair as Ga,PublicKey as km,Transaction as Xa,TransactionMessage as hm,VersionedTransaction as Qa}from"@solana/web3.js";var U={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip"};import{TOKEN_PROGRAM_ID as Tm}from"@solana/spl-token";var Ua=fe("Raydium_txUtil"),za=1644;function Eo(r){let e=[],t=[];return r.microLamports&&(e.push(qa.setComputeUnitPrice({microLamports:r.microLamports})),t.push(U.SetComputeUnitPrice)),r.units&&(e.push(qa.setComputeUnitLimit({units:r.units})),t.push(U.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function ti(r,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=r.getLatestBlockhash)==null?void 0:n.call(r,{commitment:t})))==null?void 0:i.blockhash}async function Vo(r,e){return r.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);r.onSignature(e,o=>{if(clearTimeout(i),!o.err){t("");return}n(Object.assign(o.err,{txId:e}))},"confirmed")})}function ls(r,e){r.length<1&&Ua.logWithError(`no instructions provided: ${r.toString()}`),e.length<1&&Ua.logWithError(`no signers provided:, ${e.toString()}`);let t=new Xa;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...r);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<za}catch{return!1}}function le(r,e){let[t,n]=km.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}function hi({instructions:r,payer:e,signers:t}){return ls(r,[e,...t])}function Ti({instructions:r,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Ga.generate().publicKey.toString()}){let o=new hm({payerKey:e,recentBlockhash:n,instructions:r}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Qa(o).serialize()).toString("base64").length<za}catch{return!1}}var Im=r=>Buffer.isBuffer(r)?r:r instanceof Uint8Array?Buffer.from(r.buffer,r.byteOffset,r.byteLength):Buffer.from(r),Bm=r=>{let e=r.serialize({requireAllSignatures:!1,verifySignatures:!1});r instanceof Qa&&(e=Im(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Nn(r){let e=[];return r.forEach(t=>{t instanceof Xa&&(t.recentBlockhash||(t.recentBlockhash=Tm.toBase58()),t.feePayer||(t.feePayer=Ga.generate().publicKey)),e.push(Bm(t))}),console.log("simulate tx string:",e),e}function ie(r,e,t){return le([r.toBuffer(),(t!=null?t:xm).toBuffer(),e.toBuffer()],new Sm("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ce}from"@solana/web3.js";var ja=new ce("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Ha=new ce("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Ya=new ce("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Ii=new ce("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Ny=new ce("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Za=new ce("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),ms=new ce("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Fo=new ce("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Oy=new ce("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),$a=new ce("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),On=new ce("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Bi=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Do=new ce("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),vy=new ce("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Ja=new ce("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Km=new ce("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Cm=new ce("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Lm=new ce("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),Rm=new ce("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Wo=new ce("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),eu=new ce("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),My=new ce("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Nm=new ce("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Om=new ce("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),vm=new ce("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),qo=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Mm=new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),Uo=new ce("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),_m=new ce("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),Pn=new ce("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),_y=new ce("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Em=new ce("7soRSLviCKHCKzCbRuVpZDif76NWLVqFtbjt8LpyxWSq"),Vm=new ce("DG6kZFFCqxdtWXw53Zc28hLs3MTr28Efkm2FrsNERNSQ"),Si={IDO_PROGRAM_ID_V1:Km,IDO_PROGRAM_ID_V2:Cm,IDO_PROGRAM_ID_V3:Lm,IDO_PROGRAM_ID_V4:Rm};var Ey={SERUM_MARKET:ce.default,OPENBOOK_MARKET:new ce("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ce.default,FarmV3:new ce("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ce("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ce("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ce("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ce("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ce("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ce("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ce("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Nm,CREATE_CPMM_POOL_AUTH:Om,CREATE_CPMM_POOL_FEE_ACC:vm,FEE_DESTINATION_ID:new ce("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:Mm,LCOK_CPMM_AUTH:_m,LAUNCHPAD_PROGRAM:Em,LAUNCHPAD_AUTH:Vm};import bt from"bn.js";var xi=1e4;function Te(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let i=q(v({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),o=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new bt(o.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===xi){let c=new bt(o.maximumFee.toString());return{amount:r.add(c),fee:c,expirationTime:a}}else{let c=wn(r.mul(new bt(xi)),new bt(xi-o.transferFeeBasisPoints)),u=new bt(o.maximumFee.toString()),l=c.sub(r).gt(u)?r.add(u):c,m=wn(l.mul(new bt(o.transferFeeBasisPoints)),new bt(xi)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let c=wn(r.mul(new bt(o.transferFeeBasisPoints)),new bt(xi)),u=c.gt(s)?s:c;return{amount:r,fee:u,expirationTime:a}}}function qt(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function wn(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new bt(0))?t.add(new bt(1)):t}function Go(r,e){if(r.isZero())return new bt(0);let t=r.div(e);return t.isZero()?new bt(1):r.mod(e).gt(new bt(0))?t.add(new bt(1)):t}import{PublicKey as tu,AddressLookupTableAccount as Xo}from"@solana/web3.js";async function ds({connection:r,address:e}){let t=await Et(r,[...new Set(e.map(i=>i.toString()))].map(i=>new tu(i))),n={};for(let i=0;i<e.length;i++){let o=t[i],s=e[i];if(!o)continue;let a=new Xo({key:s,state:Xo.deserialize(o.data)});n[s.toString()]=a,Qo[s.toString()]=a}return n}var Qo={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new Xo({key:new tu("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:Xo.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as ni,sendAndConfirmTransaction as ps,SystemProgram as Fm,Transaction as Ki,TransactionMessage as Ci,VersionedTransaction as Li}from"@solana/web3.js";import Dm from"axios";var zo=2e3,jo=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await Dm.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=Eo(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){var t;return e?(this.endInstructions.push(Fm.transfer({fromPubkey:(t=e.feePayer)!=null?t:this.feePayer,toPubkey:new ni(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(U.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:o=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...o),this.lookupTableAddress.push(...s.filter(a=>a!==ni.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(v({},t||{})):this.build(t)}build(e){var n;let t=new Ki;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var l;let{recentBlockHash:o,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=i||{},u=o!=null?o:await ti(this.connection,this.blockhashCommitment);if(t.recentBlockhash=u,this.signers.length&&t.sign(...this.signers),Nn([t]),(l=this.owner)!=null&&l.isKeyPair)return{txId:a?await ps(this.connection,t,this.signers.find(d=>d.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let m=await this.signAllTransactions([t]);if(this.signers.length)for(let d of m)try{d.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(m[0].serialize(),{skipPreflight:s}),signedTx:m[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var u;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),o=t.filter(l=>l.transaction.instructions.length>0),s=[i,...o.map(l=>l.transaction)],a=[this.signers,...o.map(l=>l.signers)],c=[...this.instructionTypes,...o.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async l=>{var g;let{sequentially:m,onTxUpdate:d,skipTxCount:p=0,recentBlockHash:f,skipPreflight:b=!0}=l||{},y=f!=null?f:await ti(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(m){let A=[],w=0;for(let h of s){if(++w,w<=p)continue;let T=await ps(this.connection,h,this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:b});A.push(T)}return{txIds:A,signedTxs:s}}return{txIds:await await Promise.all(s.map(async A=>(A.recentBlockhash=y,await this.connection.sendRawTransaction(A.serialize(),{skipPreflight:b})))),signedTxs:s}}if(this.signAllTransactions){let A=s.map((h,T)=>(h.recentBlockhash=y,a[T].length&&h.sign(...a[T]),h));Nn(A);let w=await this.signAllTransactions(A);if(m){let h=0,T=[],k=async()=>{if(!w[h])return;let x=await this.connection.sendRawTransaction(w[h].serialize(),{skipPreflight:b});T.push({txId:x,status:"sent",signedTx:w[h]}),d==null||d([...T]),h++;let S=!1,K=null,I=null,C=L=>{K!==null&&clearInterval(K),I!==null&&this.connection.removeSignatureListener(I);let R=T.findIndex(_=>_.txId===x);if(R>-1){if(T[R].status==="error"||T[R].status==="success")return;T[R].status=L.err?"error":"success"}d==null||d([...T]),L.err||k()};this.loopMultiTxStatus&&(K=setInterval(async()=>{var L;if(S){clearInterval(K);return}try{let R=await this.connection.getTransaction(x,{commitment:"confirmed",maxSupportedTransactionVersion:0});R&&(S=!0,clearInterval(K),C({err:((L=R.meta)==null?void 0:L.err)||null}),console.log("tx status from getTransaction:",x))}catch(R){S=!0,clearInterval(K),console.error("getTransaction timeout:",R,x)}},zo)),I=this.connection.onSignature(x,L=>{if(S){this.connection.removeSignatureListener(I);return}S=!0,C(L)},"confirmed"),this.connection.getSignatureStatus(x)};return await k(),{txIds:T.map(x=>x.txId),signedTxs:w}}else{let h=[];for(let T=0;T<w.length;T+=1){let k=await this.connection.sendRawTransaction(w[T].serialize(),{skipPreflight:b});h.push(k)}return{txIds:h,signedTxs:w}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var b;let f=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:o}=f,s=Ee(f,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=v(v({},this.cluster==="devnet"?{}:Qo),t),c=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let y of c)a[y]===void 0&&u.push(new ni(y));let l=await ds({connection:this.connection,address:u});for(let[y,g]of Object.entries(l))a[y]=g;let m=i?ni.default.toBase58():o!=null?o:await ti(this.connection,this.blockhashCommitment),d=new Ci({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((b=this.owner)==null?void 0:b.signer)&&!this.signers.some(y=>y.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new Li(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async y=>{var h;let{skipPreflight:g=!0,sendAndConfirm:A,notSendToRpc:w}=y||{};if(Nn([p]),(h=this.owner)!=null&&h.isKeyPair){let T=await this.connection.sendTransaction(p,{skipPreflight:g});return A&&await Vo(this.connection,T),{txId:T,signedTx:p}}if(this.signAllTransactions){let T=await this.signAllTransactions([p]);if(this.signers.length)for(let k of T)try{k.sign(this.signers)}catch{}return{txId:w?"":await this.connection.sendTransaction(T[0],{skipPreflight:g}),signedTx:T[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var u;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),o=t.filter(l=>l.builder.instructions.length>0),s=[i,...o.map(l=>l.transaction)],a=[this.signers,...o.map(l=>l.signers)],c=[...this.instructionTypes,...o.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async l=>{var b;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:f=!0}=l||{};if(p&&s.forEach(y=>y.message.recentBlockhash=p),Nn(s),(b=this.owner)!=null&&b.isKeyPair){if(m){let y=[];for(let g of s){let A=await this.connection.sendTransaction(g,{skipPreflight:f});await Vo(this.connection,A),y.push(A)}return{txIds:y,signedTxs:s}}return{txIds:await Promise.all(s.map(async y=>await this.connection.sendTransaction(y,{skipPreflight:f}))),signedTxs:s}}if(this.signAllTransactions){let y=await this.signAllTransactions(s);if(m){let g=0,A=[],w=async()=>{if(!y[g])return;let h=await this.connection.sendTransaction(y[g],{skipPreflight:f});A.push({txId:h,status:"sent",signedTx:y[g]}),d==null||d([...A]),g++;let T=!1,k=null,x=null,S=K=>{k!==null&&clearInterval(k),x!==null&&this.connection.removeSignatureListener(x);let I=A.findIndex(C=>C.txId===h);if(I>-1){if(A[I].status==="error"||A[I].status==="success")return;A[I].status=K.err?"error":"success"}d==null||d([...A]),K.err||w()};this.loopMultiTxStatus&&(k=setInterval(async()=>{var K;if(T){clearInterval(k);return}try{let I=await this.connection.getTransaction(h,{commitment:"confirmed",maxSupportedTransactionVersion:0});I&&(T=!0,clearInterval(k),S({err:((K=I.meta)==null?void 0:K.err)||null}),console.log("tx status from getTransaction:",h))}catch(I){T=!0,clearInterval(k),console.error("getTransaction timeout:",I,h)}},zo)),x=this.connection.onSignature(h,K=>{if(T){this.connection.removeSignatureListener(x);return}T=!0,S(K)},"confirmed"),this.connection.getSignatureStatus(h)};return w(),{txIds:[],signedTxs:y}}else{let g=[];for(let A=0;A<y.length;A+=1){let w=await this.connection.sendTransaction(y[A],{skipPreflight:f});g.push(w)}return{txIds:g,signedTxs:y}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var d;let m=e||{},{splitIns:t=[],computeBudgetConfig:n}=m,i=Ee(m,["splitIns","computeBudgetConfig"]),o=n?Eo(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((p,f)=>q(v({},p),{[f.publicKey.toBase58()]:f}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(p=>{let f=[...u,p],b=n?[...o.instructions,...f]:f,g=[...new Set(f.map(A=>A.keys.filter(w=>w.isSigner).map(w=>w.pubkey.toString())).flat()).values()].map(A=>new ni(A));if(p!==t[l]&&u.length<12&&(hi({instructions:b,payer:this.feePayer,signers:g})||hi({instructions:f,payer:this.feePayer,signers:g})))u.push(p);else{if(u.length===0)throw Error("item ins too big");l+=p===t[l]?1:0,hi({instructions:n?[...o.instructions,...u]:[...u],payer:this.feePayer,signers:g})?a.push(new Ki().add(...o.instructions,...u)):a.push(new Ki().add(...u)),c.push(Array.from(new Set(u.map(A=>A.keys.filter(w=>w.isSigner).map(w=>w.pubkey.toString())).flat())).map(A=>s[A]).filter(A=>A!==void 0)),u=[p]}}),u.length>0){let f=[...new Set(u.map(b=>b.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(b=>s[b]).filter(b=>b!==void 0);hi({instructions:n?[...o.instructions,...u]:[...u],payer:this.feePayer,signers:f.map(b=>b.publicKey)})?a.push(new Ki().add(...o.instructions,...u)):a.push(new Ki().add(...u)),c.push(f)}return a.forEach(p=>p.feePayer=this.feePayer),(d=this.owner)!=null&&d.signer&&c.forEach(p=>{p.some(f=>f.publicKey.equals(this.owner.publicKey))||p.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async p=>{var h;let{sequentially:f,onTxUpdate:b,skipTxCount:y=0,recentBlockHash:g,skipPreflight:A=!0}=p||{},w=g!=null?g:await ti(this.connection,this.blockhashCommitment);if(a.forEach(async(T,k)=>{T.recentBlockhash=w,c[k].length&&T.sign(...c[k])}),Nn(a),(h=this.owner)!=null&&h.isKeyPair){if(f){let T=0,k=[];for(let x of a){if(++T,T<=y){k.push("tx skipped");continue}let S=await ps(this.connection,x,this.signers.find(K=>K.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:A});k.push(S)}return{txIds:k,signedTxs:a}}return{txIds:await Promise.all(a.map(async T=>await this.connection.sendRawTransaction(T.serialize(),{skipPreflight:A}))),signedTxs:a}}if(this.signAllTransactions){let T=await this.signAllTransactions(a.slice(y,a.length)),k=[...a.slice(0,y),...T];if(f){let x=0,S=[],K=async()=>{if(!k[x])return;x<y&&(S.push({txId:"",status:"success",signedTx:k[x]}),b==null||b([...S]),x++,K());let I=await this.connection.sendRawTransaction(k[x].serialize(),{skipPreflight:A});S.push({txId:I,status:"sent",signedTx:k[x]}),b==null||b([...S]),x++;let C=!1,L=null,R=null,_=M=>{L!==null&&clearInterval(L),R!==null&&this.connection.removeSignatureListener(R);let V=S.findIndex(H=>H.txId===I);if(V>-1){if(S[V].status==="error"||S[V].status==="success")return;S[V].status=M.err?"error":"success"}b==null||b([...S]),M.err||K()};this.loopMultiTxStatus&&(L=setInterval(async()=>{var M;if(C){clearInterval(L);return}try{let V=await this.connection.getTransaction(I,{commitment:"confirmed",maxSupportedTransactionVersion:0});V&&(C=!0,clearInterval(L),_({err:((M=V.meta)==null?void 0:M.err)||null}),console.log("tx status from getTransaction:",I))}catch(V){C=!0,clearInterval(L),console.error("getTransaction timeout:",V,I)}},zo)),R=this.connection.onSignature(I,M=>{if(C){this.connection.removeSignatureListener(R);return}C=!0,_(M)},"confirmed"),this.connection.getSignatureStatus(I)};return await K(),{txIds:S.map(I=>I.txId),signedTxs:k}}else{let x=[];for(let S=0;S<k.length;S+=1){let K=await this.connection.sendRawTransaction(k[S].serialize(),{skipPreflight:A});x.push(K)}return{txIds:x,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async sizeCheckBuildV0(e){var w;let A=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:o=[]}=A,s=Ee(A,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),a=v(v({},this.cluster==="devnet"?{}:Qo),i),c=Array.from(new Set([...this.lookupTableAddress,...o])),u=[];for(let h of c)a[h]===void 0&&u.push(new ni(h));let l=await ds({connection:this.connection,address:u});for(let[h,T]of Object.entries(l))a[h]=T;let m=t?Eo(t):{instructions:[],instructionTypes:[]},d=await ti(this.connection,this.blockhashCommitment),p=this.signers.reduce((h,T)=>q(v({},h),{[T.publicKey.toBase58()]:T}),{}),f=[],b=[],y=[],g=0;if(this.allInstructions.forEach(h=>{let T=[...y,h],k=t?[...m.instructions,...T]:T;if(h!==n[g]&&y.length<12&&(Ti({instructions:k,payer:this.feePayer,lookupTableAddressAccount:a})||Ti({instructions:T,payer:this.feePayer,lookupTableAddressAccount:a})))y.push(h);else{if(y.length===0)throw Error("item ins too big");g+=h===n[g]?1:0;let x={};for(let S of[...new Set(c)])a[S]!==void 0&&(x[S]=a[S]);if(t&&Ti({instructions:[...m.instructions,...y],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let S=new Ci({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...y]}).compileToV0Message(Object.values(a));f.push(new Li(S))}else{let S=new Ci({payerKey:this.feePayer,recentBlockhash:d,instructions:[...y]}).compileToV0Message(Object.values(a));f.push(new Li(S))}b.push(Array.from(new Set(y.map(S=>S.keys.filter(K=>K.isSigner).map(K=>K.pubkey.toString())).flat())).map(S=>p[S]).filter(S=>S!==void 0)),y=[h]}}),y.length>0){let T=[...new Set(y.map(k=>k.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat()).values()].map(k=>p[k]).filter(k=>k!==void 0);if(t&&Ti({instructions:[...m.instructions,...y],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let k=new Ci({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...y]}).compileToV0Message(Object.values(a));f.push(new Li(k))}else{let k=new Ci({payerKey:this.feePayer,recentBlockhash:d,instructions:[...y]}).compileToV0Message(Object.values(a));f.push(new Li(k))}b.push(T)}return(w=this.owner)!=null&&w.signer&&b.forEach(h=>{h.some(T=>T.publicKey.equals(this.owner.publicKey))||h.push(this.owner.signer)}),f.forEach((h,T)=>{h.sign(b[T])}),{builder:this,transactions:f,buildProps:e,signers:b,instructionTypes:this.instructionTypes,execute:async h=>{var I;let{sequentially:T,onTxUpdate:k,skipTxCount:x=0,recentBlockHash:S,skipPreflight:K=!0}=h||{};if(f.map(async(C,L)=>{b[L].length&&C.sign(b[L]),S&&(C.message.recentBlockhash=S)}),Nn(f),(I=this.owner)!=null&&I.isKeyPair){if(T){let C=0,L=[];for(let R of f){if(++C,C<=x){console.log("skip tx: ",C),L.push("tx skipped");continue}let _=await this.connection.sendTransaction(R,{skipPreflight:K});await Vo(this.connection,_),L.push(_)}return{txIds:L,signedTxs:f}}return{txIds:await Promise.all(f.map(async C=>await this.connection.sendTransaction(C,{skipPreflight:K}))),signedTxs:f}}if(this.signAllTransactions){let C=await this.signAllTransactions(f.slice(x,f.length)),L=[...f.slice(0,x),...C];if(T){let R=0,_=[],M=async()=>{if(!L[R])return;if(R<x){_.push({txId:"",status:"success",signedTx:L[R]}),k==null||k([..._]),R++,M();return}let V=await this.connection.sendTransaction(L[R],{skipPreflight:K});_.push({txId:V,status:"sent",signedTx:L[R]}),k==null||k([..._]),R++;let H=!1,re=null,ge=null,ae=me=>{re!==null&&clearInterval(re),ge!==null&&this.connection.removeSignatureListener(ge);let xe=_.findIndex(je=>je.txId===V);if(xe>-1){if(_[xe].status==="error"||_[xe].status==="success")return;_[xe].status=me.err?"error":"success"}k==null||k([..._]),me.err||M()};this.loopMultiTxStatus&&(re=setInterval(async()=>{var me;if(H){clearInterval(re);return}try{let xe=await this.connection.getTransaction(V,{commitment:"confirmed",maxSupportedTransactionVersion:0});xe&&(H=!0,clearInterval(re),ae({err:((me=xe.meta)==null?void 0:me.err)||null}),console.log("tx status from getTransaction:",V))}catch(xe){H=!0,clearInterval(re),console.error("getTransaction timeout:",xe,V)}},zo)),ge=this.connection.onSignature(V,me=>{if(H){this.connection.removeSignatureListener(ge);return}H=!0,ae(me)},"confirmed"),this.connection.getSignatureStatus(V)};return M(),{txIds:[],signedTxs:L}}else{let R=[];for(let _=0;_<L.length;_+=1){let M=await this.connection.sendTransaction(L[_],{skipPreflight:K});R.push(M)}return{txIds:R,signedTxs:L}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import Wm from"bn.js";var Ut=new Wm(1e6);var et={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://tokens.jup.ag/tokens?tags=lst,community",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},Bg=v({},et);var nu="ray_tab_hash",fs="ray_req_hash",qm=()=>{if(typeof window===void 0)return"";let r=sessionStorage.getItem(nu);return r||(r=`ray-${Date.now()}`,sessionStorage.setItem(nu,r)),r},Ho=async n=>{var i=n,{logCount:r=1e3,removeLastLog:e}=i,t=Ee(i,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let o=JSON.parse(localStorage.getItem(fs)||"[]").slice(0,r-1);e&&o.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),o.unshift(q(v({},t),{time:Date.now(),session:qm()}));try{localStorage.setItem(fs,JSON.stringify(o))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(o[0].data=a+(a.length>100?"...":"");!s;){o.pop();let c=JSON.stringify(t.data).substring(0,100);o[0].data=c+(c.length>100?"...":"");try{localStorage.setItem(fs,JSON.stringify(o)),s=!0}catch{s=!1}}return new Promise(c=>c())}return Ho(q(v({},t),{logCount:r,removeLastLog:!0}))}};var Yo=fe("Raydium_Api"),bs=new Map;var Zo=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:i,urlConfigs:o}){this.cluster=e,this.urlConfigs=o||{},this.logCount=i||1e3,this.api=iu.create({baseURL:this.urlConfigs.BASE_HOST||et.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return Yo.debug(`${a==null?void 0:a.toUpperCase()} ${c}${u}`),s},s=>(Yo.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:m,url:d}=a;return n&&Ho({status:u,url:`${m}${d}`,params:a.params,data:c,logCount:this.logCount}),Yo.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:m,url:d}=a;return n&&Ho({status:u,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),Yo.error(`${l.toUpperCase()} ${m}${d} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||et.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||et.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||et.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await iu.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(i=>i.numSlots);return n.reduce((i,o)=>i+o,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||et.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||et.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||et.TOKEN_LIST)).data}async getJupTokenList(){return this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||et.JUP_TOKEN_LIST})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||et.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:i="desc",page:o=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||et.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${i}&page=${o}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||et.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],i=t.filter(s=>bs.has(s)?(n.push(bs.get(s)),!1):!0),o=[];return i.length&&(o=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||et.POOL_KEY_BY_ID)+`?ids=${i.join(",")}`)).data.filter(Boolean),o.forEach(a=>{bs.set(a.id,a)})),n.concat(o)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:i="all",sort:o="default",order:s="desc",page:a=1}=e,[c,u]=[t&&at(t).toBase58(),n&&n!=="undefined"?at(n).toBase58():""],[l,m]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||et.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${i}&poolSortField=${o}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||et.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||et.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||et.CHECK_AVAILABILITY)).data}};var $o="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",ou="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as rr,SystemProgram as Pd}from"@solana/web3.js";import{AccountLayout as ai,createAssociatedTokenAccountInstruction as Bs,TOKEN_PROGRAM_ID as Bn,TOKEN_2022_PROGRAM_ID as wd}from"@solana/spl-token";var ys=(...r)=>r.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Le=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=fe(t)}createTxBuilder(e){return this.scope.checkOwner(),new jo({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(ys(e))}logInfo(...e){this.logger.info(ys(e))}logAndCreateError(...e){let t=ys(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as pd,SystemProgram as fd}from"@solana/web3.js";import bd from"bn.js";import{createCloseAccountInstruction as yd,createInitializeAccountInstruction as gd,createTransferInstruction as Ad,TOKEN_PROGRAM_ID as si}from"@solana/spl-token";import{Keypair as cd,PublicKey as Pu}from"@solana/web3.js";import ld from"bn.js";import{TOKEN_PROGRAM_ID as md}from"@solana/spl-token";function Um(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function gs(r,...e){if(!Um(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function As(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function ru(r,e){gs(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var er=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),Gt=(r,e)=>r<<32-e|r>>>e;var aA=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Gm(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Ps(r){return typeof r=="string"&&(r=Gm(r)),gs(r),r}var Jo=class{clone(){return this._cloneInto()}},uA={}.toString;function su(r){let e=n=>r().update(Ps(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Xm(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let i=BigInt(32),o=BigInt(4294967295),s=Number(t>>i&o),a=Number(t&o),c=n?4:0,u=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+u,a,n)}var au=(r,e,t)=>r&e^~r&t,uu=(r,e,t)=>r&e^r&t^e&t,tr=class extends Jo{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=er(this.buffer)}update(e){As(this);let{view:t,buffer:n,blockLen:i}=this;e=Ps(e);let o=e.length;for(let s=0;s<o;){let a=Math.min(i-this.pos,o-s);if(a===i){let c=er(e);for(;i<=o-s;s+=i)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){As(this),ru(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:o}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(n,0),s=0);for(let m=s;m<i;m++)t[m]=0;Xm(n,i-8,BigInt(this.length*8),o),this.process(n,0);let a=er(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)a.setUint32(4*m,l[m],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:o,destroyed:s,pos:a}=this;return e.length=i,e.pos=a,e.finished=o,e.destroyed=s,i%t&&e.buffer.set(n),e}};var Qm=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),kn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),hn=new Uint32Array(64),ws=class extends tr{constructor(){super(64,32,8,!1),this.A=kn[0]|0,this.B=kn[1]|0,this.C=kn[2]|0,this.D=kn[3]|0,this.E=kn[4]|0,this.F=kn[5]|0,this.G=kn[6]|0,this.H=kn[7]|0}get(){let{A:e,B:t,C:n,D:i,E:o,F:s,G:a,H:c}=this;return[e,t,n,i,o,s,a,c]}set(e,t,n,i,o,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=o|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)hn[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=hn[m-15],p=hn[m-2],f=Gt(d,7)^Gt(d,18)^d>>>3,b=Gt(p,17)^Gt(p,19)^p>>>10;hn[m]=b+hn[m-7]+f+hn[m-16]|0}let{A:n,B:i,C:o,D:s,E:a,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let d=Gt(a,6)^Gt(a,11)^Gt(a,25),p=l+d+au(a,c,u)+Qm[m]+hn[m]|0,b=(Gt(n,2)^Gt(n,13)^Gt(n,22))+uu(n,i,o)|0;l=u,u=c,c=a,a=s+p|0,s=o,o=i,i=n,n=p+b|0}n=n+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,i,o,s,a,c,u,l)}roundClean(){hn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var cu=su(()=>new ws);import{PublicKey as rd}from"@solana/web3.js";import bu,{isBN as yu}from"bn.js";import{bits as zm,BitStructure as gA,blob as jm,Blob as AA,cstr as PA,f32 as wA,f32be as kA,f64 as hA,f64be as TA,greedy as IA,Layout as Hm,ns64 as BA,ns64be as SA,nu64 as Ym,nu64be as xA,offset as Zm,s16 as KA,s16be as CA,s24 as LA,s24be as RA,s32 as $m,s32be as NA,s40 as OA,s40be as vA,s48 as MA,s48be as _A,s8 as EA,seq as Jm,struct as VA,Structure as ed,u16 as td,u16be as FA,u24 as DA,u24be as WA,u32 as nd,u32be as qA,u40 as UA,u40be as GA,u48 as XA,u48be as QA,u8 as id,UInt as od,union as zA,Union as jA,unionLayoutDiscriminator as HA,utf8 as YA}from"@solana/buffer-layout";var nr=Hm,lu=ed;var ks=od;var mu=id,Xt=td;var ir=nd;var du=Ym;var Re=$m;var pu=Jm;var ke=jm;var hs=zm,fu=Zm;var vn=class extends nr{constructor(t,n,i){super(t,i);this.blob=ke(t),this.signed=n}decode(t,n=0){let i=new bu(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new bu(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}},or=class extends nr{constructor(t){super(8,t);this._lower=hs(ir(),!1),this._upper=hs(ir(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let i=this._lower.decode(t,n),o=this._upper.decode(t,n+this._lower.span);return v(v({},i),o)}encode(t,n,i=0){return this._lower.encode(t,n,i)+this._upper.encode(t,n,i+this._lower.span)}};function G(r){return new ks(1,r)}function lt(r){return new ks(4,r)}function P(r){return new vn(8,!1,r)}function ee(r){return new vn(16,!1,r)}function gu(r){return new vn(1,!0,r)}function ri(r){return new vn(8,!0,r)}function Au(r){return new vn(16,!0,r)}var oi=class extends nr{constructor(t,n,i,o){super(t.span,o);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function N(r){return new oi(ke(32),e=>new rd(e),e=>e.toBuffer(),r)}function Ve(r){return new oi(mu(),sd,ad,r)}function sd(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function ad(r){return r?1:0}function ud(r){let e=ir("length"),t=E([e,ke(fu(e,-e.span),"data")]);return new oi(t,({data:n})=>n,n=>({data:n}),r)}function Tn(r){return new oi(ud(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),r)}var Ts=class extends lu{decode(e,t){return super.decode(e,t)}};function E(r,e,t){return new Ts(r,e,t)}function Q(r,e,t){let n,i=typeof e=="number"?e:yu(e)?e.toNumber():new Proxy(e,{get(o,s){if(!n){let a=Reflect.get(o,"count");n=yu(a)?a.toNumber():a,Reflect.set(o,"count",n)}return Reflect.get(o,s)},set(o,s,a){return s==="count"&&(n=a),Reflect.set(o,s,a)}});return pu(r,i,t)}var Mn=E([N("mint"),N("owner"),P("amount"),lt("delegateOption"),N("delegate"),G("state"),lt("isNativeOption"),P("isNative"),P("delegatedAmount"),lt("closeAuthorityOption"),N("closeAuthority")]);var gP=fe("Raydium_Util");function wu({owner:r,solAccountResp:e,tokenAccountResp:t}){let n=[],i=[];for(let{pubkey:o,account:s}of t.value){let a=Mn.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:o,mint:c,amount:u,isAssociated:ie(r,c,s.owner).publicKey.equals(o),isNative:!1,programId:s.owner}),i.push({pubkey:o,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Pu.default,amount:new ld(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:i}}function qe({fromPublicKey:r,programId:e=md,assignSeed:t}){let n=t?btoa(t).slice(0,32):cd.generate().publicKey.toBase58().slice(0,32);return{publicKey:dd(r,n,e),seed:n}}function dd(r,e,t){let n=Buffer.concat([r.toBuffer(),Buffer.from(e),t.toBuffer()]),i=cu(n);return new Pu(i)}function Is(r){let{mint:e,tokenAccount:t,owner:n,programId:i=si}=r;return gd(t,e,n,i)}function rn(r){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:o=si}=r;return yd(e,t,i,n,o)}async function In(r){let{connection:e,amount:t,commitment:n,payer:i,owner:o,skipCloseAccount:s}=r,a=await e.getMinimumBalanceForRentExemption(Mn.span,n),c=$(t).add(new bd(a)),u=qe({fromPublicKey:i,programId:si});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[fd.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:Mn.span,programId:si}),Is({mint:new pd(ct.address),tokenAccount:u.publicKey,owner:o,programId:si})],instructionTypes:[U.CreateAccount,U.InitAccount],endInstructionTypes:s?[]:[U.CloseAccount],endInstructions:s?[]:[rn({tokenAccount:u.publicKey,payer:i,owner:o})]}}function ku({source:r,destination:e,owner:t,amount:n,multiSigners:i=[],tokenProgram:o=si}){return Ad(r,e,t,BigInt(String(n)),i,o)}var Ri=class extends Le{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._notSubscribeAccountChange=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:i,notSubscribeAccountChange:o}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=i||[],this._notSubscribeAccountChange=o!=null?o:!0,this._clientOwnedToken=!!(n||i)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(t){this._notSubscribeAccountChange=t}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return ie(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let i=v(v({},{}),t),[o,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Bn},i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:wd},i.commitment)]),{tokenAccounts:c,tokenAccountRawInfos:u}=wu({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=c,this._tokenAccountRawInfos=u,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(l=>l({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:t==null?void 0:t.commitment})),{tokenAccounts:c,tokenAccountRawInfos:u}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:t,programId:n=Bn,associatedOnly:i=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,c)=>a.amount.lt(c.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of o){let{publicKey:c}=a;if(c&&(!i||i&&s.equals(c)))return c}}async getOrCreateTokenAccount(t){var b,y,g,A;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:i,associatedOnly:o,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:c=!1,checkCreateATAOwner:u=!1,assignSeed:l}=t,m=new rr(t.tokenProgram||Bn),d=this.getAssociatedTokenAccount(n,new rr(m)),p=(a?[]:this.tokenAccountRawInfos).filter(w=>w.accountInfo.mint.equals(n)&&(!o||w.pubkey.equals(d))).sort((w,h)=>w.accountInfo.amount.lt(h.accountInfo.amount)?1:-1);if(i===void 0||p.length>0)return p.length>0?{account:p[0].pubkey}:{};let f={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let w=Bs(s,d,s,n,m),h=this.tokenAccountRawInfos.find(T=>T.pubkey.equals(d));if(u){let T=await this.scope.connection.getAccountInfo(d);if(T===null)(b=f.instructions)==null||b.push(w),f.instructionTypes.push(U.CreateATA);else if(!(T.owner.equals(m)&&ai.decode(T.data).mint.equals(n)&&ai.decode(T.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${d.toString()}`)}else h===void 0&&(f.instructions.push(w),f.instructionTypes.push(U.CreateATA));if(n.equals(Z)&&i.amount){let T=await In({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(y=i.amount)!=null?y:0,skipCloseAccount:c});f.instructions.push(...T.instructions||[]),f.endInstructions.push(...T.endInstructions||[]),f.instructionTypes.push(...T.instructionTypes||[]),f.endInstructionTypes.push(...T.endInstructionTypes||[]),i.amount&&(f.instructions.push(ku({source:T.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:i.amount,tokenProgram:Bn})),f.instructionTypes.push(U.TransferAmount))}return!c&&h===void 0&&(f.endInstructions.push(rn({owner:s,payer:i.payer||s,tokenAccount:d,programId:m})),f.endInstructionTypes.push(U.CloseAccount)),{account:d,instructionParams:f}}else{let w=qe({fromPublicKey:s,programId:m,assignSeed:l}),h=await this.scope.connection.getMinimumBalanceForRentExemption(ai.span),T=Pd.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:w.seed,newAccountPubkey:w.publicKey,lamports:h+Number((A=(g=i.amount)==null?void 0:g.toString())!=null?A:0),space:ai.span,programId:m});return f.instructions.push(T,Is({mint:n,tokenAccount:w.publicKey,owner:this.scope.ownerPubKey,programId:m})),f.instructionTypes.push(U.CreateAccount),f.instructionTypes.push(U.InitAccount),c||(f.endInstructions.push(rn({owner:s,payer:i.payer||s,tokenAccount:w.publicKey,programId:m})),f.endInstructionTypes.push(U.CloseAccount)),{account:w.publicKey,instructionParams:f}}}async checkOrCreateAta({mint:t,programId:n=Bn,autoUnwrapWSOLToSOL:i}){var c;await this.fetchWalletTokenAccounts();let o=(c=this.scope.account.tokenAccounts.find(({mint:u})=>(u==null?void 0:u.toBase58())===t.toBase58()))==null?void 0:c.publicKey,s=this.scope.ownerPubKey,a={};if(!o){let u=this.getAssociatedTokenAccount(t,n),l=await Bs(s,u,s,t,n);a.instructions=[l],a.instructionTypes=[U.CreateATA],o=u}return i&&Z.toBase58()===t.toBase58()&&(a.endInstructions=[rn({owner:s,payer:s,tokenAccount:o,programId:n})],a.endInstructionTypes=[U.CloseAccount]),{pubKey:o,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:i,mint:o,programId:s=Bn,tokenAccount:a,payer:c=this.scope.ownerPubKey,bypassAssociatedCheck:u,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(o,s);if(new rr(Z).equals(o)){let p=await In({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:c,amount:i,skipCloseAccount:l});return v({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!u){let p=[],f=Bs(this.scope.ownerPubKey,d,this.scope.ownerPubKey,o,s);if(m){let b=await this.scope.connection.getAccountInfo(d);if(b===null)p.push(f);else if(!(b.owner.equals(Bn)&&ai.decode(b.data).mint.equals(o)&&ai.decode(b.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${d.toString()}`)}else p.push(f);return{tokenAccount:d,instructions:p,instructionTypes:[U.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:i=Bn,amount:o,useSOLBalance:s,handleTokenAccount:a,feePayer:c}=t,u,l=this.createTxBuilder(c);if(n.equals(new rr(Z))&&s){let m=await this.handleTokenAccount({side:"in",amount:o||0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=m,f=Ee(m,["tokenAccount"]);u=p,l.addInstruction(f)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:i}),!u&&a){let d=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=d,f=Ee(d,["tokenAccount"]);u=p,l.addInstruction(f)}return v({tokenAccount:u},l.AllTxData)}};import{PublicKey as Ie,SystemProgram as Ed}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Vd}from"@solana/spl-token";import{PublicKey as Iu}from"@solana/web3.js";var Ss=E([G("instruction")]),xs=E([G("instruction")]),kd=E([P("rewardState"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardLastUpdateTime"),P("totalReward"),P("totalRewardEmissioned"),P("rewardClaimed"),P("rewardPerSecond"),ee("accRewardPerShare"),N("rewardVault"),N("rewardMint"),N("rewardSender"),P("rewardType"),Q(P(),15,"padding")]),hd=E([P("state"),P("nonce"),N("lpVault"),N("rewardVault"),N(),N(),P(),P(),P("totalReward"),ee("perShareReward"),P("lastSlot"),P("perSlotReward")]),Td=E([P("state"),P("nonce"),N("lpVault"),N("rewardVaultA"),P("totalRewardA"),ee("perShareRewardA"),P("perSlotRewardA"),G("option"),N("rewardVaultB"),ke(7),P("totalRewardB"),ee("perShareRewardB"),P("perSlotRewardB"),P("lastSlot"),N()]),Id=E([P(),P("state"),P("nonce"),P("validRewardTokenNum"),ee("rewardMultiplier"),P("rewardPeriodMax"),P("rewardPeriodMin"),P("rewardPeriodExtend"),N("lpMint"),N("lpVault"),Q(kd,5,"rewardInfos"),N("creator"),N(),Q(P(),32,"padding")]),Bd=new Proxy(hd,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return q(v({},i),{version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]})}:Reflect.get(r,e,t)}}),Sd=new Proxy(Td,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return q(v({},i),{version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]})}:Reflect.get(r,e,t)}}),sr=new Proxy(Id,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return q(v({},i),{version:6,rewardInfos:i.rewardInfos.map(o=>{var s;return q(v({},o),{rewardType:((s=Object.entries(Sn).find(a=>String(a[1])===o.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(r,e,t)}}),xd=E([P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),Ks=E([G("instruction"),P("nonce"),Q(xd,5,"rewardTimeInfo")]),Cs=E([G("instruction"),P("rewardReopenTime"),P("rewardEndTime"),P("rewardPerSecond")]),Ls=E([G("instruction"),P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),HP=E([P("state"),N("id"),N("owner"),P("deposited"),Q(P(),1,"rewardDebts")]),Rs=E([P("state"),N("id"),N("owner"),P("deposited"),Q(ee(),1,"rewardDebts"),P(""),P("voteLockedBalance"),Q(P(),15)]),YP=E([P("state"),N("id"),N("owner"),P("deposited"),Q(P(),2,"rewardDebts")]),hu=E([P("state"),N("id"),N("owner"),P("deposited"),Q(ee(),2,"rewardDebts"),Q(P(),17)]),Tu=E([P(),P("state"),N("id"),N("owner"),P("deposited"),Q(ee(),5,"rewardDebts"),Q(P(),16)]),It=E([G("instruction"),P("amount")]),Kd=E([N("mint"),N("grantAuthority"),P("baselineVoteWeightScaledFactor"),P("maxExtraLockupVoteWeightScaledFactor"),P("lockupSaturationSecs"),gu("digitShift"),Q(G(),7,"reserved1"),Q(P(),7,"reserved2")]),Cd=E([ke(8),N("governanceProgramId"),N("realm"),N("realmGoverningTokenMint"),N("realmAuthority"),Q(G(),32,"reserved1"),Q(Kd,4,"votingMints"),ri("timeOffset"),G("bump"),Q(G(),7,"reserved2"),Q(P(),11,"reserved3")]),Ld=E([ri("startTime"),ri("endTime"),G("kind"),Q(G(),15,"reserved")]),Rd=E([Q(Ld,1,"lockup"),P("amountDeposited_native"),P("amountInitiallyLockedNative"),Ve("isUsed"),Ve("allowClawback"),G("votingMintConfigIdx"),Q(G(),29,"reserved")]),Nd=E([ke(8),N("voterAuthority"),N("registrar"),Q(Rd,32,"deposits"),G("voterBump"),G("voterWweightRecordBump"),Q(G(),94,"reserved")]);var ow=fe("Raydium_farm_config"),Bu=new Iu("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Su=new Iu("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1");var xu={3:Rs,5:hu,6:Tu},Ns=r=>[3,4,5,6].indexOf(r)!==-1,Os=r=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=r,i=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,o={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${i}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${i}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${i}`}};return(s=o[e])==null?void 0:s.call(o)},Sn={"Standard SPL":0,"Option tokens":1},Kt={[ja.toString()]:3,[Ha.toString()]:4,[Ya.toString()]:5,[Ii.toString()]:6};import{PublicKey as pe,SystemProgram as Lu,SYSVAR_CLOCK_PUBKEY as vi,SYSVAR_RENT_PUBKEY as Md,TransactionInstruction as Lt}from"@solana/web3.js";import Ru from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as _w,createAssociatedTokenAccountInstruction as Ew,TOKEN_PROGRAM_ID as sn}from"@solana/spl-token";import Od from"bn.js";var vd=fe("Raydium.farm.util");function Ni({programId:r,poolId:e,mint:t,type:n}){let{publicKey:i}=le([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],r);return i}function Ct({programId:r,poolId:e,owner:t,version:n}){let{publicKey:i}=le([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],r);return i}var Ku=({programId:r,poolId:e})=>le([e.toBuffer()],r);function Cu(r){return{isSet:new Od(1),rewardPerSecond:$(r.perSecond),rewardOpenTime:$(r.openTime),rewardEndTime:$(r.endTime),rewardType:$(Sn[r.rewardType])}}function vs(r){return $(r.endTime).sub($(r.openTime)).mul($(r.perSecond))}function Oi(r){let e=xu[r];return e||vd.logWithError("invalid version",r),e}var _d=fe("Raydium_farm_instruction"),jw={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function Mi(r){let{version:e,id:t,ledger:n,programId:i,owner:o}=r,s={3:9,5:10}[e];s||_d.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Ss.span);Ss.encode({instruction:s},a);let c=[B({pubkey:t}),B({pubkey:n}),B({pubkey:o,isWritable:!1}),B({pubkey:Lu.programId,isWritable:!1}),B({pubkey:Md,isWritable:!1})];return{instruction:new Lt({programId:i,keys:c,data:a}),instructionType:U.FarmV3CreateLedger}}function Nu(r){var n;let e=Buffer.alloc(Ks.span);Ks.encode({instruction:0,nonce:new Ru(r.nonce),rewardTimeInfo:r.rewardInfoConfig},e);let t=[...ts,B({pubkey:r.farmId}),B({pubkey:r.farmAuthority,isWritable:!1}),B({pubkey:r.lpVault}),B({pubkey:r.lpMint,isWritable:!1}),B({pubkey:r.lockVault}),B({pubkey:r.lockMint,isWritable:!1}),B({pubkey:(n=r.lockUserAccount)!=null?n:$e}),B({pubkey:r.owner,isWritable:!1,isSigner:!0})];for(let i of r.rewardInfo)t.push(B({pubkey:i.rewardMint,isWritable:!1}),B({pubkey:i.rewardVault}),B({pubkey:i.userRewardToken}));return{instruction:new Lt({programId:r.programId,keys:t,data:e}),instructionType:U.FarmV6Create}}function Ou(r){let e=Buffer.alloc(xs.span);xs.encode({instruction:5},e);let t=[B({pubkey:sn,isWritable:!1}),B({pubkey:r.id}),B({pubkey:r.authority,isWritable:!1}),B({pubkey:r.lpVault,isWritable:!1}),B({pubkey:r.rewardVault}),B({pubkey:r.userRewardToken}),B({pubkey:r.owner,isWritable:!1,isSigner:!0})];return{instruction:new Lt({programId:r.programId,keys:t,data:e}),instructionType:U.FarmV6CreatorWithdraw}}function Ms({payer:r,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:i}){let o=Buffer.alloc(Cs.span);Cs.encode({instruction:3,rewardReopenTime:$(i.openTime),rewardEndTime:$(i.endTime),rewardPerSecond:$(i.perSecond)},o);let s=[B({pubkey:sn,isWritable:!1}),B({pubkey:n.id}),B({pubkey:n.lpVault,isWritable:!1}),B({pubkey:e}),B({pubkey:t}),B({pubkey:r,isWritable:!1,isSigner:!0})];return new Lt({programId:n.programId,keys:s,data:o})}function _s({payer:r,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:i}){let o=Buffer.alloc(Ls.span);Ls.encode({instruction:4,isSet:new Ru(1),rewardPerSecond:$(i.perSecond),rewardOpenTime:$(i.openTime),rewardEndTime:$(i.endTime),rewardType:$(Sn[i.rewardType])},o);let s=[...ts,B({pubkey:t.id}),B({pubkey:t.authority,isWritable:!1}),B({pubkey:i.mint,isWritable:!1}),B({pubkey:n}),B({pubkey:e}),B({pubkey:r,isWritable:!1,isSigner:!0})];return new Lt({programId:t.programId,keys:s,data:o})}function _i(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s}=r,[a,c]=[new pe(e.programId),new pe(e.id)],u=Ct({programId:a,poolId:c,owner:o,version:6}),l=Buffer.alloc(It.span);It.encode({instruction:2,amount:$(s)},l);let m=[B({pubkey:sn,isWritable:!1}),B({pubkey:c}),B({pubkey:new pe(t.authority),isWritable:!1}),B({pubkey:new pe(t.lpVault)}),B({pubkey:u}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(B({pubkey:new pe(t.rewardInfos[d].vault)})),m.push(B({pubkey:i[d]}));return new Lt({programId:a,keys:m,data:l})}function Ei(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new pe(e.programId),new pe(e.id)],l=Ct({programId:c,poolId:u,owner:o,version:5}),m=Buffer.alloc(It.span);It.encode({instruction:12,amount:$(s)},m);let d=[B({pubkey:u}),B({pubkey:new pe(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new pe(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new pe(t.rewardInfos[0].vault)}),B({pubkey:vi,isWritable:!1}),B({pubkey:sn,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(B({pubkey:i[p]})),d.push(B({pubkey:new pe(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(B({pubkey:p}));return new Lt({programId:c,keys:d,data:m})}function vu(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new pe(e.programId),new pe(e.id)],l=E([G("instruction"),P("amount")]),m=[B({pubkey:u}),B({pubkey:new pe(t.authority),isWritable:!1}),B({pubkey:a[0]}),B({pubkey:o,isSigner:!0,isWritable:!1}),B({pubkey:n}),B({pubkey:new pe(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new pe(t.rewardInfos[0].vault)}),B({pubkey:vi,isWritable:!1}),B({pubkey:sn,isWritable:!1}),B({pubkey:i[1]}),B({pubkey:new pe(t.rewardInfos[1].vault)})],d=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},d),new Lt({keys:m,programId:c,data:d})}function Vi(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new pe(e.programId),new pe(e.id)],l=Ct({programId:c,poolId:u,owner:o,version:3}),m=Buffer.alloc(It.span);It.encode({instruction:11,amount:$(s)},m);let d=[B({pubkey:u}),B({pubkey:new pe(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new pe(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new pe(t.rewardInfos[0].vault)}),B({pubkey:vi,isWritable:!1}),B({pubkey:sn,isWritable:!1})];if(a)for(let p of a)d.push(B({pubkey:p}));return new Lt({programId:c,keys:d,data:m})}function Mu(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new pe(e.programId),new pe(e.id)],l=Ct({programId:c,poolId:u,owner:o,version:3}),m=Buffer.alloc(It.span);It.encode({instruction:10,amount:$(s)},m);let d=[B({pubkey:u}),B({pubkey:new pe(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new pe(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new pe(t.rewardInfos[0].vault)}),B({pubkey:vi,isWritable:!1}),B({pubkey:sn,isWritable:!1})];if(a)for(let p of a)d.push(B({pubkey:p}));return new Lt({programId:c,keys:d,data:m})}function _u(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new pe(e.programId),new pe(e.id)],l=Ct({programId:c,poolId:u,owner:o,version:5}),m=Buffer.alloc(It.span);It.encode({instruction:11,amount:$(s)},m);let d=[B({pubkey:u}),B({pubkey:new pe(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new pe(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new pe(t.rewardInfos[0].vault)}),B({pubkey:vi,isWritable:!1}),B({pubkey:sn,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(B({pubkey:i[p]})),d.push(B({pubkey:new pe(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(B({pubkey:p}));return new Lt({programId:c,keys:d,data:m})}function Eu(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s}=r,[a,c]=[new pe(e.programId),new pe(e.id)],u=Ct({programId:a,poolId:c,owner:o,version:6}),l=Buffer.alloc(It.span);It.encode({instruction:1,amount:$(s)},l);let m=[B({pubkey:sn,isWritable:!1}),B({pubkey:Lu.programId,isWritable:!1}),B({pubkey:c}),B({pubkey:new pe(t.authority),isWritable:!1}),B({pubkey:new pe(t.lpVault)}),B({pubkey:u}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(B({pubkey:new pe(t.rewardInfos[d].vault)})),m.push(B({pubkey:i[d]}));return new Lt({programId:a,keys:m,data:l})}var Fi=class extends Le{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals($e)){let n=await In({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:vs(q(v({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:i=Ii,txVersion:o,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new Ie(e.lpMint.address),lockInfo:{lockMint:Bu,lockVault:Su},version:6,rewardInfos:t,programId:i},u=this.createTxBuilder(s),l=n!=null?n:this.scope.ownerPubKey,m=qe({fromPublicKey:l,programId:c.programId}),d=await this.scope.connection.getMinimumBalanceForRentExemption(sr.span);u.addInstruction({instructions:[Ed.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:m.seed,newAccountPubkey:m.publicKey,lamports:d,space:sr.span,programId:c.programId})]});let{publicKey:p,nonce:f}=Ku({programId:new Ie(c.programId),poolId:m.publicKey}),b=Ni({programId:c.programId,poolId:m.publicKey,mint:c.lpMint,type:"lpVault"}),y=[],g=[];for(let k of c.rewardInfos){k.openTime>=k.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",k.openTime.toString()),isNaN(Sn[k.rewardType])&&this.logAndCreateError("rewardType error",k.rewardType),Number(k.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",k.perSecond),y.push(Cu(k));let{rewardPubKey:x,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:k,payer:l});S&&u.addInstruction(S),x||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let K=k.mint.equals($e)?new Ie(ct.address):k.mint;g.push({rewardMint:K,rewardVault:Ni({programId:c.programId,poolId:m.publicKey,mint:K,type:"rewardVault"}),userRewardToken:x})}let{account:A,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({mint:new Ie(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});w&&u.addInstruction(w),A||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:h,instructionType:T}=Nu({farmId:m.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:b,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:A,programId:c.programId,rewardInfo:g,rewardInfoConfig:y,nonce:f});return u.addInstruction({instructions:[h],instructionTypes:[T]}).versionBuild({txVersion:o,extInfo:{farmId:m.publicKey,farmAuthority:p,lpVault:b,lockUserAccount:A,nonce:f}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:i,feePayer:o}){var g;let s=Kt[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=ot((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals($e)?new Ie(ct.address):n.mint,m=c.rewardInfos.findIndex(A=>new Ie(A.mint.address).equals(l)),d=a.rewardInfos[m];d||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=(g=d.vault)!=null?g:$e,f=this.createTxBuilder(o),{rewardPubKey:b,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return y&&f.addInstruction(y),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),f.addInstruction({instructions:[Ms({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:b,farmKeys:c,rewardInfo:n})],instructionTypes:[U.FarmV6Restart]}).versionBuild({txVersion:i})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:i,feePayer:o}){var m;let s=Kt[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=ot((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(o);for(let d of n){let p=d.mint.equals($e)?new Ie(ct.address):d.mint,f=c.rewardInfos.findIndex(h=>new Ie(h.mint.address).equals(p)),b=a.rewardInfos[f];b||this.logAndCreateError("configuration does not exist","rewardMint",p);let y=(m=b.vault)!=null?m:$e,{rewardPubKey:g,newInstruction:A}=await this._getUserRewardInfo({rewardInfo:d,payer:u});A&&l.addInstruction(A),g||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let w=Ms({payer:this.scope.ownerPubKey,rewardVault:y,userRewardTokenPub:g,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[w],instructionTypes:[U.FarmV6Restart]})}return l.versionBuild({txVersion:i})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:i,payer:o,feePayer:s}=e,a=Kt[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=ot((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,l=this.createTxBuilder(s),m=i.mint.equals($e)?new Ie(ct.address):i.mint,d=Ni({programId:new Ie(n.programId),poolId:new Ie(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:i,payer:u});return f&&l.addInstruction(f),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),i.mint=m,l.addInstruction({instructions:[_s({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:d,rewardInfo:i})],instructionTypes:[U.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:i,payer:o,feePayer:s}=e,a=Kt[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=ot((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let m of i){let d=m.mint.equals($e)?new Ie(ct.address):m.mint,p=Ni({programId:new Ie(n.programId),poolId:new Ie(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:f,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:m,payer:u});b&&l.addInstruction(b),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let y=_s({payer:this.scope.ownerPubKey,userRewardTokenPub:f,farmKeys:c,rewardVault:p,rewardInfo:q(v({},m),{mint:d})});l.addInstruction({instructions:[y],instructionTypes:[U.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:i,feePayer:o,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:m}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:d,programId:p}=n,f=Kt[p];f===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),Ns(f)||this.logAndCreateError("invalid farm program:",n.programId);let[b,y]=[new Ie(n.programId),new Ie(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],A=Ct({programId:b,poolId:y,owner:this.scope.ownerPubKey,version:f}),w=this.createTxBuilder(o);w.addCustomComputeBudget(l),w.addTipInstruction(m);let h={};for(let _ of this.scope.account.tokenAccounts)if(a){let M=ie(this.scope.ownerPubKey,_.mint,_.programId).publicKey;_.publicKey&&M.equals(_.publicKey)&&(h[_.mint.toString()]=_.publicKey)}else h[_.mint.toString()]=_.publicKey;let T=g.lpMint,k=h[T.address];k||this.logAndCreateError("you don't have any lp","lp zero",h);let x=[];for(let _ of d){let M=s&&_.mint.address===Z.toString(),V=h[_.mint.address];if(!V){let{account:H,instructionParams:re}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:_.mint.programId,mint:new Ie(_.mint.address),notUseTokenAccount:M,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!M,associatedOnly:M?!1:a,checkCreateATAOwner:c});V=H,re&&w.addInstruction(re)}h[_.mint.address]=V,x.push(V)}let S,K=await this.scope.connection.getAccountInfo(A);if(K&&(S=Oi(f).decode(K.data)),n.programId!==Ii.toString()&&!S){let{instruction:_,instructionType:M}=Mi({id:y,programId:b,version:f,ledger:A,owner:this.scope.ownerPubKey});w.addInstruction({instructions:[_],instructionTypes:[M]})}let I=Os({version:f,rewardInfos:d,rewardTokenAccountsPublicKeys:x});I&&this.logAndCreateError(I);let C={amount:$(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:k,rewardAccounts:x,userAuxiliaryLedgers:u==null?void 0:u.map(_=>new Ie(_))},L=f===6?Eu(C):f===5?_u(C):Mu(C),R={3:U.FarmV3Deposit,5:U.FarmV5Deposit,6:U.FarmV6Deposit};return w.addInstruction({instructions:[L],instructionTypes:[R[f]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:i,deposited:o,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m,txTipConfig:d}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let f=Kt[n.programId];Ns(f)||this.logAndCreateError("invalid farm program:",n.programId);let b=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],y=this.createTxBuilder(a);y.addCustomComputeBudget(m),y.addTipInstruction(d);let g={};for(let I of this.scope.account.tokenAccounts)if(c){let C=ie(this.scope.ownerPubKey,I.mint).publicKey;I.publicKey&&C.equals(I.publicKey)&&(g[I.mint.toString()]=I.publicKey)}else g[I.mint.toString()]=I.publicKey;if(f!==4){let I=Ct({programId:new Ie(n.programId),poolId:new Ie(n.id),owner:this.scope.ownerPubKey,version:f}),C=await this.scope.connection.getAccountInfo(I);if(C)Oi(f).decode(C.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(f!==6){let{instruction:L,instructionType:R}=Mi({id:new Ie(b.id),programId:new Ie(b.programId),version:f,ledger:I,owner:this.scope.ownerPubKey});y.addInstruction({instructions:[L],instructionTypes:[R]})}}o&&o.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let A=b.lpMint.address,w=s&&A===Z.toString(),h=g[A.toString()];if(!h){let{account:I,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.lpMint.programId,mint:new Ie(A),notUseTokenAccount:w,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:w?!1:c,checkCreateATAOwner:u});h=I,C&&y.addInstruction(C)}g[A.toString()]=h;let T=[];for(let I of p){let C=s&&I.mint.address===Z.toString(),L=g[I.mint.address];if(!L){let{account:R,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:I.mint.programId,mint:new Ie(I.mint.address),notUseTokenAccount:C,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!C,associatedOnly:C?!1:c,checkCreateATAOwner:u});L=R,_&&y.addInstruction(_)}g[I.mint.address]=L,T.push(L)}let k=Os({version:f,rewardInfos:p,rewardTokenAccountsPublicKeys:T});k&&this.logAndCreateError(k);let x={amount:$(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:b,lpAccount:h,rewardAccounts:T,userAuxiliaryLedgers:l==null?void 0:l.map(I=>new Ie(I))},S=f===6?_i(x):f===5?Ei(x):f===4?vu(x):Vi(x),K={3:U.FarmV3Withdraw,4:U.FarmV4Withdraw,5:U.FarmV5Withdraw,6:U.FarmV6Withdraw};return y.addInstruction({instructions:[S],instructionTypes:[K[f]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:i,txTipConfig:o,feePayer:s}){var b;this.scope.checkOwner();let a=ot((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=Kt[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(y=>at(y.mint.address).equals(at(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=(b=u==null?void 0:u.vault)!=null?b:$e,m=this.createTxBuilder(s),d;if(t.equals($e)||t.equals(Ie.default)){let y=await In({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:vs(q(v({},u),{openTime:u.openTime,endTime:u.endTime,perSecond:new O(u.perSecond).mul(10**u.mint.decimals).toString()}))});d=y.addresses.newAccount,m.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(d=await this.scope.account.getAssociatedTokenAccount(t),m.addInstruction({instructions:[Vd(this.scope.ownerPubKey,d,this.scope.ownerPubKey,t)],instructionTypes:[U.CreateATA]})):d=y}let{instruction:p,instructionType:f}=Ou({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:d,owner:this.scope.ownerPubKey});return m.addCustomComputeBudget(i),m.addTipInstruction(o),m.addInstruction({instructions:[p],instructionTypes:[f]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(i),m={};for(let f of this.scope.account.tokenAccounts)if(o){let b=ie(this.scope.ownerPubKey,f.mint).publicKey;f.publicKey&&b.equals(f.publicKey)&&(m[f.mint.toString()]=f.publicKey)}else m[f.mint.toString()]=f.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(f=>f.id).join(",")})).reduce((f,b)=>q(v({},f),{[b.id]:b}),{});for(let f of Object.values(t)){let{programId:b,lpMint:y,rewardInfos:g,id:A}=f,w=Kt[b],h=y.address,T=n&&h===Z.toString(),k=m[h];if(!k){let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.programId,mint:new Ie(h),notUseTokenAccount:T,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:T?!1:o,checkCreateATAOwner:s});k=L,R&&l.addInstruction(R)}m[h.toString()]=k;let x=[];for(let L of g){let R=n&&L.mint.address===Z.toString(),_=m[L.mint.address];if(!_){let{account:M,instructionParams:V}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:L.mint.programId,mint:new Ie(L.mint.address),notUseTokenAccount:R,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!R,associatedOnly:R?!1:o,checkCreateATAOwner:s});_=M,V&&l.addInstruction(V)}m[L.mint.address]=_,x.push(_)}let S=p[A],K={amount:wt,owner:this.scope.ownerPubKey,farmInfo:f,farmKeys:S,lpAccount:k,rewardAccounts:x,userAuxiliaryLedgers:a==null?void 0:a.map(L=>new Ie(L))},I=w===6?_i(K):w===5?Ei(K):Vi(K),C={3:U.FarmV3Withdraw,5:U.FarmV5Withdraw,6:U.FarmV6Withdraw};l.addInstruction({instructions:[I],instructionTypes:[C[w]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as Qe}from"@solana/web3.js";import{AccountLayout as Kp,NATIVE_MINT as Pr,TOKEN_PROGRAM_ID as Kn}from"@solana/spl-token";import{Keypair as dr,PublicKey as X,SystemProgram as ln,TransactionInstruction as rt}from"@solana/web3.js";import Xs from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Hi,TOKEN_2022_PROGRAM_ID as Fe,TOKEN_PROGRAM_ID as Be}from"@solana/spl-token";import Yd from"bn.js";import Rt from"bn.js";var _e=new Rt(0),Bt=new Rt(1),an=new Rt(-1),ze=new Rt(1).shln(64),ar=new Rt(1).shln(128),Di=ze.sub(Bt),Wi=64,Vu=ar.subn(1),mt=-443636,yt=-mt,Nt=new Rt("4295048016"),Ot=new Rt("79226673521066979257578248091"),ur=new Rt("4295048017"),cr=new Rt("79226673521066979257578248090"),Fu=16,Du="59543866431248",Wu="184467440737095516",qu="15793534762490258745",lr=new Rt(10).pow(new Rt(6));var Uu={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},Bk=new Rt("18446744073700000000");import de from"bn.js";function mr(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function Es(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function Vs(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function qi(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function Gu(r,e){return qi(r,e)?null:Es(r,e)}function Xu(r,e){return qi(r,e)?null:Vs(r,e)}var Lk=Buffer.from("amm_config","utf8"),Dd=Buffer.from("pool","utf8"),Wd=Buffer.from("pool_vault","utf8"),qd=Buffer.from("pool_reward_vault","utf8"),Qu=Buffer.from("position","utf8"),Ud=Buffer.from("tick_array","utf8"),Gd=Buffer.from("operation","utf8"),Xd=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Qd=Buffer.from("observation","utf8");function zu(r,e,t,n){return le([Dd,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Fs(r,e,t){return le([Wd,e.toBuffer(),t.toBuffer()],r)}function ju(r,e,t){return le([qd,e.toBuffer(),t.toBuffer()],r)}function ye(r,e,t){return le([Ud,e.toBuffer(),mr(t)],r)}function Qt(r,e,t,n){return le([Qu,e.toBuffer(),mr(t),mr(n)],r)}function gt(r,e){return le([Qu,e.toBuffer()],r)}function un(r){return le([Buffer.from("metadata","utf8"),Dt.toBuffer(),r.toBuffer()],Dt)}function Ui(r){return le([Gd],r)}function Ue(r,e){return le([Xd,e.toBuffer()],r)}function Hu(r,e){return le([Qd,e.toBuffer()],r)}var Yu=Buffer.from("locked_position","utf8");function Ds(r,e){return le([Yu,e.toBuffer()],r)}function Gi(r,e){return le([Yu,e.toBuffer()],r)}var zd=Buffer.from("support_mint","utf8");function Ws(r,e){return le([zd,e.toBuffer()],r)}import{PublicKey as St}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Zu}from"@solana/spl-token";import Ne from"bn.js";import $t from"bn.js";var Xi=class{static getfeeGrowthInside(e,t,n){let i=new $t(0),o=new $t(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new $t(0),a=new $t(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=se.wrappingSubU128(se.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),u=se.wrappingSubU128(se.wrappingSubU128(e.feeGrowthGlobalX64B,o),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=se.mulDivFloor(se.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,ze),c=t.tokenFeesOwedA.add(a),u=se.mulDivFloor(se.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,ze),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=se.mulDivFloor(se.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,ze),c=t.tokenFeesOwedA.add(a),u=se.mulDivFloor(se.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,ze),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let o=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=se.wrappingSubU128(c,u.growthInsideLastX64),m=se.mulDivFloor(l,t.liquidity,ze),d=u.rewardAmountOwed.add(m);o.push(d)}return o}static GetPositionRewards(e,t,n,i){let o=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=se.wrappingSubU128(c,u.growthInsideLastX64),m=se.mulDivFloor(l,t.liquidity,ze),d=u.rewardAmountOwed.add(m);o.push(d)}return o}static getRewardGrowthInside(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new $t(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new $t(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(se.wrappingSubU128(se.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return o}static getRewardGrowthInsideV2(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new $t(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new $t(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(se.wrappingSubU128(se.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:o,epochInfo:s}){var y,g,A,w;let a=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),c=oe.getSqrtPriceX64FromTick(t.tickLower),u=oe.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+i:1-i,m=Pe.getAmountsFromLiquidity(a,c,u,n,o),[d,p]=[Te(m.amountA,(y=e.mintA.extensions)==null?void 0:y.feeConfig,s,!0),Te(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[f,b]=[Te(new $t(new O(m.amountA.toString()).mul(l).toFixed(0)),(A=e.mintA.extensions)==null?void 0:A.feeConfig,s,!0),Te(new $t(new O(m.amountB.toString()).mul(l).toFixed(0)),(w=e.mintB.extensions)==null?void 0:w.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:b,expirationTime:qt(d.expirationTime,p.expirationTime)}}};var jd=15,Ae=class{static async getTickArrays(e,t,n,i,o,s,a){let c=[],u=Y.getTickArrayStartIndexByTick(i,o),l=Y.getInitializedTickArrayInRange(s,a,o,u,Math.floor(jd/2));for(let p=0;p<l.length;p++){let{publicKey:f}=ye(t,n,l[p]);c.push(f)}let m=(await Et(e,c)).map(p=>p!==null?Qi.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let f=m[p];f!==null&&(d[f.startTickIndex]=q(v({},f),{address:c[p]}))}return d}static nextInitializedTick(e,t,n,i,o,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,i,o,s);for(;a==null||a.liquidityGross.lten(0);){if(u=Y.getNextTickArrayStartIndex(u,o,s),this.checkIsValidStartIndex(u,o))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,i,o){let s=Math.floor(e/Ae.tickCount(t)),a=n?Y.searchLowBitFromStart(i,o,s-1,1,t):Y.searchHightBitFromStart(i,o,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let o;if(i){let a=Ze-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){o=c;break}a=a-1}}else{let a=0;for(;a<Ze;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){o=c;break}a=a+1}}let{publicKey:s}=ye(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,o,s){let a=Y.getTickArrayStartIndexByTick(i,o),c=Math.floor((i-a)/o),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<Ze;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=ye(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(Y.checkIsOutOfBoundary(e)){if(e>yt)return!1;let n=Y.getTickArrayStartIndexByTick(mt,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Ze*e}};var qs=14,cn=class{static maxTickInTickarrayBitmap(e){return e*Ze*_n}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let o=n*i;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!Ae.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),s=i?t-Ae.tickCount(n):t+Ae.tickCount(n);if(s<-o||s>=o)return{isInit:!1,tickIndex:t};let a=n*Ze,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(i){let l=e.shln(1024-u-1),m=Gu(1024,l);if(m!==null){let d=(u-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(u),m=Xu(1024,l);if(m!==null){let d=(u+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:o-Ae.tickCount(n)}}}},zi=class{static getBitmapOffset(e,t){if(!Ae.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=cn.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=cn.maxTickInTickarrayBitmap(e),n=-t;if(yt<=t)throw Error(`extensionTickBoundary check error: ${yt}, ${t}`);if(n<=mt)throw Error(`extensionTickBoundary check error: ${n}, ${mt}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:Y.mergeTickArrayBitmap(i).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let o=Ae.tickCount(t),s=n?e-o:e+o,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:o,maxValue:s}=cn.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let c=Y.mergeTickArrayBitmap(e).shln(_n-1-a),u=qi(512,c)?null:Es(512,c);if(u!==null){let l=t-u*Ae.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let c=Y.mergeTickArrayBitmap(e).shrn(a),u=qi(512,c)?null:Vs(512,c);if(u!==null){let l=t+u*Ae.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-Ae.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%cn.maxTickInTickarrayBitmap(t),i=Math.floor(n/Ae.tickCount(t));return e<0&&n!=0&&(i=_n-i),i}};var Ce=class{static getOutputAmountAndRemainAccounts(e,t,n,i,o,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:f,sqrtPriceX64:b,feeAmount:y}=En.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,l,o,s);return c.push(...f),{allTrade:d,expectedAmountOut:p.mul(an),remainingAccounts:c,executionPrice:b,feeAmount:y}}static getInputAmountAndRemainAccounts(e,t,n,i,o){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let b=this.preInitializedTickArrayStartIndex(e,s);if(b.isExist){let{publicKey:y}=ye(e.programId,e.id,b.nextStartIndex);a.push(y)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:f}=En.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(an),u,o);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:f}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Ce.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?zi.checkTickArrayIsInit(Ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):Y.checkTickArrayIsInitialized(Y.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=ye(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:o,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,Ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:a}=ye(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/Ae.tickCount(e.tickSpacing)),i=t?Y.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):Y.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=Ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:o}=cn.nextInitializedTickArrayStartIndex(Y.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:s,tickIndex:a}=zi.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<mt||t>yt)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:o}){var a,c,u;let s=[];for(let l=0;l<o.length;l++){let m=o[l],d=(u=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?u:(c=await e.getAccountInfo(m.tokenMint))==null?void 0:c.owner;if(d===void 0)throw Error("get new reward mint info error");let p=q(v({},m),{perSecond:se.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new St(d)});if(p.tokenMint.equals(St.default))continue;if(n<=p.openTime.toNumber()||i.eq(_e)){s.push(p);continue}let f=new Ne(Math.min(p.endTime.toNumber(),n)),b=f.sub(p.lastUpdateTime),y=se.mulDivFloor(b,p.emissionsPerSecondX64,i),g=p.rewardGrowthGlobalX64.add(y),A=se.mulDivFloor(b,p.emissionsPerSecondX64,ze),w=p.rewardTotalEmissioned.add(A);s.push(q(v({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:w,lastUpdateTime:f}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let o of t){let s=Y.getTickArrayStartIndexByTick(o,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=cn.maxTickInTickarrayBitmap(e),n=-t;return t>yt&&(t=Ae.getArrayStartIndex(yt,e)+Ae.tickCount(e)),n<mt&&(n=Ae.getArrayStartIndex(mt,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!Ae.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/Ae.tickCount(t)*_n}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Oe(e,t.map(s=>({pubkey:s})),{batchRequest:n}),o={};for(let s of i)s.accountInfo!==null&&(o[s.pubkey.toString()]=Ju.decode(s.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},o=[];for(let c of t){let u=Y.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=Y.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=ye(c.programId,c.id,m);o.push({pubkey:d}),i[d.toString()]=c.id}}let s=await Oe(e,o,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=i[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=Qi.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]=q(v({},l),{address:c.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:o=!0}){var a;let s=[];for(let c=0;c<e.length;c++){let u=e[c];u!==null&&(s.find(l=>l.equals(u.state.programId))||s.push(u.state.programId))}if(n){let c=n.tokenAccounts.map(d=>d.accountInfo.mint),u=[];for(let d of c)for(let p of s)u.push(gt(p,d).publicKey);let l=await Et(t,u,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let p=ji.decode(d.data),f=p.poolId.toString(),b=e.find(S=>S.state.id.toBase58()===f);if(b===void 0)continue;let y=b.state,g=Y._getTickPriceLegacy({poolInfo:y,tick:p.tickLower,baseIn:!0}),A=Y._getTickPriceLegacy({poolInfo:y,tick:p.tickUpper,baseIn:!0}),{amountA:w,amountB:h}=Pe.getAmountsFromLiquidity(y.sqrtPriceX64,g.tickSqrtPriceX64,A.tickSqrtPriceX64,p.liquidity,!1),T=1/(1-Math.sqrt(Math.sqrt(g.price.div(A.price).toNumber())));b.positionAccount=[...(a=b.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:A.price,amountA:w,amountB:h,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(S=>q(v({},S),{pendingReward:new Ne(0)})),leverage:T,tokenFeeAmountA:new Ne(0),tokenFeeAmountB:new Ne(0)}];let k=await Y.getTickArrayAddressByTick(b.state.programId,p.poolId,p.tickLower,b.state.tickSpacing),x=await Y.getTickArrayAddressByTick(b.state.programId,p.poolId,p.tickUpper,b.state.tickSpacing);m[`${b.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=k,m[`${b.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=x}if(o){let d=Object.values(m),p=await Et(t,d,{batchRequest:i}),f={};for(let b=0;b<d.length;b++){let y=p[b];if(y===null)continue;let g=d[b].toString();f[g]=Qi.decode(y.data)}for(let{state:b,positionAccount:y}of e)if(!!y)for(let g of y){let A=`${b.programId.toString()}-${b.id.toString()}-${g.tickLower}`,w=`${b.programId.toString()}-${b.id.toString()}-${g.tickUpper}`,h=f[m[A].toString()],T=f[m[w].toString()],k=h.ticks[Y.getTickOffsetInArray(g.tickLower,b.tickSpacing)],x=T.ticks[Y.getTickOffsetInArray(g.tickUpper,b.tickSpacing)],{tokenFeeAmountA:S,tokenFeeAmountB:K}=await Xi.GetPositionFees(b,g,k,x),I=await Xi.GetPositionRewards(b,g,k,x);g.tokenFeeAmountA=S.gte(new Ne(0))?S:new Ne(0),g.tokenFeeAmountB=K.gte(new Ne(0))?K:new Ne(0);for(let C=0;C<I.length;C++)g.rewardInfos[C].pendingReward=I[C].gte(new Ne(0))?I[C]:new Ne(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:o,slippage:s,priceLimit:a=new O(0),catchLiquidityInsufficient:c=!1}){var L;let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new O(0))?u=l?Nt.add(new Ne(1)):Ot.sub(new Ne(1)):u=oe.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=Te(o,m,i,!1),{allTrade:f,expectedAmountOut:b,remainingAccounts:y,executionPrice:g,feeAmount:A}=Ce.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((L=p.fee)!=null?L:_e),u,c),w=Te(b,d,i,!1),h=oe.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),T=l?h:new O(1).div(h),k=b.mul(new Ne(Math.floor((1-s)*1e10))).div(new Ne(1e10)),x=Te(k,d,i,!1),S=l?e.currentPrice:new O(1).div(e.currentPrice),K=new O(T).sub(S).abs(),I=S,C=new Je(new O(K).mul(10**15).toFixed(0),new O(I).mul(10**15).toFixed(0));return{allTrade:f,realAmountIn:p,amountOut:w,minAmountOut:x,expirationTime:qt(p.expirationTime,w.expirationTime),currentPrice:e.currentPrice,executionPrice:T,priceImpact:C,fee:A,remainingAccounts:y,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:o,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=i.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Me(q(v({},u),{mint:u.address,isToken2022:u.programId===Zu.toBase58()})),new Me(q(v({},l),{mint:l.address,isToken2022:l.programId===Zu.toBase58()}))],{allTrade:p,realAmountIn:f,amountOut:b,minAmountOut:y,expirationTime:g,currentPrice:A,executionPrice:w,priceImpact:h,fee:T,remainingAccounts:k,executionPriceX64:x}=Ce.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new St(u.address),amountIn:n,slippage:o,epochInfo:s,catchLiquidityInsufficient:a}),S=q(v({},f),{amount:new he(m,f.amount),fee:f.fee===void 0?void 0:new he(m,f.fee)}),K=q(v({},b),{amount:new he(d,b.amount),fee:b.fee===void 0?void 0:new he(d,b.fee)}),I=q(v({},y),{amount:new he(d,y.amount),fee:y.fee===void 0?void 0:new he(d,y.fee)}),C=new Pt({baseToken:m,denominator:new Ne(10).pow(new Ne(20+m.decimals)),quoteToken:d,numerator:A.mul(new O(10**(20+d.decimals))).toFixed(0)}),L=new Pt({baseToken:m,denominator:new Ne(10).pow(new Ne(20+m.decimals)),quoteToken:d,numerator:w.mul(new O(10**(20+d.decimals))).toFixed(0)}),R=new he(m,T);return{allTrade:p,realAmountIn:S,amountOut:K,minAmountOut:I,expirationTime:g,currentPrice:C,executionPrice:L,priceImpact:h,fee:R,remainingAccounts:k,executionPriceX64:x}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:o,slippage:s,priceLimit:a=new O(0)}){var I;let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new O(0))?l=c?Ot.sub(new Ne(1)):Nt.add(new Ne(1)):l=oe.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=Te(o,u[n.toString()],i,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:f,feeAmount:b}=Ce.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((I=m.fee)!=null?I:_e),l),y=c?e.mintB.address:e.mintA.address,g=Te(d,u[y],i,!1),A=oe.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),w=c?A:new O(1).div(A),h=d.mul(new Ne(Math.floor((1+s)*1e10))).div(new Ne(1e10)),T=Te(h,u[y],i,!0),k=c?e.currentPrice:new O(1).div(e.currentPrice),x=new O(w).sub(k).abs(),S=k,K=new Je(new O(x).mul(10**15).toFixed(0),new O(S).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:T,realAmountOut:m,expirationTime:qt(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:w,priceImpact:K,fee:b,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var f,b,y;let o=e[t],s=Y.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=Y.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),c=Math.max(s,o.priceMin),l=Math.min(a,o.priceMax)-c,m=a-s,d=o.priceMax-o.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:o.feeApr*p,rewardsApr:[((f=o.rewardApr[0])!=null?f:0)*p,((b=o.rewardApr[1])!=null?b:0)*p,((y=o.rewardApr[2])!=null?y:0)*p],apr:o.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:o,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[at(e.mintA.address).toString()],d=i[at(e.mintB.address).toString()],p=e.mintA.decimals,f=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let b=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),y=oe.getSqrtPriceX64FromTick(s),g=oe.getSqrtPriceX64FromTick(a),{amountSlippageA:A,amountSlippageB:w}=Pe.getAmountsFromLiquidityWithSlippage(b,y,g,t,!1,!1,0),{amountSlippageA:h,amountSlippageB:T}=Pe.getAmountsFromLiquidityWithSlippage(b,y,g,o,!1,!1,0),k=new O(A.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(w.toString()).div(new O(10).pow(f)).mul(d.value)),x=new O(h.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(T.toString()).div(new O(10).pow(f)).mul(d.value)),S=new O(1).div(k.add(x)),I=new O(l.volumeFee).mul(365).div(u).mul(S).mul(100).toNumber(),C=3600*24*365,L=e.rewardDefaultInfos.map(R=>{var V,H;let _=R.mint.decimals,M=i[R.mint.address];return c<((V=R.startTime)!=null?V:0)||c>((H=R.endTime)!=null?H:0)||!R.perSecond||!M||_===void 0?0:new O(M.value).mul(new O(R.perSecond).mul(C)).div(new O(10).pow(_)).mul(S).mul(100).toNumber()});return{feeApr:I,rewardsApr:L,apr:I+L.reduce((R,_)=>R+_,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:o,slippage:s,add:a,epochInfo:c,amountHasFee:u}){var g,A;let l=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),m=oe.getSqrtPriceX64FromTick(n),d=oe.getSqrtPriceX64FromTick(i),p=Te(o,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,c,!u),f=new Ne(new O(p.amount.sub((A=p.fee)!=null?A:_e).toString()).toFixed(0)),b;if(l.lte(m))b=t?Pe.getLiquidityFromTokenAmountA(m,d,f,!a):new Ne(0);else if(l.lte(d)){let w=Pe.getLiquidityFromTokenAmountA(l,d,f,!a),h=Pe.getLiquidityFromTokenAmountB(m,l,f);b=t?w:h}else b=t?new Ne(0):Pe.getLiquidityFromTokenAmountB(m,d,f);let y=await Ce.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:i,liquidity:b,slippage:s,add:a});return{liquidity:b,amountA:t?p:y.amountA,amountB:t?y.amountB:p,amountSlippageA:t?p:y.amountSlippageA,amountSlippageB:t?y.amountSlippageB:p,expirationTime:y.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:o,slippage:s,add:a}){var y,g,A,w;let c=oe.getSqrtPriceX64FromTick(n),u=oe.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=Pe.getAmountsFromLiquidity(oe.priceToSqrtPriceX64(new O(t.price),t.mintA.decimals,t.mintB.decimals),c,u,o,a),[d,p]=[Te(m.amountA,(y=t.mintA.extensions)==null?void 0:y.feeConfig,e,!0),Te(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[f,b]=[Te(m.amountA.muln(l),(A=t.mintA.extensions)==null?void 0:A.feeConfig,e,!0),Te(m.amountB.muln(l),(w=t.mintB.extensions)==null?void 0:w.feeConfig,e,!0)];return{liquidity:o,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:b,expirationTime:qt(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(c=>!n[c.id]).map(c=>new St(c.id));(await Et(e,i)).forEach((c,u)=>{!c||(n[i[u].toBase58()]=Vn.decode(c.data))});let s=t.map(c=>Ue(new St(c.programId),new St(c.id)).publicKey),a=await Ce.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>q(v({},c),{[u.id]:q(v({},n[u.id]),{id:new St(u.id),version:6,programId:new St(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:q(v({},u.config),{id:new St(u.config.id),fundOwner:""}),currentPrice:new O(u.price),exBitmapAccount:Ue(new St(u.programId),new St(u.id)).publicKey,exBitmapInfo:a[Ue(new St(u.programId),new St(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var Us={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function $u(r){return q(v({},r),{type:"Concentrated",programId:r.programId.toString(),id:r.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:r.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:r.ammConfig.tradeFeeRate,openTime:r.startTime.toString(),tvl:0,day:Us,week:Us,month:Us,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:q(v({},r.ammConfig),{id:r.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var se=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),o=i.div(n);return i.mod(n).eq(_e)||(o=o.add(Bt)),o}static mulDivFloor(e,t,n){if(n.eq(_e))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(_e))throw new Error("division by 0");return e.mul(t).add(n.sub(Bt)).div(n)}static x64ToDecimal(e,t){return new O(e.toString()).div(O.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new de(e.mul(O.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(ar).sub(t).mod(ar)}};function tt(r,e){return Gs(r.mul(e),64,256)}function Hd(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Gs(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var oe=class{static sqrtPriceX64ToPrice(e,t,n){return se.x64ToDecimal(e).pow(2).mul(O.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return se.decimalToX64(e.mul(O.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(_e))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(_e))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(_e))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(_e))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(_e))return e;let o=t.shln(Wi);if(i){let s=o,a=o.add(n.mul(e));return a.gte(s)?se.mulDivCeil(s,e,a):se.mulDivRoundingUp(s,Bt,s.div(e).add(n))}else{let s=n.mul(e);if(!o.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=o.sub(s);return se.mulDivCeil(o,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let o=n.shln(Wi);if(i)return e.add(o.div(t));{let s=se.mulDivRoundingUp(o,Bt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<mt||e>yt)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new de("18445821805675395072"):new de("18446744073709551616");return(t&2)!=0&&(n=tt(n,new de("18444899583751176192"))),(t&4)!=0&&(n=tt(n,new de("18443055278223355904"))),(t&8)!=0&&(n=tt(n,new de("18439367220385607680"))),(t&16)!=0&&(n=tt(n,new de("18431993317065453568"))),(t&32)!=0&&(n=tt(n,new de("18417254355718170624"))),(t&64)!=0&&(n=tt(n,new de("18387811781193609216"))),(t&128)!=0&&(n=tt(n,new de("18329067761203558400"))),(t&256)!=0&&(n=tt(n,new de("18212142134806163456"))),(t&512)!=0&&(n=tt(n,new de("17980523815641700352"))),(t&1024)!=0&&(n=tt(n,new de("17526086738831433728"))),(t&2048)!=0&&(n=tt(n,new de("16651378430235570176"))),(t&4096)!=0&&(n=tt(n,new de("15030750278694412288"))),(t&8192)!=0&&(n=tt(n,new de("12247334978884435968"))),(t&16384)!=0&&(n=tt(n,new de("8131365268886854656"))),(t&32768)!=0&&(n=tt(n,new de("3584323654725218816"))),(t&65536)!=0&&(n=tt(n,new de("696457651848324352"))),(t&131072)!=0&&(n=tt(n,new de("26294789957507116"))),(t&262144)!=0&&(n=tt(n,new de("37481735321082"))),e>0&&(n=Vu.div(n)),n}static getTickFromPrice(e,t,n){return oe.getTickFromSqrtPriceX64(oe.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Ot)||e.lt(Nt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new de(t-64),i=Hd(n,32,128),o=new de("8000000000000000","hex"),s=0,a=new de(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new de(0))&&s<Fu;){c=c.mul(c);let f=c.shrn(127);c=c.shrn(63+f.toNumber()),a=a.add(o.mul(f)),o=o.shrn(1),s+=1}let u=a.shrn(32),m=i.add(u).mul(new de(Du)),d=Gs(m.sub(new de(Wu)),64,128).toNumber(),p=Gs(m.add(new de(qu)),64,128).toNumber();return d==p?d:oe.getSqrtPriceX64FromTick(p).lte(e)?p:d}},Fn=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=oe.getTickFromSqrtPriceX64(oe.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let o=Fn.getTickWithPriceAndTickspacing(e,t,n,i),s=oe.getSqrtPriceX64FromTick(o);return oe.sqrtPriceX64ToPrice(s,n,i)}},Pe=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(_e))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln(Wi),s=t.sub(e);return i?se.mulDivRoundingUp(se.mulDivCeil(o,s,t),Bt,e):se.mulDivFloor(o,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(_e))throw new Error("sqrtPriceX64A must greater than 0");return i?se.mulDivCeil(n,t.sub(e),ze):se.mulDivFloor(n,t.sub(e),ze)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),s=t.sub(e),a=o.div(s);return i?se.mulDivRoundingUp(a,Bt,Di):a.shrn(Wi)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),se.mulDivFloor(n,Di,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return Pe.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=Pe.getLiquidityFromTokenAmountA(e,n,i,!1),a=Pe.getLiquidityFromTokenAmountB(t,e,o);return s.lt(a)?s:a}else return Pe.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:Pe.getTokenAmountAFromLiquidity(t,n,i,o),amountB:new de(0)};if(e.lt(n)){let s=Pe.getTokenAmountAFromLiquidity(e,n,i,o),a=Pe.getTokenAmountBFromLiquidity(t,e,i,o);return{amountA:s,amountB:a}}else return{amountA:new de(0),amountB:Pe.getTokenAmountBFromLiquidity(t,n,i,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,o,s,a){let{amountA:c,amountB:u}=Pe.getAmountsFromLiquidity(e,t,n,i,s),l=o?1+a:1-a,m=new de(new O(c.toString()).mul(l).toFixed(0)),d=new de(new O(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:o,add:s,epochInfo:a,amountAddFee:c}){var A,w,h,T;let u=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),l=oe.getSqrtPriceX64FromTick(t),m=oe.getSqrtPriceX64FromTick(n),d=s?1+o:1-o,p=Pe.getAmountsFromLiquidity(u,l,m,i,s),[f,b]=[Te(p.amountA,(A=e.mintA.extensions)==null?void 0:A.feeConfig,a,c),Te(p.amountB,(w=e.mintB.extensions)==null?void 0:w.feeConfig,a,c)],[y,g]=[Te(new de(new O(p.amountA.toString()).mul(d).toFixed(0)),(h=e.mintA.extensions)==null?void 0:h.feeConfig,a,c),Te(new de(new O(p.amountB.toString()).mul(d).toFixed(0)),(T=e.mintB.extensions)==null?void 0:T.feeConfig,a,c)];return{liquidity:i,amountA:f,amountB:b,amountSlippageA:y,amountSlippageB:g,expirationTime:qt(f.expirationTime,b.expirationTime)}}},En=class{static swapCompute(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b=!1){if(d.eq(_e))throw new Error("amountSpecified must not be 0");if(f||(f=s?Nt.add(Bt):Ot.sub(Bt)),s){if(f.lt(Nt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(f.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(f.gt(Ot))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(f.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let y=d.gt(_e),g={amountSpecifiedRemaining:d,amountCalculated:_e,sqrtPriceX64:m,tick:u>p?Math.min(p+Ae.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new de(0)},A=p,w=n[p],h=0,T=!s&&w.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(_e)&&!g.sqrtPriceX64.eq(f);){h>10;let k={};k.sqrtPriceStartX64=g.sqrtPriceX64;let x=Y.nextInitTick(w,g.tick,l,s,T),S=x||null,K=null;if(!(S!=null&&S.liquidityGross.gtn(0))){let C=Ce.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:o},A,s);if(!C.isExist){if(b)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}A=C.nextStartIndex;let{publicKey:L}=ye(e,t,A);K=L,w=n[A];try{S=Y.firstInitializedTick(w,s)}catch{throw Error("not found next tick info")}}k.tickNext=S.tick,k.initialized=S.liquidityGross.gtn(0),p!==A&&K&&(g.accounts.push(K),p=A),k.tickNext<mt?k.tickNext=mt:k.tickNext>yt&&(k.tickNext=yt),k.sqrtPriceNextX64=oe.getSqrtPriceX64FromTick(k.tickNext);let I;if(s&&k.sqrtPriceNextX64.lt(f)||!s&&k.sqrtPriceNextX64.gt(f)?I=f:I=k.sqrtPriceNextX64,[g.sqrtPriceX64,k.amountIn,k.amountOut,k.feeAmount]=En.swapStepCompute(g.sqrtPriceX64,I,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(k.feeAmount),y?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(k.amountIn.add(k.feeAmount)),g.amountCalculated=g.amountCalculated.sub(k.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(k.amountOut),g.amountCalculated=g.amountCalculated.add(k.amountIn.add(k.feeAmount))),g.sqrtPriceX64.eq(k.sqrtPriceNextX64)){if(k.initialized){let C=S.liquidityNet;s&&(C=C.mul(an)),g.liquidity=Pe.addDelta(g.liquidity,C)}T=k.tickNext!=g.tick&&!s&&w.startTickIndex===k.tickNext,g.tick=s?k.tickNext-1:k.tickNext}else if(g.sqrtPriceX64!=k.sqrtPriceStartX64){let C=oe.getTickFromSqrtPriceX64(g.sqrtPriceX64);T=C!=g.tick&&!s&&w.startTickIndex===C,g.tick=C}++h}try{let{nextStartIndex:k,isExist:x}=Ae.nextInitializedTickArray(g.tick,l,s,i,o);x&&p!==k&&(g.accounts.push(ye(e,t,k).publicKey),p=k)}catch{}return{allTrade:!0,amountSpecifiedRemaining:_e,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,o,s){let a={sqrtPriceX64Next:new de(0),amountIn:new de(0),amountOut:new de(0),feeAmount:new de(0)},c=i.gte(_e);if(c){let l=se.mulDivFloor(i,lr.sub(new de(o.toString())),lr);a.amountIn=s?Pe.getTokenAmountAFromLiquidity(t,e,n,!0):Pe.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=oe.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?Pe.getTokenAmountBFromLiquidity(t,e,n,!1):Pe.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(an).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=oe.getNextSqrtPriceX64FromOutput(e,n,i.mul(an),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=Pe.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=Pe.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:Pe.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:Pe.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(i.mul(an))&&(a.amountOut=i.mul(an)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=i.sub(a.amountIn):a.feeAmount=se.mulDivCeil(a.amountIn,new de(o),lr.sub(new de(o))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var Ze=60,_n=512,Y=class{static getTickArrayAddressByTick(e,t,n,i){let o=Y.getTickArrayStartIndexByTick(n,i),{publicKey:s}=ye(e,t,o);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=Y.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=Ze)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=Ae.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*Ae.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Ze,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*Ze,o=Math.floor(t/i)+512,s=Math.abs(o);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Ze:e+t*Ze}static mergeTickArrayBitmap(e){let t=new Yd(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,o){let s=Math.floor(i/(n*Ze));return[...Y.searchLowBitFromStart(e,t,s-1,o,n),...Y.searchHightBitFromStart(e,t,s,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return Y.searchHightBitFromStart(e,t,-7680,_n,n)}static getAllInitializedTickArrayInfo(e,t,n,i,o){let s=[],a=Y.getAllInitializedTickArrayStartIndex(n,i,o);for(let c of a){let{publicKey:u}=ye(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>Y.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===i)break}let c=Ae.tickCount(o);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>Y.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===i)break}let c=Ae.tickCount(o);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<mt||e>yt}static nextInitTick(e,t,n,i,o){if(Ae.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(o||(a=a+1);a<Ze;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Ze-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Ze;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=oe.getSqrtPriceX64FromTick(t),o=oe.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(o),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),o=Fn.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=oe.getSqrtPriceX64FromTick(o),a=oe.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new O(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=oe.getSqrtPriceX64FromTick(t),o=oe.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(o),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),o=Fn.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=oe.getSqrtPriceX64FromTick(o),a=oe.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new O(1).div(a)}}};var ec=E([ke(8),G("bump"),Xt("index"),N(""),lt("protocolFeeRate"),lt("tradeFeeRate"),Xt("tickSpacing"),Q(P(),8,"")]),Zd=E([lt("blockTimestamp"),ri("tickCumulative"),Q(P(),4)]),tc=E([ke(8),Ve("initialized"),P("recentEpoch"),Xt("observationIndex"),N("poolId"),Q(Zd,100,"observations"),Q(P(),4)]),$d=E([G("rewardState"),P("openTime"),P("endTime"),P("lastUpdateTime"),ee("emissionsPerSecondX64"),P("rewardTotalEmissioned"),P("rewardClaimed"),N("tokenMint"),N("tokenVault"),N("creator"),ee("rewardGrowthGlobalX64")]),Vn=E([ke(8),G("bump"),N("ammConfig"),N("creator"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("observationId"),G("mintDecimalsA"),G("mintDecimalsB"),Xt("tickSpacing"),ee("liquidity"),ee("sqrtPriceX64"),Re("tickCurrent"),lt(),ee("feeGrowthGlobalX64A"),ee("feeGrowthGlobalX64B"),P("protocolFeesTokenA"),P("protocolFeesTokenB"),ee("swapInAmountTokenA"),ee("swapOutAmountTokenB"),ee("swapInAmountTokenB"),ee("swapOutAmountTokenA"),G("status"),Q(G(),7,""),Q($d,3,"rewardInfos"),Q(P(),16,"tickArrayBitmap"),P("totalFeesTokenA"),P("totalFeesClaimedTokenA"),P("totalFeesTokenB"),P("totalFeesClaimedTokenB"),P("fundFeesTokenA"),P("fundFeesTokenB"),P("startTime"),Q(P(),15*4-3,"padding")]),Jd=E([ee("growthInsideLastX64"),P("rewardAmountOwed")]),ji=E([ke(8),G("bump"),N("nftMint"),N("poolId"),Re("tickLower"),Re("tickUpper"),ee("liquidity"),ee("feeGrowthInsideLastX64A"),ee("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),Q(Jd,3,"rewardInfos"),Q(P(),8,"")]),Vh=E([ke(8),G("bump"),N("poolId"),Re("tickLowerIndex"),Re("tickUpperIndex"),ee("liquidity"),ee("feeGrowthInsideLastX64A"),ee("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),Q(ee(),3,"rewardGrowthInside"),Q(P(),8,"")]),ep=E([Re("tick"),Au("liquidityNet"),ee("liquidityGross"),ee("feeGrowthOutsideX64A"),ee("feeGrowthOutsideX64B"),Q(ee(),3,"rewardGrowthsOutsideX64"),Q(lt(),13,"")]),Qi=E([ke(8),N("poolId"),Re("startTickIndex"),Q(ep,Ze,"ticks"),G("initializedTickCount"),Q(G(),115,"")]),nc=E([ke(329),Q(N(),100,"whitelistMints")]),Ju=E([ke(8),N("poolId"),Q(Q(P(),8),qs,"positiveTickArrayBitmap"),Q(Q(P(),8),qs,"negativeTickArrayBitmap")]),Fh=E([P(),G("bump"),N("owner"),N("poolId"),N("positionId"),N("nftAccount"),Q(P(),8)]),Dh=E([ke(8),G("bump"),N("lockOwner"),N("poolId"),N("positionId"),N("nftAccount"),N("lockNftMint"),P("recentEpoch"),Q(P(),8)]);tc.span;var ic=fe("Raydium_Clmm"),xt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},oc=[188,37,179,131,82,150,84,73],rc=[16,72,250,198,14,162,212,19],Se=class{static createPoolInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,f){let b=E([ee("sqrtPriceX64"),P("zero")]),y=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:it,isSigner:!1,isWritable:!1},...(f==null?void 0:f.map(w=>({pubkey:w,isSigner:!1,isWritable:!1})))||[]],g=Buffer.alloc(b.span);b.encode({sqrtPriceX64:p,zero:_e},g);let A=Buffer.from([...xt.createPool,...g]);return new rt({keys:y,programId:e,data:A})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:o,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new X(i.address),new X(o.address)],{publicKey:m}=zu(t,s,u,l),{publicKey:d}=Hu(t,m),{publicKey:p}=Fs(t,m,u),{publicKey:f}=Fs(t,m,l),b=Ue(t,m).publicKey,y=[this.createPoolInstruction(t,m,n,s,d,u,p,new X(i.programId||Be),l,f,new X(o.programId||Be),b,a,c)];return{signers:[],instructions:y,instructionTypes:[U.CreateAccount,U.ClmmCreatePool],address:{poolId:m,observationId:d,exBitmapAccount:b,mintAVault:p,mintBVault:f},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A,w,h,T,k,x,S,K,I){let C=E([Re("tickLowerIndex"),Re("tickUpperIndex"),Re("tickArrayLowerStartIndex"),Re("tickArrayUpperStartIndex"),ee("liquidity"),P("amountMaxA"),P("amountMaxB"),Ve("withMetadata"),G("optionBaseFlag"),Ve("baseFlag")]),L=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Hi,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],_=Buffer.alloc(C.span);C.encode({tickLowerIndex:A,tickUpperIndex:w,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:T,liquidity:k,amountMaxA:x,amountMaxB:S,withMetadata:K==="create",baseFlag:!1,optionBaseFlag:0},_);let M=Buffer.from([...xt.openPosition,..._]);return new rt({keys:R,programId:e,data:M})}static openPositionFromLiquidityInstruction22(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A,w,h,T,k,x,S,K){let I=E([Re("tickLowerIndex"),Re("tickUpperIndex"),Re("tickArrayLowerStartIndex"),Re("tickArrayUpperStartIndex"),ee("liquidity"),P("amountMaxA"),P("amountMaxB"),Ve("withMetadata"),G("optionBaseFlag"),Ve("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Hi,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...C],R=Buffer.alloc(I.span);I.encode({tickLowerIndex:g,tickUpperIndex:A,tickArrayLowerStartIndex:w,tickArrayUpperStartIndex:h,liquidity:T,amountMaxA:k,amountMaxB:x,withMetadata:S==="create",baseFlag:!1,optionBaseFlag:0},R);let _=Buffer.from([...xt.openPositionWithTokenEx,...R]);return new rt({keys:L,programId:e,data:_})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,f]=[new X(e.programId),new X(e.id)],b;if(l)b=new X((await l(1))[0]);else{let K=dr.generate();d.push(K),b=K.publicKey}let y=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Y.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:A}=ye(p,f,y),{publicKey:w}=ye(p,f,g),{publicKey:h}=m?ie(n.wallet,b,Fe):ie(n.wallet,b,Be),{publicKey:T}=un(b),{publicKey:k}=gt(p,b),{publicKey:x}=Qt(p,f,i,o),S=m?this.openPositionFromLiquidityInstruction22(p,n.feePayer,f,n.wallet,b,h,x,A,w,k,n.tokenAccountA,n.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(e.mintA.address),new X(e.mintB.address),i,o,y,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Ue(p,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,f,n.wallet,b,h,T,x,A,w,k,n.tokenAccountA,n.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(e.mintA.address),new X(e.mintB.address),i,o,y,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Ue(p,f).publicKey:void 0);return{signers:d,instructions:[S],instructionTypes:[U.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:b,tickArrayLower:A,tickArrayUpper:w,positionNftAccount:h,metadataAccount:T,personalPosition:k,protocolPosition:x}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,f]=[new X(e.programId),new X(e.id)],b;if(l)b=new X((await l(1))[0]);else{let K=dr.generate();d.push(K),b=K.publicKey}let y=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Y.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:A}=ye(p,f,y),{publicKey:w}=ye(p,f,g),{publicKey:h}=m?ie(n.wallet,b,Fe):ie(n.wallet,b,Be),{publicKey:T}=un(b),{publicKey:k}=gt(p,b),{publicKey:x}=Qt(p,f,i,o),S=m?this.openPositionFromBaseInstruction22(p,n.feePayer,f,n.wallet,b,h,x,A,w,k,n.tokenAccountA,n.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(e.mintA.address),new X(e.mintB.address),i,o,y,g,u,s,a,c,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Ue(p,f).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,f,n.wallet,b,h,T,x,A,w,k,n.tokenAccountA,n.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(e.mintA.address),new X(e.mintB.address),i,o,y,g,u,s,a,c,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Ue(p,f).publicKey:void 0);return{address:{nftMint:b,tickArrayLower:A,tickArrayUpper:w,positionNftAccount:h,metadataAccount:T,personalPosition:k,protocolPosition:x},instructions:[S],signers:d,instructionTypes:[U.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A,w,h,T,k,x,S,K,I){let C=E([Re("tickLowerIndex"),Re("tickUpperIndex"),Re("tickArrayLowerStartIndex"),Re("tickArrayUpperStartIndex"),ee("liquidity"),P("amountMaxA"),P("amountMaxB"),Ve("withMetadata"),G("optionBaseFlag"),Ve("baseFlag")]),L=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Hi,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],_=Buffer.alloc(C.span);C.encode({tickLowerIndex:A,tickUpperIndex:w,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:T,liquidity:new Xs(0),amountMaxA:x==="MintA"?S:K,amountMaxB:x==="MintA"?K:S,withMetadata:k==="create",baseFlag:x==="MintA",optionBaseFlag:1},_);let M=Buffer.from([...xt.openPosition,..._]);return new rt({keys:R,programId:e,data:M})}static openPositionFromBaseInstruction22(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A,w,h,T,k,x,S,K){let I=E([Re("tickLowerIndex"),Re("tickUpperIndex"),Re("tickArrayLowerStartIndex"),Re("tickArrayUpperStartIndex"),ee("liquidity"),P("amountMaxA"),P("amountMaxB"),Ve("withMetadata"),G("optionBaseFlag"),Ve("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Hi,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...C],R=Buffer.alloc(I.span);I.encode({tickLowerIndex:g,tickUpperIndex:A,tickArrayLowerStartIndex:w,tickArrayUpperStartIndex:h,liquidity:new Xs(0),amountMaxA:k==="MintA"?x:S,amountMaxB:k==="MintA"?S:x,withMetadata:T==="create",baseFlag:k==="MintA",optionBaseFlag:1},R);let _=Buffer.from([...xt.openPositionWithTokenEx,...R]);return new rt({keys:L,programId:e,data:_})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d,p=[];if(l)d=new X((await l(1))[0]);else{let K=dr.generate();p.push(K),d=K.publicKey}let[f,b]=[new X(e.programId),new X(e.id)],y=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Y.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:A}=ye(f,b,y),{publicKey:w}=ye(f,b,g),{publicKey:h}=m?ie(n.wallet,d,Fe):ie(n.wallet,d,Be),{publicKey:T}=un(d),{publicKey:k}=gt(f,d),{publicKey:x}=Qt(f,b,i,o),S=m?this.openPositionFromLiquidityInstruction22(f,n.wallet,b,n.wallet,d,h,x,A,w,k,n.tokenAccountA,n.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(t.mintA.address),new X(t.mintB.address),i,o,y,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Ue(f,b).publicKey:void 0):this.openPositionFromLiquidityInstruction(f,n.wallet,b,n.wallet,d,h,T,x,A,w,k,n.tokenAccountA,n.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(t.mintA.address),new X(t.mintB.address),i,o,y,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Ue(f,b).publicKey:void 0);return{address:{nftMint:d,tickArrayLower:A,tickArrayUpper:w,positionNftAccount:h,metadataAccount:T,personalPosition:k,protocolPosition:x},instructions:[S],signers:p,instructionTypes:[U.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,o,s){let a=E([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:s?Fe:Be,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...xt.closePosition,...u]);return new rt({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i,nft2022:o}){let s=new X(e.programId),a=o?ie(n.wallet,i.nftMint,Fe).publicKey:ie(n.wallet,i.nftMint,Be).publicKey,{publicKey:c}=gt(s,i.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,i.nftMint,a,c,o)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[U.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A){let w=E([ee("liquidity"),P("amountMaxA"),P("amountMaxB"),G("optionBaseFlag"),Ve("baseFlag")]),h=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...h],k=Buffer.alloc(w.span);w.encode({liquidity:b,amountMaxA:y,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},k);let x=Buffer.from([...xt.increaseLiquidity,...k]);return new rt({keys:T,programId:e,data:x})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:o,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new X(e.programId),new X(e.id)],m=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ye(u,l,m),{publicKey:f}=ye(u,l,d),{publicKey:b}=c?ie(i.wallet,n.nftMint,Fe):ie(i.wallet,n.nftMint,Be),{publicKey:y}=gt(u,n.nftMint),{publicKey:g}=Qt(u,l,n.tickLower,n.tickUpper),A=this.increasePositionFromLiquidityInstruction(u,i.wallet,b,y,l,g,p,f,i.tokenAccountA,i.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(e.mintA.address),new X(e.mintB.address),o,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Ue(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:b,personalPosition:y,protocolPosition:g},signers:[],instructions:[A],instructionTypes:[U.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:o,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new X(e.programId),new X(e.id)],m=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ye(u,l,m),{publicKey:f}=ye(u,l,d),{publicKey:b}=c?ie(i.wallet,n.nftMint,Fe):ie(i.wallet,n.nftMint,Be),{publicKey:y}=gt(u,n.nftMint),{publicKey:g}=Qt(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:b,personalPosition:y,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,b,y,l,g,p,f,i.tokenAccountA,i.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(e.mintA.address),new X(e.mintB.address),o,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Ue(u,l).publicKey:void 0)],signers:[],instructionTypes:[U.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A){let w=E([ee("liquidity"),P("amountMaxA"),P("amountMaxB"),G("optionBaseFlag"),Ve("baseFlag")]),h=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...h],k=Buffer.alloc(w.span);w.encode({liquidity:new Xs(0),amountMaxA:b==="MintA"?y:g,amountMaxB:b==="MintA"?g:y,baseFlag:b==="MintA",optionBaseFlag:1},k);let x=Buffer.from([...xt.increaseLiquidity,...k]);return new rt({keys:T,programId:e,data:x})}static decreaseLiquidityInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A,w){let h=E([ee("liquidity"),P("amountMinA"),P("amountMinB")]),T=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[],...b.map(K=>[{pubkey:K.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.rewardMint,isSigner:!1,isWritable:!1}]).flat()],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:Oo,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...T],x=Buffer.alloc(h.span);h.encode({liquidity:y,amountMinA:g,amountMinB:A},x);let S=Buffer.from([...xt.decreaseLiquidity,...x]);return new rt({keys:k,programId:e,data:S})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:o,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,m]=[new X(e.programId),new X(e.id)],d=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:f}=ye(l,m,d),{publicKey:b}=ye(l,m,p),{publicKey:y}=u?ie(i.wallet,n.nftMint,Fe):ie(i.wallet,n.nftMint,c),{publicKey:g}=gt(l,n.nftMint),{publicKey:A}=Qt(l,m,n.tickLower,n.tickUpper),w=[];for(let k=0;k<e.rewardDefaultInfos.length;k++)w.push({poolRewardVault:new X(t.rewardInfos[k].vault),ownerRewardVault:i.rewardAccounts[k],rewardMint:new X(e.rewardDefaultInfos[k].mint.address)});let h=[],T=this.decreaseLiquidityInstruction(l,i.wallet,y,g,m,A,f,b,i.tokenAccountA,i.tokenAccountB,new X(t.vault.A),new X(t.vault.B),new X(e.mintA.address),new X(e.mintB.address),w,o,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,p])?Ue(l,m).publicKey:void 0);return h.push(T),{address:{tickArrayLower:f,tickArrayUpper:b,positionNftAccount:y,personalPosition:g,protocolPosition:A},signers:[],instructions:h,instructionTypes:[U.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g){let A=E([P("amount"),P("otherAmountThreshold"),ee("sqrtPriceLimitX64"),Ve("isBaseInput")]),w=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(x=>({pubkey:x,isSigner:!1,isWritable:!0}))],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:Oo,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...w],T=Buffer.alloc(A.span);A.encode({amount:p,otherAmountThreshold:f,sqrtPriceLimitX64:b,isBaseInput:y},T);let k=Buffer.from([...xt.swap,...T]);return new rt({keys:h,programId:e,data:k})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:o,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new X(e.programId),new X(e.id)],[d,p]=[new X(t.vault.A),new X(t.vault.B)],[f,b]=[new X(e.mintA.address),new X(e.mintB.address)],y=e.mintA.address===o.toString(),g=[this.swapInstruction(l,i.wallet,m,new X(e.config.id),y?i.tokenAccountA:i.tokenAccountB,y?i.tokenAccountB:i.tokenAccountA,y?d:p,y?p:d,y?f:b,y?b:f,u,n,s,a,c,!0,Ue(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[U.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:o,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new X(e.programId),new X(e.id)],[d,p]=[new X(t.vault.A),new X(t.vault.B)],[f,b]=[new X(e.mintA.address),new X(e.mintB.address)],y=e.mintA.address===o.toBase58(),g=[this.swapInstruction(l,i.wallet,m,new X(e.config.id),y?i.tokenAccountB:i.tokenAccountA,y?i.tokenAccountA:i.tokenAccountB,y?p:d,y?d:p,y?b:f,y?f:b,u,n,s,a,c,!1,Ue(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[U.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,o,s,a,c,u,l,m,d){let p=E([P("openTime"),P("endTime"),ee("emissionsPerSecondX64")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:it,isSigner:!1,isWritable:!1}],b=Buffer.alloc(p.span);p.encode({openTime:$(l),endTime:$(m),emissionsPerSecondX64:d},b);let y=Buffer.from([...xt.initReward,...b]);return new rt({keys:f,programId:e,data:y})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[o,s]=[new X(e.programId),new X(e.id)],a=ju(o,s,i.mint).publicKey,c=Ui(o).publicKey,u=[this.initRewardInstruction(o,n.wallet,s,c,new X(e.config.id),n.tokenAccount,i.programId,i.mint,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[U.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,o,s,a,c,u,l,m,d){let p=E([G("rewardIndex"),ee("emissionsPerSecondX64"),P("openTime"),P("endTime")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],b=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:$(l),endTime:$(m)},b);let y=Buffer.from([...xt.setRewardEmissions,...b]);return new rt({keys:f,programId:e,data:y})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[o,s]=[new X(e.programId),new X(e.id)],a,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===i.mint.toString()&&(a=d,c=new X(t.rewardInfos[d].vault),u=new X(t.rewardInfos[d].mint.address));(a===void 0||c===void 0)&&ic.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=Ui(o).publicKey,m=[this.setRewardInstruction(o,n.wallet,s,l,new X(e.config.id),n.tokenAccount,c,u,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[U.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,o,s,a){let c=E([G("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:Oo,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let m=Buffer.from([...xt.collectReward,...l]);return new rt({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[o,s]=[new X(e.programId),new X(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(a=l,c=new X(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&ic.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(o,n.wallet,s,n.tokenAccount,c,i,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[U.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:o,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new X((await c(1))[0]);else{let g=dr.generate();u.push(g),l=g.publicKey}let m=a?ie(o,s,Fe).publicKey:ie(o,s,Be).publicKey,{publicKey:d}=gt(n,s),p=Gi(e,l).publicKey,f=ie(o,l,Be).publicKey,b=un(l).publicKey,y=Se.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:o,lockOwner:o,positionNftAccount:m,positionId:d,lockPositionId:p,lockNftMint:l,lockNftAccount:f,metadataAccount:b,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:ie(t,s,a?Fe:Be).publicKey,positionNftProgram:a?Fe:Be});return{address:{positionId:d,lockPositionId:p,lockNftAccount:f,lockNftMint:l,positionNftAccount:m,metadataAccount:b},instructions:[y],signers:u,instructionTypes:[U.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:o,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:m,lockNftMint:d,lockNftAccount:p,metadataAccount:f,withMetadata:b}){let y=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:Hi,isSigner:!1,isWritable:!1},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1}],g=E([Ve("withMetadata")]),A=Buffer.alloc(g.span);g.encode({withMetadata:b},A);let w=Buffer.from([...oc,...A]);return new rt({keys:y,programId:e,data:w})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:o}){let{publicKey:s}=ie(i,o,Be),{publicKey:a}=gt(n,o),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Ds(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1}];return new rt({keys:c,programId:e,data:Buffer.from(oc)})}static harvestLockPositionInstruction(e){let[t,n]=[new X(e.poolKeys.programId),new X(e.poolKeys.id)],i=Y.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),o=Y.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=ye(t,n,i),{publicKey:a}=ye(t,n,o),{publicKey:c}=ie(e.owner,e.ownerPosition.nftMint,Be),{publicKey:u}=gt(t,e.ownerPosition.nftMint),{publicKey:l}=Qt(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let f=0;f<e.poolKeys.rewardInfos.length;f++)m.push({poolRewardVault:new X(e.poolKeys.rewardInfos[f].vault),ownerRewardVault:e.ownerRewardAccounts[f],rewardMint:new X(e.poolKeys.rewardInfos[f].mint.address)});let d=[...m.map(f=>[{pubkey:f.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Ds(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new X(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new X(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:An,isSigner:!1,isWritable:!1},{pubkey:new X(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new X(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new rt({keys:p,programId:e.programId,data:Buffer.from(rc)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:o,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:m,vaultA:d,vaultB:p,tickArrayLower:f,tickArrayUpper:b,userVaultA:y,userVaultB:g,mintA:A,mintB:w,rewardAccounts:h,exTickArrayBitmap:T}){let k=[...T?[{pubkey:T,isSigner:!1,isWritable:!0}]:[],...h.map(S=>[{pubkey:S.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.rewardMint,isSigner:!1,isWritable:!1}]).flat()],x=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:An,isSigner:!1,isWritable:!1},{pubkey:A,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},...k];return new rt({keys:x,programId:e,data:Buffer.from(rc)})}};var tp=E([lt("mintAuthorityOption"),N("mintAuthority"),P("supply"),G("decimals"),G("isInitialized"),lt("freezeAuthorityOption"),N("freezeAuthority")]);import{PublicKey as aT}from"@solana/web3.js";import{MintLayout as cT,TOKEN_PROGRAM_ID as mT}from"@solana/spl-token";var pr=r=>new Me({mint:r.address,decimals:r.decimals,symbol:r.symbol,name:r.name}),Yi=i=>{var o=i,{amount:r,isRaw:e,name:t}=o,n=Ee(o,["amount","isRaw","name"]);return new he(new Me({mint:at(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),r,e,t)};var dt=i=>{var o=i,{address:r,programId:e,decimals:t}=o,n=Ee(o,["address","programId","decimals"]);return v({chainId:101,address:at(r).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},xn=r=>r?q(v({},r),{transferFeeConfigAuthority:r.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:r.withdrawWithheldAuthority.toBase58(),withheldAmount:r.withheldAmount.toString(),olderTransferFee:q(v({},r.olderTransferFee),{epoch:r.olderTransferFee.epoch.toString(),maximumFee:r.olderTransferFee.maximumFee.toString()}),newerTransferFee:q(v({},r.newerTransferFee),{epoch:r.newerTransferFee.epoch.toString(),maximumFee:r.newerTransferFee.maximumFee.toString()})}):void 0;import sc from"bn.js";var Qs=new sc(25),fr=new sc(1e4);import{PublicKey as Jt,SystemProgram as bp,SYSVAR_RENT_PUBKEY as vT,TransactionInstruction as ci}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as yp,TOKEN_PROGRAM_ID as Ji}from"@solana/spl-token";var zs=E([G("instruction"),P("amountIn"),P("minAmountOut")]),js=E([G("instruction"),P("maxAmountIn"),P("amountOut")]),ST=E([G("instruction"),G("nonce")]),np=E([G("instruction"),G("nonce"),P("startTime")]),Zi=E([P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalValue"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),ee("swapBaseInAmount"),ee("swapQuoteOutAmount"),P("swapBase2QuoteFee"),ee("swapQuoteInAmount"),ee("swapBaseOutAmount"),P("swapQuote2BaseFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("withdrawQueue"),N("lpVault"),N("owner"),P("lpReserve"),Q(P(),3,"padding")]),xT=E([P("accountType"),P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalsValue"),P("abortTradeFactor"),P("priceTickMultiplier"),P("priceTick"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),ee("swapBaseInAmount"),ee("swapQuoteOutAmount"),ee("swapQuoteInAmount"),ee("swapBaseOutAmount"),P("swapQuote2BaseFee"),P("swapBase2QuoteFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("modelDataAccount"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("owner"),Q(P(),64,"padding")]),Hs=E([G("instruction"),P("baseAmountIn"),P("quoteAmountIn"),P("fixedSide"),P("otherAmountMin")]),Ys=E([G("instruction"),P("lpAmount"),P("baseAmountMin"),P("quoteAmountMin")]);var ac=E([P("fee")]);import{PublicKey as ip}from"@solana/web3.js";var ui=new ip("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Wn=5e4,op=E([P("x"),P("y"),P("price")]),rp=E([P("accountType"),P("status"),P("multiplier"),P("validDataCount"),Q(op,Wn,"DataElement")]);function sp(r,e){return[0,Wn-2]}function ap(r){return[0,Wn-2]}function up(r){return[0,Wn-2]}function cp(r,e,t){let[n,i]=sp(e,t),o=n,s=i,a=0,c=e*r.multiplier/t;for(;o<=s;){if(a=Math.floor((s+o)/2),a===0||a>=Wn-2)return[a,a,!1];let u=r.DataElement[a].x*r.multiplier/r.DataElement[a].y,l=r.DataElement[a-1].x*r.multiplier/r.DataElement[a-1].y,m=r.DataElement[a+1].x*r.multiplier/r.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===m)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<m)return[a,a+1,!0];o=a+1}}return[a,a,!1]}function Zs(r,e,t){let[n,i,o]=cp(r,e,t);if(!o)return 0;if(n===i){let s=r.DataElement[n].x;return e*r.multiplier/s}else{let s=r.DataElement[n].x,a=r.DataElement[n].y,c=r.DataElement[i].x,u=r.DataElement[i].y,l=t*(c*a-s*u),m=s*l,d=(c-s)*(e*a-s*t)*u,p=m+d;return e*r.multiplier*l/p}}function Dn(r,e,t){return e*r.multiplier/t}function uc(r,e,t){return e*t/r.multiplier}function lp(r,e){let[t,n]=ap(e),i=t,o=n,s=0,a=e;for(;i<o;){if(s=Math.floor((o+i)/2),s<=0||s>Wn-2)return[s,s,!1];let c=r.DataElement[s].x,u=r.DataElement[s-1].x,l=r.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)o=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];i=s+1}}return[s,s,!1]}function mp(r,e){let[t,n]=up(e),i=t,o=n,s=0,a=e;for(;i<=o;){if(s=Math.floor((o+i)/2),s<=0||s>=Wn-2)return[s,s,!1];let c=r.DataElement[s].y,u=r.DataElement[s-1].y,l=r.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)i=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];o=s-1}}return[s,s,!1]}function cc(r,e,t,n){let i=n?e+t:e-t,[o,s,a]=lp(r,i);if(!a)return[0,0,!1,a];if(o===s)return[r.DataElement[s].price,r.DataElement[s].y,!1,a];{let c=r.DataElement[o].x,u=r.DataElement[s].x,l=r.DataElement[o].price,m=r.DataElement[s].price,d=r.DataElement[o].y,p=r.DataElement[s].y;if(e>=c&&e<=u)return n?[m,p,!0,a]:[l,d,!0,a];{let f,b;return n?(f=l+(m-l)*(e-c)/(u-c),b=d-(i-c)*r.multiplier/m):(f=l+(m-l)*(e-c)/(u-c),b=p+(u-i)*r.multiplier/l),[f,b,!1,a]}}}function dp(r,e,t,n){let i=n?e-t:e+t,[o,s,a]=mp(r,i);if(!a)return[0,0,!1,a];if(o===s)return[r.DataElement[s].price,r.DataElement[s].x,!1,a];{let c=r.DataElement[o].x,u=r.DataElement[s].x,l=r.DataElement[o].price,m=r.DataElement[s].price,d=r.DataElement[o].y,p=r.DataElement[s].y;if(e>=p&&e<=d)return n?[m,u,!0,a]:[l,c,!0,a];{let f,b;return n?(f=l+(m-l)*(d-e)/(d-p),b=c+m*(d-i)/r.multiplier):(f=l+(m-l)*(d-e)/(d-p),b=u-l*(i-p)/r.multiplier),[f,b,!1,a]}}}function pp(r,e){let t=cc(r,e,0,!1);return t[3]?t[0]:0}function lc(r,e,t,n){let i=Zs(r,e,t),o=Dn(r,e,i),s=Dn(r,t,i),a=Dn(r,n,i),c=!0,[u,l,m,d]=cc(r,o,a,c);if(!d)return 0;if(m)return n*r.multiplier/u;{let p=s-l;return uc(r,p,i)}}function mc(r,e,t,n){let i=Zs(r,e,t),o=Dn(r,e,i),s=Dn(r,t,i),a=Dn(r,n,i),c=!1,[u,l,m,d]=dp(r,s,a,c);if(!d)return 0;if(m)return n*u/r.multiplier;{let p=o-l;return uc(r,p,i)}}function fp(r){let e=rp.decode(r);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function dc(r,e,t,n){let i=pp(r,Dn(r,e,Zs(r,e,t)))/r.multiplier;return n?i:1/i}var $i=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(ui);e&&(this._layoutData=fp(e==null?void 0:e.data))}}};var pc=fe("Raydium_liquidity_instruction");function fc(r){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:o,fixedSide:s,otherAmountMin:a}=r,c=Buffer.alloc(Hs.span);Hs.encode({instruction:3,baseAmountIn:$(i),quoteAmountIn:$(o),otherAmountMin:$(a),fixedSide:s==="base"?wt:Wa},c);let u=[B({pubkey:Ji,isWritable:!1}),B({pubkey:new Jt(e.id)}),B({pubkey:new Jt(t.authority),isWritable:!1}),B({pubkey:new Jt(t.openOrders),isWritable:!1}),B({pubkey:new Jt(t.targetOrders)}),B({pubkey:new Jt(e.lpMint.address)}),B({pubkey:new Jt(t.vault.A)}),B({pubkey:new Jt(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(B({pubkey:ui})),u.push(B({pubkey:new Jt(e.marketId),isWritable:!1}),B({pubkey:n.baseTokenAccount}),B({pubkey:n.quoteTokenAccount}),B({pubkey:n.lpTokenAccount}),B({pubkey:n.owner,isWritable:!1,isSigner:!0}),B({pubkey:new Jt(t.marketEventQueue),isWritable:!1})),new ci({programId:new Jt(e.programId),keys:u,data:c})}function $s(r){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:i,baseAmountMin:o,quoteAmountMin:s}=r,a=ot(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(Ys.span);Ys.encode({instruction:4,lpAmount:$(i),baseAmountMin:$(o),quoteAmountMin:$(s)},u);let l=[B({pubkey:Ji,isWritable:!1}),B({pubkey:a.id}),B({pubkey:a.authority,isWritable:!1}),B({pubkey:a.openOrders}),B({pubkey:a.targetOrders}),B({pubkey:a.mintLp.address}),B({pubkey:a.vault.A}),B({pubkey:a.vault.B})];return c===5?l.push(B({pubkey:ui})):(l.push(B({pubkey:a.id})),l.push(B({pubkey:a.id}))),l.push(B({pubkey:a.marketProgramId,isWritable:!1}),B({pubkey:a.marketId}),B({pubkey:a.marketBaseVault}),B({pubkey:a.marketQuoteVault}),B({pubkey:a.marketAuthority,isWritable:!1}),B({pubkey:n.lpTokenAccount}),B({pubkey:n.baseTokenAccount}),B({pubkey:n.quoteTokenAccount}),B({pubkey:n.owner,isWritable:!1,isSigner:!0}),B({pubkey:a.marketEventQueue}),B({pubkey:a.marketBids}),B({pubkey:a.marketAsks})),new ci({programId:a.programId,keys:l,data:u})}return new ci({programId:a.programId,keys:[]})}function Js({programId:r,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:o,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:f,userCoinVault:b,userPcVault:y,userLpVault:g,nonce:A,openTime:w,coinAmount:h,pcAmount:T,ammConfigId:k,feeDestinationId:x}){let S=E([G("instruction"),G("nonce"),P("openTime"),P("pcAmount"),P("coinAmount")]),K=[{pubkey:Ji,isSigner:!1,isWritable:!1},{pubkey:yp,isSigner:!1,isWritable:!1},{pubkey:bp.programId,isSigner:!1,isWritable:!1},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:k,isSigner:!1,isWritable:!1},{pubkey:x,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!0,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],I=Buffer.alloc(S.span);return S.encode({instruction:1,nonce:A,openTime:w,coinAmount:h,pcAmount:T},I),{instruction:new ci({keys:K,programId:r,data:I}),instructionType:U.AmmV4CreatePool}}function gp({poolKeys:r,userKeys:e,amountIn:t,minAmountOut:n},i){let o=ot(r),s=Buffer.alloc(zs.span);zs.encode({instruction:9,amountIn:$(t),minAmountOut:$(n)},s);let a=[B({pubkey:Ji,isWritable:!1}),B({pubkey:o.id}),B({pubkey:o.authority,isWritable:!1}),B({pubkey:o.openOrders})];return i===4&&a.push(B({pubkey:o.targetOrders})),a.push(B({pubkey:o.vault.A}),B({pubkey:o.vault.B})),i===5&&a.push(B({pubkey:ui})),a.push(B({pubkey:o.marketProgramId,isWritable:!1}),B({pubkey:o.marketId}),B({pubkey:o.marketBids}),B({pubkey:o.marketAsks}),B({pubkey:o.marketEventQueue}),B({pubkey:o.marketBaseVault}),B({pubkey:o.marketQuoteVault}),B({pubkey:o.marketAuthority,isWritable:!1}),B({pubkey:e.tokenAccountIn}),B({pubkey:e.tokenAccountOut}),B({pubkey:e.owner,isWritable:!1,isSigner:!0})),new ci({programId:o.programId,keys:a,data:s})}function Ap({poolKeys:r,userKeys:e,maxAmountIn:t,amountOut:n},i){let o=ot(r),s=Buffer.alloc(js.span);js.encode({instruction:11,maxAmountIn:$(t),amountOut:$(n)},s);let a=[B({pubkey:Ji,isWritable:!1}),B({pubkey:o.id}),B({pubkey:o.authority,isWritable:!1}),B({pubkey:o.openOrders}),B({pubkey:o.targetOrders}),B({pubkey:o.vault.A}),B({pubkey:o.vault.B})];return i===5&&a.push(B({pubkey:ui})),a.push(B({pubkey:o.marketProgramId,isWritable:!1}),B({pubkey:o.marketId}),B({pubkey:o.marketBids}),B({pubkey:o.marketAsks}),B({pubkey:o.marketEventQueue}),B({pubkey:o.marketBaseVault}),B({pubkey:o.marketQuoteVault}),B({pubkey:o.marketAuthority,isWritable:!1}),B({pubkey:e.tokenAccountIn}),B({pubkey:e.tokenAccountOut}),B({pubkey:e.owner,isWritable:!1,isSigner:!0})),new ci({programId:o.programId,keys:a,data:s})}function br(r){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:o,fixedSide:s}=r;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return gp(q(v({},a),{amountIn:i,minAmountOut:o}),t);if(s==="out")return Ap(q(v({},a),{maxAmountIn:i,amountOut:o}),t);pc.logWithError("invalid params","params",r)}throw pc.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{PublicKey as kp}from"@solana/web3.js";import uI from"bn.js";import{TOKEN_PROGRAM_ID as hp}from"@solana/spl-token";import{PublicKey as Pp}from"@solana/web3.js";var wp=fe("Raydium_liquidity_serum");function bc({programId:r,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let o=t.concat(Buffer.from([n]),Buffer.alloc(7));i=Pp.createProgramAddressSync(o,r)}catch(o){if(o instanceof TypeError)throw o;n++;continue}return{publicKey:i,nonce:n}}throw wp.logWithError("unable to find a viable program address nonce","params",{programId:r,marketId:e}),new Error("unable to find a viable program address nonce")}function yr({programId:r}){let{publicKey:e}=le([Buffer.from("amm_config_account_seed","utf-8")],r);return e}function qn({name:r,programId:e,marketId:t}){let{publicKey:n}=le([e.toBuffer(),t.toBuffer(),Buffer.from(r,"utf-8")],e);return n}function Tp({programId:r,marketId:e}){let{publicKey:t}=le([r.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],r);return t}function ta({programId:r}){return le([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],r)}function na({version:r,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:o,quoteDecimals:s,programId:a,marketProgramId:c}){let u=qn({name:"amm_associated_seed",programId:a,marketId:t}),l=qn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=ta({programId:a}),p=qn({name:"coin_vault_associated_seed",programId:a,marketId:t}),f=qn({name:"pc_vault_associated_seed",programId:a,marketId:t}),b=qn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),y=Tp({programId:a,marketId:t}),g=qn({name:"target_associated_seed",programId:a,marketId:t}),A=qn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:w}=bc({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:o,quoteDecimals:s,lpDecimals:o,version:r,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:f,lpVault:b,openOrders:y,targetOrders:g,withdrawQueue:A,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:w,lookupTableAccount:kp.default,configId:yr({programId:a})}}var ea={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},gr=r=>{let e={},t=hp.toBase58();return Object.keys(r).map(n=>{let i=r[n],[o,s]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:dt({address:o,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:dt({address:s,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new O(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new O(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new O(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:ea,week:ea,month:ea,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:yr({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:new O(i.lpReserve.toString()).div(10**Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())).toNumber(),lpMint:dt({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};import De from"bn.js";import{PublicKey as eo}from"@solana/web3.js";import to from"bn.js";import{TOKEN_PROGRAM_ID as Pc}from"@solana/spl-token";import{SystemProgram as Un,SYSVAR_RENT_PUBKEY as Bp,Transaction as yc,TransactionInstruction as Sp}from"@solana/web3.js";import{createInitializeAccountInstruction as gc,TOKEN_PROGRAM_ID as Ac}from"@solana/spl-token";function Ip(r="accountFlags"){let e=new or(r);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var ia=E([ke(5),Ip("accountFlags"),N("ownAddress"),P("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),N("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),ke(7)]);function xp({programId:r,marketInfo:e}){let t=E([G("version"),lt("instruction"),P("baseLotSize"),P("quoteLotSize"),Xt("feeRateBps"),P("vaultSignerNonce"),P("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Bp,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new Sp({keys:n,programId:r,data:i})}async function Ar({connection:r,wallet:e,marketInfo:t}){var s,a,c,u,l,m,d,p;let n=new yc,i=await r.getMinimumBalanceForRentExemption(165);n.add(Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:Ac}),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:Ac}),gc(t.baseVault.publicKey,t.baseMint,t.vaultOwner),gc(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await r.getMinimumBalanceForRentExemption(ia.span),space:ia.span,programId:t.programId}));let o=new yc;return o.add(Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await r.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:t.lowestFeeMarket?764:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await r.getMinimumBalanceForRentExemption((c=t.eventQueueSpace)!=null?c:262144+12),space:t.lowestFeeMarket?11308:(u=t.eventQueueSpace)!=null?u:262144+12,programId:t.programId}),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:t.lowestFeeMarket?14524:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:t.lowestFeeMarket?14524:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),xp({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[U.CreateAccount,U.CreateAccount,U.InitAccount,U.InitAccount]},{transaction:o,signer:[],instructionTypes:[U.CreateAccount,U.CreateAccount,U.CreateAccount,U.CreateAccount,U.CreateAccount,U.InitMarket]}]}var li=class extends Le{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:i,dexProgramId:o,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:f}){let b=this.scope.ownerPubKey,y=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=qe({fromPublicKey:b,programId:o,assignSeed:y&&`${y}-market`}),A=qe({fromPublicKey:b,programId:o,assignSeed:y&&`${y}-request`}),w=qe({fromPublicKey:b,programId:o,assignSeed:y&&`${y}-event`}),h=qe({fromPublicKey:b,programId:o,assignSeed:y&&`${y}-bids`}),T=qe({fromPublicKey:b,programId:o,assignSeed:y&&`${y}-asks`}),k=qe({fromPublicKey:b,programId:Pc,assignSeed:y&&`${y}-baseVault`}),x=qe({fromPublicKey:b,programId:Pc,assignSeed:y&&`${y}-quoteVault`}),S=0,K=new to(100);function I(){let H=new to(0);for(;;)try{return{vaultOwner:eo.createProgramAddressSync([g.publicKey.toBuffer(),H.toArrayLike(Buffer,"le",8)],o),vaultSignerNonce:H}}catch{if(H.iaddn(1),H.gt(new to(25555)))throw Error("find vault owner error")}}let{vaultOwner:C,vaultSignerNonce:L}=I(),R=new to(Math.round(10**e.decimals*n)),_=new to(Math.round(n*10**t.decimals*i));if(R.eq(wt))throw Error("lot size is too small");if(_.eq(wt))throw Error("tick size or lot size is too small");let M=await Ar({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:o,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:k,quoteVault:x,vaultOwner:C,requestQueue:A,eventQueue:w,bids:h,asks:T,feeRateBps:S,quoteDustThreshold:K,vaultSignerNonce:L,baseLotSize:R,quoteLotSize:_,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),V=this.createTxBuilder(f);V.addInstruction({instructions:M[0].transaction.instructions,signers:M[0].signer});for await(let H of M.slice(1,M.length))V.addInstruction({instructions:H.transaction.instructions,signers:H.signer,instructionTypes:H.instructionTypes});return m===0?V.sizeCheckBuildV0({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:A.publicKey,eventQueue:w.publicKey,bids:h.publicKey,asks:T.publicKey,baseVault:k.publicKey,quoteVault:x.publicKey,baseMint:new eo(e.mint),quoteMint:new eo(t.mint)}}):V.sizeCheckBuild({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:A.publicKey,eventQueue:w.publicKey,bids:h.publicKey,asks:T.publicKey,baseVault:k.publicKey,quoteVault:x.publicKey,baseMint:new eo(e.mint),quoteMint:new eo(t.mint)}})}};var no=class extends Le{constructor(t){super(t);this.stableLayout=new $i({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:i,baseIn:o}){let s=new De(new O(n).mul(10**t[o?"mintA":"mintB"].decimals).toFixed(0)),a=pr(t[o?"mintB":"mintA"]),[c,u]=[new De(new O(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new De(new O(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new De(new O(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",c.toString(),"quoteReserve:",u.toString()),this.logDebug("tokenIn:",o?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",o?t.mintB.symbol:t.mintA.symbol,"slippage:",`${i.toSignificant()}%`,"baseReserve",c.toString(),"quoteReserve",u.toString());let m=o?"base":"quote";this.logDebug("input side:",m);let d=wt;s.isZero()||(d=m==="base"?Mo(s.mul(u),c):Mo(s.mul(c),u)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=Mo(s.mul(l),m==="base"?c:u);this.logDebug("liquidity:",p.toString());let f=new Je(new De(1)).add(i),b=new Je(new De(1)).sub(i),y=f.mul(d).quotient,g=b.mul(d).quotient,A=new he(a,d),w=new he(a,y),h=new he(a,g);return this.logDebug("anotherAmount:",A.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:A,maxAnotherAmount:w,minAnotherAmount:h,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:i,amountInA:o,amountInB:s,otherAmountMin:a,fixedSide:c,config:u,txVersion:l,computeBudgetConfig:m,txTipConfig:d,feePayer:p}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",o,"amountInB:",s),(o.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:o.toFixed(),amountInB:s.toFixed()});let{account:f}=this.scope,{bypassAssociatedCheck:b,checkCreateATAOwner:y}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),[g,A]=[o.token,s.token],w=await f.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1}),h=await f.getCreatedTokenAccount({mint:A.mint,associatedOnly:!1});!w&&!h&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",f.tokenAccounts);let T=await f.getCreatedTokenAccount({mint:new Qe(n.lpMint.address)}),k=[g,A],x=[w,h],S=[o.raw,s.raw],K=o.token.mint.toBase58()===n.mintA.address?"base":"quote",I="base";["quote","base"].includes(K)||this.logAndCreateError("invalid fixedSide","fixedSide",c),K==="quote"?(k.reverse(),x.reverse(),S.reverse(),I=c==="a"?"quote":"base"):K==="base"&&(I=c==="a"?"base":"quote");let[C,L]=k,[R,_]=x,[M,V]=S,H=i!=null?i:await this.getAmmPoolKeys(n.id),re=this.createTxBuilder(p),ft=await f.handleTokenAccount({side:"in",amount:M,mint:C.mint,tokenAccount:R,bypassAssociatedCheck:b,checkCreateATAOwner:y}),{tokenAccount:ge}=ft,ae=Ee(ft,["tokenAccount"]);re.addInstruction(ae);let We=await f.handleTokenAccount({side:"in",amount:V,mint:L.mint,tokenAccount:_,bypassAssociatedCheck:b,checkCreateATAOwner:y}),{tokenAccount:me}=We,xe=Ee(We,["tokenAccount"]);re.addInstruction(xe);let st=await f.handleTokenAccount({side:"out",amount:0,mint:new Qe(n.lpMint.address),tokenAccount:T,bypassAssociatedCheck:b,checkCreateATAOwner:y}),{tokenAccount:je}=st,Mt=Ee(st,["tokenAccount"]);return re.addInstruction(Mt),re.addInstruction({instructions:[fc({poolInfo:n,poolKeys:H,userKeys:{baseTokenAccount:ge,quoteTokenAccount:me,lpTokenAccount:je,owner:this.scope.ownerPubKey},baseAmountIn:M,quoteAmountIn:V,otherAmountMin:a.raw,fixedSide:I})],instructionTypes:[n.pooltype.includes("StablePool")?U.AmmV5AddLiquidity:U.AmmV4AddLiquidity],lookupTableAddress:H.lookupTableAccount?[H.lookupTableAccount]:[]}),re.addCustomComputeBudget(m),re.addTipInstruction(d),l===0?await re.buildV0():re.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:i,lpAmount:o,baseAmountMin:s,quoteAmountMin:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=t,p=i!=null?i:await this.getAmmPoolKeys(n.id),[f,b,y]=[new Qe(n.mintA.address),new Qe(n.mintB.address),new Qe(n.lpMint.address)];this.logDebug("lpAmount:",o),this.logDebug("baseAmountMin:",s),this.logDebug("quoteAmountMin:",a),o.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",o.toString());let{account:g}=this.scope,A=await g.getCreatedTokenAccount({mint:y,associatedOnly:!1});A||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",g.tokenAccounts);let w=await g.getCreatedTokenAccount({mint:f}),h=await g.getCreatedTokenAccount({mint:b}),T=this.createTxBuilder(d),{bypassAssociatedCheck:k,checkCreateATAOwner:x}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),L=await g.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:w,bypassAssociatedCheck:k,checkCreateATAOwner:x}),{tokenAccount:S}=L,K=Ee(L,["tokenAccount"]);T.addInstruction(K);let R=await g.handleTokenAccount({side:"out",amount:0,mint:b,tokenAccount:h,bypassAssociatedCheck:k,checkCreateATAOwner:x}),{tokenAccount:I}=R,C=Ee(R,["tokenAccount"]);return T.addInstruction(C),T.addInstruction({instructions:[$s({poolInfo:n,poolKeys:p,userKeys:{lpTokenAccount:A,baseTokenAccount:S,quoteTokenAccount:I,owner:this.scope.ownerPubKey},lpAmount:o,baseAmountMin:s,quoteAmountMin:a})],lookupTableAddress:p.lookupTableAccount?[p.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?U.AmmV5RemoveLiquidity:U.AmmV4RemoveLiquidity]}),T.addCustomComputeBudget(l),T.addTipInstruction(m),u===0?await T.buildV0():T.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:i,createPositionInfo:o,farmInfo:s,userFarmLpAmount:a,base:c,computeBudgetConfig:u,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=Kn,checkCreateATAOwner:p=!0,getEphemeralSigners:f,txVersion:b,feePayer:y}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let g=this.createTxBuilder(y),A={};for(let H of this.scope.account.tokenAccountRawInfos)(A[H.accountInfo.mint.toString()]===void 0||ie(this.scope.ownerPubKey,H.accountInfo.mint,Kn).publicKey.equals(H.pubkey))&&(A[H.accountInfo.mint.toString()]=H.pubkey);let w=A[t.lpMint.address];if(w===void 0)throw Error("find lp account error in trade accounts");let h=i.add(a!=null?a:new De(0)),T=t.mintA.address===Me.WSOL.mint.toString(),k=t.mintB.address===Me.WSOL.mint.toString(),{account:x,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Kn,mint:new Qe(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:T?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(S||{}),x===void 0)throw new Error("base token account not found");let{account:K,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Kn,mint:new Qe(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(I||{}),K===void 0)throw new Error("quote token account not found");if(A[t.mintA.address]=x,A[t.mintB.address]=K,s!==void 0&&!(a!=null&&a.isZero())){let H=Kt[s.programId],re=Ct({programId:new Qe(s.programId),poolId:new Qe(s.id),owner:this.scope.ownerPubKey,version:H}),ge,ae=await this.scope.connection.getAccountInfo(re);if(ae&&(ge=Oi(H).decode(ae.data)),H!==6&&!ge){let{instruction:st,instructionType:jt}=Mi({id:new Qe(s.id),programId:new Qe(s.programId),version:H,ledger:re,owner:this.scope.ownerPubKey});g.addInstruction({instructions:[st],instructionTypes:[jt]})}let me=[];for(let st of s.rewardInfos){let jt=st.mint.address===Me.WSOL.mint.toString();if(A[st.mint.address])me.push(A[st.mint.address]);else{let{account:nn,instructionParams:_t}=await this.scope.account.getOrCreateTokenAccount({mint:new Qe(st.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!jt,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});nn||this.logAndCreateError("farm reward account not found:",st.mint.address),_t&&g.addInstruction(_t),me.push(nn)}}let xe=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],je={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:xe,lpAccount:w,rewardAccounts:me},Mt=Kt[s.programId],ft=Mt===6?_i(je):Mt===5?Ei(je):Vi(je),We={3:U.FarmV3Withdraw,5:U.FarmV5Withdraw,6:U.FarmV6Withdraw};g.addInstruction({instructions:[ft],instructionTypes:[We[Mt]]})}let C=await this.getAmmPoolKeys(t.id),L=$s({poolInfo:t,poolKeys:C,userKeys:{lpTokenAccount:w,baseTokenAccount:x,quoteTokenAccount:K,owner:this.scope.ownerPubKey},lpAmount:h,baseAmountMin:0,quoteAmountMin:0});g.addInstruction({instructions:[L],instructionTypes:[t.pooltype.includes("StablePool")?U.AmmV5RemoveLiquidity:U.AmmV4RemoveLiquidity],lookupTableAddress:C.lookupTableAccount?[C.lookupTableAccount]:[]});let[R,_]=t.mintA.address===n.mintA.address?[x,K]:[K,x],M=await this.scope.clmm.getClmmPoolKeys(n.id),V=await Se.openPositionFromBaseInstructions(q(v({poolInfo:n,poolKeys:M,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:R,tokenAccountB:_},withMetadata:"create"},o),{base:c,getEphemeralSigners:f}));return g.addInstruction({instructions:[...V.instructions],signers:V.signers,instructionTypes:[...V.instructionTypes],lookupTableAddress:M.lookupTableAccount?[M.lookupTableAccount]:[]}),b===0?g.sizeCheckBuildV0({computeBudgetConfig:u}):g.sizeCheckBuild({computeBudgetConfig:u})}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:i,quoteMintInfo:o,baseAmount:s,quoteAmount:a,startTime:c,ownerInfo:u,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:f,computeBudgetConfig:b,txTipConfig:y,feePayer:g}){var _;let A=u.feePayer||((_=this.scope.owner)==null?void 0:_.publicKey),w=u.useSOLBalance&&i.mint.equals(Pr),h=u.useSOLBalance&&o.mint.equals(Pr),T=this.createTxBuilder(g),{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:w?{payer:A,amount:s}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:l,checkCreateATAOwner:m});T.addInstruction(x||{});let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:h?{payer:A,amount:a}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:l,checkCreateATAOwner:m});if(T.addInstruction(K||{}),k===void 0||S===void 0)throw Error("you don't has some token account");let I=na({version:4,marketVersion:3,marketId:n.marketId,baseMint:i.mint,quoteMint:o.mint,baseDecimals:i.decimals,quoteDecimals:o.decimals,programId:t,marketProgramId:n.programId}),C={programId:t,ammId:I.id,ammAuthority:I.authority,ammOpenOrders:I.openOrders,lpMint:I.lpMint,coinMint:I.baseMint,pcMint:I.quoteMint,coinVault:I.baseVault,pcVault:I.quoteVault,withdrawQueue:I.withdrawQueue,ammTargetOrders:I.targetOrders,poolTempLp:I.lpVault,marketProgramId:I.marketProgramId,marketId:I.marketId,ammConfigId:I.configId,feeDestinationId:f},{instruction:L,instructionType:R}=Js(q(v({},C),{userWallet:this.scope.ownerPubKey,userCoinVault:k,userPcVault:S,userLpVault:ie(this.scope.ownerPubKey,I.lpMint,d).publicKey,nonce:I.nonce,openTime:c,coinAmount:s,pcAmount:a}));return T.addInstruction({instructions:[L],instructionTypes:[R]}),T.addCustomComputeBudget(b),T.addTipInstruction(y),T.versionBuild({txVersion:p,extInfo:{address:C}})}async createMarketAndPoolV4({programId:t=Fo,marketProgram:n=Za,feeDestinationId:i=Ja,tokenProgram:o,baseMintInfo:s,quoteMintInfo:a,baseAmount:c,quoteAmount:u,startTime:l,ownerInfo:m,lowestFeeMarket:d,assignSeed:p,associatedOnly:f=!1,checkCreateATAOwner:b=!1,lotSize:y=1,tickSize:g=.01,txVersion:A,computeBudgetConfig:w,txTipConfig:h,feePayer:T}){var yi,Tt,ko;let k=this.scope.ownerPubKey,x=m.feePayer||((yi=this.scope.owner)==null?void 0:yi.publicKey),S=m.useSOLBalance&&s.mint.equals(Pr),K=m.useSOLBalance&&a.mint.equals(Pr),I=p?`${s.mint.toBase58().slice(0,7)}-${a.mint.toBase58().slice(0,7)}-${p}`:void 0,C=qe({fromPublicKey:k,programId:n,assignSeed:I&&`${I}-market`}),L=qe({fromPublicKey:k,programId:n,assignSeed:I&&`${I}-request`}),R=qe({fromPublicKey:k,programId:n,assignSeed:I&&`${I}-event`}),_=qe({fromPublicKey:k,programId:n,assignSeed:I&&`${I}-bids`}),M=qe({fromPublicKey:k,programId:n,assignSeed:I&&`${I}-asks`}),V=qe({fromPublicKey:k,programId:Kn,assignSeed:I&&`${I}-baseVault`}),H=qe({fromPublicKey:k,programId:Kn,assignSeed:I&&`${I}-quoteVault`}),re=0,ge=new De(100);function ae(){let Ht=new De(0);for(;;)try{return{vaultOwner:Qe.createProgramAddressSync([C.publicKey.toBuffer(),Ht.toArrayLike(Buffer,"le",8)],n),vaultSignerNonce:Ht}}catch{if(Ht.iaddn(1),Ht.gt(new De(25555)))throw Error("find vault owner error")}}let{vaultOwner:me,vaultSignerNonce:xe}=ae(),je=new De(Math.round(10**s.decimals*y)),Mt=new De(Math.round(y*10**a.decimals*g));if(je.eq(wt))throw Error("lot size is too small");if(Mt.eq(wt))throw Error("tick size or lot size is too small");let ft=await Ar({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:n,vaultOwner:me,baseMint:s.mint,quoteMint:a.mint,id:C,baseVault:V,quoteVault:H,requestQueue:L,eventQueue:R,bids:_,asks:M,feeRateBps:re,quoteDustThreshold:ge,vaultSignerNonce:xe,baseLotSize:je,quoteLotSize:Mt,lowestFeeMarket:d}}),We=this.createTxBuilder(T);We.addInstruction({instructions:ft[0].transaction.instructions,signers:ft[0].signer});for await(let Ht of ft.slice(1,ft.length))We.addInstruction({instructions:Ht.transaction.instructions,signers:Ht.signer,instructionTypes:Ht.instructionTypes});let{account:st,instructionParams:jt}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:x,amount:c}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:f,checkCreateATAOwner:b,assignSeed:S&&I?`${I}-wsol`:void 0});We.addInstruction(jt||{});let{account:nn,instructionParams:_t}=await this.scope.account.getOrCreateTokenAccount({mint:a.mint,owner:this.scope.ownerPubKey,createInfo:K?{payer:x,amount:u}:void 0,notUseTokenAccount:K,skipCloseAccount:!K,associatedOnly:K?!1:f,checkCreateATAOwner:b,assignSeed:K&&I?`${I}-wsol`:void 0});if(We.addInstruction(_t||{}),st===void 0)throw Error("you don't has base token account");if(nn===void 0)throw Error("you don't has quote token account");let He=na({version:4,marketVersion:3,marketId:C.publicKey,baseMint:s.mint,quoteMint:a.mint,baseDecimals:s.decimals,quoteDecimals:a.decimals,programId:t,marketProgramId:n}),Zn={programId:t,ammId:He.id,ammAuthority:He.authority,ammOpenOrders:He.openOrders,lpMint:He.lpMint,coinMint:He.baseMint,pcMint:He.quoteMint,coinVault:He.baseVault,pcVault:He.quoteVault,withdrawQueue:He.withdrawQueue,ammTargetOrders:He.targetOrders,poolTempLp:He.lpVault,marketProgramId:He.marketProgramId,marketId:He.marketId,ammConfigId:He.configId,feeDestinationId:i},{instruction:Po,instructionType:wo}=Js(q(v({},Zn),{userWallet:this.scope.ownerPubKey,userCoinVault:st,userPcVault:nn,userLpVault:ie(this.scope.ownerPubKey,He.lpMint,o).publicKey,nonce:He.nonce,openTime:l,coinAmount:c,pcAmount:u}));We.addInstruction({instructions:[Po],instructionTypes:[wo]});let bi=S||K?[((Tt=jt==null?void 0:jt.instructions)==null?void 0:Tt[0])||((ko=_t==null?void 0:_t.instructions)==null?void 0:ko[0])].filter(Ht=>!!Ht):void 0;return A===0?We.sizeCheckBuildV0({computeBudgetConfig:w,splitIns:bi,address:v({requestQueue:L.publicKey,eventQueue:R.publicKey,bids:_.publicKey,asks:M.publicKey,baseVault:V.publicKey,quoteVault:H.publicKey,baseMint:new Qe(s.mint),quoteMint:new Qe(a.mint)},Zn)}):We.sizeCheckBuild({computeBudgetConfig:w,splitIns:bi,address:v({requestQueue:L.publicKey,eventQueue:R.publicKey,bids:_.publicKey,asks:M.publicKey,baseVault:V.publicKey,quoteVault:H.publicKey,baseMint:new Qe(s.mint),quoteMint:new Qe(a.mint)},Zn)})}async getCreatePoolFee({programId:t}){let n=yr({programId:t}),i=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(i===null)throw Error("get config account error");return ac.decode(i.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:i,mintOut:o,slippage:s}){let[a,c]=[i.toString(),o.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(c!==t.mintA.address&&c!==t.mintB.address)throw new Error("toke not match");let{baseReserve:u,quoteReserve:l}=t,m=[u,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[f,b]=m,[y,g]=d,A=t.version===4,w;if(A)w=new O(b.toString()).div(10**g).div(new O(f.toString()).div(10**y));else{let R=dc(this.stableLayout.stableModelData,u.toNumber(),l.toNumber(),!1);p==="quote"?w=new O(1e6).div(R*1e6):w=new O(R*1e6).div(1e6)}let h=n,T=new De(0),k=new De(0);if(!h.isZero())if(A){k=wn(h.mul(Qs),fr);let R=h.sub(k),_=f.add(R);T=b.mul(R).div(_)}else{k=h.mul(new De(2)).div(new De(1e4));let R=h.sub(k);p==="quote"?T=new De(lc(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),R.toNumber())):T=new De(mc(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),R.toNumber()))}let x=new De(new O(T.toString()).mul(1-s).toFixed(0)),S=T,K=x,I=new O(T.toString()).div(new O(h.sub(k).toString()).toFixed(0));!h.isZero()&&!T.isZero()&&(I=new O(T.toString()).div(10**g).div(new O(h.sub(k).toString()).div(10**y)));let C=w.sub(I).div(w).mul(100);return{amountOut:S,minAmountOut:K,currentPrice:w,executionPrice:I,priceImpact:C,fee:k}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:i,mintOut:o,slippage:s}){let{baseReserve:a,quoteReserve:c}=t;i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),o.toString()!==t.mintA.address&&o.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",c.toString());let u=i.toString()===t.mintA.address,[l,m]=u?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new O(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,c],p=u?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[f,b]=d,y=new O(b.toString()).div(10**t[u?"mintB":"mintA"].decimals).div(new O(f.toString()).div(10**t[u?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${y.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(y).toString()} ${l.symbol||l.address}`);let g=new De(0),A=n;if(!A.isZero()){A.gt(b)&&(A=b.sub(new De(1)));let K=b.sub(A);g=f.mul(A).div(K).mul(fr).div(fr.sub(Qs))}let w=new De(new O(g.toString()).mul(1+s).toFixed(0)),h=g,T=w;this.logDebug("amountIn:",new O(h.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new O(T.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let k=null;!g.isZero()&&!A.isZero()&&(k=new O(A.toString()).div(10**m.decimals).div(new O(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${k.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(k).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let x=y.mul(h.toString()),S=x.sub(n.toString()).abs().div(x);return this.logDebug("priceImpact:",`${S.toString()}%`),{amountIn:h,maxAmountIn:T,currentPrice:y,executionPrice:k,priceImpact:S}}async swap({poolInfo:t,poolKeys:n,amountIn:i,amountOut:o,inputMint:s,fixedSide:a,txVersion:c,config:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}){let p=this.createTxBuilder(d),{associatedOnly:f=!0,inputUseSolBalance:b=!0,outputUseSolBalance:y=!0}=u||{},[g,A]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],w=b&&g.address===Z.toBase58(),h=y&&A.address===Z.toBase58(),{account:T,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Kn,mint:new Qe(g.address),owner:this.scope.ownerPubKey,createInfo:w?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:f});p.addInstruction(k||{}),T||this.logAndCreateError("input token account not found",{token:g.symbol||g.address,tokenAccountIn:T,inputTokenUseSolBalance:w,associatedOnly:f});let{account:x,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Kn,mint:new Qe(A.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:f});p.addInstruction(S||{}),x===void 0&&this.logAndCreateError("output token account not found",{token:A.symbol||A.address,tokenAccountOut:x,outputTokenUseSolBalance:h,associatedOnly:f});let K=n||await this.getAmmPoolKeys(t.id),I=4;return t.pooltype.includes("StablePool")&&(I=5),p.addInstruction({instructions:[br({version:I,poolKeys:K,userKeys:{tokenAccountIn:T,tokenAccountOut:x,owner:this.scope.ownerPubKey},amountIn:i,amountOut:o,fixedSide:a})],instructionTypes:[I===4?U.AmmV4SwapBaseIn:U.AmmV5SwapBaseIn]}),p.addCustomComputeBudget(l),p.addTipInstruction(m),p.versionBuild({txVersion:c})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let i=await Oe(this.scope.connection,t.map(l=>({pubkey:new Qe(l)})),n),o={},s=[];for(let l=0;l<t.length;l++){let m=i[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=Zi.decode(m.accountInfo.data);o[String(t[l])]=q(v({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},c=await Oe(this.scope.connection,s.map(l=>({pubkey:new Qe(l)})),n);for(let l=0;l<s.length;l++){let m=c[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new De(Kp.decode(m.data).amount.toString())}let u={};for(let[l,m]of Object.entries(o)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);u[l]=q(v({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new O(p.toString()).div(new O(10).pow(m.quoteDecimal.toString())).div(new O(d.toString()).div(new O(10).pow(m.baseDecimal.toString())))})}return u}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),i=gr({[t]:n}),o=i[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[i[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:o,poolKeys:s[0]}}};import{PublicKey as j}from"@solana/web3.js";import kt from"bn.js";import{AccountLayout as wc,TOKEN_2022_PROGRAM_ID as Cn,TOKEN_PROGRAM_ID as io}from"@solana/spl-token";var oo=class extends Le{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var x;let{programId:t,owner:n=((x=this.scope.owner)==null?void 0:x.publicKey)||j.default,mint1:i,mint2:o,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:m,txTipConfig:d,feePayer:p}=e,f=this.createTxBuilder(p),[b,y,g]=new kt(new j(i.address).toBuffer()).gt(new kt(new j(o.address).toBuffer()))?[o,i,new O(1).div(a)]:[i,o,a],A=oe.priceToSqrtPriceX64(g,b.decimals,y.decimals),w=[],h=[];b.programId===Cn.toBase58()&&h.push(Ws(t,new j(b.address)).publicKey),y.programId===Cn.toBase58()&&h.push(Ws(t,new j(y.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(h)).forEach((S,K)=>{S&&w.push(h[K])});let k=await Se.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:b,mintB:y,ammConfigId:s.id,initialPriceX64:A,forerunCreate:!l&&u,extendMintAccount:w});return f.addInstruction(k),f.addCustomComputeBudget(c),f.addTipInstruction(d),f.versionBuild({txVersion:m,extInfo:{address:q(v({},k.address),{observationId:k.address.observationId.toBase58(),exBitmapAccount:k.address.exBitmapAccount.toBase58(),programId:t.toString(),id:k.address.poolId.toString(),mintA:b,mintB:y,openTime:"0",vault:{A:k.address.mintAVault.toString(),B:k.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:v({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:k.address.poolId.toString(),mintA:b,mintB:y,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},Uu),forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,withMetadata:d="create",getEphemeralSigners:p,computeBudgetConfig:f,txTipConfig:b,txVersion:y,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let A=this.createTxBuilder(g),w=null,h=null,T=n.useSOLBalance&&e.mintA.address===Z.toString(),k=n.useSOLBalance&&e.mintB.address===Z.toString(),[x,S]=s==="MintA"?[a,c]:[c,a],{account:K,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new j(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:T||x.isZero()?{payer:this.scope.ownerPubKey,amount:x}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:l,checkCreateATAOwner:m});K&&(w=K),A.addInstruction(I||{});let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new j(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:l,checkCreateATAOwner:m});C&&(h=C),A.addInstruction(L||{}),(!w||!h)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:w==null?void 0:w.toBase58(),ownerTokenAccountB:h==null?void 0:h.toBase58()});let R=t||await this.getClmmPoolKeys(e.id),_=await Se.openPositionFromBaseInstructions({poolInfo:e,poolKeys:R,ownerInfo:q(v({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:h}),tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,withMetadata:d,getEphemeralSigners:p,nft2022:u});return A.addInstruction(_),A.addCustomComputeBudget(f),A.addTipInstruction(b),A.versionBuild({txVersion:y,extInfo:v({},_.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:i,amountMaxB:o,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,txTipConfig:f,getEphemeralSigners:b,nft2022:y,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let A=this.createTxBuilder(g),w=null,h=null,T=n.useSOLBalance&&e.mintA.address===Z.toBase58(),k=n.useSOLBalance&&e.mintB.address===Z.toBase58(),{account:x,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new j(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:T||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:u,checkCreateATAOwner:l});x&&(w=x),A.addInstruction(S||{});let{account:K,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new j(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:u,checkCreateATAOwner:l});K&&(h=K),A.addInstruction(I||{}),(w===void 0||h===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let C=t||await this.getClmmPoolKeys(e.id),L=await Se.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:h},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:i,amountMaxB:o,withMetadata:m,getEphemeralSigners:b,nft2022:y});return A.addInstruction(L),A.addCustomComputeBudget(p),A.addTipInstruction(f),A.versionBuild({txVersion:d,extInfo:{address:L.address}})}async increasePositionFromLiquidity(e){var I;let{poolInfo:t,poolKeys:n,ownerPosition:i,amountMaxA:o,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:f}=e,b=this.createTxBuilder(f),y,g,A=c.useSOLBalance&&t.mintA.address===Z.toString(),w=c.useSOLBalance&&t.mintB.address===Z.toString(),{account:h,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:A||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!A,associatedOnly:A?!1:u,checkCreateATAOwner:l});h&&(y=h),b.addInstruction(T||{});let{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});k&&(g=k),b.addInstruction(x||{}),!y&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=n!=null?n:await this.getClmmPoolKeys(t.id),K=Se.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:g},liquidity:a,amountMaxA:o,amountMaxB:s,nft2022:(I=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:I.owner.equals(Cn)});return b.addInstruction(K),b.addCustomComputeBudget(m),b.addTipInstruction(d),b.versionBuild({txVersion:p,extInfo:{address:K.address}})}async increasePositionFromBase(e){var K;let{poolInfo:t,ownerPosition:n,base:i,baseAmount:o,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,f=this.createTxBuilder(p),b,y,g=a.useSOLBalance&&t.mintA.address===Z.toString(),A=a.useSOLBalance&&t.mintB.address===Z.toString(),{account:w,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(i==="MintA"?o:s).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?o:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});w&&(b=w),f.addInstruction(h||{});let{account:T,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:A||(i==="MintA"?s:o).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?s:o}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:c,checkCreateATAOwner:u});T&&(y=T),f.addInstruction(k||{}),!b&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let x=await this.getClmmPoolKeys(t.id),S=Se.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:x,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:y},base:i,baseAmount:o,otherAmountMax:s,nft2022:(K=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:K.owner.equals(Cn)});return f.addInstruction(S),f.addCustomComputeBudget(l),f.addTipInstruction(m),f.versionBuild({txVersion:d,extInfo:{address:S.address}})}async decreaseLiquidity(e){var R;let{poolInfo:t,poolKeys:n,ownerPosition:i,ownerInfo:o,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:f}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let b=this.createTxBuilder(f),y=o.useSOLBalance&&t.mintA.address===Z.toString(),g=o.useSOLBalance&&t.mintB.address===Z.toString(),A,w,{account:h,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:l});A=h,T&&b.addInstruction(T);let{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});w=k,x&&b.addInstruction(x);let S=[];for(let _ of t.rewardDefaultInfos){let M=o.useSOLBalance&&_.mint.address===Z.toString(),V;if(_.mint.address===t.mintA.address)V=A;else if(_.mint.address===t.mintB.address)V=w;else{let{account:H,instructionParams:re}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(_.mint.programId),mint:new j(_.mint.address),notUseTokenAccount:M,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!M,associatedOnly:M?!1:u,checkCreateATAOwner:l});V=H,re&&b.addInstruction(re)}S.push(V)}!A&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let K=n!=null?n:await this.getClmmPoolKeys(t.id),I=(R=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:R.owner.equals(Cn),C=await Se.decreaseLiquidityInstructions({poolInfo:t,poolKeys:K,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:w,rewardAccounts:S},liquidity:c,amountMinA:s,amountMinB:a,nft2022:I});b.addInstruction({instructions:C.instructions,instructionTypes:[U.ClmmDecreasePosition]});let L=v({},C.address);if(o.closePosition){let _=await Se.closePositionInstructions({poolInfo:t,poolKeys:K,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:i,nft2022:I});b.addInstruction({endInstructions:_.instructions,endInstructionTypes:_.instructionTypes}),L=v(v({},L),_.address)}return b.addCustomComputeBudget(m),b.addTipInstruction(d),b.versionBuild({txVersion:p,extInfo:{address:L}})}async lockPosition(e){var f;let{programId:t=Bi,authProgramId:n=Do,poolProgramId:i=On,ownerPosition:o,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:m}=e,d=this.createTxBuilder(m),p=await Se.makeLockPositions({programId:t,authProgramId:n,poolProgramId:i,wallet:this.scope.ownerPubKey,payer:s!=null?s:this.scope.ownerPubKey,nftMint:o.nftMint,getEphemeralSigners:l,nft2022:(f=await this.scope.connection.getAccountInfo(o.nftMint))==null?void 0:f.owner.equals(Cn)});return d.addInstruction(p),d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=Bi,authProgramId:n=Do,clmmProgram:i=On,poolKeys:o,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,f=o||await this.getClmmPoolKeys(s.poolId.toString()),b=this.createTxBuilder(p),y=await this.scope.connection.getAccountInfo(s.positionId);y||this.logger.logWithError("position not found",s.positionId);let g=ji.decode(y.data),A=a.useSOLBalance&&f.mintA.address===Z.toString(),w=a.useSOLBalance&&f.mintB.address===Z.toString(),h,T,{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintA.programId,mint:new j(f.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,associatedOnly:A?!1:c,checkCreateATAOwner:u});h=k,x&&b.addInstruction(x);let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintB.programId,mint:new j(f.mintB.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});T=S,K&&b.addInstruction(K);let I={},C=[];for(let me of f.rewardInfos){let xe=a.useSOLBalance&&me.mint.address===Z.toString(),je=I[me.mint.address];if(!je){let{account:Mt,instructionParams:ft}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(me.mint.programId),mint:new j(me.mint.address),notUseTokenAccount:xe,owner:this.scope.ownerPubKey,skipCloseAccount:!xe,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:xe?!1:c});je=Mt,ft&&b.addInstruction(ft)}I[me.mint.address]=je,C.push(je)}let L=Gi(t,s.lockNftMint).publicKey,R=ie(this.scope.ownerPubKey,s.lockNftMint,io).publicKey,_=Y.getTickArrayStartIndexByTick(g.tickLower,f.config.tickSpacing),M=Y.getTickArrayStartIndexByTick(g.tickUpper,f.config.tickSpacing),{publicKey:V}=ye(new j(f.programId),s.poolId,_),{publicKey:H}=ye(new j(f.programId),s.poolId,M),{publicKey:re}=Qt(new j(f.programId),s.poolId,g.tickLower,g.tickUpper),ge=[];for(let me=0;me<f.rewardInfos.length;me++)ge.push({poolRewardVault:new j(f.rewardInfos[me].vault),ownerRewardVault:C[me],rewardMint:new j(f.rewardInfos[me].mint.address)});let ae=await Se.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:L,clmmProgram:i,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:R,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:re,vaultA:new j(f.vault.A),vaultB:new j(f.vault.B),tickArrayLower:V,tickArrayUpper:H,userVaultA:h,userVaultB:T,mintA:new j(f.mintA.address),mintB:new j(f.mintB.address),rewardAccounts:ge,exTickArrayBitmap:Ue(i,s.poolId).publicKey});return b.addInstruction({instructions:[ae],instructionTypes:[U.ClmmHarvestLockPosition]}),b.addCustomComputeBudget(l),b.addTipInstruction(m),b.versionBuild({txVersion:d})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:i,computeBudgetConfig:o,txTipConfig:s,feePayer:a}){var m;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t!=null?t:await this.getClmmPoolKeys(e.id),l=Se.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(m=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:m.owner.equals(Cn)});return c.addCustomComputeBudget(o),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:i,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===Z.toString(),m=n.perSecond.mul(n.endTime-n.openTime),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(n.mint.address),mint:new j(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new kt(new O(m.toFixed(0)).gte(m)?m.toFixed(0):m.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:i,checkCreateATAOwner:o});p&&u.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=Se.initRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{programId:new j(n.mint.programId),mint:new j(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:se.decimalToX64(n.perSecond)}});return u.addInstruction(b),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:b.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of i)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let m=this.createTxBuilder(l),d={};for(let p of i){let f=n.useSOLBalance&&p.mint.address===Z.toString(),b=p.perSecond.mul(p.endTime-p.openTime),{account:y,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(p.mint.programId),mint:new j(p.mint.address),notUseTokenAccount:!!f,skipCloseAccount:!f,owner:this.scope.ownerPubKey,createInfo:f?{payer:n.feePayer||this.scope.ownerPubKey,amount:new kt(new O(b.toFixed(0)).gte(b)?b.toFixed(0):b.add(1).toFixed(0))}:void 0,associatedOnly:f?!1:o,checkCreateATAOwner:s});g&&m.addInstruction(g),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let A=t!=null?t:await this.getClmmPoolKeys(e.id),w=Se.initRewardInstructions({poolInfo:e,poolKeys:A,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{programId:new j(p.mint.programId),mint:new j(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:se.decimalToX64(p.perSecond)}});d=v(v({},d),w.address),m.addInstruction(w)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),m=t.useSOLBalance&&n.mint.equals(Z),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new kt(new O(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:i,checkCreateATAOwner:o});p&&l.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=Se.setRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:se.decimalToX64(n.perSecond)}});return l.addInstruction(b),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:b.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let m=this.createTxBuilder(l),d={};for(let p of i){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let f=n.useSOLBalance&&p.mint.address===Z.toString(),{account:b,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(p.mint.programId),mint:new j(p.mint.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:n.feePayer||this.scope.ownerPubKey,amount:new kt(new O(p.perSecond.sub(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.sub(p.endTime-p.openTime))?p.perSecond.sub(p.endTime-p.openTime).toFixed(0):p.perSecond.sub(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:f?!1:o,checkCreateATAOwner:s});y&&m.addInstruction(y),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t!=null?t:await this.getClmmPoolKeys(e.id),A=Se.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{mint:new j(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:se.decimalToX64(p.perSecond)}});m.addInstruction(A),d=v(v({},d),A.address)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let m=this.createTxBuilder(u),d=t.useSOLBalance&&n.equals(Z),{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(l.mint.programId),mint:n,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:i,checkCreateATAOwner:o});f&&m.addInstruction(f),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=await this.getClmmPoolKeys(e.id),y=Se.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return m.addInstruction(y),m.addCustomComputeBudget(s),m.addTipInstruction(a),m.versionBuild({txVersion:c,extInfo:{address:y.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let m of n){let d=e.rewardDefaultInfos.find(A=>A.mint.address===m.toString());if(!d){this.logAndCreateError("reward mint error","not found reward mint",m);continue}let p=t.useSOLBalance&&m.equals(Z),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(d.mint.programId),mint:m,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:i,checkCreateATAOwner:o});f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),b&&u.addInstruction(b);let y=await this.getClmmPoolKeys(e.id),g=Se.collectRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardMint:m});u.addInstruction(g),l=v(v({},l),g.address)}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:i,amountOutMin:o,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:f,feePayer:b}){let y=this.createTxBuilder(b),g=n.toString()===e.mintA.address,A=c.useSOLBalance&&e.mintA.address===Z.toBase58(),w=c.useSOLBalance&&e.mintB.address===Z.toBase58(),h;!s||s.equals(new O(0))?h=g?Nt.add(new kt(1)):Ot.sub(new kt(1)):h=oe.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let T;if(!T){let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new j(e.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:A||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?i:0}:void 0,associatedOnly:A?!1:l,checkCreateATAOwner:m});T=S,K&&y.addInstruction(K)}let k;if(!k){let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new j(e.mintB.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:i}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:m});k=S,K&&y.addInstruction(K)}(!T||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:T,ownerTokenAccountB:k,mintAUseSOLBalance:A,mintBUseSOLBalance:w,associatedOnly:l});let x=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Se.makeSwapBaseInInstructions({poolInfo:e,poolKeys:x,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:T,tokenAccountB:k},inputMint:new j(n),amountIn:i,amountOutMin:o,sqrtPriceLimitX64:h,remainingAccounts:u})),y.addCustomComputeBudget(p),y.addTipInstruction(f),y.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:i,amountInMax:o,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:f,feePayer:b}){let y=this.createTxBuilder(b),g=n.toString()===e.mintB.address,A=c.useSOLBalance&&e.mintA.address===Z.toBase58(),w=c.useSOLBalance&&e.mintB.address===Z.toBase58(),h;!s||s.equals(new O(0))?h=n.toString()===e.mintB.address?Nt.add(new kt(1)):Ot.sub(new kt(1)):h=oe.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let T;if(!T){let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new j(e.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:A||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?o:0}:void 0,associatedOnly:A?!1:l,checkCreateATAOwner:m});T=S,K&&y.addInstruction(K)}let k;if(!k){let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new j(e.mintB.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:o}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:m});k=S,K&&y.addInstruction(K)}(!T||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:T,ownerTokenAccountB:k,mintAUseSOLBalance:A,mintBUseSOLBalance:w,associatedOnly:l});let x=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Se.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:x,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:T,tokenAccountB:k},outputMint:new j(n),amountOut:i,amountInMax:o,sqrtPriceLimitX64:h,remainingAccounts:u})),y.addCustomComputeBudget(p),y.addTipInstruction(f),y.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){var y,g;let m={};for(let A of this.scope.account.tokenAccountRawInfos)o?ie(this.scope.ownerPubKey,A.accountInfo.mint,a).publicKey.equals(A.pubkey)&&(m[A.accountInfo.mint.toString()]=A.pubkey):m[A.accountInfo.mint.toString()]=A.pubkey;let d=Object.values(t).flat().map(A=>A.nftMint),p=await Oe(this.scope.connection,d.map(A=>({pubkey:A}))),f={};p.forEach(A=>{var w,h;f[A.pubkey.toBase58()]=(h=(w=A==null?void 0:A.accountInfo)==null?void 0:w.owner)!=null?h:null});let b=this.createTxBuilder(l);for(let A of Object.values(e)){if(t[A.id]===void 0||!t[A.id].find(C=>!C.liquidity.isZero()||C.rewardInfos.find(L=>!L.rewardAmountOwed.isZero())))continue;let w=A,h=i.useSOLBalance&&w.mintA.address===Z.toString(),T=i.useSOLBalance&&w.mintB.address===Z.toString(),k=m[w.mintA.address];if(!k){let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:w.mintA.programId,mint:new j(w.mintA.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,skipCloseAccount:!h,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:h?!1:o,checkCreateATAOwner:s});k=C,L&&b.addInstruction(L)}let x=m[w.mintB.address];if(!x){let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:w.mintB.programId,mint:new j(w.mintB.address),notUseTokenAccount:T,owner:this.scope.ownerPubKey,skipCloseAccount:!T,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:T?!1:o,checkCreateATAOwner:s});x=C,L&&b.addInstruction(L)}m[w.mintA.address]=k,m[w.mintB.address]=x;let S=[];for(let C of w.rewardDefaultInfos){let L=i.useSOLBalance&&C.mint.address===Z.toString(),R=m[C.mint.address];if(!R){let{account:_,instructionParams:M}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(C.mint.programId),mint:new j(C.mint.address),notUseTokenAccount:L,owner:this.scope.ownerPubKey,skipCloseAccount:!L,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:L?!1:o});R=_,M&&b.addInstruction(M)}m[C.mint.address]=R,S.push(R)}let K=await this.getClmmPoolKeys(w.id),I=[];for(let C=0;C<K.rewardInfos.length;C++)I.push({poolRewardVault:new j(K.rewardInfos[C].vault),ownerRewardVault:S[C],rewardMint:new j(K.rewardInfos[C].mint.address)});for(let C of t[A.id]){let L=(y=n==null?void 0:n[A.id])==null?void 0:y[C.nftMint.toBase58()];if(L){let R=ie(this.scope.ownerPubKey,L.lockNftMint,io).publicKey,_=Y.getTickArrayStartIndexByTick(C.tickLower,K.config.tickSpacing),M=Y.getTickArrayStartIndexByTick(C.tickUpper,K.config.tickSpacing),{publicKey:V}=ye(new j(K.programId),L.poolId,_),{publicKey:H}=ye(new j(K.programId),L.poolId,M),{publicKey:re}=Qt(new j(K.programId),L.poolId,C.tickLower,C.tickUpper),ge=Gi(Bi,L.lockNftMint).publicKey,ae=Se.harvestLockPositionInstructionV2({programId:Bi,auth:Do,lockPositionId:ge,clmmProgram:On,lockOwner:this.scope.ownerPubKey,lockNftMint:L.lockNftMint,lockNftAccount:R,positionNftAccount:L.nftAccount,positionId:L.positionId,poolId:L.poolId,protocolPosition:re,vaultA:new j(K.vault.A),vaultB:new j(K.vault.B),tickArrayLower:V,tickArrayUpper:H,userVaultA:k,userVaultB:x,mintA:new j(K.mintA.address),mintB:new j(K.mintB.address),rewardAccounts:I,exTickArrayBitmap:Ue(On,L.poolId).publicKey});b.addInstruction({instructions:[ae],instructionTypes:[U.ClmmHarvestLockPosition],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]})}else{let R=Se.decreaseLiquidityInstructions({poolInfo:w,poolKeys:K,ownerPosition:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:x,rewardAccounts:S},liquidity:new kt(0),amountMinA:new kt(0),amountMinB:new kt(0),nft2022:(g=f[C.nftMint.toBase58()])==null?void 0:g.equals(Cn)});b.addInstruction(R)}}}return c===0?b.sizeCheckBuildV0({computeBudgetConfig:u}):b.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(Ui(e).publicKey);return t?nc.decode(t.data).whitelistMints.filter(i=>!i.equals(j.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new kt(1))).map(s=>gt(new j(e),s.accountInfo.mint).publicKey),i=await this.scope.connection.getMultipleAccountsInfo(n),o=[];return i.forEach(s=>{if(!s)return;let a=ji.decode(s.data);o.push(a)}),o}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Oe(this.scope.connection,e.map(o=>({pubkey:new j(o)})),t),i={};for(let o=0;o<e.length;o++){let s=n[o];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[o]));let a=Vn.decode(s.accountInfo.data),c=oe.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();i[String(e[o])]=q(v({},a),{currentPrice:c,programId:s.accountInfo.owner})}return i}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),i=await Oe(this.scope.connection,Array.from(n).map(c=>({pubkey:new j(c)}))),o={};i.forEach(c=>{!c.accountInfo||(o[c.pubkey.toBase58()]=ec.decode(c.accountInfo.data))});let s=await Ce.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{var m,d,p,f;let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:dt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||io.toBase58(),extensions:{feeConfig:(m=t[u])!=null&&m.feeConfig?xn((d=t[u])==null?void 0:d.feeConfig):void 0}}),mintB:dt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||io.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?xn((f=t[l])==null?void 0:f.feeConfig):void 0}}),price:e[c].currentPrice,config:q(v({},o[e[c].ammConfig.toBase58()]),{id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await Ce.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),i=await $n({connection:this.scope.connection,mints:Array.from(n).map(m=>new j(m))}),{computeClmmPoolInfo:o,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:i}),a=await Oe(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=$u(o[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(wc.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(wc.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let u=q(v({},o[e]),{exBitmapAccount:o[e].exBitmapAccount.toBase58(),observationId:o[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:o[e].rewardInfos.filter(m=>!m.tokenVault.equals(j.default)).map(m=>({mint:dt({address:m.tokenMint.toBase58(),programId:io.toBase58(),decimals:10}),vault:m.tokenVault.toBase58()}))});return{poolInfo:c,poolKeys:u,computePoolInfo:o[e],tickData:s}}};import{PublicKey as z}from"@solana/web3.js";import{AccountLayout as Wp,NATIVE_MINT as Kr,TOKEN_PROGRAM_ID as zt}from"@solana/spl-token";import oa from"bn.js";import Tr from"decimal.js-light";import ro from"bn.js";function wr(r,e){if(e.isZero())throw Error("divisor is zero");return r.mod(e)}function Cp(r,e){if(e.isZero())throw Error("rhs is zero");let t=r.div(e);if(t.isZero())throw Error("quotient is zero");let n=wr(r,e);return n.gt(mi)&&(t=t.add(new ro(1)),e=r.div(t),n=wr(r,t),n.gt(mi)&&(e=e.add(new ro(1)))),[t,e]}var mi=new ro(0),kr=class{static swapWithoutFees(e,t,n){let i=t.mul(n),o=t.add(e),[s]=Cp(i,o),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,i,o){let s=e.mul(n).div(t),a=e.mul(i).div(t);if(o===0)return{tokenAmount0:s,tokenAmount1:a};if(o===1)return wr(e.mul(n),t).gt(mi)&&s.gt(mi)&&(s=s.add(new ro(1))),wr(e.mul(i),t).gt(mi)&&a.gt(mi)&&(a=a.add(new ro(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var hr=class{static tradingFee(e,t){return _o(e,t,Ut)}static protocolFee(e,t){return cs(e,t,Ut)}static fundFee(e,t){return cs(e,t,Ut)}};var Ir=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,i){let o=hr.tradingFee(e,i),s=e.sub(o),{destinationAmountSwapped:a}=kr.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:o}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:i,quoteReserve:o,outputMint:s,outputAmount:a}){let[c,u,l,m,d]=t.address===s.toString()?[i,o,e.decimals,t.decimals,e.address]:[o,i,t.decimals,e.decimals,t.address],p=new Tr(u.toString()).div(10**m).div(new Tr(c.toString()).div(10**l)),f=a.gte(u)?u.sub(new oa(1)):a,b=u.sub(f),y=wn(c.mul(f),b),g=wn(y.mul(new oa(1e6)),new oa(1e6).sub(n)),A=g.sub(y),w=new Tr(f.toString()).div(10**m).div(new Tr(g.toString()).div(10**l)),h=p.isZero()?0:w.sub(p).div(p).abs().toNumber();return{amountRealOut:f,amountIn:g,amountInWithoutFee:y,tradeFee:A,priceImpact:h}}};import Ge from"bn.js";import{PublicKey as ao,TransactionInstruction as Gn,Keypair as Ep,SystemProgram as Vp}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Tc,TOKEN_2022_PROGRAM_ID as sa,TOKEN_PROGRAM_ID as Ln}from"@solana/spl-token";var Lp=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),AS=Buffer.from("amm_config","utf8"),Rp=Buffer.from("pool","utf8"),Np=Buffer.from("pool_lp_mint","utf8"),Op=Buffer.from("pool_vault","utf8"),vp=Buffer.from("observation","utf8");function di(r){return le([Lp],r)}function ra(r,e,t,n){return le([Rp,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Mp(r,e){return le([Np,e.toBuffer()],r)}function kc(r,e,t){return le([Op,e.toBuffer(),t.toBuffer()],r)}function so(r,e){return le([vp,e.toBuffer()],r)}function hc({poolId:r,programId:e,configId:t,mintA:n,mintB:i}){let o=di(e).publicKey,s=r||ra(e,t,n,i).publicKey,a=Mp(e,s).publicKey,c=kc(e,s,n).publicKey,u=kc(e,s,i).publicKey,l=so(e,s).publicKey;return{poolId:s,configId:t,authority:o,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var _p=Buffer.from("locked_liquidity","utf8");function Br(r,e){return le([_p,e.toBuffer()],r)}var Fp=fe("Raydium_cpmm"),Xn={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function Ic(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A,w){let h=E([P("amountMaxA"),P("amountMaxB"),P("openTime")]),T=ra(r,t,o,s).publicKey,k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!i.equals(T),isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ln,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:Tc,isSigner:!1,isWritable:!1},{pubkey:os,isSigner:!1,isWritable:!1},{pubkey:it,isSigner:!1,isWritable:!1}],x=Buffer.alloc(h.span);return h.encode({amountMaxA:g,amountMaxB:A,openTime:w},x),new Gn({keys:k,programId:r,data:Buffer.from([...Xn.initialize,...x])})}function Bc(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f){let b=E([P("lpAmount"),P("amountMaxA"),P("amountMaxB")]),y=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Ln,isSigner:!1,isWritable:!1},{pubkey:sa,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(b.span);return Fp.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:f.toString()}),b.encode({lpAmount:d,amountMaxA:p,amountMaxB:f},g),new Gn({keys:y,programId:r,data:Buffer.from([...Xn.deposit,...g])})}function Sc(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f){let b=E([P("lpAmount"),P("amountMinA"),P("amountMinB")]),y=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Ln,isSigner:!1,isWritable:!1},{pubkey:sa,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:An,isSigner:!1,isWritable:!1}],g=Buffer.alloc(b.span);return b.encode({lpAmount:d,amountMinA:p,amountMinB:f},g),new Gn({keys:y,programId:r,data:Buffer.from([...Xn.withdraw,...g])})}function Sr(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f,b){let y=E([P("amountIn"),P("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],A=Buffer.alloc(y.span);return y.encode({amountIn:f,amounOutMin:b},A),new Gn({keys:g,programId:r,data:Buffer.from([...Xn.swapBaseInput,...A])})}function xc(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f,b){let y=E([P("amountInMax"),P("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],A=Buffer.alloc(y.span);return y.encode({amountInMax:f,amountOut:b},A),new Gn({keys:g,programId:r,data:Buffer.from([...Xn.swapBaseOutput,...A])})}async function Kc(r){var y;let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:i,getEphemeralSigners:o}=r,s=[],[a,c]=[new ao(t.id),new ao(t.lpMint.address)],u;if(o)u=new ao((await o(1))[0]);else{let g=Ep.generate();s.push(g),u=g.publicKey}let{publicKey:l}=ie(i,u,Ln),{publicKey:m}=un(u),{publicKey:d}=Br(r.lockProgram,u),{publicKey:p}=ie(e.wallet,c,Ln),{publicKey:f}=ie(r.lockAuthProgram,c,Ln),b=Dp({programId:r.lockProgram,auth:r.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:i,nftMint:u,nftAccount:l,poolId:a,lockPda:d,mintLp:c,userLpVault:p,lockLpVault:f,poolVaultA:new ao(n.vault.A),poolVaultB:new ao(n.vault.B),metadataAccount:m,lpAmount:r.lpAmount,withMetadata:(y=r.withMetadata)!=null?y:!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:m,lockPda:d,userLpVault:p,lockLpVault:f},instructions:[b],signers:s,instructionTypes:[U.CpmmLockLp],lookupTableAddress:[]}}function Dp({programId:r,auth:e,payer:t,liquidityOwner:n,nftOwner:i,nftMint:o,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:m,poolVaultA:d,poolVaultB:p,metadataAccount:f,lpAmount:b,withMetadata:y}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:Vp.programId,isSigner:!1,isWritable:!1},{pubkey:Ln,isSigner:!1,isWritable:!1},{pubkey:Tc,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1}],A=E([P("lpAmount"),Ve("withMetadata")]),w=Buffer.alloc(A.span);A.encode({lpAmount:b,withMetadata:y},w);let h=Buffer.from([...Xn.lockCpLiquidity,...w]);return new Gn({keys:g,programId:r,data:h})}function Cc({programId:r,nftOwner:e,auth:t,nftAccount:n,lockPda:i,poolId:o,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:m,mintB:d,lockLpVault:p,lpFeeAmount:f,cpmmProgram:b,cpmmAuthProgram:y}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:b!=null?b:Wo,isSigner:!1,isWritable:!1},{pubkey:y!=null?y:eu,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Ln,isSigner:!1,isWritable:!1},{pubkey:sa,isSigner:!1,isWritable:!1},{pubkey:An,isSigner:!1,isWritable:!1}],A=E([P("lpFeeAmount")]),w=Buffer.alloc(A.span);A.encode({lpFeeAmount:f},w);let h=Buffer.from([...Xn.collectCpFee,...w]);return new Gn({keys:g,programId:r,data:h})}var Lc=E([ke(8),G("bump"),Ve("disableCreatePool"),Xt("index"),P("tradeFeeRate"),P("protocolFeeRate"),P("fundFeeRate"),P("createPoolFee"),N("protocolOwner"),N("fundOwner"),Q(P(),16)]),xr=E([ke(8),N("configId"),N("poolCreator"),N("vaultA"),N("vaultB"),N("mintLp"),N("mintA"),N("mintB"),N("mintProgramA"),N("mintProgramB"),N("observationId"),G("bump"),G("status"),G("lpDecimals"),G("mintDecimalA"),G("mintDecimalB"),P("lpAmount"),P("protocolFeesMintA"),P("protocolFeesMintB"),P("fundFeesMintA"),P("fundFeesMintB"),P("openTime"),Q(P(),32)]);var uo=class extends Le{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await Oe(this.scope.connection,e.map(m=>({pubkey:new z(m)}))),i={},o=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=xr.decode(d.accountInfo.data);i[String(e[m])]=q(v({},p),{programId:d.accountInfo.owner}),o.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...o],d=await Oe(this.scope.connection,m.map(p=>({pubkey:new z(p)})));for(let p=0;p<m.length;p++){let f=d[p].accountInfo;if(f===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=Lc.decode(f.data)}}let c={},u=await Oe(this.scope.connection,s.map(m=>({pubkey:new z(m)})));for(let m=0;m<s.length;m++){let d=u[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);c[String(s[m])]=new Ge(Wp.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(i)){let p=c[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),f=c[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=q(v({},d),{baseReserve:p,quoteReserve:f,vaultAAmount:c[d.vaultA.toString()],vaultBAmount:c[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new O(f.toString()).div(new O(10).pow(d.mintDecimalB)).div(new O(p.toString()).div(new O(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,i)=>{var c,u,l,m;let o=e[i],[s,a]=[o.mintA.toBase58(),o.mintB.toBase58()];return q(v({},n),{[i]:q(v({},o),{id:new z(i),configInfo:o.configInfo,version:7,authority:di(o.programId).publicKey,mintA:dt({address:s,decimals:o.mintDecimalA,programId:o.mintProgramA.toBase58(),extensions:{feeConfig:(c=t[s])!=null&&c.feeConfig?xn((u=t[s])==null?void 0:u.feeConfig):void 0}}),mintB:dt({address:a,decimals:o.mintDecimalB,programId:o.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?xn((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await $n({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),i=dt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?xn(n[t.mintA.toBase58()].feeConfig):void 0}}),o=dt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?xn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=dt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:zt.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:i,mintB:o,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new O(t.vaultAAmount.toString()).div(10**i.decimals).toNumber(),mintAmountB:new O(t.vaultBAmount.toString()).div(10**o.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:i,mintB:o,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:di(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:so(t.programId,new z(e)).publicKey.toBase58()},rpcData:t}}async createPool(f){var b=f,{poolId:e,programId:t,poolFeeAccount:n,startTime:i,ownerInfo:o,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=b,p=Ee(b,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig","txTipConfig","feePayer"]);var V,H,re;let y=o.feePayer||((V=this.scope.owner)==null?void 0:V.publicKey),g=new Ge(new z(p.mintA.address).toBuffer()).lte(new Ge(new z(p.mintB.address).toBuffer())),[A,w]=g?[p.mintA,p.mintB]:[p.mintB,p.mintA],[h,T]=g?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],k=o.useSOLBalance&&A.address===Kr.toBase58(),x=o.useSOLBalance&&w.address===Kr.toBase58(),[S,K]=[new z(A.address),new z(w.address)],I=this.createTxBuilder(d),{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({mint:S,tokenProgram:A.programId,owner:this.scope.ownerPubKey,createInfo:k?{payer:y,amount:h}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:s,checkCreateATAOwner:a});I.addInstruction(L||{});let{account:R,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({mint:new z(w.address),tokenProgram:w.programId,owner:this.scope.ownerPubKey,createInfo:x?{payer:y,amount:T}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:s,checkCreateATAOwner:a});if(I.addInstruction(_||{}),C===void 0||R===void 0)throw Error("you don't has some token account");let M=hc({poolId:e,programId:t,configId:new z(u.id),mintA:S,mintB:K});return I.addInstruction({instructions:[Ic(t,this.scope.ownerPubKey,new z(u.id),M.authority,M.poolId,S,K,M.lpMint,C,R,ie(this.scope.ownerPubKey,M.lpMint).publicKey,M.vaultA,M.vaultB,n,new z((H=A.programId)!=null?H:zt),new z((re=w.programId)!=null?re:zt),M.observationId,h,T,i)],instructionTypes:[U.CpmmCreatePool]}),I.addCustomComputeBudget(l),I.addTipInstruction(m),I.versionBuild({txVersion:c,extInfo:{address:q(v({},M),{mintA:A,mintB:w,programId:t,poolFeeAccount:n,feeConfig:u})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:i,baseIn:o,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:m,feePayer:d}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),i.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:i.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:b}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},l),y=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:A,anotherAmount:w}=a||this.computePairAmount({poolInfo:q(v({},t),{lpAmount:new O(y.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:y.baseReserve,quoteReserve:y.quoteReserve,slippage:new Je(0),baseIn:o,epochInfo:await this.scope.fetchEpochInfo(),amount:new O(i.toString()).div(10**(o?t.mintA.decimals:t.mintB.decimals))}),h=w.amount,T=t.mintA.address===Kr.toString(),k=t.mintB.address===Kr.toString(),x=this.createTxBuilder(d),[S,K]=[new z(t.mintA.address),new z(t.mintB.address)],{account:I,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:T||(o?i:h).isZero()?{payer:this.scope.ownerPubKey,amount:o?i:h}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!1,checkCreateATAOwner:b});x.addInstruction(C||{});let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||(o?h:i).isZero()?{payer:this.scope.ownerPubKey,amount:o?h:i}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!1,checkCreateATAOwner:b});x.addInstruction(R||{}),!I&&!L&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let _=await p.getCreatedTokenAccount({mint:new z(t.lpMint.address)}),ge=await p.handleTokenAccount({side:"out",amount:0,mint:new z(t.lpMint.address),tokenAccount:_,bypassAssociatedCheck:f,checkCreateATAOwner:b}),{tokenAccount:M}=ge,V=Ee(ge,["tokenAccount"]);x.addInstruction(V);let H=n!=null?n:await this.getCpmmPoolKeys(t.id),re=new Je(new Ge(1)).sub(s);return x.addInstruction({instructions:[Bc(new z(t.programId),this.scope.ownerPubKey,new z(H.authority),new z(t.id),M,I,L,new z(H.vault.A),new z(H.vault.B),S,K,new z(t.lpMint.address),a?a==null?void 0:a.liquidity:re.mul(g).quotient,o?A.amount:h,o?h:A.amount)],instructionTypes:[U.CpmmAddLiquidity],lookupTableAddress:H.lookupTableAccount?[H.lookupTableAccount]:[]}),x.addCustomComputeBudget(c),x.addTipInstruction(u),x.versionBuild({txVersion:m})}async withdrawLiquidity(e){var V,H;let{poolInfo:t,poolKeys:n,lpAmount:i,slippage:o,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let m=new Je(new Ge(1)).sub(o),d=await this.getRpcPoolInfo(t.id),[p,f]=[m.mul(i.mul(d.baseReserve).div(d.lpAmount)).quotient,m.mul(i.mul(d.quoteReserve).div(d.lpAmount)).quotient],b=await this.scope.fetchEpochInfo(),[y,g]=[Te(p,t.mintA.extensions.feeConfig,b,!1),Te(f,t.mintB.extensions.feeConfig,b,!1)],{account:A}=this.scope,w=this.createTxBuilder(u),[h,T]=[new z(t.mintA.address),new z(t.mintB.address)],k=h.equals(Z),x=T.equals(Z),S,K,{account:I,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(k&&l),associatedOnly:!k,checkCreateATAOwner:!1});S=I,C&&w.addInstruction(C);let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:x,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(x&&l),associatedOnly:!x,checkCreateATAOwner:!1});K=L,R&&w.addInstruction(R),(!S||!K)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",A.tokenAccounts);let _=await A.getCreatedTokenAccount({mint:new z(t.lpMint.address)});_||this.logAndCreateError("cannot found lp token account","tokenAccounts",A.tokenAccounts);let M=n!=null?n:await this.getCpmmPoolKeys(t.id);return w.addInstruction({instructions:[Sc(new z(t.programId),this.scope.ownerPubKey,new z(M.authority),new z(t.id),_,S,K,new z(M.vault.A),new z(M.vault.B),h,T,new z(t.lpMint.address),i,p.sub((V=y.fee)!=null?V:new Ge(0)),f.sub((H=g.fee)!=null?H:new Ge(0)))],instructionTypes:[U.CpmmWithdrawLiquidity],lookupTableAddress:M.lookupTableAccount?[M.lookupTableAccount]:[]}),w.addCustomComputeBudget(s),w.addTipInstruction(a),w.versionBuild({txVersion:c})}async swap(e){var C,L,R,_,M,V;let{poolInfo:t,poolKeys:n,baseIn:i,fixedOut:o,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,{bypassAssociatedCheck:f,checkCreateATAOwner:b,associatedOnly:y}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},u),g=this.createTxBuilder(p),[A,w]=[new z(t.mintA.address),new z(t.mintB.address)];o?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Ge((1+c)*1e4)).div(new Ge(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Ge((1-c)*1e4)).div(new Ge(1e4));let h=t.mintA.address===Z.toBase58(),T=t.mintB.address===Z.toBase58(),{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:A,tokenProgram:new z((C=t.mintA.programId)!=null?C:zt),owner:this.scope.ownerPubKey,createInfo:h||!i?{payer:this.scope.ownerPubKey,amount:i?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:y,checkCreateATAOwner:b});x&&g.addInstruction(x);let{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:w,tokenProgram:new z((L=t.mintB.programId)!=null?L:zt),owner:this.scope.ownerPubKey,createInfo:T||i?{payer:this.scope.ownerPubKey,amount:i?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:T,skipCloseAccount:!T,associatedOnly:T?!1:y,checkCreateATAOwner:b});K&&g.addInstruction(K),(!k||!S)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:k,mintBTokenAcc:S,mintAUseSOLBalance:h,mintBUseSOLBalance:T,associatedOnly:y});let I=n!=null?n:await this.getCpmmPoolKeys(t.id);return g.addInstruction({instructions:[o?xc(new z(t.programId),this.scope.ownerPubKey,new z(I.authority),new z(I.config.id),new z(t.id),i?k:S,i?S:k,new z(I.vault[i?"A":"B"]),new z(I.vault[i?"B":"A"]),new z((M=t[i?"mintA":"mintB"].programId)!=null?M:zt),new z((V=t[i?"mintB":"mintA"].programId)!=null?V:zt),i?A:w,i?w:A,so(new z(t.programId),new z(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):Sr(new z(t.programId),this.scope.ownerPubKey,new z(I.authority),new z(I.config.id),new z(t.id),i?k:S,i?S:k,new z(I.vault[i?"A":"B"]),new z(I.vault[i?"B":"A"]),new z((R=t[i?"mintA":"mintB"].programId)!=null?R:zt),new z((_=t[i?"mintB":"mintA"].programId)!=null?_:zt),i?A:w,i?w:A,so(new z(t.programId),new z(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[o?U.CpmmSwapBaseOut:U.ClmmSwapBaseIn]}),g.addCustomComputeBudget(l),g.addTipInstruction(m),g.versionBuild({txVersion:d})}async lockLp(e){var d,p,f,b,y;let{poolInfo:t,lpAmount:n,computeBudgetConfig:i,txTipConfig:o,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=(d=e.poolKeys)!=null?d:await this.getCpmmPoolKeys(t.id),m=await Kc({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:(p=e.feePayer)!=null?p:this.scope.ownerPubKey},feeNftOwner:c!=null?c:this.scope.ownerPubKey,lockProgram:(f=e.programId)!=null?f:qo,lockAuthProgram:(b=e.authProgram)!=null?b:Uo,lpAmount:n,withMetadata:(y=e.withMetadata)!=null?y:!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(m),u.addCustomComputeBudget(i),u.addTipInstruction(o),u.versionBuild({txVersion:s,extInfo:m.address})}async harvestLockLp(e){var L;let{poolInfo:t,lpFeeAmount:n,nftMint:i,programId:o=qo,authProgram:s=Uo,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:m=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let d=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(d),[f,b]=[new z(t.mintA.address),new z(t.mintB.address)],y=f.equals(Z),g=b.equals(Z),A,w,{account:h,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(y&&m),associatedOnly:!y,checkCreateATAOwner:!1});A=h,T&&p.addInstruction(T);let{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&m),associatedOnly:!g,checkCreateATAOwner:!1});w=k,x&&p.addInstruction(x),(!A||!w)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:A,tokenAccountB:w});let S=(L=e.poolKeys)!=null?L:await this.getCpmmPoolKeys(t.id),{publicKey:K}=ie(d,i,zt),{publicKey:I}=Br(o,i),{publicKey:C}=ie(s,new z(t.lpMint.address),zt);return p.addInstruction({instructions:[Cc({programId:o!=null?o:qo,nftOwner:this.scope.ownerPubKey,auth:s!=null?s:Uo,nftMint:i,nftAccount:K,lockPda:I,poolId:new z(t.id),mintLp:new z(S.mintLp.address),userVaultA:A,userVaultB:w,poolVaultA:new z(S.vault.A),poolVaultB:new z(S.vault.B),mintA:f,mintB:b,lockLpVault:C,lpFeeAmount:n,cpmmProgram:a==null?void 0:a.programId,cpmmAuthProgram:a==null?void 0:a.authProgram})],instructionTypes:[U.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:i}){let o=n.toString()===e.mintB.address,s=Ir.swap(t,o?e.baseReserve:e.quoteReserve,o?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new O(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new Ge((1-i)*1e4)).div(new Ge(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:i,slippage:o,epochInfo:s,baseIn:a}){var h,T,k,x,S,K,I,C,L;let c=1-Number(o.toSignificant())/100,u=new Ge(new O(i).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=Te(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=u.sub((h=l.fee)!=null?h:new Ge(0)),d=new Ge(new O(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",(k=(T=l.fee)==null?void 0:T.toString())!=null?k:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${o.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let f=m.mul(d).div(p==="base"?t:n),b={amount:wt,fee:void 0,expirationTime:void 0};if(!m.isZero()){let R=qp(f,t,n,d);this.logDebug("lpAmountData:",{amountA:R.amountA.toString(),amountB:R.amountB.toString()}),b=Te(R[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let y=new Je(new Ge(1)).add(o),g=new Je(new Ge(1)).sub(o),A=Te(y.mul(b.amount.sub((x=b.fee)!=null?x:new Ge(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),w=Te(g.mul(b.amount.sub((S=b.fee)!=null?S:new Ge(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",b.amount.toString(),"anotherAmountFee:",(I=(K=b.fee)==null?void 0:K.toString())!=null?I:0,"maxAnotherAmount:",A.amount.toString(),"maxAnotherAmountFee:",(L=(C=A.fee)==null?void 0:C.toString())!=null?L:0),{inputAmountFee:l,anotherAmount:b,maxAnotherAmount:A,minAnotherAmount:w,liquidity:f}}};function qp(r,e,t,n){let i=r.mul(e).div(n);!i.isZero()&&!r.mul(e).mod(n).isZero()&&(i=i.add(new Ge(1)));let o=r.mul(t).div(n);return!o.isZero()&&!r.mul(t).mod(n).isZero()&&(o=o.add(new Ge(1))),{amountA:i,amountB:o}}import{PublicKey as zn}from"@solana/web3.js";import{createTransferInstruction as _c,TOKEN_PROGRAM_ID as Xe,TOKEN_2022_PROGRAM_ID as Rr}from"@solana/spl-token";import Nr from"bn.js";var Rc={[ms.toBase58()]:3},Nc={3:ms};var aa=E([ke(5),ke(8),N("ownAddress"),P("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),N("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),ke(7)]),Oc={3:aa};import{PublicKey as vc}from"@solana/web3.js";var Cr=fe("Serum"),Lr=class{static getProgramId(e){let t=Nc[e];return t||Cr.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Rc[t];return n||Cr.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Oc[e];return t||Cr.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,o;for(;i<100;){try{let s=n.concat(Buffer.from([i]),Buffer.alloc(7));o=vc.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;i++;continue}return{publicKey:o,nonce:i}}return Cr.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:vc.default,nonce:i}}};import{PublicKey as ne,SystemProgram as Up,TransactionInstruction as Gp}from"@solana/web3.js";import Qn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Xp,TOKEN_2022_PROGRAM_ID as Qp,TOKEN_PROGRAM_ID as zp}from"@solana/spl-token";function jp(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f){var k;let b=[],y=[B({pubkey:zp,isWritable:!1}),B({pubkey:Qp,isWritable:!1}),B({pubkey:Xp,isWritable:!1}),B({pubkey:Up.programId,isWritable:!1}),B({pubkey:e,isSigner:!0})];y.push(B({pubkey:t})),y.push(B({pubkey:i}));let g=[c,u],A=[l,m],w=[o,s,a];for(let x=0;x<g.length;x++){let S=g[x],K=w[x]===S.mintA.address;if(y.push(B({pubkey:new ne(S.programId),isWritable:!1})),x===g.length-1?y.push(B({pubkey:i})):y.push(B({pubkey:n})),y.push(B({pubkey:new ne(w[x])})),y.push(B({pubkey:new ne(w[x+1])})),S.version===6){let I=A[x];y.push(B({pubkey:new ne(I.config.id)})),y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(K?I.vault.A:I.vault.B)})),y.push(B({pubkey:new ne(K?I.vault.B:I.vault.A)})),y.push(B({pubkey:new ne(S.observationId)})),y.push(B({pubkey:An})),y.push(B({pubkey:Ue(new ne(S.programId),new ne(S.id)).publicKey})),b.push(Hp(S.sqrtPriceX64.toString(),K));for(let C of(k=f[x])!=null?k:[])y.push(B({pubkey:new ne(C)}))}else if(S.version===5){let I=A[x];y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(I.authority),isWritable:!1})),y.push(B({pubkey:new ne(I.marketProgramId)})),y.push(B({pubkey:new ne(I.marketAuthority)})),y.push(B({pubkey:$a,isWritable:!1})),y.push(B({pubkey:new ne(I.openOrders)})),y.push(B({pubkey:new ne(I.vault.A)})),y.push(B({pubkey:new ne(I.vault.B)})),y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(I.marketId)})),y.push(B({pubkey:new ne(I.marketBids)})),y.push(B({pubkey:new ne(I.marketAsks)})),y.push(B({pubkey:new ne(I.marketEventQueue)})),y.push(B({pubkey:new ne(I.marketBaseVault)})),y.push(B({pubkey:new ne(I.marketQuoteVault)}))}else if(S.version===4){let I=A[x],C=S.status!==1;y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(I.authority),isWritable:!1})),y.push(B({pubkey:new ne(C?I.id:I.marketProgramId)})),y.push(B({pubkey:new ne(C?I.id:I.marketAuthority)})),y.push(B({pubkey:new ne(C?I.id:I.openOrders)})),y.push(B({pubkey:new ne(I.vault.A)})),y.push(B({pubkey:new ne(I.vault.B)})),y.push(B({pubkey:new ne(C?I.id:I.marketId)})),y.push(B({pubkey:new ne(C?I.id:I.marketBids)})),y.push(B({pubkey:new ne(C?I.id:I.marketAsks)})),y.push(B({pubkey:new ne(C?I.id:I.marketEventQueue)})),y.push(B({pubkey:new ne(C?I.id:I.marketBaseVault)})),y.push(B({pubkey:new ne(C?I.id:I.marketQuoteVault)}))}else if(S.version===7){let I=A[x];y.push(B({pubkey:new ne(I.authority)})),y.push(B({pubkey:new ne(I.config.id)})),y.push(B({pubkey:new ne(I.id)})),y.push(B({pubkey:new ne(K?I.vault.A:I.vault.B)})),y.push(B({pubkey:new ne(K?I.vault.B:I.vault.A)})),y.push(B({pubkey:new ne(S.observationId)}))}else throw Error("pool type error")}let h=E([G("insId"),P("amountIn"),P("amountOut"),Q(ee(),b.length,"clmmPriceLimit")]),T=Buffer.alloc(h.span);return h.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:b},T),new Gp({keys:y,programId:r,data:T})}function Hp(r,e){if(r)if(e){let t=new Qn(r).div(new Qn(25));return t.gt(ur)?t:ur}else{let t=new Qn(r).mul(new Qn(25));return t.lt(cr)?t:cr}else return e?ur:cr}function Mc({routeProgram:r,ownerInfo:e,inputMint:t,swapInfo:n}){var i,o,s,a,c,u,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=ot(m),p=t.equals(d.mintA.address)?Nt.add(Bt):Ot.sub(Bt);return Se.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((o=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?o:new Qn(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[Sr(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new ne(m[d?"mintA":"mintB"].address),new ne(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?U.CpmmSwapBaseIn:U.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[br({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((c=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?c:new Qn(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?U.AmmV5SwapBaseIn:U.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],f=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[jp(r,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,f,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?l:new Qn(0)),n.remainingAccounts)],instructionTypes:[U.RouteSwap],lookupTableAddress:[p.lookupTableAccount,f.lookupTableAccount].filter(b=>b!==void 0),address:{}}}else throw Error("route type error")}var mn=new Nr(0),co=class extends Le{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(Z));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1,feePayer:o}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(o);a.addCustomComputeBudget(e.computeBudgetConfig);let c=$(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[rn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[rn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:i})}async wrapWSol(e,t,n,i){let o=this.createTxBuilder(i),s=await In({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return o.addInstruction(s),o.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:o,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,m=u.amount.token.mint.equals(Z),d=l.amount.token.mint.equals(Z),p=u.amount.token.mint,f=l.amount.token.mint,{account:b,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?Rr:Xe,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:m?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(y&&c.addInstruction(y),b===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!d)g=this.scope.account.getAssociatedTokenAccount(f,l.amount.token.isToken2022?Rr:Xe);else{let{account:T,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?Rr:Xe,mint:f,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=T,k&&c.addInstruction(k)}d&&c.addInstruction({endInstructions:[rn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:Xe})],endInstructionTypes:[U.CloseAccount]});let A;if(e.routeType==="route"){let T=e.middleToken;A=this.scope.account.getAssociatedTokenAccount(T.mint,T.isToken2022?Rr:Xe)}let w=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),h=Mc({routeProgram:o,inputMint:p,swapInfo:q(v({},e),{poolInfo:[...e.poolInfoList],poolKey:w,outputMint:f}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:b,routeToken:A,destinationToken:g}});if(e.feeConfig!==void 0){let T=this.createTxBuilder();T.addInstruction({instructions:[_c(b,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[U.TransferAmount]}),T.addInstruction(h);let{transactions:k}=s===0?await T.sizeCheckBuildV0():await T.sizeCheckBuild();k.length<2&&c.addInstruction({instructions:[_c(b,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[U.TransferAmount]})}return c.addInstruction(h),s===0?c.sizeCheckBuildV0({computeBudgetConfig:i,address:h.address}):c.sizeCheckBuild({computeBudgetConfig:i,address:h.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Fo,clmm:n=On,cpmm:i=Wo}=e||{},o=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:Zi.offsetOf("baseMint"),length:64}}),s=E([N("baseMint"),N("quoteMint")]),a=o.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=E([N("mintA"),N("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:Vn.span}],dataSlice:{offset:Vn.offsetOf("mintA"),length:64}})).map(p=>{let f=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:f.mintA,mintB:f.mintB}}),d=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:xr.offsetOf("mintA"),length:64}})).map(p=>{let f=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:f.mintA,mintB:f.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:o}){e=e.toString()===zn.default.toString()?Z:e,t=t.toString()===zn.default.toString()?Z:t;let s={},a={},c={},u=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of o)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),c[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let f of p.in)for(let b of p.out)f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f),b.version===6&&a[b.id.toString()]===void 0?a[b.id.toString()]=b:b.version===7&&c[b.id.toString()]===void 0?c[b.id.toString()]=b:(b.version===4||b.version===5)&&s[b.id.toString()]===void 0&&(s[b.id.toString()]=b)}return{directPath:u,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(b=>[b.mintA.toBase58(),b.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let o=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(b=>b.id)),s=gr(o),a={};Object.values(s).forEach(b=>{i.delete(b.mintA.address),a[b.mintA.address]={address:new zn(b.mintA.address),programId:Xe,mintAuthority:null,supply:BigInt(0),decimals:b.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(b.mintB.address),a[b.mintB.address]={address:new zn(b.mintB.address),programId:Xe,mintAuthority:null,supply:BigInt(0),decimals:b.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(b=>b.id.toBase58()),!0);Object.values(c).forEach(b=>{let[y,g]=[b.mintA.toBase58(),b.mintB.toBase58()];b.mintProgramA.equals(Xe)?(i.delete(y),a[y]={address:b.mintA,programId:b.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:b.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(y),b.mintProgramB.equals(Xe)?(i.delete(g),a[g]={address:b.mintB,programId:b.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:b.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let u=await $n({connection:this.scope.connection,mints:Array.from(i).map(b=>new zn(b))});a=v(v({},a),u);let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(b=>b.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),f=Object.keys(e.routePathDict).reduce((b,y)=>q(v({},b),{[y]:q(v({},e.routePathDict[y]),{mintProgram:a[y].programId,mDecimals:a[y].decimals,in:e.routePathDict[y].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[y].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:o,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:f}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:o,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){var g,A,w,h,T,k,x,S,K;let m=l===void 0?new Nr(0):e.raw.mul(new Nr(l.feeBps.toNumber())).div(new Nr(1e4)),d=e.raw.sub(m),p=new he(e.token,d),f=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},b=q(v({},t),{address:at(t.address).toString()}),y=[];for(let I of n)try{y.push(q(v({},this.computeAmountOut({itemPool:I,tickCache:s,simulateCache:o,chainTime:c,epochInfo:u,slippage:a,outputToken:b,amountIn:p})),{feeConfig:f}))}catch(C){this.logDebug("direct error",I.version,I.id.toString(),C.message)}this.logDebug("direct done");for(let[I,C]of Object.entries(i)){let L={chainId:101,address:I,programId:C.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:C.mDecimals,tags:[],extensions:{}},R=C.in.map(M=>{try{return{pool:M,data:this.computeAmountOut({itemPool:M,tickCache:s,simulateCache:o,chainTime:c,epochInfo:u,slippage:a,outputToken:L,amountIn:p})}}catch(V){this.logDebug("route in error",M.version,M.id.toString(),V.message);return}}).sort((M,V)=>{var ge,ae,me,xe;let H=M===void 0?mn:M.data.amountOut.amount.raw.sub((ae=(ge=M.data.amountOut.fee)==null?void 0:ge.raw)!=null?ae:mn),re=V===void 0?mn:V.data.amountOut.amount.raw.sub((xe=(me=V.data.amountOut.fee)==null?void 0:me.raw)!=null?xe:mn);return H.lt(re)?1:-1})[0];if(R===void 0)continue;let _=new he(pr(L),R.data.amountOut.amount.raw.sub((A=(g=R.data.amountOut.fee)==null?void 0:g.raw)!=null?A:mn));for(let M of C.out)try{let V=this.computeAmountOut({itemPool:M,tickCache:s,simulateCache:o,chainTime:c,epochInfo:u,slippage:a,outputToken:b,amountIn:_});y.push(q(v({},V),{allTrade:!!(R.data.allTrade&&V.allTrade),amountIn:R.data.amountIn,amountOut:V.amountOut,minAmountOut:V.minAmountOut,currentPrice:void 0,executionPrice:new O(new Pt({baseToken:R.data.amountIn.amount.token,denominator:R.data.amountIn.amount.raw,quoteToken:V.amountOut.amount.token,numerator:V.amountOut.amount.raw.sub((h=(w=V.amountOut.fee)==null?void 0:w.raw)!=null?h:mn)}).toFixed()),priceImpact:new O(R.data.priceImpact.add(V.priceImpact).toFixed()),fee:[R.data.fee[0],V.fee[0]],routeType:"route",poolInfoList:[R.pool,M],remainingAccounts:[R.data.remainingAccounts[0],V.remainingAccounts[0]],minMiddleAmountFee:(T=V.amountOut.fee)!=null&&T.raw?new he(R.data.amountOut.amount.token,((x=(k=R.data.amountOut.fee)==null?void 0:k.raw)!=null?x:mn).add((K=(S=V.amountOut.fee)==null?void 0:S.raw)!=null?K:mn)):void 0,middleToken:R.data.amountOut.amount.token,poolReady:R.data.poolReady&&V.poolReady,poolType:[R.data.poolType,V.poolType],feeConfig:f,expirationTime:qt(R.data.expirationTime,V.expirationTime)}))}catch(V){this.logDebug("route out error",M.version,M.id.toString(),V.message)}}return y.filter(I=>(I.allTrade||this.logDebug(`pool ${I.poolInfoList.map(C=>C.id.toString()).join(",")} filter out since not all trade`),I.allTrade)).sort((I,C)=>I.amountOut.amount.raw.sub(C.amountOut.amount.raw).gt(mn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:o,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:f,executionPrice:b,priceImpact:y,fee:g,remainingAccounts:A,executionPriceX64:w}=Ce.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:o,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new O(f.toFixed()),executionPrice:new O(b.toFixed()),priceImpact:new O(y.toFixed()),fee:[g],remainingAccounts:[A],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:s,clmmExPriceX64:[w],expirationTime:qt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:f}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Yi(q(v({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Yi(q(v({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new he(c.token,f)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:f}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Yi(q(v({},a),{amount:u})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Yi(q(v({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new he(c.token,f)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(i.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let o=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(o));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Oe(this.scope.connection,Array.from(s).map(l=>({pubkey:new zn(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=aa.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:Lr.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],m={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:q(v({},u.ammConfig),{id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(m)}else if(u.version===4){let l=n[u.id.toString()],m=v({programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:ta({programId:new zn(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint},a[u.marketId]);c.push(m)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:di(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:dt({address:u.mintLp.toBase58(),programId:Xe.toBase58(),decimals:u.lpDecimals}),config:q(v({id:u.configId.toBase58()},u.configInfo),{protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()})})}),c}};import{PublicKey as Yp,Transaction as ua,TransactionInstruction as Zp}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as $p}from"@solana/spl-token";import Ec from"bn.js";var pt=class extends Le{static getPdaPoolId(e,t){return le([pt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,i){return le([pt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Ec(i).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:i,chainTime:o}){if(n.length===0)return[];let s=n.map(l=>pt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<pt.VERSION_PROJECT.length;l++)a.push(...s.map(m=>pt.getPdaOwnerId(t,m,i,l).publicKey));let c=await Et(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],f=a[l],b=c[d],y=c[n.length+l];if(!(b&&y)||b.data.length!==pt.POOL_LAYOUT.span||y.data.length!==pt.OWNER_LAYOUT.span)continue;let g=pt.POOL_LAYOUT.decode(b.data),A=pt.OWNER_LAYOUT.decode(y.data),w=g.openTime.toNumber(),h=g.endTime.toNumber(),T=A.tokenInfo.map(S=>S.debtAmount.gt(new Ec(0))).filter(S=>!S).length!==3,k=o>w&&o<h&&g.status===1,x=T&&k;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:f,snapshotLpAmount:A.lpAmount,project:pt.VERSION_PROJECT[m],openTime:w,endTime:h,canClaim:x,canClaimErrorType:T?k?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((S,K)=>({mintAddress:S.mintAddress,mintVault:S.mintVault,mintDecimals:S.mintDecimals,perLpLoss:S.perLpLoss,debtAmount:A.tokenInfo[K].debtAmount.add(A.tokenInfo[K].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let i=this.createTxBuilder(n),o=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Me.WSOL.mint),createInfo:{payer:o,amount:0},skipCloseAccount:!u.mintAddress.equals(Me.WSOL.mint),associatedOnly:u.mintAddress.equals(Me.WSOL.mint)?!1:t.associatedOnly});m&&i.addInstruction(m),s.push(l)}i.addInstruction({instructions:[pt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:o,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=i.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let i=this.createTxBuilder(n),o=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let m=[];for(let d of l.tokenInfo){let{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({mint:d.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:d.mintAddress.equals(Me.WSOL.mint),createInfo:{payer:o,amount:0},skipCloseAccount:!d.mintAddress.equals(Me.WSOL.mint),associatedOnly:d.mintAddress.equals(Me.WSOL.mint)?!1:t.associatedOnly});f&&i.addInstruction(f),p&&(s[d.mintAddress.toString()]=p,m.push(p))}i.addInstruction({instructions:[pt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:o,ownerPda:l.ownerAccountId,claimAddress:m}})]})}let{transaction:a,signers:c}=i.build(),u=i.allInstructions;return ls(u,[o,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new ua().add(...u.slice(0,i.AllTxData.instructions.length-1)),signer:c},{transaction:new ua().add(...u.slice(i.AllTxData.instructions.length-1)),signer:[]},{transaction:new ua().add(...i.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let i=E([]),o=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:$p,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new Zp({keys:o,programId:e,data:a})}},vt=pt;vt.CLAIMED_NUM=3,vt.POOL_LAYOUT=E([ke(8),G("bump"),G("status"),P("openTime"),P("endTime"),N("ammId"),Q(E([G("mintDecimals"),N("mintAddress"),N("mintVault"),P("perLpLoss"),P("totalClaimedAmount")]),pt.CLAIMED_NUM,"tokenInfo"),Q(P(),10,"padding")]),vt.OWNER_LAYOUT=E([ke(8),G("bump"),G("version"),N("poolId"),N("owner"),P("lpAmount"),Q(E([N("mintAddress"),P("debtAmount"),P("claimedAmount")]),pt.CLAIMED_NUM,"tokenInfo"),Q(P(),4,"padding")]),vt.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Yp(e)),vt.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},vt.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as mo}from"@solana/web3.js";import Dc from"bn.js";import{SYSVAR_CLOCK_PUBKEY as ef,TransactionInstruction as Vc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Fc}from"@solana/spl-token";var Jp=E([G("instruction"),du("amount")]),lo=E([G("instruction")]);function Or({programId:r},e){let t=[{pubkey:Fc,isSigner:!1,isWritable:!1},{pubkey:Va,isSigner:!1,isWritable:!1},...Object.entries(e).map(([i,o])=>({pubkey:o,isSigner:i==="userOwner",isWritable:!["authority","userOwner"].includes(i)}))],n=Buffer.alloc(lo.span);return lo.encode({instruction:2},n),new Vc({keys:t,programId:r,data:n})}function ca(r){let{poolConfig:e,userKeys:t,side:n}=r,i=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,o=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(lo.span);lo.encode({instruction:2},s);let a=[{pubkey:Fc,isWritable:!1,isSigner:!1},{pubkey:ef,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new Vc({programId:e.programId,keys:a,data:s})}var tf={[Si.IDO_PROGRAM_ID_V1.toString()]:1,[Si.IDO_PROGRAM_ID_V2.toString()]:2,[Si.IDO_PROGRAM_ID_V3.toString()]:3,[Si.IDO_PROGRAM_ID_V4.toString()]:4},pi=class extends Le{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:i=!1,txVersion:o,feePayer:s}){let a=this.createTxBuilder(s),c=tf[t.programId];c||this.logAndCreateError("invalid version",c);let u=ot(t),[l,m]=[!new Dc(e.coin).isZero(),!new Dc(e.pc).isZero()],d=u.projectInfo.mint.address.equals(Z),{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,notUseTokenAccount:d,associatedOnly:d?!1:n,checkCreateATAOwner:i});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&f&&a.addInstruction(f);let b=u.buyInfo.mint.address.equals(Z),{account:y,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,notUseTokenAccount:b,associatedOnly:b?!1:n,checkCreateATAOwner:i});if(!p&&m&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),m&&g&&a.addInstruction(g),(!p||!y)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[Or({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new mo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...m?[Or({programId:new mo(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:y,userIdoInfo:new mo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:o});if(c<3)return!l&&!m&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[Or({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:y,userBaseTokenAccount:p,userIdoInfo:new mo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:o});let A={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:y,ledgerAccount:new mo(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[ca(q(v({},A),{side:"base"}))]:[],...m?[ca(q(v({},A),{side:"quote"}))]:[]]}).versionBuild({txVersion:o})}};var nf=Buffer.from("vault_auth_seed","utf8"),YK=Buffer.from("global_config","utf8"),of=Buffer.from("pool","utf8"),rf=Buffer.from("pool_vault","utf8"),sf=Buffer.from("pool_vesting","utf8"),af=Buffer.from("platform_config","utf8");function po(r){return le([nf],r)}function vr(r,e,t){return le([of,e.toBuffer(),t.toBuffer()],r)}function la(r,e,t){return le([rf,e.toBuffer(),t.toBuffer()],r)}function Mr(r){return le([Buffer.from("__event_authority","utf8")],r)}function ma(r,e){return le([af,e.toBuffer()],r)}function Wc(r,e,t){return le([sf,e.toBuffer(),t.toBuffer()],r)}import{SystemProgram as _r,TransactionInstruction as jn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as uf}from"@solana/spl-token";import qc from"bn.js";var Hn={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function Uc(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g,A,w,h,T){let k=E([G("decimals"),Tn("name"),Tn("symbol"),Tn("uri")]),x=E([P("totalLockedAmount"),P("cliffPeriod"),P("unlockPeriod")]),S=E([G("index"),P("supply"),P("totalFundRaisingB"),G("migrateType")]),K=E([G("index"),P("supply"),P("totalSellA"),P("totalFundRaisingB"),G("migrateType")]),I=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Dt,isSigner:!1,isWritable:!1},{pubkey:_r.programId,isSigner:!1,isWritable:!1},{pubkey:it,isSigner:!1,isWritable:!1},{pubkey:Mr(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}],C=Buffer.alloc(Buffer.from(b,"utf-8").length+Buffer.from(y,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),L=Buffer.alloc(x.span),R=Buffer.alloc(A.type==="ConstantCurve"?K.span:S.span);return k.encode({decimals:f,name:b,symbol:y,uri:g},C),A.type==="ConstantCurve"?K.encode(q(v({index:0},A),{migrateType:A.migrateType==="amm"?0:1}),R):A.type==="FixedCurve"?S.encode(q(v({index:1},A),{migrateType:A.migrateType==="amm"?0:1}),R):A.type==="LinearCurve"&&S.encode(q(v({index:2},A),{migrateType:A.migrateType==="amm"?0:1}),R),x.encode({totalLockedAmount:w,cliffPeriod:h,unlockPeriod:T},L),new jn({keys:I,programId:r,data:Buffer.from([...Hn.initialize,...C,...R,...L])})}function Gc(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g){let A=E([P("amountB"),P("minAmountA"),P("shareFeeRate")]),w=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mr(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&w.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:f.toString(),minAmountA:b.toString()});let h=Buffer.alloc(A.span);return A.encode({amountB:f,minAmountA:b,shareFeeRate:y!=null?y:new qc(0)},h),new jn({keys:w,programId:r,data:Buffer.from([...Hn.buyExactIn,...h])})}function Xc(r,e,t,n,i,o,s,a,c,u,l,m,d,p,f,b,y,g){let A=E([P("amountA"),P("minAmountB"),P("shareFeeRate")]),w=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mr(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&w.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(A.span);return A.encode({amountA:f,minAmountB:b,shareFeeRate:y!=null?y:new qc(0)},h),new jn({keys:w,programId:r,data:Buffer.from([...Hn.sellExactIn,...h])})}function Qc(r,e,t,n,i,o){let s=E([P("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:_r.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:o},c),new jn({keys:a,programId:r,data:Buffer.from([...Hn.createVestingAccount,...c])})}function zc(r,e,t,n,i,o,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:_r.programId,isSigner:!1,isWritable:!0},{pubkey:uf,isSigner:!1,isWritable:!0}];return new jn({keys:u,programId:r,data:Hn.claimPlatformFee})}function jc(r,e,t,n,i,o,s,a,c,u){let l=E([P("platformScale"),P("creatorScale"),P("burnScale"),P("feeRate"),Tn("name"),Tn("web"),Tn("img")]),m=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:_r.programId,isSigner:!1,isWritable:!1}],d=Buffer.alloc(8*4+Buffer.from(a,"utf-8").length+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+4*3);return l.encode({platformScale:o.platformScale,creatorScale:o.creatorScale,burnScale:o.burnScale,feeRate:s,name:a,web:c,img:u},d),new jn({keys:m,programId:r,data:Buffer.from([...Hn.createPlatformConfig,...d])})}function Hc(r,e,t,n){let i=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],o;if(n.type==="updateClaimFeeWallet"){let s=E([G("index"),N("value")]);o=Buffer.alloc(s.span),s.encode({index:0,value:n.value},o)}else if(n.type==="updateLockNftWallet"){let s=E([G("index"),N("value")]);o=Buffer.alloc(s.span),s.encode({index:1,value:n.value},o)}else if(n.type==="migrateCpLockNftScale"){let s=E([G("index"),P("platformScale"),P("creatorScale"),P("burnScale")]);o=Buffer.alloc(s.span),s.encode(v({index:2},n.value),o)}else if(n.type==="updateFeeRate"){let s=E([G("index"),P("value")]);o=Buffer.alloc(s.span),s.encode({index:3,value:n.value},o)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=E([G("index"),Tn("value")]);o=Buffer.alloc(s.span),n.type==="updateName"?s.encode({index:4,value:n.value},o):n.type==="updateWeb"?s.encode({index:5,value:n.value},o):n.type==="updateImg"&&s.encode({index:6,value:n.value},o)}else throw Error("updateInfo params type error");return new jn({keys:i,programId:r,data:Buffer.from([...Hn.updatePlaformConfig,...o])})}import{NATIVE_MINT as Wr,TOKEN_PROGRAM_ID as dn,createAssociatedTokenAccountIdempotentInstruction as $c}from"@solana/spl-token";import be from"bn.js";import{PublicKey as Jc}from"@solana/web3.js";var fi=E([P(),P("epoch"),G("curveType"),Xt("index"),P("migrateFee"),P("tradeFeeRate"),P("maxShareFeeRate"),P("minSupplyA"),P("maxLockRate"),P("minSellRateA"),P("minMigrateRateA"),P("minFundRaisingB"),N("mintB"),N("protocolFeeOwner"),N("migrateFeeOwner"),N("migrateToAmmWallet"),N("migrateToCpmmWallet"),Q(P(),16)]),cf=E([P("totalLockedAmount"),P("cliffPeriod"),P("unlockPeriod"),P("startTime"),P("totalAllocatedShare")]),fo=E([P(),P("epoch"),G("bump"),G("status"),G("mintDecimalsA"),G("mintDecimalsB"),G("migrateType"),P("supply"),P("totalSellA"),P("virtualA"),P("virtualB"),P("realA"),P("realB"),P("totalFundRaisingB"),P("protocolFee"),P("platformFee"),P("migrateFee"),cf.replicate("vestingSchedule"),N("configId"),N("platformId"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("creator"),Q(P(),8)]),u0=E([P(),P("epoch"),N("poolId"),N("beneficiary"),P("claimedAmount"),P("tokenShareAmount"),Q(P(),8)]),Er=E([P(),P("epoch"),N("platformClaimFeeWallet"),N("platformLockNftWallet"),P("platformScale"),P("creatorScale"),P("burnScale"),P("feeRate"),Q(G(),64,"name"),Q(G(),256,"web"),Q(G(),256,"img"),Q(G(),256)]);import en from"bn.js";import bo from"bn.js";var Rn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:o,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:o}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var Vr=class extends Rn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(t.toString()).div(e.toString()).mul(10**(n-i))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:o,decimalA:s,decimalB:a}){return new O(i.sub(o).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),o=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB.add(o)).toString()).div(e.virtualA.sub(e.realA.add(i)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:o}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(i);if(s.lte(new bo(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(o);if(a.lte(new bo(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new bo(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),m=t.mul(t).div(u);if(l.lt(new bo(0))||m.lt(new bo(0)))throw Error("invalid input 0");return{a:l,b:m,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let i=e.mul(n),o=t.add(e);return i.div(o)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let i=t.mul(e),o=n.sub(e);return Go(i,o)}};import Yc from"bn.js";var Fr=class extends Rn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(t.toString()).div(e.toString()).mul(10**(n-i))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:o,decimalA:s,decimalB:a}){return new O(i.sub(o).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),o=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB).add(o).toString()).div(e.virtualA.sub(e.realA).add(i).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:o}){let s=e.sub(i);if(s.lte(new Yc(0)))throw Error("invalid input 1");let a=new Yc(2).mul(t).sub(o),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let i=t.mul(e);return Go(i,n)}};import ht from"bn.js";import Zc from"bn.js";var yo=class{static _multipler(e){return new O(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new O(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let i=e.mul(this._multipler(n)).div(this._multipler(t));return new Zc(i.mul(this._Q64).toFixed(0))}};yo._Q64=new O(new Zc(1).shln(64).toString());var Dr=class extends Rn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualA.mul(e.realA).toString()).div(yo._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:o,decimalA:s,decimalB:a}){return new O(i.sub(o).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),o=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB).add(o).toString()).div(e.virtualA.sub(e.realA).add(i).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:o}){let s=e.sub(i);if(s.lte(new ht(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new ht(3)).sub(o),u=t.mul(new ht(2)).mul(s).div(a),l=u.mul(u),m=t.mul(new ht(2)).mul(ze).div(l);if(!m.gt(new ht(0)))throw Error("a need gt 0");if(!Di.gt(m))throw Error("a need lt u64 max");return{a:m,b:new ht(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),i=new ht(2).mul(n).mul(ze).div(e.virtualA);return new ht(new O(i.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),i=n.mul(n),{div:o,mod:s}=e.virtualA.mul(i).divmod(new ht(2).mul(ze));return(s.isZero()?o:o.add(new ht(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),i=n.mul(n),{div:o,mod:s}=e.virtualA.mul(i).divmod(new ht(2).mul(ze)),a=s.isZero()?o:o.add(new ht(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),i=new ht(2).mul(n).mul(ze).div(e.virtualA),o=new ht(new O(i.toString()).sqrt().toFixed(0));return e.realA.sub(o)}};var tn=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:i,totalSell:o,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),m=l.getInitParam({supply:n,totalFundRaising:i,totalSell:o,totalLockedAmount:s,migrateFee:a}),d=l.getPoolInitPriceByInit(q(v({},m),{decimalA:c,decimalB:u})),p=i.div(new en(t-1)),f=new en(0),b=[{price:d,totalSellSupply:0}],{a:y,b:g}=m,A=f,w=f;for(let h=1;h<t;h++){let T=h!==t-1?p:i.sub(w),k=this.buyExactIn({poolInfo:{virtualA:y,virtualB:g,realA:A,realB:w,totalFundRaisingB:i,totalSellA:o},amountB:T,protocolFeeRate:f,platformFeeRate:f,curveType:e,shareFeeRate:f});A=A.add(k.amountA),w=w.add(k.amountB);let x=this.getPrice({poolInfo:{virtualA:y,virtualB:g,realA:A,realB:w},decimalA:c,decimalB:u,curveType:e});b.push({price:x,totalSellSupply:new O(A.toString()).div(10**c).toNumber()})}return b}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:i}){return this.getCurve(i).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i,curveType:o}){return this.getCurve(o).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:i})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:i})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:i})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,decimals:o,config:s,migrateType:a}){if(Number(o)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(Ut).lt(i))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new en(10**o))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(Ut);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(i),m=e.mul(s.minMigrateRateA).div(Ut);if(l.lt(m))throw Error("migrate lt min migrate amount");let d=e.sub(n).sub(i),p=new en(new O(d.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let f=new en(10).pow(new en(o));if(p.lte(f))throw Error("check migrate lp error")}else if(a==="cpmm"){let f=new en(100);if(p.lte(f))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:i,curveType:o,shareFeeRate:s}){let a=n.add(s).add(i),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(o),m=l.buyExactIn({poolInfo:e,amount:u}),d=e.totalSellA.sub(e.realA),p,f,b;if(m.gt(d)){p=d;let g=l.buyExactOut({poolInfo:e,amount:p});f=this.calculatePreFee({postFeeAmount:g,feeRate:a}),b=f.sub(g)}else p=m,f=t,b=c;let y=this.splitFee({totalFee:b,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:p,amountB:f,splitFee:y}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:i,curveType:o,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(o).buyExactOut({poolInfo:e,amount:t}),m=n.add(s).add(i),d=this.calculatePreFee({postFeeAmount:l,feeRate:m}),p=d.sub(l),f=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:c,amountB:d,splitFee:f}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:i,curveType:o,shareFeeRate:s}){let c=this.getCurve(o).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(i)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:i,curveType:o,shareFeeRate:s}){let a=n.add(s).add(i),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),m=tn.getCurve(o).sellExactOut({poolInfo:e,amount:c});if(m.gt(e.realA))throw Error();let d=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:m,amountB:t,splitFee:d}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:i}){let o=t.add(n).add(i),s=o.isZero()?new en(0):e.mul(n).div(o),a=o.isZero()?new en(0):e.mul(i).div(o),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return _o(e,t,Ut)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(Ut),i=Ut.sub(t);return n.add(i).sub(new en(1)).div(i)}static getCurve(e){switch(e){case 0:return Vr;case 1:return Fr;case 2:return Dr}throw Error("find curve error")}};var Yn={initPriceX64:new be("515752397214619"),supply:new be(1e15),totalSellA:new be(7931e11),totalFundRaisingB:new be(85e9),totalLockedAmount:new be("0"),cliffPeriod:new be("0"),unlockPeriod:new be("0"),decimals:6,virtualA:new be("1073471847374405"),virtualB:new be("30050573465"),realA:new be(0),realB:new be(0),protocolFee:new be(0),platformId:new Jc("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new be(0),cliffPeriod:new be(0),unlockPeriod:new be(0),startTime:new be(0),totalAllocatedShare:new be(0)}},qr=new be(1e4),go=class extends Le{constructor(e){super(e)}async createLaunchpad(K){var I=K,{programId:e=Pn,authProgramId:t,platformId:n=Yn.platformId,mintA:i,decimals:o=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:m,configInfo:d,platformFeeRate:p,txVersion:f,computeBudgetConfig:b,txTipConfig:y,feePayer:g,buyAmount:A,minMintAAmount:w,slippage:h,associatedOnly:T=!0,checkCreateATAOwner:k=!1,extraSigners:x}=I,S=Ee(I,["programId","authProgramId","platformId","mintA","decimals","mintBDecimals","name","symbol","uri","migrateType","configId","configInfo","platformFeeRate","txVersion","computeBudgetConfig","txTipConfig","feePayer","buyAmount","minMintAAmount","slippage","associatedOnly","checkCreateATAOwner","extraSigners"]);var He,Zn,Po,wo,bi,yi;let C=this.createTxBuilder(g);t=t!=null?t:po(e).publicKey;let L=d;if(!L&&m){let Tt=await this.scope.connection.getAccountInfo(m);Tt&&(L=fi.decode(Tt.data))}L||this.logAndCreateError("config not found");let R=L.mintB,_=L.curveType,{publicKey:M}=vr(e,i,R),{publicKey:V}=la(e,M,i),{publicKey:H}=la(e,M,R),{publicKey:re}=un(i);console.log(`create token: ${i.toBase58()}, mintB: ${R.toBase58()}, decimals A:${o}/B:${s}, config:${m.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),A.lte(new be(0))&&this.logAndCreateError("buy amount should gt 0:",A.toString());let ge=(He=S==null?void 0:S.supply)!=null?He:Yn.supply,ae=(Zn=S==null?void 0:S.totalSellA)!=null?Zn:Yn.totalSellA,me=(Po=S==null?void 0:S.totalFundRaisingB)!=null?Po:Yn.totalFundRaisingB,xe=(wo=S==null?void 0:S.totalLockedAmount)!=null?wo:new be(0),je=p;if(!p){let Tt=await this.scope.connection.getAccountInfo(n);Tt||this.logAndCreateError("platform id not found:",n.toString()),je=Er.decode(Tt.data).feeRate}let ft=tn.getCurve(L.curveType).getInitParam({supply:ge,totalFundRaising:me,totalSell:ae,totalLockedAmount:xe,migrateFee:L.migrateFee}),We={epoch:new be(896),bump:254,status:0,mintDecimalsA:o,mintDecimalsB:s,supply:ge,totalSellA:ae,mintA:new Jc(i),mintB:R,virtualA:ft.a,virtualB:ft.b,realA:Yn.realA,realB:Yn.realB,migrateFee:L.migrateFee,migrateType:l==="amm"?0:1,protocolFee:Yn.protocolFee,platformFee:je,platformId:n,configId:m,vaultA:V,vaultB:H,creator:this.scope.ownerPubKey,totalFundRaisingB:me,vestingSchedule:{totalLockedAmount:xe,cliffPeriod:new be(0),unlockPeriod:new be(0),startTime:new be(0),totalAllocatedShare:new be(0)}},st=tn.getCurve(L.curveType),{c:jt}=st.getInitParam({supply:We.supply,totalFundRaising:We.totalFundRaisingB,totalLockedAmount:xe,totalSell:L.curveType===0?We.totalSellA:new be(0),migrateFee:L.migrateFee});try{tn.checkParam({supply:We.supply,totalFundRaising:We.totalFundRaisingB,totalSell:jt,totalLockedAmount:xe,decimals:We.mintDecimalsA,config:L,migrateType:l}),console.log("check init params success")}catch(Tt){this.logAndCreateError(`check create mint params failed, ${Tt.message}`)}C.addInstruction({instructions:[Uc(e,g!=null?g:this.scope.ownerPubKey,this.scope.ownerPubKey,m,n,t,M,i,R,V,H,re,dn,dn,o,a,c,u||"https://",{type:_===0?"ConstantCurve":_===1?"FixedCurve":_===2?"LinearCurve":"ConstantCurve",totalSellA:ae,migrateType:l,supply:ge,totalFundRaisingB:me},xe,(bi=S==null?void 0:S.cliffPeriod)!=null?bi:new be(0),(yi=S==null?void 0:S.unlockPeriod)!=null?yi:new be(0))]});let nn=new be(0),_t;if(x!=null&&x.length&&C.addInstruction({signers:x}),!S.createOnly){let{builder:Tt,extInfo:ko}=await this.buyToken({programId:e,authProgramId:t,mintA:i,mintB:R,poolInfo:We,buyAmount:A,minMintAAmount:w,shareFeeRate:S.shareFeeRate,shareFeeReceiver:S.shareFeeReceiver,configInfo:L,platformFeeRate:je,slippage:h,associatedOnly:T,checkCreateATAOwner:k});C.addInstruction(v({},Tt.AllTxData)),nn=ko.outAmount,_t=(this.scope.cluster==="devnet"||f===1)&&S.shareFeeReceiver?[Tt.allInstructions[0]]:void 0}return C.addTipInstruction(y),f===0?C.sizeCheckBuildV0({computeBudgetConfig:b,outAmount:nn,splitIns:_t,address:q(v({},We),{poolId:M})}):C.sizeCheckBuild({computeBudgetConfig:b,outAmount:nn,splitIns:_t,address:q(v({},We),{poolId:M})})}async buyToken({programId:e=Pn,authProgramId:t,mintA:n,mintB:i=Wr,poolInfo:o,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,buyAmount:d,minMintAAmount:p,slippage:f,shareFeeRate:b=new be(0),shareFeeReceiver:y,associatedOnly:g=!0,checkCreateATAOwner:A=!1}){d.lte(new be(0))&&this.logAndCreateError("buy amount should gt 0:",d.toString());let w=this.createTxBuilder(m),{publicKey:h}=vr(e,n,i);t=t!=null?t:po(e).publicKey;let T=null,k=null,x=i.equals(Wr),{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:A});S&&(T=S),w.addInstruction(K||{}),T===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:I,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:i,owner:this.scope.ownerPubKey,createInfo:x?{payer:this.scope.ownerPubKey,amount:d}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:g,checkCreateATAOwner:A});I&&(k=I),w.addInstruction(C||{}),k===void 0&&this.logAndCreateError(`cannot found mintB(${i.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let L=o;if(!L){let ae=await this.scope.connection.getAccountInfo(h,{commitment:"confirmed"});ae||this.logAndCreateError("cannot found pool:",h.toBase58()),L=fo.decode(ae.data)}let R=s,_=await Oe(this.scope.connection,[R?void 0:L.configId,a?void 0:L.platformId].filter(Boolean).map(ae=>({pubkey:ae})));if(!R){let ae=_.find(me=>me.pubkey.equals(L.configId));(!ae||!ae.accountInfo)&&this.logAndCreateError("config not found: ",L.configId.toBase58()),R=fi.decode(ae.accountInfo.data)}if(!a){let ae=_.find(me=>me.pubkey.equals(L.platformId));(!ae||!ae.accountInfo)&&this.logAndCreateError("platform info not found: ",L.configId.toBase58()),a=Er.decode(ae.accountInfo.data).feeRate}let M=tn.buyExactIn({poolInfo:L,amountB:d,protocolFeeRate:R.tradeFeeRate,platformFeeRate:a,curveType:R.curveType,shareFeeRate:b}),V=new O(M.amountA.toString()),H=f?new O(qr.sub(f).toNumber()/qr.toNumber()).clampedTo(0,1):new O(1),re=p!=null?p:f?new be(V.mul(H).toFixed(0)):M.amountA;M.amountB.lt(d)&&console.log(`maximum ${n.toBase58()} amount can buy is ${M.amountA.toString()}, input ${i.toBase58()} amount: ${M.amountB.toString()}`);let ge=y?ie(y,i,dn).publicKey:void 0;return ge&&w.addInstruction({instructions:[$c(this.scope.ownerPubKey,ge,y,i)]}),w.addInstruction({instructions:[Gc(e,this.scope.ownerPubKey,t,L.configId,L.platformId,h,T,k,L.vaultA,L.vaultB,n,i,dn,dn,M.amountB.lt(d)?M.amountB:d,re,b,ge)]}),w.addCustomComputeBudget(u),w.addTipInstruction(l),w.versionBuild({txVersion:c,extInfo:{outAmount:re}})}async sellToken({programId:e=Pn,authProgramId:t,mintA:n,mintB:i=Wr,poolInfo:o,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,sellAmount:d,minAmountB:p,slippage:f,shareFeeRate:b=new be(0),shareFeeReceiver:y,associatedOnly:g=!0,checkCreateATAOwner:A=!1}){t=t!=null?t:po(e).publicKey;let w=this.createTxBuilder(m);d.lte(new be(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:h}=vr(e,n,i),T=null,k=null,x=i.equals(Wr),{account:S,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:A});S&&(T=S),w.addInstruction(K||{}),T===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:I,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:i,owner:this.scope.ownerPubKey,createInfo:x?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:g,checkCreateATAOwner:A});I&&(k=I),w.addInstruction(C||{}),k===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let L=o;if(!L){let ae=await this.scope.connection.getAccountInfo(h);ae||this.logAndCreateError("cannot found pool",h.toBase58()),L=fo.decode(ae.data)}let R=s,_=await Oe(this.scope.connection,[R?void 0:L.configId,a?void 0:L.platformId].filter(Boolean).map(ae=>({pubkey:ae})));if(!R){let ae=_.find(me=>me.pubkey.equals(L.configId));(!ae||!ae.accountInfo)&&this.logAndCreateError("config not found: ",L.configId.toBase58()),R=fi.decode(ae.accountInfo.data)}if(!a){let ae=_.find(me=>me.pubkey.equals(L.platformId));(!ae||!ae.accountInfo)&&this.logAndCreateError("platform info not found: ",L.configId.toBase58()),a=Er.decode(ae.accountInfo.data).feeRate}let M=tn.sellExactIn({poolInfo:L,amountA:d,protocolFeeRate:R.tradeFeeRate,platformFeeRate:a,curveType:R.curveType,shareFeeRate:b}),V=new O(M.amountB.toString()),H=f?new O(qr.sub(f).toNumber()/qr.toNumber()).clampedTo(0,1):new O(1),re=p!=null?p:f?new be(V.mul(H).toFixed(0)):M.amountB;re.lte(new be(0))&&this.logAndCreateError(`out ${i.toBase58()} amount should be gt 0`);let ge=y?ie(y,i,dn).publicKey:void 0;return ge&&w.addInstruction({instructions:[$c(this.scope.ownerPubKey,ge,y,i)]}),w.addInstruction({instructions:[Xc(e,this.scope.ownerPubKey,t,L.configId,L.platformId,h,T,k,L.vaultA,L.vaultB,n,i,dn,dn,M.amountA.lt(d)?M.amountA:d,re,b,ge)]}),w.addCustomComputeBudget(u),w.addTipInstruction(l),w.versionBuild({txVersion:c,extInfo:{outAmount:re}})}async createPlatformConfig({programId:e=Pn,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:i,migrateCpLockNftScale:o,feeRate:s,name:a,web:c,img:u,txVersion:l,computeBudgetConfig:m,txTipConfig:d,feePayer:p}){let f=this.createTxBuilder(p),{publicKey:b}=ma(e,t);return f.addInstruction({instructions:[jc(e,t,n,i,b,o,s,a,c,u)]}),f.addCustomComputeBudget(m),f.addTipInstruction(d),f.versionBuild({txVersion:l,extInfo:{platformId:b}})}async updatePlatformConfig({programId:e=Pn,platformAdmin:t,platformId:n,updateInfo:i,txVersion:o,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n!=null?n:ma(e,t).publicKey;return u.addInstruction({instructions:[Hc(e,t,l,i)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:o})}async claimPlatformFee({programId:e=Pn,authProgramId:t,platformId:n,poolId:i,platformClaimFeeWallet:o,mintB:s,vaultB:a,mintBProgram:c=dn,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d,associatedOnly:p=!0,checkCreateATAOwner:f=!1}){var T;let b=this.createTxBuilder(d);t=t!=null?t:po(e).publicKey;let y=s,g=a;if(!y){let k=await this.scope.connection.getAccountInfo(i,{commitment:"confirmed"});k||this.logAndCreateError("cannot found pool:",i.toBase58());let x=fo.decode(k.data),S=await this.scope.connection.getAccountInfo(x.configId);S||this.logAndCreateError("cannot found config:",x.configId.toBase58()),y=fi.decode(S.data).mintB,g=g!=null?g:x.vaultB}(!y||!g)&&this.logAndCreateError("cannot found mint info, mintB: ",y.toBase58(),", vaultB: ",(T=g==null?void 0:g.toBase58())!=null?T:"");let A=null,{account:w,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({mint:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:p,checkCreateATAOwner:f});return w&&(A=w),b.addInstruction(h||{}),b.addInstruction({instructions:[zc(e,o,t,i,n,g,A,y,c)]}),b.addCustomComputeBudget(l),b.addTipInstruction(m),b.versionBuild({txVersion:u})}async createVesting({programId:e=Pn,poolId:t,beneficiary:n,shareAmount:i,txVersion:o,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=Wc(e,t,n).publicKey;return u.addInstruction({instructions:[Qc(e,this.scope.ownerPubKey,n,t,l,i)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:o})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Oe(this.scope.connection,e.map(c=>({pubkey:c})),t),i={},o=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=fo.decode(u.accountInfo.data);i[e[c].toBase58()]=q(v({},l),{poolId:u.accountInfo.owner}),o.push(l.configId)}let s=await Oe(this.scope.connection,o.map(c=>({pubkey:c})),t),a={};for(let c=0;c<o.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+o[c].toBase58());let l=fi.decode(u.accountInfo.data);a[o[c].toBase58()]=q(v({},l),{configId:u.accountInfo.owner})}return{poolInfoMap:Object.keys(i).reduce((c,u)=>q(v({},c),{[u]:q(v({},i[u]),{configInfo:a[i[u].configId.toBase58()]})}),{})}}};import{PublicKey as lf}from"@solana/web3.js";import{MintLayout as mf,TOKEN_2022_PROGRAM_ID as da,TOKEN_PROGRAM_ID as pa}from"@solana/spl-token";var Ao=class extends Le{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Set;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:i="strict"}=t||{},{mintList:o,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),c=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(s),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(gn.address,gn),this._mintGroup.official.add(gn.address),o.forEach(u=>{var l;this._blackTokenMap.has(u.address)||(this._tokenMap.set(u.address,q(v({},u),{type:"raydium",priority:2,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?da.toBase58():pa.toBase58()})),this._mintGroup.official.add(u.address))}),c.forEach(u=>{var l;this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,q(v({},u),{type:"jupiter",priority:1,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?da.toBase58():pa.toBase58(),tags:u.freezeAuthority?[...u.tags||[],"hasFreeze"]:u.tags})),this._mintGroup.jup.add(u.address))}),this._extraTokenList.forEach(u=>{this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,q(v({},u),{type:"extra",priority:1,programId:u.programId||u.tags.includes("token-2022")?da.toBase58():pa.toBase58()})),this._mintGroup.extra.add(u.address))}),this._tokenList=Array.from(this._tokenMap).map(u=>u[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),i=this._tokenMap.get(n);if(i)return i;if(n.toLocaleUpperCase()==="SOL")return gn;let o=(await this.scope.api.getTokenInfo([n]))[0];if(o)return this._mintGroup.extra.add(n),this._tokenMap.set(n,q(v({},o),{priority:2})),o;let s=await this.scope.connection.getAccountInfo(new lf(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=mf.decode(s.data),c=n.toString().substring(0,6),u={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:c,name:c,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,u),u}};var Ur=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:i,api:o,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=i?new Wt(i):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=o,this._apiCacheTime=c||5*60*1e3,this.logger=fe("Raydium"),this.farm=new Fi({scope:this,moduleName:"Raydium_Farm"}),this.account=new Ri({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new no({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Ao({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new co({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new oo({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new uo({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new vt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new li({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new pi({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new go({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let m=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:m,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=df({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:i,logCount:o,logRequests:s,urlConfigs:a}=t,c=new Zo({cluster:n,timeout:i,urlConfigs:a,logCount:o,logRequests:s}),u=new Ur(q(v({},t),{api:c}));return await u.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error($o);return this._owner.publicKey}setOwner(e){return this._owner=e?new Wt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(ou);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error($o),new Error($o)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(i=>q(v({},i),{mintAuthority:i.mint_authority||void 0,freezeAuthority:i.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};export{Ur as Raydium};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=raydium.mjs.map