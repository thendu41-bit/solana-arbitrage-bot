var dm=Object.defineProperty,pm=Object.defineProperties;var fm=Object.getOwnPropertyDescriptors;var Jo=Object.getOwnPropertySymbols;var yu=Object.prototype.hasOwnProperty,gu=Object.prototype.propertyIsEnumerable;var bu=(o,e,t)=>e in o?dm(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,v=(o,e)=>{for(var t in e||(e={}))yu.call(e,t)&&bu(o,t,e[t]);if(Jo)for(var t of Jo(e))gu.call(e,t)&&bu(o,t,e[t]);return o},U=(o,e)=>pm(o,fm(e));var We=(o,e)=>{var t={};for(var n in o)yu.call(o,n)&&e.indexOf(n)<0&&(t[n]=o[n]);if(o!=null&&Jo)for(var n of Jo(o))e.indexOf(n)<0&&gu.call(o,n)&&(t[n]=o[n]);return t};import uc from"axios";import{PublicKey as wu}from"@solana/web3.js";import{get as ws,set as Au}from"lodash";var bm=(i=>(i[i.Error=0]="Error",i[i.Warning=1]="Warning",i[i.Info=2]="Info",i[i.Debug=3]="Debug",i))(bm||{}),ks=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},hs={},Pu={};function be(o){let e=ws(hs,o);if(!e){let t=ws(Pu,o);e=new ks({name:o,logLevel:t}),Au(hs,o,e)}return e}function by(o,e){Au(Pu,o,e);let t=ws(hs,o);t&&(t.level=e)}import{MINT_SIZE as ym,TOKEN_PROGRAM_ID as gm,getTransferFeeConfig as Am,unpackMint as Pm}from"@solana/spl-token";var Ts=be("Raydium_accountInfo_util");async function Ut(o,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:r=100}=v({batchRequest:!1},t),s=Is(e,r),a=new Array(s.length).fill([]);if(n){let c=s.map(m=>{let d=o._buildArgs([m.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=Is(c,10);a=(await(await Promise.all(u.map(async m=>await o._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&Ts.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:b,lamports:f,owner:y,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&Ts.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:b,lamports:f,owner:new wu(y),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>o.getMultipleAccountsInfo(c,i)))}catch(c){c instanceof Error&&Ts.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Oe(o,e,t){let n=await Ut(o,e.map(i=>i.pubkey),t);return e.map((i,r)=>U(v({},i),{accountInfo:n[r]}))}var wm=(n=>(n[n.Uninitialized=0]="Uninitialized",n[n.Mint=1]="Mint",n[n.Account=2]="Account",n))(wm||{}),Iy=1;async function fi({connection:o,mints:e,config:t}){var r,s,a;if(e.length===0)return{};let n=await Oe(o,e.map(c=>({pubkey:yt(c)})),t),i={};for(let c of n){if(!c.accountInfo||c.accountInfo.data.length<ym){console.log("invalid mint account",c.pubkey.toBase58());continue}let u=Pm(c.pubkey,c.accountInfo,(r=c.accountInfo)==null?void 0:r.owner);i[c.pubkey.toString()]=U(v({},u),{programId:((s=c.accountInfo)==null?void 0:s.owner)||gm,feeConfig:(a=Am(u))!=null?a:void 0})}return i[wu.default.toBase58()]=i[$.toBase58()],i}import Qe from"bn.js";var bi=9e15,Nn=1e9,Bs="0123456789abcdef",tr="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",nr="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",xs={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-bi,maxE:bi,crypto:!1},Iu,yn,le=!0,or="[DecimalError] ",Rn=or+"Invalid argument: ",Bu=or+"Precision limit exceeded",xu=or+"crypto unavailable",Su="[object Decimal]",gt=Math.floor,ot=Math.pow,km=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,hm=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,Tm=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,Ku=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Xt=1e7,re=7,Im=9007199254740991,Bm=tr.length-1,Ss=nr.length-1,G={toStringTag:Su};G.absoluteValue=G.abs=function(){var o=new this.constructor(this);return o.s<0&&(o.s=1),ne(o)};G.ceil=function(){return ne(new this.constructor(this),this.e+1,2)};G.clampedTo=G.clamp=function(o,e){var t,n=this,i=n.constructor;if(o=new i(o),e=new i(e),!o.s||!e.s)return new i(NaN);if(o.gt(e))throw Error(Rn+e);return t=n.cmp(o),t<0?o:n.cmp(e)>0?e:new i(n)};G.comparedTo=G.cmp=function(o){var e,t,n,i,r=this,s=r.d,a=(o=new r.constructor(o)).d,c=r.s,u=o.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(r.e!==o.e)return r.e>o.e^c<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===i?0:n>i^c<0?1:-1};G.cosine=G.cos=function(){var o,e,t=this,n=t.constructor;return t.d?t.d[0]?(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+re,n.rounding=1,t=xm(n,Ou(n,t)),n.precision=o,n.rounding=e,ne(yn==2||yn==3?t.neg():t,o,e,!0)):new n(1):new n(NaN)};G.cubeRoot=G.cbrt=function(){var o,e,t,n,i,r,s,a,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(le=!1,r=l.s*ot(l.s*l,1/3),!r||Math.abs(r)==1/0?(t=dt(l.d),o=l.e,(r=(o-t.length+1)%3)&&(t+=r==1||r==-2?"0":"00"),r=ot(t,1/3),o=gt((o+1)/3)-(o%3==(o<0?-1:2)),r==1/0?t="5e"+o:(t=r.toExponential(),t=t.slice(0,t.indexOf("e")+1)+o),n=new m(t),n.s=l.s):n=new m(r.toString()),s=(o=m.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Re(u.plus(l).times(a),u.plus(c),s+2,1),dt(a.d).slice(0,s)===(t=dt(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(ne(a,o+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(ne(n,o+1,1),e=!n.times(n).times(n).eq(l));break}return le=!0,ne(n,o,m.rounding,e)};G.decimalPlaces=G.dp=function(){var o,e=this.d,t=NaN;if(e){if(o=e.length-1,t=(o-gt(this.e/re))*re,o=e[o],o)for(;o%10==0;o/=10)t--;t<0&&(t=0)}return t};G.dividedBy=G.div=function(o){return Re(this,new this.constructor(o))};G.dividedToIntegerBy=G.divToInt=function(o){var e=this,t=e.constructor;return ne(Re(e,new t(o),0,1,1),t.precision,t.rounding)};G.equals=G.eq=function(o){return this.cmp(o)===0};G.floor=function(){return ne(new this.constructor(this),this.e+1,3)};G.greaterThan=G.gt=function(o){return this.cmp(o)>0};G.greaterThanOrEqualTo=G.gte=function(o){var e=this.cmp(o);return e==1||e===0};G.hyperbolicCosine=G.cosh=function(){var o,e,t,n,i,r=this,s=r.constructor,a=new s(1);if(!r.isFinite())return new s(r.s?1/0:NaN);if(r.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(r.e,r.sd())+4,s.rounding=1,i=r.d.length,i<32?(o=Math.ceil(i/3),e=(1/sr(4,o)).toString()):(o=16,e="2.3283064365386962890625e-10"),r=yi(s,1,r.times(e),new s(1),!0);for(var c,u=o,l=new s(8);u--;)c=r.times(r),r=a.minus(c.times(l.minus(c.times(l))));return ne(r,s.precision=t,s.rounding=n,!0)};G.hyperbolicSine=G.sinh=function(){var o,e,t,n,i=this,r=i.constructor;if(!i.isFinite()||i.isZero())return new r(i);if(e=r.precision,t=r.rounding,r.precision=e+Math.max(i.e,i.sd())+4,r.rounding=1,n=i.d.length,n<3)i=yi(r,2,i,i,!0);else{o=1.4*Math.sqrt(n),o=o>16?16:o|0,i=i.times(1/sr(5,o)),i=yi(r,2,i,i,!0);for(var s,a=new r(5),c=new r(16),u=new r(20);o--;)s=i.times(i),i=i.times(a.plus(s.times(c.times(s).plus(u))))}return r.precision=e,r.rounding=t,ne(i,e,t,!0)};G.hyperbolicTangent=G.tanh=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+7,n.rounding=1,Re(t.sinh(),t.cosh(),n.precision=o,n.rounding=e)):new n(t.s)};G.inverseCosine=G.acos=function(){var o,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,r=t.rounding;return n!==-1?n===0?e.isNeg()?Gt(t,i,r):new t(0):new t(NaN):e.isZero()?Gt(t,i+4,r).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),o=Gt(t,i+4,r).times(.5),t.precision=i,t.rounding=r,o.minus(e))};G.inverseHyperbolicCosine=G.acosh=function(){var o,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(o=n.precision,e=n.rounding,n.precision=o+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,le=!1,t=t.times(t).minus(1).sqrt().plus(t),le=!0,n.precision=o,n.rounding=e,t.ln()):new n(t)};G.inverseHyperbolicSine=G.asinh=function(){var o,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,le=!1,t=t.times(t).plus(1).sqrt().plus(t),le=!0,n.precision=o,n.rounding=e,t.ln())};G.inverseHyperbolicTangent=G.atanh=function(){var o,e,t,n,i=this,r=i.constructor;return i.isFinite()?i.e>=0?new r(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(o=r.precision,e=r.rounding,n=i.sd(),Math.max(n,o)<2*-i.e-1?ne(new r(i),o,e,!0):(r.precision=t=n-i.e,i=Re(i.plus(1),new r(1).minus(i),t+o,1),r.precision=o+4,r.rounding=1,i=i.ln(),r.precision=o,r.rounding=e,i.times(.5))):new r(NaN)};G.inverseSine=G.asin=function(){var o,e,t,n,i=this,r=i.constructor;return i.isZero()?new r(i):(e=i.abs().cmp(1),t=r.precision,n=r.rounding,e!==-1?e===0?(o=Gt(r,t+4,n).times(.5),o.s=i.s,o):new r(NaN):(r.precision=t+6,r.rounding=1,i=i.div(new r(1).minus(i.times(i)).sqrt().plus(1)).atan(),r.precision=t,r.rounding=n,i.times(2)))};G.inverseTangent=G.atan=function(){var o,e,t,n,i,r,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=Ss)return s=Gt(l,m+4,d).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(m+4<=Ss)return s=Gt(l,m+4,d).times(.5),s.s=u.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/re+2|0),o=t;o;--o)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(le=!1,e=Math.ceil(a/re),n=1,c=u.times(u),s=new l(u),i=u;o!==-1;)if(i=i.times(c),r=s.minus(i.div(n+=2)),i=i.times(c),s=r.plus(i.div(n+=2)),s.d[e]!==void 0)for(o=e;s.d[o]===r.d[o]&&o--;);return t&&(s=s.times(2<<t-1)),le=!0,ne(s,l.precision=m,l.rounding=d,!0)};G.isFinite=function(){return!!this.d};G.isInteger=G.isInt=function(){return!!this.d&&gt(this.e/re)>this.d.length-2};G.isNaN=function(){return!this.s};G.isNegative=G.isNeg=function(){return this.s<0};G.isPositive=G.isPos=function(){return this.s>0};G.isZero=function(){return!!this.d&&this.d[0]===0};G.lessThan=G.lt=function(o){return this.cmp(o)<0};G.lessThanOrEqualTo=G.lte=function(o){return this.cmp(o)<1};G.logarithm=G.log=function(o){var e,t,n,i,r,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(o==null)o=new l(10),e=!0;else{if(o=new l(o),t=o.d,o.s<0||!t||!t[0]||o.eq(1))return new l(NaN);e=o.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)r=!0;else{for(i=t[0];i%10===0;)i/=10;r=i!==1}if(le=!1,a=m+p,s=Ln(u,a),n=e?ir(l,a+10):Ln(o,a),c=Re(s,n,a,1),Fi(c.d,i=m,d))do if(a+=10,s=Ln(u,a),n=e?ir(l,a+10):Ln(o,a),c=Re(s,n,a,1),!r){+dt(c.d).slice(i+1,i+15)+1==1e14&&(c=ne(c,m+1,0));break}while(Fi(c.d,i+=10,d));return le=!0,ne(c,m,d)};G.minus=G.sub=function(o){var e,t,n,i,r,s,a,c,u,l,m,d,p=this,b=p.constructor;if(o=new b(o),!p.d||!o.d)return!p.s||!o.s?o=new b(NaN):p.d?o.s=-o.s:o=new b(o.d||p.s!==o.s?p:NaN),o;if(p.s!=o.s)return o.s=-o.s,p.plus(o);if(u=p.d,d=o.d,a=b.precision,c=b.rounding,!u[0]||!d[0]){if(d[0])o.s=-o.s;else if(u[0])o=new b(p);else return new b(c===3?-0:0);return le?ne(o,a,c):o}if(t=gt(o.e/re),l=gt(p.e/re),u=u.slice(),r=l-t,r){for(m=r<0,m?(e=u,r=-r,s=d.length):(e=d,t=l,s=u.length),n=Math.max(Math.ceil(a/re),s)+2,r>n&&(r=n,e.length=1),e.reverse(),n=r;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}r=0}for(m&&(e=u,u=d,d=e,o.s=-o.s),s=u.length,n=d.length-s;n>0;--n)u[s++]=0;for(n=d.length;n>r;){if(u[--n]<d[n]){for(i=n;i&&u[--i]===0;)u[i]=Xt-1;--u[i],u[n]+=Xt}u[n]-=d[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(o.d=u,o.e=rr(u,t),le?ne(o,a,c):o):new b(c===3?-0:0)};G.modulo=G.mod=function(o){var e,t=this,n=t.constructor;return o=new n(o),!t.d||!o.s||o.d&&!o.d[0]?new n(NaN):!o.d||t.d&&!t.d[0]?ne(new n(t),n.precision,n.rounding):(le=!1,n.modulo==9?(e=Re(t,o.abs(),0,3,1),e.s*=o.s):e=Re(t,o,0,n.modulo,1),e=e.times(o),le=!0,t.minus(e))};G.naturalExponential=G.exp=function(){return Ks(this)};G.naturalLogarithm=G.ln=function(){return Ln(this)};G.negated=G.neg=function(){var o=new this.constructor(this);return o.s=-o.s,ne(o)};G.plus=G.add=function(o){var e,t,n,i,r,s,a,c,u,l,m=this,d=m.constructor;if(o=new d(o),!m.d||!o.d)return!m.s||!o.s?o=new d(NaN):m.d||(o=new d(o.d||m.s===o.s?m:NaN)),o;if(m.s!=o.s)return o.s=-o.s,m.minus(o);if(u=m.d,l=o.d,a=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(o=new d(m)),le?ne(o,a,c):o;if(r=gt(m.e/re),n=gt(o.e/re),u=u.slice(),i=r-n,i){for(i<0?(t=u,i=-i,s=l.length):(t=l,n=r,s=u.length),r=Math.ceil(a/re),s=r>s?r+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=u.length,i=l.length,s-i<0&&(i=s,t=l,l=u,u=t),e=0;i;)e=(u[--i]=u[i]+l[i]+e)/Xt|0,u[i]%=Xt;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return o.d=u,o.e=rr(u,n),le?ne(o,a,c):o};G.precision=G.sd=function(o){var e,t=this;if(o!==void 0&&o!==!!o&&o!==1&&o!==0)throw Error(Rn+o);return t.d?(e=Cu(t.d),o&&t.e+1>e&&(e=t.e+1)):e=NaN,e};G.round=function(){var o=this,e=o.constructor;return ne(new e(o),o.e+1,e.rounding)};G.sine=G.sin=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+re,n.rounding=1,t=Km(n,Ou(n,t)),n.precision=o,n.rounding=e,ne(yn>2?t.neg():t,o,e,!0)):new n(NaN)};G.squareRoot=G.sqrt=function(){var o,e,t,n,i,r,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(le=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=dt(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=gt((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(r=n,n=r.plus(Re(s,r,t+2,1)).times(.5),dt(r.d).slice(0,t)===(e=dt(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(ne(r,c+1,0),r.times(r).eq(s))){n=r;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(ne(n,c+1,1),o=!n.times(n).eq(s));break}return le=!0,ne(n,c,l.rounding,o)};G.tangent=G.tan=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+10,n.rounding=1,t=t.sin(),t.s=1,t=Re(t,new n(1).minus(t.times(t)).sqrt(),o+10,0),n.precision=o,n.rounding=e,ne(yn==2||yn==4?t.neg():t,o,e,!0)):new n(NaN)};G.times=G.mul=function(o){var e,t,n,i,r,s,a,c,u,l=this,m=l.constructor,d=l.d,p=(o=new m(o)).d;if(o.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!o.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?o.s/0:o.s*0);for(t=gt(l.e/re)+gt(o.e/re),c=d.length,u=p.length,c<u&&(r=d,d=p,p=r,s=c,c=u,u=s),r=[],s=c+u,n=s;n--;)r.push(0);for(n=u;--n>=0;){for(e=0,i=c+n;i>n;)a=r[i]+p[n]*d[i-n-1]+e,r[i--]=a%Xt|0,e=a/Xt|0;r[i]=(r[i]+e)%Xt|0}for(;!r[--s];)r.pop();return e?++t:r.shift(),o.d=r,o.e=rr(r,t),le?ne(o,m.precision,m.rounding):o};G.toBinary=function(o,e){return Ls(this,2,o,e)};G.toDecimalPlaces=G.toDP=function(o,e){var t=this,n=t.constructor;return t=new n(t),o===void 0?t:(St(o,0,Nn),e===void 0?e=n.rounding:St(e,0,8),ne(t,o+t.e+1,e))};G.toExponential=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=rn(n,!0):(St(o,0,Nn),e===void 0?e=i.rounding:St(e,0,8),n=ne(new i(n),o+1,e),t=rn(n,!0,o+1)),n.isNeg()&&!n.isZero()?"-"+t:t};G.toFixed=function(o,e){var t,n,i=this,r=i.constructor;return o===void 0?t=rn(i):(St(o,0,Nn),e===void 0?e=r.rounding:St(e,0,8),n=ne(new r(i),o+i.e+1,e),t=rn(n,!1,o+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};G.toFraction=function(o){var e,t,n,i,r,s,a,c,u,l,m,d,p=this,b=p.d,f=p.constructor;if(!b)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),r=e.e=Cu(b)-p.e-1,s=r%re,e.d[0]=ot(10,s<0?re+s:s),o==null)o=r>0?e:u;else{if(a=new f(o),!a.isInt()||a.lt(u))throw Error(Rn+a);o=a.gt(e)?r>0?e:u:a}for(le=!1,a=new f(dt(b)),l=f.precision,f.precision=r=b.length*re*2;m=Re(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(o)!=1;)t=n,n=i,i=u,u=c.plus(m.times(i)),c=i,i=e,e=a.minus(m.times(i)),a=i;return i=Re(o.minus(t),n,0,1,1),c=c.plus(i.times(u)),t=t.plus(i.times(n)),c.s=u.s=p.s,d=Re(u,n,r,1).minus(p).abs().cmp(Re(c,t,r,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,le=!0,d};G.toHexadecimal=G.toHex=function(o,e){return Ls(this,16,o,e)};G.toNearest=function(o,e){var t=this,n=t.constructor;if(t=new n(t),o==null){if(!t.d)return t;o=new n(1),e=n.rounding}else{if(o=new n(o),e===void 0?e=n.rounding:St(e,0,8),!t.d)return o.s?t:o;if(!o.d)return o.s&&(o.s=t.s),o}return o.d[0]?(le=!1,t=Re(t,o,0,e,1).times(o),le=!0,ne(t)):(o.s=t.s,t=o),t};G.toNumber=function(){return+this};G.toOctal=function(o,e){return Ls(this,8,o,e)};G.toPower=G.pow=function(o){var e,t,n,i,r,s,a=this,c=a.constructor,u=+(o=new c(o));if(!a.d||!o.d||!a.d[0]||!o.d[0])return new c(ot(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,r=c.rounding,o.eq(1))return ne(a,n,r);if(e=gt(o.e/re),e>=o.d.length-1&&(t=u<0?-u:u)<=Im)return i=Lu(c,a,t,n),o.s<0?new c(1).div(i):ne(i,n,r);if(s=a.s,s<0){if(e<o.d.length-1)return new c(NaN);if((o.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=ot(+a,u),e=t==0||!isFinite(t)?gt(u*(Math.log("0."+dt(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(le=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),i=Ks(o.times(Ln(a,n+t)),n),i.d&&(i=ne(i,n+5,1),Fi(i.d,n,r)&&(e=n+10,i=ne(Ks(o.times(Ln(a,e+t)),e),e+5,1),+dt(i.d).slice(n+1,n+15)+1==1e14&&(i=ne(i,n+1,0)))),i.s=s,le=!0,c.rounding=r,ne(i,n,r))};G.toPrecision=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=rn(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(St(o,1,Nn),e===void 0?e=i.rounding:St(e,0,8),n=ne(new i(n),o,e),t=rn(n,o<=n.e||n.e<=i.toExpNeg,o)),n.isNeg()&&!n.isZero()?"-"+t:t};G.toSignificantDigits=G.toSD=function(o,e){var t=this,n=t.constructor;return o===void 0?(o=n.precision,e=n.rounding):(St(o,1,Nn),e===void 0?e=n.rounding:St(e,0,8)),ne(new n(t),o,e)};G.toString=function(){var o=this,e=o.constructor,t=rn(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()&&!o.isZero()?"-"+t:t};G.truncated=G.trunc=function(){return ne(new this.constructor(this),this.e+1,1)};G.valueOf=G.toJSON=function(){var o=this,e=o.constructor,t=rn(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()?"-"+t:t};function dt(o){var e,t,n,i=o.length-1,r="",s=o[0];if(i>0){for(r+=s,e=1;e<i;e++)n=o[e]+"",t=re-n.length,t&&(r+=Cn(t)),r+=n;s=o[e],n=s+"",t=re-n.length,t&&(r+=Cn(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return r+s}function St(o,e,t){if(o!==~~o||o<e||o>t)throw Error(Rn+o)}function Fi(o,e,t,n){var i,r,s,a;for(r=o[0];r>=10;r/=10)--e;return--e<0?(e+=re,i=0):(i=Math.ceil((e+1)/re),e%=re),r=ot(10,re-e),a=o[i]%r|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==r||t>3&&a+1==r/2)&&(o[i+1]/r/100|0)==ot(10,e-2)-1||(a==r/2||a==0)&&(o[i+1]/r/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==r||!n&&t>3&&a+1==r/2)&&(o[i+1]/r/1e3|0)==ot(10,e-3)-1,s}function er(o,e,t){for(var n,i=[0],r,s=0,a=o.length;s<a;){for(r=i.length;r--;)i[r]*=e;for(i[0]+=Bs.indexOf(o.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function xm(o,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/sr(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),o.precision+=t,e=yi(o,1,e.times(i),new o(1));for(var r=t;r--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return o.precision-=t,e}var Re=function(){function o(n,i,r){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*i+a,n[c]=s%r|0,a=s/r|0;return a&&n.unshift(a),n}function e(n,i,r,s){var a,c;if(r!=s)c=r>s?1:-1;else for(a=c=0;a<r;a++)if(n[a]!=i[a]){c=n[a]>i[a]?1:-1;break}return c}function t(n,i,r,s){for(var a=0;r--;)n[r]-=a,a=n[r]<i[r]?1:0,n[r]=a*s+n[r]-i[r];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,r,s,a,c){var u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K,B,C,L,R=n.constructor,D=n.s==i.s?1:-1,F=n.d,W=i.d;if(!F||!F[0]||!W||!W[0])return new R(!n.s||!i.s||(F?W&&F[0]==W[0]:!W)?NaN:F&&F[0]==0||!W?D*0:D/0);for(c?(p=1,l=n.e-i.e):(c=Xt,p=re,l=gt(n.e/p)-gt(i.e/p)),C=W.length,K=F.length,g=new R(D),P=g.d=[],m=0;W[m]==(F[m]||0);m++);if(W[m]>(F[m]||0)&&l--,r==null?(h=r=R.precision,s=R.rounding):a?h=r+(n.e-i.e)+1:h=r,h<0)P.push(1),b=!0;else{if(h=h/p+2|0,m=0,C==1){for(d=0,W=W[0],h++;(m<K||d)&&h--;m++)S=d*c+(F[m]||0),P[m]=S/W|0,d=S%W|0;b=d||m<K}else{for(d=c/(W[0]+1)|0,d>1&&(W=o(W,d,c),F=o(F,d,c),C=W.length,K=F.length),x=C,k=F.slice(0,C),T=k.length;T<C;)k[T++]=0;L=W.slice(),L.unshift(0),B=W[0],W[1]>=c/2&&++B;do d=0,u=e(W,k,C,T),u<0?(I=k[0],C!=T&&(I=I*c+(k[1]||0)),d=I/B|0,d>1?(d>=c&&(d=c-1),f=o(W,d,c),y=f.length,T=k.length,u=e(f,k,y,T),u==1&&(d--,t(f,C<y?L:W,y,c))):(d==0&&(u=d=1),f=W.slice()),y=f.length,y<T&&f.unshift(0),t(k,f,T,c),u==-1&&(T=k.length,u=e(W,k,C,T),u<1&&(d++,t(k,C<T?L:W,T,c))),T=k.length):u===0&&(d++,k=[0]),P[m++]=d,u&&k[0]?k[T++]=F[x]||0:(k=[F[x]],T=1);while((x++<K||k[0]!==void 0)&&h--);b=k[0]!==void 0}P[0]||P.shift()}if(p==1)g.e=l,Iu=b;else{for(m=1,d=P[0];d>=10;d/=10)m++;g.e=m+l*p-1,ne(g,a?r+g.e+1:r,s,b)}return g}}();function ne(o,e,t,n){var i,r,s,a,c,u,l,m,d,p=o.constructor;e:if(e!=null){if(m=o.d,!m)return o;for(i=1,a=m[0];a>=10;a/=10)i++;if(r=e-i,r<0)r+=re,s=e,l=m[d=0],c=l/ot(10,i-s-1)%10|0;else if(d=Math.ceil((r+1)/re),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=c=0,i=1,r%=re,s=r-re+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;r%=re,s=r-re+i,c=s<0?0:l/ot(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%ot(10,i-s-1)),u=t<4?(c||n)&&(t==0||t==(o.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(r>0?s>0?l/ot(10,i-s):0:m[d-1])%10&1||t==(o.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=o.e+1,m[0]=ot(10,(re-e%re)%re),o.e=-e||0):m[0]=o.e=0,o;if(r==0?(m.length=d,a=1,d--):(m.length=d+1,a=ot(10,re-r),m[d]=s>0?(l/ot(10,i-s)%ot(10,s)|0)*a:0),u)for(;;)if(d==0){for(r=1,s=m[0];s>=10;s/=10)r++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;r!=a&&(o.e++,m[0]==Xt&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Xt)break;m[d--]=0,a=1}for(r=m.length;m[--r]===0;)m.pop()}return le&&(o.e>p.maxE?(o.d=null,o.e=NaN):o.e<p.minE&&(o.e=0,o.d=[0])),o}function rn(o,e,t){if(!o.isFinite())return Nu(o);var n,i=o.e,r=dt(o.d),s=r.length;return e?(t&&(n=t-s)>0?r=r.charAt(0)+"."+r.slice(1)+Cn(n):s>1&&(r=r.charAt(0)+"."+r.slice(1)),r=r+(o.e<0?"e":"e+")+o.e):i<0?(r="0."+Cn(-i-1)+r,t&&(n=t-s)>0&&(r+=Cn(n))):i>=s?(r+=Cn(i+1-s),t&&(n=t-i-1)>0&&(r=r+"."+Cn(n))):((n=i+1)<s&&(r=r.slice(0,n)+"."+r.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(r+="."),r+=Cn(n))),r}function rr(o,e){var t=o[0];for(e*=re;t>=10;t/=10)e++;return e}function ir(o,e,t){if(e>Bm)throw le=!0,t&&(o.precision=t),Error(Bu);return ne(new o(tr),e,1,!0)}function Gt(o,e,t){if(e>Ss)throw Error(Bu);return ne(new o(nr),e,t,!0)}function Cu(o){var e=o.length-1,t=e*re+1;if(e=o[e],e){for(;e%10==0;e/=10)t--;for(e=o[0];e>=10;e/=10)t++}return t}function Cn(o){for(var e="";o--;)e+="0";return e}function Lu(o,e,t,n){var i,r=new o(1),s=Math.ceil(n/re+4);for(le=!1;;){if(t%2&&(r=r.times(e),hu(r.d,s)&&(i=!0)),t=gt(t/2),t===0){t=r.d.length-1,i&&r.d[t]===0&&++r.d[t];break}e=e.times(e),hu(e.d,s)}return le=!0,r}function ku(o){return o.d[o.d.length-1]&1}function Ru(o,e,t){for(var n,i=new o(e[0]),r=0;++r<e.length;)if(n=new o(e[r]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function Ks(o,e){var t,n,i,r,s,a,c,u=0,l=0,m=0,d=o.constructor,p=d.rounding,b=d.precision;if(!o.d||!o.d[0]||o.e>17)return new d(o.d?o.d[0]?o.s<0?0:1/0:1:o.s?o.s<0?0:o:0/0);for(e==null?(le=!1,c=b):c=e,a=new d(.03125);o.e>-2;)o=o.times(a),m+=5;for(n=Math.log(ot(2,m))/Math.LN10*2+5|0,c+=n,t=r=s=new d(1),d.precision=c;;){if(r=ne(r.times(o),c,1),t=t.times(++l),a=s.plus(Re(r,t,c,1)),dt(a.d).slice(0,c)===dt(s.d).slice(0,c)){for(i=m;i--;)s=ne(s.times(s),c,1);if(e==null)if(u<3&&Fi(s.d,c-n,p,u))d.precision=c+=10,t=r=a=new d(1),l=0,u++;else return ne(s,d.precision=b,p,le=!0);else return d.precision=b,s}s=a}}function Ln(o,e){var t,n,i,r,s,a,c,u,l,m,d,p=1,b=10,f=o,y=f.d,g=f.constructor,P=g.rounding,k=g.precision;if(f.s<0||!y||!y[0]||!f.e&&y[0]==1&&y.length==1)return new g(y&&!y[0]?-1/0:f.s!=1?NaN:y?0:f);if(e==null?(le=!1,l=k):l=e,g.precision=l+=b,t=dt(y),n=t.charAt(0),Math.abs(r=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(o),t=dt(f.d),n=t.charAt(0),p++;r=f.e,n>1?(f=new g("0."+t),r++):f=new g(n+"."+t.slice(1))}else return u=ir(g,l+2,k).times(r+""),f=Ln(new g(n+"."+t.slice(1)),l-b).plus(u),g.precision=k,e==null?ne(f,k,P,le=!0):f;for(m=f,c=s=f=Re(f.minus(1),f.plus(1),l,1),d=ne(f.times(f),l,1),i=3;;){if(s=ne(s.times(d),l,1),u=c.plus(Re(s,new g(i),l,1)),dt(u.d).slice(0,l)===dt(c.d).slice(0,l))if(c=c.times(2),r!==0&&(c=c.plus(ir(g,l+2,k).times(r+""))),c=Re(c,new g(p),l,1),e==null)if(Fi(c.d,l-b,P,a))g.precision=l+=b,u=s=f=Re(m.minus(1),m.plus(1),l,1),d=ne(f.times(f),l,1),i=a=1;else return ne(c,g.precision=k,P,le=!0);else return g.precision=k,c;c=u,i+=2}}function Nu(o){return String(o.s*o.s/0)}function Cs(o,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,o.e=t=t-n-1,o.d=[],n=(t+1)%re,t<0&&(n+=re),n<i){for(n&&o.d.push(+e.slice(0,n)),i-=re;n<i;)o.d.push(+e.slice(n,n+=re));e=e.slice(n),n=re-e.length}else n-=i;for(;n--;)e+="0";o.d.push(+e),le&&(o.e>o.constructor.maxE?(o.d=null,o.e=NaN):o.e<o.constructor.minE&&(o.e=0,o.d=[0]))}else o.e=0,o.d=[0];return o}function Sm(o,e){var t,n,i,r,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),Ku.test(e))return Cs(o,e)}else if(e==="Infinity"||e==="NaN")return+e||(o.s=NaN),o.e=NaN,o.d=null,o;if(hm.test(e))t=16,e=e.toLowerCase();else if(km.test(e))t=2;else if(Tm.test(e))t=8;else throw Error(Rn+e);for(r=e.search(/p/i),r>0?(c=+e.slice(r+1),e=e.substring(2,r)):e=e.slice(2),r=e.indexOf("."),s=r>=0,n=o.constructor,s&&(e=e.replace(".",""),a=e.length,r=a-r,i=Lu(n,new n(t),r,r*2)),u=er(e,t,Xt),l=u.length-1,r=l;u[r]===0;--r)u.pop();return r<0?new n(o.s*0):(o.e=rr(u,l),o.d=u,le=!1,s&&(o=Re(o,i,a*4)),c&&(o=o.times(Math.abs(c)<54?ot(2,c):Di.pow(2,c))),le=!0,o)}function Km(o,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:yi(o,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/sr(5,t)),e=yi(o,2,e,e);for(var i,r=new o(5),s=new o(16),a=new o(20);t--;)i=e.times(e),e=e.times(r.plus(i.times(s.times(i).minus(a))));return e}function yi(o,e,t,n,i){var r,s,a,c,u=1,l=o.precision,m=Math.ceil(l/re);for(le=!1,c=t.times(t),a=new o(n);;){if(s=Re(a.times(c),new o(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=Re(s.times(c),new o(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(r=m;s.d[r]===a.d[r]&&r--;);if(r==-1)break}r=a,a=n,n=s,s=r,u++}return le=!0,s.d.length=m+1,s}function sr(o,e){for(var t=o;--e;)t*=o;return t}function Ou(o,e){var t,n=e.s<0,i=Gt(o,o.precision,1),r=i.times(.5);if(e=e.abs(),e.lte(r))return yn=n?4:1,e;if(t=e.divToInt(i),t.isZero())yn=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(r))return yn=ku(t)?n?2:3:n?4:1,e;yn=ku(t)?n?1:4:n?3:2}return e.minus(i).abs()}function Ls(o,e,t,n){var i,r,s,a,c,u,l,m,d,p=o.constructor,b=t!==void 0;if(b?(St(t,1,Nn),n===void 0?n=p.rounding:St(n,0,8)):(t=p.precision,n=p.rounding),!o.isFinite())l=Nu(o);else{for(l=rn(o),s=l.indexOf("."),b?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=er(rn(d),10,i),d.e=d.d.length),m=er(l,10,i),r=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=b?"0p+0":"0";else{if(s<0?r--:(o=new p(o),o.d=m,o.e=r,o=Re(o,d,t,n,0,i),m=o.d,r=o.e,u=Iu),s=m[t],a=i/2,u=u||m[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(o.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&m[t-1]&1||n===(o.s<0?8:7)),m.length=t,u)for(;++m[--t]>i-1;)m[t]=0,t||(++r,m.unshift(1));for(c=m.length;!m[c-1];--c);for(s=0,l="";s<c;s++)l+=Bs.charAt(m[s]);if(b){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(m=er(l,i,e),c=m.length;!m[c-1];--c);for(s=1,l="1.";s<c;s++)l+=Bs.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(r<0?"p":"p+")+r}else if(r<0){for(;++r;)l="0"+l;l="0."+l}else if(++r>c)for(r-=c;r--;)l+="0";else r<c&&(l=l.slice(0,r)+"."+l.slice(r))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return o.s<0?"-"+l:l}function hu(o,e){if(o.length>e)return o.length=e,!0}function Cm(o){return new this(o).abs()}function Lm(o){return new this(o).acos()}function Rm(o){return new this(o).acosh()}function Nm(o,e){return new this(o).plus(e)}function Om(o){return new this(o).asin()}function Mm(o){return new this(o).asinh()}function vm(o){return new this(o).atan()}function Em(o){return new this(o).atanh()}function _m(o,e){o=new this(o),e=new this(e);var t,n=this.precision,i=this.rounding,r=n+4;return!o.s||!e.s?t=new this(NaN):!o.d&&!e.d?(t=Gt(this,r,1).times(e.s>0?.25:.75),t.s=o.s):!e.d||o.isZero()?(t=e.s<0?Gt(this,n,i):new this(0),t.s=o.s):!o.d||e.isZero()?(t=Gt(this,r,1).times(.5),t.s=o.s):e.s<0?(this.precision=r,this.rounding=1,t=this.atan(Re(o,e,r,1)),e=Gt(this,r,1),this.precision=n,this.rounding=i,t=o.s<0?t.minus(e):t.plus(e)):t=this.atan(Re(o,e,r,1)),t}function Vm(o){return new this(o).cbrt()}function Fm(o){return ne(o=new this(o),o.e+1,2)}function Dm(o,e,t){return new this(o).clamp(e,t)}function Wm(o){if(!o||typeof o!="object")throw Error(or+"Object expected");var e,t,n,i=o.defaults===!0,r=["precision",1,Nn,"rounding",0,8,"toExpNeg",-bi,0,"toExpPos",0,bi,"maxE",0,bi,"minE",-bi,0,"modulo",0,9];for(e=0;e<r.length;e+=3)if(t=r[e],i&&(this[t]=xs[t]),(n=o[t])!==void 0)if(gt(n)===n&&n>=r[e+1]&&n<=r[e+2])this[t]=n;else throw Error(Rn+t+": "+n);if(t="crypto",i&&(this[t]=xs[t]),(n=o[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(xu);else this[t]=!1;else throw Error(Rn+t+": "+n);return this}function qm(o){return new this(o).cos()}function Um(o){return new this(o).cosh()}function Mu(o){var e,t,n;function i(r){var s,a,c,u=this;if(!(u instanceof i))return new i(r);if(u.constructor=i,Tu(r)){u.s=r.s,le?!r.d||r.e>i.maxE?(u.e=NaN,u.d=null):r.e<i.minE?(u.e=0,u.d=[0]):(u.e=r.e,u.d=r.d.slice()):(u.e=r.e,u.d=r.d?r.d.slice():r.d);return}if(c=typeof r,c==="number"){if(r===0){u.s=1/r<0?-1:1,u.e=0,u.d=[0];return}if(r<0?(r=-r,u.s=-1):u.s=1,r===~~r&&r<1e7){for(s=0,a=r;a>=10;a/=10)s++;le?s>i.maxE?(u.e=NaN,u.d=null):s<i.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[r]):(u.e=s,u.d=[r]);return}else if(r*0!==0){r||(u.s=NaN),u.e=NaN,u.d=null;return}return Cs(u,r.toString())}else if(c!=="string")throw Error(Rn+r);return(a=r.charCodeAt(0))===45?(r=r.slice(1),u.s=-1):(a===43&&(r=r.slice(1)),u.s=1),Ku.test(r)?Cs(u,r):Sm(u,r)}if(i.prototype=G,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Wm,i.clone=Mu,i.isDecimal=Tu,i.abs=Cm,i.acos=Lm,i.acosh=Rm,i.add=Nm,i.asin=Om,i.asinh=Mm,i.atan=vm,i.atanh=Em,i.atan2=_m,i.cbrt=Vm,i.ceil=Fm,i.clamp=Dm,i.cos=qm,i.cosh=Um,i.div=Gm,i.exp=Xm,i.floor=Qm,i.hypot=zm,i.ln=jm,i.log=Hm,i.log10=Zm,i.log2=Ym,i.max=$m,i.min=Jm,i.mod=ed,i.mul=td,i.pow=nd,i.random=id,i.round=od,i.sign=rd,i.sin=sd,i.sinh=ad,i.sqrt=ud,i.sub=cd,i.sum=ld,i.tan=md,i.tanh=dd,i.trunc=pd,o===void 0&&(o={}),o&&o.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)o.hasOwnProperty(t=n[e++])||(o[t]=this[t]);return i.config(o),i}function Gm(o,e){return new this(o).div(e)}function Xm(o){return new this(o).exp()}function Qm(o){return ne(o=new this(o),o.e+1,3)}function zm(){var o,e,t=new this(0);for(le=!1,o=0;o<arguments.length;)if(e=new this(arguments[o++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return le=!0,new this(1/0);t=e}return le=!0,t.sqrt()}function Tu(o){return o instanceof Di||o&&o.toStringTag===Su||!1}function jm(o){return new this(o).ln()}function Hm(o,e){return new this(o).log(e)}function Ym(o){return new this(o).log(2)}function Zm(o){return new this(o).log(10)}function $m(){return Ru(this,arguments,"lt")}function Jm(){return Ru(this,arguments,"gt")}function ed(o,e){return new this(o).mod(e)}function td(o,e){return new this(o).mul(e)}function nd(o,e){return new this(o).pow(e)}function id(o){var e,t,n,i,r=0,s=new this(1),a=[];if(o===void 0?o=this.precision:St(o,1,Nn),n=Math.ceil(o/re),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));r<n;)i=e[r],i>=429e7?e[r]=crypto.getRandomValues(new Uint32Array(1))[0]:a[r++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);r<n;)i=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+((e[r+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,r):(a.push(i%1e7),r+=4);r=n/4}else throw Error(xu);else for(;r<n;)a[r++]=Math.random()*1e7|0;for(n=a[--r],o%=re,n&&o&&(i=ot(10,re-o),a[r]=(n/i|0)*i);a[r]===0;r--)a.pop();if(r<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=re)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<re&&(t-=re-n)}return s.e=t,s.d=a,s}function od(o){return ne(o=new this(o),o.e+1,this.rounding)}function rd(o){return o=new this(o),o.d?o.d[0]?o.s:0*o.s:o.s||NaN}function sd(o){return new this(o).sin()}function ad(o){return new this(o).sinh()}function ud(o){return new this(o).sqrt()}function cd(o,e){return new this(o).sub(e)}function ld(){var o=0,e=arguments,t=new this(e[o]);for(le=!1;t.s&&++o<e.length;)t=t.plus(e[o]);return le=!0,ne(t,this.precision,this.rounding)}function md(o){return new this(o).tan()}function dd(o){return new this(o).tanh()}function pd(o){return ne(o=new this(o),o.e+1,1)}G[Symbol.for("nodejs.util.inspect.custom")]=G.toString;G[Symbol.toStringTag]="Decimal";var Di=G.constructor=Mu(xs);tr=new Di(tr);nr=new Di(nr);var O=Di;import wd from"big.js";import On from"bn.js";import fd from"toformat";var bd=fd,Wi=bd;import ur from"big.js";import yd from"bn.js";import gd from"decimal.js-light";import qi from"bn.js";var Rs=(n=>(n[n.ROUND_DOWN=0]="ROUND_DOWN",n[n.ROUND_HALF_UP=1]="ROUND_HALF_UP",n[n.ROUND_UP=2]="ROUND_UP",n))(Rs||{}),vu=9007199254740991;function J(o){let e=be("Raydium_parseBigNumberish");if(o instanceof qi)return o;if(typeof o=="string"){if(o.match(/^-?[0-9]+$/))return new qi(o);e.logWithError(`invalid BigNumberish string: ${o}`)}return typeof o=="number"?(o%1&&e.logWithError(`BigNumberish number underflow: ${o}`),(o>=vu||o<=-vu)&&e.logWithError(`BigNumberish number overflow: ${o}`),new qi(String(o))):typeof o=="bigint"?new qi(o.toString()):(e.error(`invalid BigNumberish value: ${o}`),new qi(0))}var ar=be("module/fraction"),Ns=Wi(ur),Ui=Wi(gd),Ad={[0]:Ui.ROUND_DOWN,[1]:Ui.ROUND_HALF_UP,[2]:Ui.ROUND_UP},Pd={[0]:ur.roundDown,[1]:ur.roundHalfUp,[2]:ur.roundUp},de=class{constructor(e,t=new yd(1)){this.numerator=J(e),this.denominator=J(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new de(this.denominator,this.numerator)}add(e){let t=e instanceof de?e:new de(J(e));return this.denominator.eq(t.denominator)?new de(this.numerator.add(t.numerator),this.denominator):new de(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof de?e:new de(J(e));return this.denominator.eq(t.denominator)?new de(this.numerator.sub(t.numerator),this.denominator):new de(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof de?e:new de(J(e));return new de(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof de?e:new de(J(e));return new de(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||ar.logWithError(`${e} is not an integer.`),e<=0&&ar.logWithError(`${e} is not positive.`),Ui.set({precision:e+1,rounding:Ad[n]});let i=new Ui(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||ar.logWithError(`${e} is not an integer.`),e<0&&ar.logWithError(`${e} is negative.`),Ns.DP=e,Ns.RM=Pd[n]||1,new Ns(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var kd=be("Raydium_amount"),cr=Wi(wd);function Eu(o,e){let t="0",n="0";if(o.includes(".")){let i=o.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):kd.logWithError(`invalid number string, num: ${o}`)}else t=o;return[t,n.slice(0,e)||n]}var he=class extends de{constructor(t,n,i=!0,r){let s=new On(0),a=Hn.pow(new On(t.decimals));if(i)s=J(n);else{let c=new On(0),u=new On(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=Eu(n.toString(),t.decimals);c=J(l),u=J(m)}c=c.mul(a),s=c.add(u)}super(s,a);this.logger=be(r||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new he(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new he(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return cr.DP=this.token.decimals,new cr(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}},jn=class extends de{constructor(t,n,i=!0,r){let s=new On(0),a=Hn.pow(new On(t.decimals));if(i)s=J(n);else{let c=new On(0),u=new On(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=Eu(n.toString(),t.decimals);c=J(l),u=J(m)}c=c.mul(a),s=c.add(u)}super(s,a);this.logger=be(r||"TokenAmount"),this.currency=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.currency.equals(t.currency)||this.logger.logWithError("gt currency not equals"),this.raw.gt(t.raw)}lt(t){return this.currency.equals(t.currency)||this.logger.logWithError("lt currency not equals"),this.raw.lt(t.raw)}add(t){return this.currency.equals(t.currency)||this.logger.logWithError("add currency not equals"),new jn(this.currency,this.raw.add(t.raw))}sub(t){return this.currency.equals(t.currency)||this.logger.logWithError("sub currency not equals"),new jn(this.currency,this.raw.sub(t.raw))}toSignificant(t=this.currency.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.currency.decimals,n,i=0){return t>this.currency.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return cr.DP=this.currency.decimals,new cr(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as hd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as _u}from"@solana/spl-token";var sn={chainId:101,address:hd.default.toBase58(),programId:_u.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},at={chainId:101,address:"So11111111111111111111111111111111111111112",programId:_u.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as _s}from"@solana/web3.js";import{PublicKey as Ve,SystemProgram as Vu,SYSVAR_RENT_PUBKEY as Td}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Id}from"@solana/spl-token";function A({pubkey:o,isSigner:e=!1,isWritable:t=!0}){return{pubkey:o,isWritable:t,isSigner:e}}var Os=[A({pubkey:Id,isWritable:!1}),A({pubkey:Vu.programId,isWritable:!1}),A({pubkey:Td,isWritable:!1})];function Ms({publicKey:o,transformSol:e}){let t=vs(o.toString());if(t instanceof Ve)return e&&t.equals(ut)?$:t;if(e&&t.toString()===ut.toBase58())return $;if(typeof t=="string"){if(t===Ve.default.toBase58())return Ve.default;try{return new Ve(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function vs(o){try{return new Ve(o)}catch{return o}}var lr=new Ve("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),an=new Ve("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),et=new Ve("SysvarRent111111111111111111111111111111111"),Es=new Ve("SysvarC1ock11111111111111111111111111111111"),Qt=new Ve("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),mr=new Ve("Sysvar1nstructions1111111111111111111111111"),dr=Vu.programId,ig=new Ve("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),og=new Ve("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),rg=new Ve("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),sg=new Ve("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),ag=new Ve("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),ug=new Ve("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),cg=new Ve("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),lg=new Ve("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),mg=new Ve("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),dg=new Ve("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),pg=new Ve("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),$=new Ve("So11111111111111111111111111111111111111112"),ut=Ve.default;function yt(o){return Ms({publicKey:o,transformSol:!0})}var Vs=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:r=!1,isToken2022:s=!1}){if(e===ut.toBase58()||e instanceof _s&&ut.equals(e)){this.decimals=at.decimals,this.symbol=at.symbol,this.name=at.name,this.mint=new _s(at.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=r?_s.default:Ms({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Be=Vs;Be.WSOL=new Vs(U(v({},at),{mint:at.address}));var Fs=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Gi=Fs;Gi.SOL=new Fs(sn);function hg(o,e){return o instanceof Be&&e instanceof Be?o.equals(e):o instanceof Be||e instanceof Be?!1:o===e}import Bd from"bn.js";var Fu=new de(new Bd(100)),Xe=class extends de{toSignificant(e=5,t,n){return this.mul(Fu).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Fu).toFixed(e,t,n)}};var xd=be("Raydium_price"),ct=class extends de{constructor(t){let{baseToken:n,quoteToken:i,numerator:r,denominator:s}=t;super(r,s);this.baseToken=n,this.quoteToken=i,this.scalar=new de(Ds(n.decimals),Ds(i.decimals))}get raw(){return new de(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new ct({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&xd.logWithError("mul token not equals");let n=super.mul(t);return new ct({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};function Ze(o){if(o instanceof Xe)return new de(o.numerator,o.denominator);if(o instanceof ct)return o.adjusted;if(o instanceof he)try{return Ze(o.toExact())}catch{return new de($e)}if(o instanceof de)return o;let e=String(o),t=Yn(e);return new de(t.numerator,t.denominator)}function Ug(o){var n;if(o instanceof Xe)return{fr:new de(o.numerator,o.denominator)};if(o instanceof ct)return{fr:o.adjusted};if(o instanceof he)return{fr:Ze(o.toExact()),decimals:o.token.decimals};if(o instanceof de)return{fr:o};let e=String(o),t=Yn(e);return{fr:new de(t.numerator,t.denominator),decimals:(n=t.dec)==null?void 0:n.length}}function Gg(o,e){if(o==null||e==null)return!1;let t=Ze(o),n=Ze(e);return t.sub(n).numerator,t.sub(n).numerator.lt($e)}function Sd(o,e){if(o==null||e==null)return!1;let t=Ze(o),n=Ze(e);return t.sub(n).numerator.gt($e)}function Xg(o,e){if(o==null||e==null)return!1;let t=Ze(o),n=Ze(e);return t.sub(n).numerator.lte($e)}function Qg(o,e){if(o==null||e==null)return!1;let t=Ze(o),n=Ze(e);return t.sub(n).numerator.gte($e)}function Kd(o,e){if(o==null||e==null)return!1;let t=Ze(o),n=Ze(e);return t.sub(n).numerator.eq($e)}function zg(o,e){if(o==null||e==null)return;let t=Ze(o),n=Ze(e);try{return t.div(n)}catch{return t}}function jg(o,e){if(o==null||e==null)return;let t=Ze(o),n=Ze(e);return t.sub(n)}function Hg(o){return o==null?!1:!Kd(o,0)}function Yg(o,e){return Sd(e,o)?e:o}function Ws(o,e){if(o==null||e==null)return;let t=Ze(o),n=Ze(e);return t.mul(n)}function Zg(o,e){if(o==null||e==null)return;let t=Ze(o),n=Ze(e);return t.add(n)}import{PublicKey as Cd}from"@solana/web3.js";import Ld from"bn.js";async function Du(o){new Promise(e=>setTimeout(e,o))}function iA(){return new Date().getTime()}function qs(o){return typeof o=="object"&&o!==null&&![Be,he,Cd,de,Ld,ct,Xe].some(e=>typeof e=="object"&&o instanceof e)}function Me(o){return typeof o=="string"?vs(o):Array.isArray(o)?o.map(e=>Me(e)):qs(o)?Object.fromEntries(Object.entries(o).map(([e,t])=>[e,Me(t)])):o}var $e=new Qe(0),Uu=new Qe(1),yA=new Qe(2),gA=new Qe(3),AA=new Qe(5),Hn=new Qe(10),PA=new Qe(100),wA=new Qe(1e3),kA=new Qe(1e4);function Ds(o){return Hn.pow(J(o))}function Yn(o){var a;if(o===void 0)return{denominator:"1",numerator:"0"};if(o instanceof Qe)return{numerator:o.toString(),denominator:"1"};if(o instanceof de)return{denominator:o.denominator.toString(),numerator:o.numerator.toString()};let e=String(o),[,t="",n="",i=""]=(a=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?a:[],r="1"+"0".repeat(i.length),s=t+(n==="0"?"":n)+i||"0";return{denominator:r,numerator:s,sign:t,int:n,dec:i}}function pr(o,e){let t=o.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function Rd(o){var n;let[,e="",t=""]=(n=o.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?n:[];return`${e}${t}`}function Nd(o,e=0){return o instanceof Qe?o:new Qe(Rd(Gu(o).mul(Hn.pow(new Qe(String(e))))))}function Gu(o){if(o instanceof Xe)return new de(o.numerator,o.denominator);if(o instanceof ct)return o.adjusted;if(o instanceof he)try{return Gu(o.toExact())}catch{return new de($e)}if(o instanceof de)return o;let e=String(o),t=Yn(e);return new de(t.numerator,t.denominator)}function fr(o,e,t){return o.mul(e).add(t).sub(new Qe(1)).div(t)}function Us(o,e,t){return o.mul(e).div(t)}function hA(o,e){let{numerator:t,denominator:n}=Yn(o);return new Xe(new Qe(t),new Qe(n).mul(e!=null&&e.alreadyDecimaled?new Qe(100):new Qe(1)))}function TA(o){let{token:e,numberPrice:t,decimalDone:n}=o,i=new Be({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:r,denominator:s}=Yn(t),a=n?new Qe(r).mul(Hn.pow(new Qe(e.decimals))):r,c=new Qe(s).mul(Hn.pow(new Qe(i.decimals)));return new ct({baseToken:i,denominator:c.toString(),quoteToken:new Be(U(v({},e),{skipMint:!0,mint:""})),numerator:a.toString()})}function Wu(o){let e=new Gi({decimals:6,symbol:"usd",name:"usd"}),t=Nd(Ws(o,10**e.decimals));return new jn(e,t)}function IA(o,e){return Wu(!e||!o?0:Ws(o,e))}function Od(o){if(o==null)return;let{numerator:e,denominator:t}=Yn(o.toString());return new de(e,t)}function Md(o){return o instanceof O}function qu(o){return Md(o)?Od(o):Array.isArray(o)?o.map(e=>qu(e)):qs(o)?Object.fromEntries(Object.entries(o).map(([e,t])=>[e,qu(t)])):o}var Xu=o=>typeof o=="number",Qu=o=>o?new Date(o):new Date,vd=o=>Qu(o).getTime();function zu(o,e,t){let n=Xu(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(o).getTime()<=n}function ju(o,e,t){let n=Xu(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(o).getTime()>n}function xA(o,e){let n=vd(o)+(e.days?e.days*24*60*60*1e3:0)+(e.hours?e.hours*60*60*1e3:0)+(e.minutes?e.minutes*60*1e3:0)+(e.seconds?e.seconds*1e3:0)+(e.milliseconds?e.milliseconds:0);return Qu(n)}function Is(o,e=1,t=[]){let n=[...o];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}function KA(o,...e){return o.filter(t=>e.every(n=>n.includes(t)))}function CA(o,...e){return o.filter(t=>e.every(n=>!n.includes(t)))}function LA(o){return[...new Set(o)]}var zt=class{constructor(e){this._owner=e}get publicKey(){return zt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return zt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return zt.isKeyPair(this._owner)}get isPublicKey(){return zt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!zt.isKeyPair(e)}};import{PublicKey as Dd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Wd}from"@solana/spl-token";import{ComputeBudgetProgram as Hu,Keypair as Yu,PublicKey as Zu,Transaction as yr,TransactionMessage as Ed,VersionedTransaction as Gs}from"@solana/web3.js";var Mn=(t=>(t[t.V0=0]="V0",t[t.LEGACY=1]="LEGACY",t))(Mn||{}),X={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip"};import{TOKEN_PROGRAM_ID as _d}from"@solana/spl-token";var gn=be("Raydium_txUtil"),$u=1644;function gr(o){let e=[],t=[];return o.microLamports&&(e.push(Hu.setComputeUnitPrice({microLamports:o.microLamports})),t.push(X.SetComputeUnitPrice)),o.units&&(e.push(Hu.setComputeUnitLimit({units:o.units})),t.push(X.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function gi(o,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=o.getLatestBlockhash)==null?void 0:n.call(o,{commitment:t})))==null?void 0:i.blockhash}async function Ar(o,e){return o.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);o.onSignature(e,r=>{if(clearTimeout(i),!r.err){t("");return}n(Object.assign(r.err,{txId:e}))},"confirmed")})}function Pr(o,e){o.length<1&&gn.logWithError(`no instructions provided: ${o.toString()}`),e.length<1&&gn.logWithError(`no signers provided:, ${e.toString()}`);let t=new yr;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...o);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<$u}catch{return!1}}async function Ju(o,e,t,n=!0){let i=new Zu("RaydiumSimuLateTransaction11111111111111111"),r=[],s=new yr;s.feePayer=i;for(let u of e)Pr([...s.instructions,u],[i])||(r.push(s),s=new yr,s.feePayer=i),s.add(u);s.instructions.length>0&&r.push(s);let a=[];try{if(a=await Vd(o,r,n),a.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&gn.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of a)if(gn.debug("simulate result:",u),u.logs){let l=u.logs.filter(m=>m&&m.includes(t));gn.debug("filteredLog:",c),l.length||gn.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function ec(o,e){let t=o.match(/{["\w:,]+}/g);return!t||t.length!==1?gn.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function An(o,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(o);return!n||n.length!==2?gn.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function ie(o,e){let[t,n]=Zu.findProgramAddressSync(o,e);return{publicKey:t,nonce:n}}async function Vd(o,e,t){let n=[];if(t){let i=await o.getLatestBlockhash(),r=[];for(let u of e){u.recentBlockhash=i.blockhash,u.lastValidBlockHeight=i.lastValidBlockHeight;let m=u._compile().serialize(),p=u._serialize(m).toString("base64");r.push(p)}let s=r.map(u=>{let l=o._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],c=20;for(let u=0;u<Math.ceil(s.length/c);u++)a.push(s.slice(u*c,(u+1)*c));n=await(await Promise.all(a.map(async u=>(await o._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async i=>await(await o.simulateTransaction(i)).value))}catch(i){i instanceof Error&&gn.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:i.message})}return n}function Xi({instructions:o,payer:e,signers:t}){return Pr(o,[e,...t])}function Qi({instructions:o,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Yu.generate().publicKey.toString()}){let r=new Ed({payerKey:e,recentBlockhash:n,instructions:o}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Gs(r).serialize()).toString("base64").length<$u}catch{return!1}}var br={time:0,data:void 0};async function UA(o){if(!br.data||(Date.now()-br.time)/1e3>30){let e=await o.getEpochInfo();return br={time:Date.now(),data:e},e}else return br.data}var tc=o=>Buffer.isBuffer(o)?o:o instanceof Uint8Array?Buffer.from(o.buffer,o.byteOffset,o.byteLength):Buffer.from(o),Fd=o=>{let e=o.serialize({requireAllSignatures:!1,verifySignatures:!1});o instanceof Gs&&(e=tc(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Zn(o){let e=[];return o.forEach(t=>{t instanceof yr&&(t.recentBlockhash||(t.recentBlockhash=_d.toBase58()),t.feePayer||(t.feePayer=Yu.generate().publicKey)),e.push(Fd(t))}),console.log("simulate tx string:",e),e}function GA(o){let e=o.serialize({requireAllSignatures:!1,verifySignatures:!1});return o instanceof Gs&&(e=tc(e)),e.toString("base64")}function ee(o,e,t){return ie([o.toBuffer(),(t!=null?t:Wd).toBuffer(),e.toBuffer()],new Dd("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as me}from"@solana/web3.js";var Xs=new me("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),nc=new me("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Qs=new me("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Ai=new me("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),qd=new me("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),zs=new me("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),wr=new me("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),zi=new me("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Ud=new me("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),kr=new me("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),vn=new me("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Pi=new me("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),ji=new me("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),Gd=new me("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),ic=new me("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Xd=new me("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Qd=new me("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),zd=new me("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),jd=new me("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Hi=new me("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),js=new me("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),Hd=new me("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Yd=new me("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Zd=new me("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),$d=new me("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),Yi=new me("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Jd=new me("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),Zi=new me("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),ep=new me("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),Pn=new me("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),tp=new me("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),np=new me("7soRSLviCKHCKzCbRuVpZDif76NWLVqFtbjt8LpyxWSq"),ip=new me("DG6kZFFCqxdtWXw53Zc28hLs3MTr28Efkm2FrsNERNSQ"),$i={IDO_PROGRAM_ID_V1:Xd,IDO_PROGRAM_ID_V2:Qd,IDO_PROGRAM_ID_V3:zd,IDO_PROGRAM_ID_V4:jd},Tt={AMM_V4:zi,AMM_STABLE:Ud,CLMM_PROGRAM_ID:vn,CLMM_LOCK_PROGRAM_ID:Pi,CLMM_LOCK_AUTH_ID:ji,FARM_PROGRAM_ID_V3:Xs,FARM_PROGRAM_ID_V5:Qs,FARM_PROGRAM_ID_V6:Ai,OPEN_BOOK_PROGRAM:zs,SERUM_PROGRAM_ID_V3:wr,UTIL1216:qd,Router:Gd,CREATE_CPMM_POOL_PROGRAM:Hi,CREATE_CPMM_POOL_AUTH:js,CREATE_CPMM_POOL_FEE_ACC:Hd,LOCK_CPMM_PROGRAM:Yi,LOCK_CPMM_AUTH:Zi,LAUNCHPAD_PROGRAM:Pn,LAUNCHPAD_AUTH:tp},ZA={SERUM_MARKET:me.default,OPENBOOK_MARKET:new me("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:me.default,FarmV3:new me("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new me("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new me("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new me("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new me("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new me("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new me("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new me("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new me("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Yd,CREATE_CPMM_POOL_AUTH:Zd,CREATE_CPMM_POOL_FEE_ACC:$d,FEE_DESTINATION_ID:new me("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:Jd,LCOK_CPMM_AUTH:ep,LAUNCHPAD_PROGRAM:np,LAUNCHPAD_AUTH:ip};import Fe from"bn.js";var un=1e4;function eP(o,e,t,n){if(e===void 0)return{amount:o,fee:void 0,expirationTime:void 0};let i=t.epoch<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,r=new Fe(i.maximumFee.toString()),s=t.epoch<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(i.transferFeeBasisPoints===un){let a=new Fe(i.maximumFee.toString());return{amount:o.add(a),fee:a,expirationTime:s}}else{let a=jt(o.mul(new Fe(un)),new Fe(un-i.transferFeeBasisPoints)),c=new Fe(i.maximumFee.toString()),u=a.sub(o).gt(c)?o.add(c):a,l=jt(u.mul(new Fe(i.transferFeeBasisPoints)),new Fe(un)),m=l.gt(r)?r:l;return{amount:u,fee:m,expirationTime:s}}else{let a=jt(o.mul(new Fe(i.transferFeeBasisPoints)),new Fe(un)),c=a.gt(r)?r:a;return{amount:o,fee:c,expirationTime:s}}}function Te(o,e,t,n){if(e===void 0)return{amount:o,fee:void 0,expirationTime:void 0};let i=U(v({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),r=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new Fe(r.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(r.transferFeeBasisPoints===un){let c=new Fe(r.maximumFee.toString());return{amount:o.add(c),fee:c,expirationTime:a}}else{let c=jt(o.mul(new Fe(un)),new Fe(un-r.transferFeeBasisPoints)),u=new Fe(r.maximumFee.toString()),l=c.sub(o).gt(u)?o.add(u):c,m=jt(l.mul(new Fe(r.transferFeeBasisPoints)),new Fe(un)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let c=jt(o.mul(new Fe(r.transferFeeBasisPoints)),new Fe(un)),u=c.gt(s)?s:c;return{amount:o,fee:u,expirationTime:a}}}function Ht(o,e){return o===void 0?e:e===void 0?o:Math.min(o,e)}function jt(o,e){let{div:t,mod:n}=o.divmod(e);return n.gt(new Fe(0))?t.add(new Fe(1)):t}function hr(o,e){if(o.isZero())return new Fe(0);let t=o.div(e);return t.isZero()?new Fe(1):o.mod(e).gt(new Fe(0))?t.add(new Fe(1)):t}import{PublicKey as oc,AddressLookupTableAccount as Tr}from"@solana/web3.js";async function Hs({connection:o,address:e}){let t=await Ut(o,[...new Set(e.map(i=>i.toString()))].map(i=>new oc(i))),n={};for(let i=0;i<e.length;i++){let r=t[i],s=e[i];if(!r)continue;let a=new Tr({key:s,state:Tr.deserialize(r.data)});n[s.toString()]=a,Ir[s.toString()]=a}return n}var Ir={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new Tr({key:new oc("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:Tr.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as wi,sendAndConfirmTransaction as Ys,SystemProgram as op,Transaction as Ji,TransactionMessage as eo,VersionedTransaction as to}from"@solana/web3.js";import rp from"axios";var Br=2e3,xr=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await rp.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=gr(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){var t;return e?(this.endInstructions.push(op.transfer({fromPubkey:(t=e.feePayer)!=null?t:this.feePayer,toPubkey:new wi(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(X.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:r=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...r),this.lookupTableAddress.push(...s.filter(a=>a!==wi.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(v({},t||{})):this.build(t)}build(e){var n;let t=new Ji;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var l;let{recentBlockHash:r,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=i||{},u=r!=null?r:await gi(this.connection,this.blockhashCommitment);if(t.recentBlockhash=u,this.signers.length&&t.sign(...this.signers),Zn([t]),(l=this.owner)!=null&&l.isKeyPair)return{txId:a?await Ys(this.connection,t,this.signers.find(d=>d.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let m=await this.signAllTransactions([t]);if(this.signers.length)for(let d of m)try{d.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(m[0].serialize(),{skipPreflight:s}),signedTx:m[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var u;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),r=t.filter(l=>l.transaction.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],c=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async l=>{var g;let{sequentially:m,onTxUpdate:d,skipTxCount:p=0,recentBlockHash:b,skipPreflight:f=!0}=l||{},y=b!=null?b:await gi(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(m){let P=[],k=0;for(let T of s){if(++k,k<=p)continue;let I=await Ys(this.connection,T,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});P.push(I)}return{txIds:P,signedTxs:s}}return{txIds:await await Promise.all(s.map(async P=>(P.recentBlockhash=y,await this.connection.sendRawTransaction(P.serialize(),{skipPreflight:f})))),signedTxs:s}}if(this.signAllTransactions){let P=s.map((T,I)=>(T.recentBlockhash=y,a[I].length&&T.sign(...a[I]),T));Zn(P);let k=await this.signAllTransactions(P);if(m){let T=0,I=[],h=async()=>{if(!k[T])return;let S=await this.connection.sendRawTransaction(k[T].serialize(),{skipPreflight:f});I.push({txId:S,status:"sent",signedTx:k[T]}),d==null||d([...I]),T++;let x=!1,K=null,B=null,C=L=>{K!==null&&clearInterval(K),B!==null&&this.connection.removeSignatureListener(B);let R=I.findIndex(D=>D.txId===S);if(R>-1){if(I[R].status==="error"||I[R].status==="success")return;I[R].status=L.err?"error":"success"}d==null||d([...I]),L.err||h()};this.loopMultiTxStatus&&(K=setInterval(async()=>{var L;if(x){clearInterval(K);return}try{let R=await this.connection.getTransaction(S,{commitment:"confirmed",maxSupportedTransactionVersion:0});R&&(x=!0,clearInterval(K),C({err:((L=R.meta)==null?void 0:L.err)||null}),console.log("tx status from getTransaction:",S))}catch(R){x=!0,clearInterval(K),console.error("getTransaction timeout:",R,S)}},Br)),B=this.connection.onSignature(S,L=>{if(x){this.connection.removeSignatureListener(B);return}x=!0,C(L)},"confirmed"),this.connection.getSignatureStatus(S)};return await h(),{txIds:I.map(S=>S.txId),signedTxs:k}}else{let T=[];for(let I=0;I<k.length;I+=1){let h=await this.connection.sendRawTransaction(k[I].serialize(),{skipPreflight:f});T.push(h)}return{txIds:T,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var f;let b=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:r}=b,s=We(b,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=v(v({},this.cluster==="devnet"?{}:Ir),t),c=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let y of c)a[y]===void 0&&u.push(new wi(y));let l=await Hs({connection:this.connection,address:u});for(let[y,g]of Object.entries(l))a[y]=g;let m=i?wi.default.toBase58():r!=null?r:await gi(this.connection,this.blockhashCommitment),d=new eo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((f=this.owner)==null?void 0:f.signer)&&!this.signers.some(y=>y.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new to(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async y=>{var T;let{skipPreflight:g=!0,sendAndConfirm:P,notSendToRpc:k}=y||{};if(Zn([p]),(T=this.owner)!=null&&T.isKeyPair){let I=await this.connection.sendTransaction(p,{skipPreflight:g});return P&&await Ar(this.connection,I),{txId:I,signedTx:p}}if(this.signAllTransactions){let I=await this.signAllTransactions([p]);if(this.signers.length)for(let h of I)try{h.sign(this.signers)}catch{}return{txId:k?"":await this.connection.sendTransaction(I[0],{skipPreflight:g}),signedTx:I[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var u;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),r=t.filter(l=>l.builder.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],c=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async l=>{var f;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:b=!0}=l||{};if(p&&s.forEach(y=>y.message.recentBlockhash=p),Zn(s),(f=this.owner)!=null&&f.isKeyPair){if(m){let y=[];for(let g of s){let P=await this.connection.sendTransaction(g,{skipPreflight:b});await Ar(this.connection,P),y.push(P)}return{txIds:y,signedTxs:s}}return{txIds:await Promise.all(s.map(async y=>await this.connection.sendTransaction(y,{skipPreflight:b}))),signedTxs:s}}if(this.signAllTransactions){let y=await this.signAllTransactions(s);if(m){let g=0,P=[],k=async()=>{if(!y[g])return;let T=await this.connection.sendTransaction(y[g],{skipPreflight:b});P.push({txId:T,status:"sent",signedTx:y[g]}),d==null||d([...P]),g++;let I=!1,h=null,S=null,x=K=>{h!==null&&clearInterval(h),S!==null&&this.connection.removeSignatureListener(S);let B=P.findIndex(C=>C.txId===T);if(B>-1){if(P[B].status==="error"||P[B].status==="success")return;P[B].status=K.err?"error":"success"}d==null||d([...P]),K.err||k()};this.loopMultiTxStatus&&(h=setInterval(async()=>{var K;if(I){clearInterval(h);return}try{let B=await this.connection.getTransaction(T,{commitment:"confirmed",maxSupportedTransactionVersion:0});B&&(I=!0,clearInterval(h),x({err:((K=B.meta)==null?void 0:K.err)||null}),console.log("tx status from getTransaction:",T))}catch(B){I=!0,clearInterval(h),console.error("getTransaction timeout:",B,T)}},Br)),S=this.connection.onSignature(T,K=>{if(I){this.connection.removeSignatureListener(S);return}I=!0,x(K)},"confirmed"),this.connection.getSignatureStatus(T)};return k(),{txIds:[],signedTxs:y}}else{let g=[];for(let P=0;P<y.length;P+=1){let k=await this.connection.sendTransaction(y[P],{skipPreflight:b});g.push(k)}return{txIds:g,signedTxs:y}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var d;let m=e||{},{splitIns:t=[],computeBudgetConfig:n}=m,i=We(m,["splitIns","computeBudgetConfig"]),r=n?gr(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((p,b)=>U(v({},p),{[b.publicKey.toBase58()]:b}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(p=>{let b=[...u,p],f=n?[...r.instructions,...b]:b,g=[...new Set(b.map(P=>P.keys.filter(k=>k.isSigner).map(k=>k.pubkey.toString())).flat()).values()].map(P=>new wi(P));if(p!==t[l]&&u.length<12&&(Xi({instructions:f,payer:this.feePayer,signers:g})||Xi({instructions:b,payer:this.feePayer,signers:g})))u.push(p);else{if(u.length===0)throw Error("item ins too big");l+=p===t[l]?1:0,Xi({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:g})?a.push(new Ji().add(...r.instructions,...u)):a.push(new Ji().add(...u)),c.push(Array.from(new Set(u.map(P=>P.keys.filter(k=>k.isSigner).map(k=>k.pubkey.toString())).flat())).map(P=>s[P]).filter(P=>P!==void 0)),u=[p]}}),u.length>0){let b=[...new Set(u.map(f=>f.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(f=>s[f]).filter(f=>f!==void 0);Xi({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:b.map(f=>f.publicKey)})?a.push(new Ji().add(...r.instructions,...u)):a.push(new Ji().add(...u)),c.push(b)}return a.forEach(p=>p.feePayer=this.feePayer),(d=this.owner)!=null&&d.signer&&c.forEach(p=>{p.some(b=>b.publicKey.equals(this.owner.publicKey))||p.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async p=>{var T;let{sequentially:b,onTxUpdate:f,skipTxCount:y=0,recentBlockHash:g,skipPreflight:P=!0}=p||{},k=g!=null?g:await gi(this.connection,this.blockhashCommitment);if(a.forEach(async(I,h)=>{I.recentBlockhash=k,c[h].length&&I.sign(...c[h])}),Zn(a),(T=this.owner)!=null&&T.isKeyPair){if(b){let I=0,h=[];for(let S of a){if(++I,I<=y){h.push("tx skipped");continue}let x=await Ys(this.connection,S,this.signers.find(K=>K.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:P});h.push(x)}return{txIds:h,signedTxs:a}}return{txIds:await Promise.all(a.map(async I=>await this.connection.sendRawTransaction(I.serialize(),{skipPreflight:P}))),signedTxs:a}}if(this.signAllTransactions){let I=await this.signAllTransactions(a.slice(y,a.length)),h=[...a.slice(0,y),...I];if(b){let S=0,x=[],K=async()=>{if(!h[S])return;S<y&&(x.push({txId:"",status:"success",signedTx:h[S]}),f==null||f([...x]),S++,K());let B=await this.connection.sendRawTransaction(h[S].serialize(),{skipPreflight:P});x.push({txId:B,status:"sent",signedTx:h[S]}),f==null||f([...x]),S++;let C=!1,L=null,R=null,D=F=>{L!==null&&clearInterval(L),R!==null&&this.connection.removeSignatureListener(R);let W=x.findIndex(Y=>Y.txId===B);if(W>-1){if(x[W].status==="error"||x[W].status==="success")return;x[W].status=F.err?"error":"success"}f==null||f([...x]),F.err||K()};this.loopMultiTxStatus&&(L=setInterval(async()=>{var F;if(C){clearInterval(L);return}try{let W=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});W&&(C=!0,clearInterval(L),D({err:((F=W.meta)==null?void 0:F.err)||null}),console.log("tx status from getTransaction:",B))}catch(W){C=!0,clearInterval(L),console.error("getTransaction timeout:",W,B)}},Br)),R=this.connection.onSignature(B,F=>{if(C){this.connection.removeSignatureListener(R);return}C=!0,D(F)},"confirmed"),this.connection.getSignatureStatus(B)};return await K(),{txIds:x.map(B=>B.txId),signedTxs:h}}else{let S=[];for(let x=0;x<h.length;x+=1){let K=await this.connection.sendRawTransaction(h[x].serialize(),{skipPreflight:P});S.push(K)}return{txIds:S,signedTxs:h}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async sizeCheckBuildV0(e){var k;let P=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:r=[]}=P,s=We(P,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),a=v(v({},this.cluster==="devnet"?{}:Ir),i),c=Array.from(new Set([...this.lookupTableAddress,...r])),u=[];for(let T of c)a[T]===void 0&&u.push(new wi(T));let l=await Hs({connection:this.connection,address:u});for(let[T,I]of Object.entries(l))a[T]=I;let m=t?gr(t):{instructions:[],instructionTypes:[]},d=await gi(this.connection,this.blockhashCommitment),p=this.signers.reduce((T,I)=>U(v({},T),{[I.publicKey.toBase58()]:I}),{}),b=[],f=[],y=[],g=0;if(this.allInstructions.forEach(T=>{let I=[...y,T],h=t?[...m.instructions,...I]:I;if(T!==n[g]&&y.length<12&&(Qi({instructions:h,payer:this.feePayer,lookupTableAddressAccount:a})||Qi({instructions:I,payer:this.feePayer,lookupTableAddressAccount:a})))y.push(T);else{if(y.length===0)throw Error("item ins too big");g+=T===n[g]?1:0;let S={};for(let x of[...new Set(c)])a[x]!==void 0&&(S[x]=a[x]);if(t&&Qi({instructions:[...m.instructions,...y],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let x=new eo({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...y]}).compileToV0Message(Object.values(a));b.push(new to(x))}else{let x=new eo({payerKey:this.feePayer,recentBlockhash:d,instructions:[...y]}).compileToV0Message(Object.values(a));b.push(new to(x))}f.push(Array.from(new Set(y.map(x=>x.keys.filter(K=>K.isSigner).map(K=>K.pubkey.toString())).flat())).map(x=>p[x]).filter(x=>x!==void 0)),y=[T]}}),y.length>0){let I=[...new Set(y.map(h=>h.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat()).values()].map(h=>p[h]).filter(h=>h!==void 0);if(t&&Qi({instructions:[...m.instructions,...y],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let h=new eo({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...y]}).compileToV0Message(Object.values(a));b.push(new to(h))}else{let h=new eo({payerKey:this.feePayer,recentBlockhash:d,instructions:[...y]}).compileToV0Message(Object.values(a));b.push(new to(h))}f.push(I)}return(k=this.owner)!=null&&k.signer&&f.forEach(T=>{T.some(I=>I.publicKey.equals(this.owner.publicKey))||T.push(this.owner.signer)}),b.forEach((T,I)=>{T.sign(f[I])}),{builder:this,transactions:b,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async T=>{var B;let{sequentially:I,onTxUpdate:h,skipTxCount:S=0,recentBlockHash:x,skipPreflight:K=!0}=T||{};if(b.map(async(C,L)=>{f[L].length&&C.sign(f[L]),x&&(C.message.recentBlockhash=x)}),Zn(b),(B=this.owner)!=null&&B.isKeyPair){if(I){let C=0,L=[];for(let R of b){if(++C,C<=S){console.log("skip tx: ",C),L.push("tx skipped");continue}let D=await this.connection.sendTransaction(R,{skipPreflight:K});await Ar(this.connection,D),L.push(D)}return{txIds:L,signedTxs:b}}return{txIds:await Promise.all(b.map(async C=>await this.connection.sendTransaction(C,{skipPreflight:K}))),signedTxs:b}}if(this.signAllTransactions){let C=await this.signAllTransactions(b.slice(S,b.length)),L=[...b.slice(0,S),...C];if(I){let R=0,D=[],F=async()=>{if(!L[R])return;if(R<S){D.push({txId:"",status:"success",signedTx:L[R]}),h==null||h([...D]),R++,F();return}let W=await this.connection.sendTransaction(L[R],{skipPreflight:K});D.push({txId:W,status:"sent",signedTx:L[R]}),h==null||h([...D]),R++;let Y=!1,se=null,we=null,ce=pe=>{se!==null&&clearInterval(se),we!==null&&this.connection.removeSignatureListener(we);let Ce=D.findIndex(nt=>nt.txId===W);if(Ce>-1){if(D[Ce].status==="error"||D[Ce].status==="success")return;D[Ce].status=pe.err?"error":"success"}h==null||h([...D]),pe.err||F()};this.loopMultiTxStatus&&(se=setInterval(async()=>{var pe;if(Y){clearInterval(se);return}try{let Ce=await this.connection.getTransaction(W,{commitment:"confirmed",maxSupportedTransactionVersion:0});Ce&&(Y=!0,clearInterval(se),ce({err:((pe=Ce.meta)==null?void 0:pe.err)||null}),console.log("tx status from getTransaction:",W))}catch(Ce){Y=!0,clearInterval(se),console.error("getTransaction timeout:",Ce,W)}},Br)),we=this.connection.onSignature(W,pe=>{if(Y){this.connection.removeSignatureListener(we);return}Y=!0,ce(pe)},"confirmed"),this.connection.getSignatureStatus(W)};return F(),{txIds:[],signedTxs:L}}else{let R=[];for(let D=0;D<L.length;D+=1){let F=await this.connection.sendTransaction(L[D],{skipPreflight:K});R.push(F)}return{txIds:R,signedTxs:L}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import sp from"bn.js";var Yt=new sp(1e6);var rc=(t=>(t.ALL="all",t.Strict="strict",t))(rc||{}),sc=(s=>(s.All="all",s.Standard="standard",s.Concentrated="concentrated",s.AllFarm="allFarm",s.StandardFarm="standardFarm",s.ConcentratedFarm="concentratedFarm",s))(sc||{});var lt={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://tokens.jup.ag/tokens?tags=lst,community",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},DP=v({},lt);var ac="ray_tab_hash",Zs="ray_req_hash",ap=()=>{if(typeof window===void 0)return"";let o=sessionStorage.getItem(ac);return o||(o=`ray-${Date.now()}`,sessionStorage.setItem(ac,o)),o},Sr=async n=>{var i=n,{logCount:o=1e3,removeLastLog:e}=i,t=We(i,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let r=JSON.parse(localStorage.getItem(Zs)||"[]").slice(0,o-1);e&&r.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),r.unshift(U(v({},t),{time:Date.now(),session:ap()}));try{localStorage.setItem(Zs,JSON.stringify(r))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(r[0].data=a+(a.length>100?"...":"");!s;){r.pop();let c=JSON.stringify(t.data).substring(0,100);r[0].data=c+(c.length>100?"...":"");try{localStorage.setItem(Zs,JSON.stringify(r)),s=!0}catch{s=!1}}return new Promise(c=>c())}return Sr(U(v({},t),{logCount:o,removeLastLog:!0}))}};var ki=be("Raydium_Api"),$s=new Map;async function aw(o,e,t=1e3){let n;for(;n==null;)try{ki.debug(`Request ${o} through endlessRetry`),n=await e()}catch(i){ki.error(`Request ${o} failed, retry after ${t} ms`,i),await Du(t)}return n}var Kr=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:i,urlConfigs:r}){this.cluster=e,this.urlConfigs=r||{},this.logCount=i||1e3,this.api=uc.create({baseURL:this.urlConfigs.BASE_HOST||lt.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return ki.debug(`${a==null?void 0:a.toUpperCase()} ${c}${u}`),s},s=>(ki.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:m,url:d}=a;return n&&Sr({status:u,url:`${m}${d}`,params:a.params,data:c,logCount:this.logCount}),ki.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:m,url:d}=a;return n&&Sr({status:u,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),ki.error(`${l.toUpperCase()} ${m}${d} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||lt.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||lt.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||lt.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await uc.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(i=>i.numSlots);return n.reduce((i,r)=>i+r,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||lt.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||lt.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||lt.TOKEN_LIST)).data}async getJupTokenList(){return this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||lt.JUP_TOKEN_LIST})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||lt.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:i="desc",page:r=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||lt.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${i}&page=${r}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||lt.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],i=t.filter(s=>$s.has(s)?(n.push($s.get(s)),!1):!0),r=[];return i.length&&(r=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||lt.POOL_KEY_BY_ID)+`?ids=${i.join(",")}`)).data.filter(Boolean),r.forEach(a=>{$s.set(a.id,a)})),n.concat(r)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:i="all",sort:r="default",order:s="desc",page:a=1}=e,[c,u]=[t&&yt(t).toBase58(),n&&n!=="undefined"?yt(n).toBase58():""],[l,m]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||lt.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${i}&poolSortField=${r}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||lt.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||lt.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||lt.CHECK_AVAILABILITY)).data}};import{merge as dy}from"lodash";var Cr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",cc="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as vr,SystemProgram as Af}from"@solana/web3.js";import{AccountLayout as Ii,createAssociatedTokenAccountInstruction as da,TOKEN_PROGRAM_ID as Dn,TOKEN_2022_PROGRAM_ID as Pf}from"@solana/spl-token";var Js=(...o)=>o.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),ve=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=be(t)}createTxBuilder(e){return this.scope.checkOwner(),new xr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Js(e))}logInfo(...e){this.logger.info(Js(e))}logAndCreateError(...e){let t=Js(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as df,SystemProgram as pf}from"@solana/web3.js";import ff from"bn.js";import{createCloseAccountInstruction as bf,createInitializeAccountInstruction as yf,createTransferInstruction as gf,TOKEN_PROGRAM_ID as Ti}from"@solana/spl-token";import{Keypair as uf,PublicKey as Bc}from"@solana/web3.js";import cf from"bn.js";import{TOKEN_PROGRAM_ID as lf}from"@solana/spl-token";function up(o){return o instanceof Uint8Array||o!=null&&typeof o=="object"&&o.constructor.name==="Uint8Array"}function ea(o,...e){if(!up(o))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(o.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${o.length}`)}function ta(o,e=!0){if(o.destroyed)throw new Error("Hash instance has been destroyed");if(e&&o.finished)throw new Error("Hash#digest() has already been called")}function lc(o,e){ea(o);let t=e.outputLen;if(o.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Rr=o=>new DataView(o.buffer,o.byteOffset,o.byteLength),Zt=(o,e)=>o<<32-e|o>>>e;var kw=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function cp(o){if(typeof o!="string")throw new Error(`utf8ToBytes expected string, got ${typeof o}`);return new Uint8Array(new TextEncoder().encode(o))}function na(o){return typeof o=="string"&&(o=cp(o)),ea(o),o}var Lr=class{clone(){return this._cloneInto()}},hw={}.toString;function mc(o){let e=n=>o().update(na(n)).digest(),t=o();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>o(),e}function lp(o,e,t,n){if(typeof o.setBigUint64=="function")return o.setBigUint64(e,t,n);let i=BigInt(32),r=BigInt(4294967295),s=Number(t>>i&r),a=Number(t&r),c=n?4:0,u=n?0:4;o.setUint32(e+c,s,n),o.setUint32(e+u,a,n)}var dc=(o,e,t)=>o&e^~o&t,pc=(o,e,t)=>o&e^o&t^e&t,Nr=class extends Lr{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Rr(this.buffer)}update(e){ta(this);let{view:t,buffer:n,blockLen:i}=this;e=na(e);let r=e.length;for(let s=0;s<r;){let a=Math.min(i-this.pos,r-s);if(a===i){let c=Rr(e);for(;i<=r-s;s+=i)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ta(this),lc(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:r}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(n,0),s=0);for(let m=s;m<i;m++)t[m]=0;lp(n,i-8,BigInt(this.length*8),r),this.process(n,0);let a=Rr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)a.setUint32(4*m,l[m],r)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:r,destroyed:s,pos:a}=this;return e.length=i,e.pos=a,e.finished=r,e.destroyed=s,i%t&&e.buffer.set(n),e}};var mp=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),En=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),_n=new Uint32Array(64),ia=class extends Nr{constructor(){super(64,32,8,!1),this.A=En[0]|0,this.B=En[1]|0,this.C=En[2]|0,this.D=En[3]|0,this.E=En[4]|0,this.F=En[5]|0,this.G=En[6]|0,this.H=En[7]|0}get(){let{A:e,B:t,C:n,D:i,E:r,F:s,G:a,H:c}=this;return[e,t,n,i,r,s,a,c]}set(e,t,n,i,r,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=r|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)_n[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=_n[m-15],p=_n[m-2],b=Zt(d,7)^Zt(d,18)^d>>>3,f=Zt(p,17)^Zt(p,19)^p>>>10;_n[m]=f+_n[m-7]+b+_n[m-16]|0}let{A:n,B:i,C:r,D:s,E:a,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let d=Zt(a,6)^Zt(a,11)^Zt(a,25),p=l+d+dc(a,c,u)+mp[m]+_n[m]|0,f=(Zt(n,2)^Zt(n,13)^Zt(n,22))+pc(n,i,r)|0;l=u,u=c,c=a,a=s+p|0,s=r,r=i,i=n,n=p+f|0}n=n+this.A|0,i=i+this.B|0,r=r+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,i,r,s,a,c,u,l)}roundClean(){_n.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var fc=mc(()=>new ia);import{PublicKey as of}from"@solana/web3.js";import kc,{isBN as hc}from"bn.js";import{bits as dp,BitStructure as pp,blob as fp,Blob as bp,cstr as yp,f32 as gp,f32be as Ap,f64 as Pp,f64be as wp,greedy as kp,Layout as hp,ns64 as Tp,ns64be as Ip,nu64 as Bp,nu64be as xp,offset as Sp,s16 as Kp,s16be as Cp,s24 as Lp,s24be as Rp,s32 as Np,s32be as Op,s40 as Mp,s40be as vp,s48 as Ep,s48be as _p,s8 as Vp,seq as Fp,struct as Rw,Structure as Dp,u16 as Wp,u16be as qp,u24 as Up,u24be as Gp,u32 as Xp,u32be as Qp,u40 as zp,u40be as jp,u48 as Hp,u48be as Yp,u8 as Zp,UInt as $p,union as Jp,Union as ef,unionLayoutDiscriminator as tf,utf8 as nf}from"@solana/buffer-layout";var no=hp,bc=Dp,yc=ef,Nw=pp,oa=$p,gc=bp,Ow=kp,Or=Zp,$t=Wp,Mw=Up,io=Xp,vw=zp,Ew=Hp,Ac=Bp,_w=qp,Vw=Gp,Fw=Qp,Dw=jp,Ww=Yp,qw=xp,Uw=Vp,Gw=Kp,Xw=Lp,Ee=Np,Qw=Mp,zw=Ep,jw=Tp,Hw=Cp,Yw=Rp,Zw=Op,$w=vp,Jw=_p,ek=Ip,tk=gp,nk=Ap,ik=Pp,ok=wp;var Pc=Fp,wc=Jp,rk=tf,Ie=fp,sk=yp,ak=nf,ra=dp,sa=Sp;var $n=class extends no{constructor(t,n,i){super(t,i);this.blob=Ie(t),this.signed=n}decode(t,n=0){let i=new kc(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new kc(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}},Mr=class extends no{constructor(t){super(8,t);this._lower=ra(io(),!1),this._upper=ra(io(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let i=this._lower.decode(t,n),r=this._upper.decode(t,n+this._lower.span);return v(v({},i),r)}encode(t,n,i=0){return this._lower.encode(t,n,i)+this._upper.encode(t,n,i+this._lower.span)}};function q(o){return new oa(1,o)}function pt(o){return new oa(4,o)}function w(o){return new $n(8,!1,o)}function te(o){return new $n(16,!1,o)}function Tc(o){return new $n(1,!0,o)}function hi(o){return new $n(8,!0,o)}function Ic(o){return new $n(16,!0,o)}var wn=class extends no{constructor(t,n,i,r){super(t.span,r);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function N(o){return new wn(Ie(32),e=>new of(e),e=>e.toBuffer(),o)}var aa=class extends no{constructor(t,n){super(-1,n);this.layout=t,this.discriminator=Or()}encode(t,n,i=0){return t==null?this.discriminator.encode(0,n,i):(this.discriminator.encode(1,n,i),this.layout.encode(t,n,i+1)+1)}decode(t,n=0){let i=this.discriminator.decode(t,n);if(i===0)return null;if(i===1)return this.layout.decode(t,n+1);throw new Error("Invalid option "+this.property)}getSpan(t,n=0){let i=this.discriminator.decode(t,n);if(i===0)return 1;if(i===1)return this.layout.getSpan(t,n+1)+1;throw new Error("Invalid option "+this.property)}};function dk(o,e){return new aa(o,e)}function De(o){return new wn(Or(),rf,sf,o)}function rf(o){if(o===0)return!1;if(o===1)return!0;throw new Error("Invalid bool: "+o)}function sf(o){return o?1:0}function pk(o,e){let t=io("length"),n=E([t,z(o,sa(t,-t.span),"values")]);return new wn(n,({values:i})=>i,i=>({values:i}),e)}function fk(o,e,t){let n=E([w("tag"),e.replicate("data")]);function i({tag:r,data:s}){if(!r.eq(o))throw new Error("Invalid tag, expected: "+o.toString("hex")+", got: "+r.toString("hex"));return s}return new wn(n,i,r=>({tag:o,data:r}),t)}function af(o){let e=io("length"),t=E([e,Ie(sa(e,-e.span),"data")]);return new wn(t,({data:n})=>n,n=>({data:n}),o)}function Vn(o){return new wn(af(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),o)}function bk(o,e){let t=wc(Or(),e);return o.forEach((n,i)=>t.addVariant(i,n,n.property)),t}function yk(o,e,t){let n=E([z(o,e,"values")]);return new wn(n,({values:i})=>i,i=>({values:i}),t)}var ua=class extends bc{decode(e,t){return super.decode(e,t)}};function E(o,e,t){return new ua(o,e,t)}var ca=class extends yc{encodeInstruction(e){let t=Math.max(...Object.values(this.registry).map(i=>i.span)),n=Buffer.alloc(t);return n.slice(0,this.encode(e,n))}decodeInstruction(e){return this.decode(e)}};function gk(o,e,t){return new ca(o,e,t)}var la=class extends gc{decode(e,t){let n=super.decode(e,t);if(!n.every(i=>i===0))throw new Error("nonzero padding bytes");return n}};function Ak(o){return new la(o)}function z(o,e,t){let n,i=typeof e=="number"?e:hc(e)?e.toNumber():new Proxy(e,{get(r,s){if(!n){let a=Reflect.get(r,"count");n=hc(a)?a.toNumber():a,Reflect.set(r,"count",n)}return Reflect.get(r,s)},set(r,s,a){return s==="count"&&(n=a),Reflect.set(r,s,a)}});return Pc(o,i,t)}var Jt=E([N("mint"),N("owner"),w("amount"),pt("delegateOption"),N("delegate"),q("state"),pt("isNativeOption"),w("isNative"),w("delegatedAmount"),pt("closeAuthorityOption"),N("closeAuthority")]);var Nk=be("Raydium_Util");function xc({owner:o,solAccountResp:e,tokenAccountResp:t}){let n=[],i=[];for(let{pubkey:r,account:s}of t.value){let a=Jt.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:r,mint:c,amount:u,isAssociated:ee(o,c,s.owner).publicKey.equals(r),isNative:!1,programId:s.owner}),i.push({pubkey:r,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Bc.default,amount:new cf(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:i}}function ze({fromPublicKey:o,programId:e=lf,assignSeed:t}){let n=t?btoa(t).slice(0,32):uf.generate().publicKey.toBase58().slice(0,32);return{publicKey:mf(o,n,e),seed:n}}function mf(o,e,t){let n=Buffer.concat([o.toBuffer(),Buffer.from(e),t.toBuffer()]),i=fc(n);return new Bc(i)}function ma(o){let{mint:e,tokenAccount:t,owner:n,programId:i=Ti}=o;return yf(t,e,n,i)}function kn(o){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:r=Ti}=o;return bf(e,t,i,n,r)}async function Fn(o){let{connection:e,amount:t,commitment:n,payer:i,owner:r,skipCloseAccount:s}=o,a=await e.getMinimumBalanceForRentExemption(Jt.span,n),c=J(t).add(new ff(a)),u=ze({fromPublicKey:i,programId:Ti});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[pf.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:Jt.span,programId:Ti}),ma({mint:new df(at.address),tokenAccount:u.publicKey,owner:r,programId:Ti})],instructionTypes:[X.CreateAccount,X.InitAccount],endInstructionTypes:s?[]:[X.CloseAccount],endInstructions:s?[]:[kn({tokenAccount:u.publicKey,payer:i,owner:r})]}}function Sc({source:o,destination:e,owner:t,amount:n,multiSigners:i=[],tokenProgram:r=Ti}){return gf(o,e,t,BigInt(String(n)),i,r)}var oo=class extends ve{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._notSubscribeAccountChange=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:i,notSubscribeAccountChange:r}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=i||[],this._notSubscribeAccountChange=r!=null?r:!0,this._clientOwnedToken=!!(n||i)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(t){this._notSubscribeAccountChange=t}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return ee(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let i=v(v({},{}),t),[r,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Dn},i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Pf},i.commitment)]),{tokenAccounts:c,tokenAccountRawInfos:u}=xc({owner:this.scope.ownerPubKey,solAccountResp:r,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=c,this._tokenAccountRawInfos=u,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(l=>l({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:t==null?void 0:t.commitment})),{tokenAccounts:c,tokenAccountRawInfos:u}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:t,programId:n=Dn,associatedOnly:i=!0}){await this.fetchWalletTokenAccounts();let r=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,c)=>a.amount.lt(c.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of r){let{publicKey:c}=a;if(c&&(!i||i&&s.equals(c)))return c}}async getOrCreateTokenAccount(t){var f,y,g,P;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:i,associatedOnly:r,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:c=!1,checkCreateATAOwner:u=!1,assignSeed:l}=t,m=new vr(t.tokenProgram||Dn),d=this.getAssociatedTokenAccount(n,new vr(m)),p=(a?[]:this.tokenAccountRawInfos).filter(k=>k.accountInfo.mint.equals(n)&&(!r||k.pubkey.equals(d))).sort((k,T)=>k.accountInfo.amount.lt(T.accountInfo.amount)?1:-1);if(i===void 0||p.length>0)return p.length>0?{account:p[0].pubkey}:{};let b={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(r){let k=da(s,d,s,n,m),T=this.tokenAccountRawInfos.find(I=>I.pubkey.equals(d));if(u){let I=await this.scope.connection.getAccountInfo(d);if(I===null)(f=b.instructions)==null||f.push(k),b.instructionTypes.push(X.CreateATA);else if(!(I.owner.equals(m)&&Ii.decode(I.data).mint.equals(n)&&Ii.decode(I.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${d.toString()}`)}else T===void 0&&(b.instructions.push(k),b.instructionTypes.push(X.CreateATA));if(n.equals($)&&i.amount){let I=await Fn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(y=i.amount)!=null?y:0,skipCloseAccount:c});b.instructions.push(...I.instructions||[]),b.endInstructions.push(...I.endInstructions||[]),b.instructionTypes.push(...I.instructionTypes||[]),b.endInstructionTypes.push(...I.endInstructionTypes||[]),i.amount&&(b.instructions.push(Sc({source:I.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:i.amount,tokenProgram:Dn})),b.instructionTypes.push(X.TransferAmount))}return!c&&T===void 0&&(b.endInstructions.push(kn({owner:s,payer:i.payer||s,tokenAccount:d,programId:m})),b.endInstructionTypes.push(X.CloseAccount)),{account:d,instructionParams:b}}else{let k=ze({fromPublicKey:s,programId:m,assignSeed:l}),T=await this.scope.connection.getMinimumBalanceForRentExemption(Ii.span),I=Af.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:k.seed,newAccountPubkey:k.publicKey,lamports:T+Number((P=(g=i.amount)==null?void 0:g.toString())!=null?P:0),space:Ii.span,programId:m});return b.instructions.push(I,ma({mint:n,tokenAccount:k.publicKey,owner:this.scope.ownerPubKey,programId:m})),b.instructionTypes.push(X.CreateAccount),b.instructionTypes.push(X.InitAccount),c||(b.endInstructions.push(kn({owner:s,payer:i.payer||s,tokenAccount:k.publicKey,programId:m})),b.endInstructionTypes.push(X.CloseAccount)),{account:k.publicKey,instructionParams:b}}}async checkOrCreateAta({mint:t,programId:n=Dn,autoUnwrapWSOLToSOL:i}){var c;await this.fetchWalletTokenAccounts();let r=(c=this.scope.account.tokenAccounts.find(({mint:u})=>(u==null?void 0:u.toBase58())===t.toBase58()))==null?void 0:c.publicKey,s=this.scope.ownerPubKey,a={};if(!r){let u=this.getAssociatedTokenAccount(t,n),l=await da(s,u,s,t,n);a.instructions=[l],a.instructionTypes=[X.CreateATA],r=u}return i&&$.toBase58()===t.toBase58()&&(a.endInstructions=[kn({owner:s,payer:s,tokenAccount:r,programId:n})],a.endInstructionTypes=[X.CloseAccount]),{pubKey:r,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:i,mint:r,programId:s=Dn,tokenAccount:a,payer:c=this.scope.ownerPubKey,bypassAssociatedCheck:u,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(r,s);if(new vr($).equals(r)){let p=await Fn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:c,amount:i,skipCloseAccount:l});return v({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!u){let p=[],b=da(this.scope.ownerPubKey,d,this.scope.ownerPubKey,r,s);if(m){let f=await this.scope.connection.getAccountInfo(d);if(f===null)p.push(b);else if(!(f.owner.equals(Dn)&&Ii.decode(f.data).mint.equals(r)&&Ii.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${r.toString()}, ata: ${d.toString()}`)}else p.push(b);return{tokenAccount:d,instructions:p,instructionTypes:[X.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:i=Dn,amount:r,useSOLBalance:s,handleTokenAccount:a,feePayer:c}=t,u,l=this.createTxBuilder(c);if(n.equals(new vr($))&&s){let m=await this.handleTokenAccount({side:"in",amount:r||0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=m,b=We(m,["tokenAccount"]);u=p,l.addInstruction(b)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:i}),!u&&a){let d=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=d,b=We(d,["tokenAccount"]);u=p,l.addInstruction(b)}return v({tokenAccount:u},l.AllTxData)}};import{PublicKey as xe,SystemProgram as Df}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Wf}from"@solana/spl-token";import{PublicKey as Mc}from"@solana/web3.js";var pa=E([q("instruction")]),fa=E([q("instruction")]),wf=E([w("rewardState"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardLastUpdateTime"),w("totalReward"),w("totalRewardEmissioned"),w("rewardClaimed"),w("rewardPerSecond"),te("accRewardPerShare"),N("rewardVault"),N("rewardMint"),N("rewardSender"),w("rewardType"),z(w(),15,"padding")]),kf=E([w("state"),w("nonce"),N("lpVault"),N("rewardVault"),N(),N(),w(),w(),w("totalReward"),te("perShareReward"),w("lastSlot"),w("perSlotReward")]),hf=E([w("state"),w("nonce"),N("lpVault"),N("rewardVaultA"),w("totalRewardA"),te("perShareRewardA"),w("perSlotRewardA"),q("option"),N("rewardVaultB"),Ie(7),w("totalRewardB"),te("perShareRewardB"),w("perSlotRewardB"),w("lastSlot"),N()]),Tf=E([w(),w("state"),w("nonce"),w("validRewardTokenNum"),te("rewardMultiplier"),w("rewardPeriodMax"),w("rewardPeriodMin"),w("rewardPeriodExtend"),N("lpMint"),N("lpVault"),z(wf,5,"rewardInfos"),N("creator"),N(),z(w(),32,"padding")]),Kc=new Proxy(kf,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(v({},i),{version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]})}:Reflect.get(o,e,t)}}),Cc=new Proxy(hf,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(v({},i),{version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]})}:Reflect.get(o,e,t)}}),ro=new Proxy(Tf,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(v({},i),{version:6,rewardInfos:i.rewardInfos.map(r=>{var s;return U(v({},r),{rewardType:((s=Object.entries(Wn).find(a=>String(a[1])===r.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(o,e,t)}}),If=E([w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),ba=E([q("instruction"),w("nonce"),z(If,5,"rewardTimeInfo")]),ya=E([q("instruction"),w("rewardReopenTime"),w("rewardEndTime"),w("rewardPerSecond")]),ga=E([q("instruction"),w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),lh=E([w("state"),N("id"),N("owner"),w("deposited"),z(w(),1,"rewardDebts")]),so=E([w("state"),N("id"),N("owner"),w("deposited"),z(te(),1,"rewardDebts"),w(""),w("voteLockedBalance"),z(w(),15)]),mh=E([w("state"),N("id"),N("owner"),w("deposited"),z(w(),2,"rewardDebts")]),Lc=E([w("state"),N("id"),N("owner"),w("deposited"),z(te(),2,"rewardDebts"),z(w(),17)]),Rc=E([w(),w("state"),N("id"),N("owner"),w("deposited"),z(te(),5,"rewardDebts"),z(w(),16)]),It=E([q("instruction"),w("amount")]),Bf=E([N("mint"),N("grantAuthority"),w("baselineVoteWeightScaledFactor"),w("maxExtraLockupVoteWeightScaledFactor"),w("lockupSaturationSecs"),Tc("digitShift"),z(q(),7,"reserved1"),z(w(),7,"reserved2")]),Nc=E([Ie(8),N("governanceProgramId"),N("realm"),N("realmGoverningTokenMint"),N("realmAuthority"),z(q(),32,"reserved1"),z(Bf,4,"votingMints"),hi("timeOffset"),q("bump"),z(q(),7,"reserved2"),z(w(),11,"reserved3")]),xf=E([hi("startTime"),hi("endTime"),q("kind"),z(q(),15,"reserved")]),Sf=E([z(xf,1,"lockup"),w("amountDeposited_native"),w("amountInitiallyLockedNative"),De("isUsed"),De("allowClawback"),q("votingMintConfigIdx"),z(q(),29,"reserved")]),Oc=E([Ie(8),N("voterAuthority"),N("registrar"),z(Sf,32,"deposits"),q("voterBump"),q("voterWweightRecordBump"),z(q(),94,"reserved")]);var Ph=be("Raydium_farm_config"),vc=new Mc("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Ec=new Mc("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),_c={3:Kc,5:Cc,6:ro},Vc={3:so,5:Lc,6:Rc},Aa=o=>[3,4,5,6].indexOf(o)!==-1,Pa=o=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=o,i=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,r={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${i}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${i}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${i}`}};return(s=r[e])==null?void 0:s.call(r)},Wn={"Standard SPL":0,"Option tokens":1},Et={[Xs.toString()]:3,[nc.toString()]:4,[Qs.toString()]:5,[Ai.toString()]:6};import{PublicKey as ae,SystemProgram as Jn,SYSVAR_CLOCK_PUBKEY as xi,SYSVAR_RENT_PUBKEY as Lf,TransactionInstruction as rt}from"@solana/web3.js";import Er from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Rf,createAssociatedTokenAccountInstruction as Nf,TOKEN_PROGRAM_ID as Ct}from"@solana/spl-token";function wa(o,e,t){return ie([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],o)}function ka(o,e){return ie([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],o)}function ha(o,e){return ie([e.toBuffer()],o)}function Ta(o,e,t){return ie([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],o)}function Ia(o,e,t){return ie([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],o)}function Ba(o,e,t,n){return ie([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}import Kt from"bn.js";var ao=be("Raydium.farm.util");function uo({programId:o,poolId:e,mint:t,type:n}){let{publicKey:i}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],o);return i}function At({programId:o,poolId:e,owner:t,version:n}){let{publicKey:i}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],o);return i}var Fc=({programId:o,poolId:e})=>ie([e.toBuffer()],o);function Dc(o){return{isSet:new Kt(1),rewardPerSecond:J(o.perSecond),rewardOpenTime:J(o.openTime),rewardEndTime:J(o.endTime),rewardType:J(Wn[o.rewardType])}}function xa(o){return J(o.endTime).sub(J(o.openTime)).mul(J(o.perSecond))}function Bi(o){let e=Vc[o];return e||ao.logWithError("invalid version",o),e}function Kf(o){let e=_c[o];return e||ao.logWithError("invalid version",o),e}function Cf(o,e,t,n){if(o.version===3||o.version===5){if(o.lastSlot.gte(new Kt(t)))return o;let i=new Kt(t).sub(o.lastSlot);o.lastSlot=new Kt(t);for(let r of o.rewardInfos){if(e.amount.eq(new Kt(0)))continue;let s=r.perSlotReward.mul(i);r.perShareReward=r.perShareReward.add(s.mul(new Kt(10).pow(new Kt(o.version===3?9:15))).div(e.amount)),r.totalReward=r.totalReward.add(s)}}else if(o.version===6)for(let i of o.rewardInfos){if(i.rewardState.eq(new Kt(0)))continue;let r=Kt.min(new Kt(n),i.rewardEndTime);if(i.rewardOpenTime.gte(r))continue;let a=r.sub(i.rewardLastUpdateTime).mul(i.rewardPerSecond),c=i.totalReward.sub(i.totalRewardEmissioned);c.lt(a)?(a=c,i.rewardLastUpdateTime=i.rewardLastUpdateTime.add(c.div(i.rewardPerSecond))):i.rewardLastUpdateTime=r,!e.amount.eq(new Kt(0))&&(i.accRewardPerShare=i.accRewardPerShare.add(a.mul(o.rewardMultiplier).div(e.amount)),i.totalRewardEmissioned=i.totalRewardEmissioned.add(a))}return o}async function Eh({connection:o,farmPools:e,owner:t,config:n,chainTime:i}){let r=!1,s=!1,a=new Kt(10),c=[];for(let d of e){let p=Me(d);p.version===6?s=!0:r=!0,c.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&c.push({pubkey:At({programId:p.programId,poolId:p.id,owner:t,version:d.version}),version:p.version,key:"ledger",poolId:p.id})}let u={},l=await Oe(o,c,n);for(let{pubkey:d,version:p,key:b,poolId:f,accountInfo:y}of l){let g=f.toBase58();if(u[g]=v({},u[g]),b==="state"){let P=Kf(p);(!y||!y.data||y.data.length!==P.span)&&ao.logWithError(`invalid farm state account info, pools.id, ${d}`),u[g].state=P.decode(y.data)}else if(b==="lpVault")(!y||!y.data||y.data.length!==Jt.span)&&ao.logWithError(`invalid farm lp vault account info, pools.lpVault, ${d}`),u[g].lpVault=Jt.decode(y.data);else if(b==="ledger"){let P=Bi(p);y&&y.data&&(y.data.length!==P.span&&ao.logWithError(`invalid farm ledger account info, ledger, ${d}`),u[g].ledger=P.decode(y.data))}}let m=s||r?await o.getSlot():0;for(let d of Object.keys(u))u[d]!==void 0&&(u[d].state=Cf(u[d].state,u[d].lpVault,m,i));for(let[d,{state:p,ledger:b}]of Object.entries(u))if(b){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new Kt(9)):a.pow(new Kt(15)),y=p.rewardInfos.map((g,P)=>{let k=b.rewardDebts[P];return b.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(k)});u[d].wrapped=U(v({},u[d].wrapped),{pendingRewards:y})}return u}function _h(o,e=Date.now()){if(o.version===6){let t=o.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>zu(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>ju(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=o.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function Sa(o,e,t,n){let i=await o.getAccountInfo(e);if(i===null)throw Error("registrar info check error");let s=Nc.decode(i.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await o.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let u=Oc.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return u===-1?{index:s,isInit:!1}:{index:u,isInit:!0}}var Of=be("Raydium_farm_instruction"),co={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function lo(o){let{version:e,id:t,ledger:n,programId:i,owner:r}=o,s={3:9,5:10}[e];s||Of.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(pa.span);pa.encode({instruction:s},a);let c=[A({pubkey:t}),A({pubkey:n}),A({pubkey:r,isWritable:!1}),A({pubkey:Jn.programId,isWritable:!1}),A({pubkey:Lf,isWritable:!1})];return{instruction:new rt({programId:i,keys:c,data:a}),instructionType:X.FarmV3CreateLedger}}function Wc(o){var n;let e=Buffer.alloc(ba.span);ba.encode({instruction:0,nonce:new Er(o.nonce),rewardTimeInfo:o.rewardInfoConfig},e);let t=[...Os,A({pubkey:o.farmId}),A({pubkey:o.farmAuthority,isWritable:!1}),A({pubkey:o.lpVault}),A({pubkey:o.lpMint,isWritable:!1}),A({pubkey:o.lockVault}),A({pubkey:o.lockMint,isWritable:!1}),A({pubkey:(n=o.lockUserAccount)!=null?n:ut}),A({pubkey:o.owner,isWritable:!1,isSigner:!0})];for(let i of o.rewardInfo)t.push(A({pubkey:i.rewardMint,isWritable:!1}),A({pubkey:i.rewardVault}),A({pubkey:i.userRewardToken}));return{instruction:new rt({programId:o.programId,keys:t,data:e}),instructionType:X.FarmV6Create}}function qc(o){let e=Buffer.alloc(fa.span);fa.encode({instruction:5},e);let t=[A({pubkey:Ct,isWritable:!1}),A({pubkey:o.id}),A({pubkey:o.authority,isWritable:!1}),A({pubkey:o.lpVault,isWritable:!1}),A({pubkey:o.rewardVault}),A({pubkey:o.userRewardToken}),A({pubkey:o.owner,isWritable:!1,isSigner:!0})];return{instruction:new rt({programId:o.programId,keys:t,data:e}),instructionType:X.FarmV6CreatorWithdraw}}function Mf(o,e,t,n,i,r,s,a,c,u,l,m,d){let p=E([q("depositEntryIndex"),w("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:Ct,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:mr,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:m,amount:d},f);let y=Buffer.from([...co.voterStakeRegistryDeposit,...f]);return new rt({keys:b,programId:o,data:y})}function vf(o,e,t,n){let i=E([]),r=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:Jn.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([...co.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new rt({keys:r,programId:o,data:a})}function Ef(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b){let f=E([q("depositEntryIndex"),w("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:Ct,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:mr,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:b},g);let P=Buffer.from([...co.voterStakeRegistryWithdraw,...g]);return new rt({keys:y,programId:o,data:P})}function _f(o,e,t,n,i,r){let s=E([q("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:Jn.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({ins:23},c),new rt({keys:a,programId:o,data:c})}function Vf(o,e,t,n,i,r,s,a){let c=E([q("voterBump"),q("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:Jn.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:mr,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:s,voterWeightRecordBump:a},l);let m=Buffer.from([...co.voterStakeRegistryCreateVoter,...l]);return new rt({keys:u,programId:o,data:m})}function Ff(o,e,t,n,i,r,s,a,c,u,l,m){let d=E([q("depositEntryIndex"),q("kind"),q("option"),w("startTs"),pt("periods"),De("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Jn.programId,isSigner:!1,isWritable:!1},{pubkey:Ct,isSigner:!1,isWritable:!1},{pubkey:Rf,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1}],b=Buffer.alloc(d.span);d.encode({depositEntryIndex:a,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:m},b);let f=Buffer.from([...co.voterStakeRegistryCreateDepositEntry,...b]);return new rt({keys:p,programId:o,data:f})}async function Jh({connection:o,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:i,communityTokenMint:r,owner:s,poolId:a,tokenProgram:c}){let u=wa(n,i,r).publicKey,l=At({programId:e,poolId:a,owner:s,version:3}),m=await o.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=so.decode(m.data),p=d.deposited.sub(d.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new Er(0)))throw Error("user do not has new stake amount");let b=ka(e,a).publicKey,f=ha(e,a).publicKey,{publicKey:y,nonce:g}=Ta(n,u,s),P=ee(y,b,c).publicKey,{publicKey:k,nonce:T}=Ia(n,u,s),I=Ba(t,i,r,s).publicKey,h=[],S=ee(s,b,c).publicKey;if(await o.getAccountInfo(S)===null&&h.push(Nf(s,S,s,b)),await o.getAccountInfo(y)===null){let L=_f(t,i,s,r,s,I);h.push(L,Vf(n,u,y,k,s,s,g,T))}let{index:B,isInit:C}=await Sa(o,u,y,b);return C||h.push(Ff(n,u,y,P,s,s,b,B,0,void 0,0,!1)),h.push(Mf(n,u,y,P,S,s,l,a,b,f,e,B,p),vf(n,u,y,k)),h}async function eT({connection:o,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:i,communityTokenMint:r,owner:s,poolId:a,tokenProgram:c}){let u=wa(n,i,r).publicKey,l=At({programId:e,poolId:a,owner:s,version:3}),m=await o.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=so.decode(m.data);if(d.voteLockedBalance.eq(new Er(0)))throw Error("user has vote locked balance = 0");let p=ka(e,a).publicKey,b=ha(e,a).publicKey,{publicKey:f}=Ta(n,u,s),y=ee(f,p,c).publicKey,{publicKey:g}=Ia(n,u,s),P=Ba(t,i,r,s).publicKey,k=[],{index:T,isInit:I}=await Sa(o,u,f,p);if(!I)throw Error("deposit entry index check error");return k.push(Ef(n,u,f,s,P,g,y,ee(s,p,c).publicKey,l,a,p,b,e,T,d.voteLockedBalance)),k}function Ka({payer:o,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:i}){let r=Buffer.alloc(ya.span);ya.encode({instruction:3,rewardReopenTime:J(i.openTime),rewardEndTime:J(i.endTime),rewardPerSecond:J(i.perSecond)},r);let s=[A({pubkey:Ct,isWritable:!1}),A({pubkey:n.id}),A({pubkey:n.lpVault,isWritable:!1}),A({pubkey:e}),A({pubkey:t}),A({pubkey:o,isWritable:!1,isSigner:!0})];return new rt({programId:n.programId,keys:s,data:r})}function Ca({payer:o,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:i}){let r=Buffer.alloc(ga.span);ga.encode({instruction:4,isSet:new Er(1),rewardPerSecond:J(i.perSecond),rewardOpenTime:J(i.openTime),rewardEndTime:J(i.endTime),rewardType:J(Wn[i.rewardType])},r);let s=[...Os,A({pubkey:t.id}),A({pubkey:t.authority,isWritable:!1}),A({pubkey:i.mint,isWritable:!1}),A({pubkey:n}),A({pubkey:e}),A({pubkey:o,isWritable:!1,isSigner:!0})];return new rt({programId:t.programId,keys:s,data:r})}function tT(o){let{farmInfo:e,farmKeys:t,version:n,lpAccount:i,rewardAccounts:r,owner:s,instruction:a,amount:c,deposit:u}=o,[l,m]=[new ae(e.programId),new ae(e.id)],d=At({programId:l,poolId:m,owner:s,version:n}),p=Buffer.alloc(It.span);It.encode({instruction:a,amount:c},p);let b=n===6?[A({pubkey:Ct,isWritable:!1}),...u?[A({pubkey:Jn.programId,isWritable:!1})]:[],A({pubkey:m}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:new ae(t.lpVault)}),A({pubkey:d}),A({pubkey:s,isWritable:!1,isSigner:!0}),A({pubkey:i})]:[A({pubkey:m}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:d}),A({pubkey:s,isWritable:!1,isSigner:!0}),A({pubkey:i}),A({pubkey:new ae(t.lpVault)}),A({pubkey:r[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:xi,isWritable:!1}),A({pubkey:Ct,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)b.push(A({pubkey:r[f]})),b.push(A({pubkey:new ae(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)b.push(A({pubkey:new ae(t.rewardInfos[f].vault)})),b.push(A({pubkey:r[f]}));return new rt({programId:l,keys:b,data:p})}function mo(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,c]=[new ae(e.programId),new ae(e.id)],u=At({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(It.span);It.encode({instruction:2,amount:J(s)},l);let m=[A({pubkey:Ct,isWritable:!1}),A({pubkey:c}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:new ae(t.lpVault)}),A({pubkey:u}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(A({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(A({pubkey:i[d]}));return new rt({programId:a,keys:m,data:l})}function po(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=At({programId:c,poolId:u,owner:r,version:5}),m=Buffer.alloc(It.span);It.encode({instruction:12,amount:J(s)},m);let d=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:xi,isWritable:!1}),A({pubkey:Ct,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(A({pubkey:i[p]})),d.push(A({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(A({pubkey:p}));return new rt({programId:c,keys:d,data:m})}function Uc(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=E([q("instruction"),w("amount")]),m=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:a[0]}),A({pubkey:r,isSigner:!0,isWritable:!1}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:xi,isWritable:!1}),A({pubkey:Ct,isWritable:!1}),A({pubkey:i[1]}),A({pubkey:new ae(t.rewardInfos[1].vault)})],d=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},d),new rt({keys:m,programId:c,data:d})}function fo(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=At({programId:c,poolId:u,owner:r,version:3}),m=Buffer.alloc(It.span);It.encode({instruction:11,amount:J(s)},m);let d=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:xi,isWritable:!1}),A({pubkey:Ct,isWritable:!1})];if(a)for(let p of a)d.push(A({pubkey:p}));return new rt({programId:c,keys:d,data:m})}function Gc(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=At({programId:c,poolId:u,owner:r,version:3}),m=Buffer.alloc(It.span);It.encode({instruction:10,amount:J(s)},m);let d=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:xi,isWritable:!1}),A({pubkey:Ct,isWritable:!1})];if(a)for(let p of a)d.push(A({pubkey:p}));return new rt({programId:c,keys:d,data:m})}function Xc(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=At({programId:c,poolId:u,owner:r,version:5}),m=Buffer.alloc(It.span);It.encode({instruction:11,amount:J(s)},m);let d=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:xi,isWritable:!1}),A({pubkey:Ct,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(A({pubkey:i[p]})),d.push(A({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(A({pubkey:p}));return new rt({programId:c,keys:d,data:m})}function Qc(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,c]=[new ae(e.programId),new ae(e.id)],u=At({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(It.span);It.encode({instruction:1,amount:J(s)},l);let m=[A({pubkey:Ct,isWritable:!1}),A({pubkey:Jn.programId,isWritable:!1}),A({pubkey:c}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:new ae(t.lpVault)}),A({pubkey:u}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(A({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(A({pubkey:i[d]}));return new rt({programId:a,keys:m,data:l})}var bo=class extends ve{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(ut)){let n=await Fn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:xa(U(v({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:i=Ai,txVersion:r,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new xe(e.lpMint.address),lockInfo:{lockMint:vc,lockVault:Ec},version:6,rewardInfos:t,programId:i},u=this.createTxBuilder(s),l=n!=null?n:this.scope.ownerPubKey,m=ze({fromPublicKey:l,programId:c.programId}),d=await this.scope.connection.getMinimumBalanceForRentExemption(ro.span);u.addInstruction({instructions:[Df.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:m.seed,newAccountPubkey:m.publicKey,lamports:d,space:ro.span,programId:c.programId})]});let{publicKey:p,nonce:b}=Fc({programId:new xe(c.programId),poolId:m.publicKey}),f=uo({programId:c.programId,poolId:m.publicKey,mint:c.lpMint,type:"lpVault"}),y=[],g=[];for(let h of c.rewardInfos){h.openTime>=h.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",h.openTime.toString()),isNaN(Wn[h.rewardType])&&this.logAndCreateError("rewardType error",h.rewardType),Number(h.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",h.perSecond),y.push(Dc(h));let{rewardPubKey:S,newInstruction:x}=await this._getUserRewardInfo({rewardInfo:h,payer:l});x&&u.addInstruction(x),S||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let K=h.mint.equals(ut)?new xe(at.address):h.mint;g.push({rewardMint:K,rewardVault:uo({programId:c.programId,poolId:m.publicKey,mint:K,type:"rewardVault"}),userRewardToken:S})}let{account:P,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({mint:new xe(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});k&&u.addInstruction(k),P||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:T,instructionType:I}=Wc({farmId:m.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:f,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:P,programId:c.programId,rewardInfo:g,rewardInfoConfig:y,nonce:b});return u.addInstruction({instructions:[T],instructionTypes:[I]}).versionBuild({txVersion:r,extInfo:{farmId:m.publicKey,farmAuthority:p,lpVault:f,lockUserAccount:P,nonce:b}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:i,feePayer:r}){var g;let s=Et[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Me((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(ut)?new xe(at.address):n.mint,m=c.rewardInfos.findIndex(P=>new xe(P.mint.address).equals(l)),d=a.rewardInfos[m];d||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=(g=d.vault)!=null?g:ut,b=this.createTxBuilder(r),{rewardPubKey:f,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return y&&b.addInstruction(y),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),b.addInstruction({instructions:[Ka({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:f,farmKeys:c,rewardInfo:n})],instructionTypes:[X.FarmV6Restart]}).versionBuild({txVersion:i})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:i,feePayer:r}){var m;let s=Et[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Me((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(r);for(let d of n){let p=d.mint.equals(ut)?new xe(at.address):d.mint,b=c.rewardInfos.findIndex(T=>new xe(T.mint.address).equals(p)),f=a.rewardInfos[b];f||this.logAndCreateError("configuration does not exist","rewardMint",p);let y=(m=f.vault)!=null?m:ut,{rewardPubKey:g,newInstruction:P}=await this._getUserRewardInfo({rewardInfo:d,payer:u});P&&l.addInstruction(P),g||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let k=Ka({payer:this.scope.ownerPubKey,rewardVault:y,userRewardTokenPub:g,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[k],instructionTypes:[X.FarmV6Restart]})}return l.versionBuild({txVersion:i})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:i,payer:r,feePayer:s}=e,a=Et[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Me((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,l=this.createTxBuilder(s),m=i.mint.equals(ut)?new xe(at.address):i.mint,d=uo({programId:new xe(n.programId),poolId:new xe(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:i,payer:u});return b&&l.addInstruction(b),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),i.mint=m,l.addInstruction({instructions:[Ca({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:d,rewardInfo:i})],instructionTypes:[X.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:i,payer:r,feePayer:s}=e,a=Et[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Me((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let m of i){let d=m.mint.equals(ut)?new xe(at.address):m.mint,p=uo({programId:new xe(n.programId),poolId:new xe(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:b,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:m,payer:u});f&&l.addInstruction(f),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let y=Ca({payer:this.scope.ownerPubKey,userRewardTokenPub:b,farmKeys:c,rewardVault:p,rewardInfo:U(v({},m),{mint:d})});l.addInstruction({instructions:[y],instructionTypes:[X.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:i,feePayer:r,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:m}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:d,programId:p}=n,b=Et[p];b===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),Aa(b)||this.logAndCreateError("invalid farm program:",n.programId);let[f,y]=[new xe(n.programId),new xe(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],P=At({programId:f,poolId:y,owner:this.scope.ownerPubKey,version:b}),k=this.createTxBuilder(r);k.addCustomComputeBudget(l),k.addTipInstruction(m);let T={};for(let D of this.scope.account.tokenAccounts)if(a){let F=ee(this.scope.ownerPubKey,D.mint,D.programId).publicKey;D.publicKey&&F.equals(D.publicKey)&&(T[D.mint.toString()]=D.publicKey)}else T[D.mint.toString()]=D.publicKey;let I=g.lpMint,h=T[I.address];h||this.logAndCreateError("you don't have any lp","lp zero",T);let S=[];for(let D of d){let F=s&&D.mint.address===$.toString(),W=T[D.mint.address];if(!W){let{account:Y,instructionParams:se}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:D.mint.programId,mint:new xe(D.mint.address),notUseTokenAccount:F,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!F,associatedOnly:F?!1:a,checkCreateATAOwner:c});W=Y,se&&k.addInstruction(se)}T[D.mint.address]=W,S.push(W)}let x,K=await this.scope.connection.getAccountInfo(P);if(K&&(x=Bi(b).decode(K.data)),n.programId!==Ai.toString()&&!x){let{instruction:D,instructionType:F}=lo({id:y,programId:f,version:b,ledger:P,owner:this.scope.ownerPubKey});k.addInstruction({instructions:[D],instructionTypes:[F]})}let B=Pa({version:b,rewardInfos:d,rewardTokenAccountsPublicKeys:S});B&&this.logAndCreateError(B);let C={amount:J(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:h,rewardAccounts:S,userAuxiliaryLedgers:u==null?void 0:u.map(D=>new xe(D))},L=b===6?Qc(C):b===5?Xc(C):Gc(C),R={3:X.FarmV3Deposit,5:X.FarmV5Deposit,6:X.FarmV6Deposit};return k.addInstruction({instructions:[L],instructionTypes:[R[b]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:i,deposited:r,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m,txTipConfig:d}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let b=Et[n.programId];Aa(b)||this.logAndCreateError("invalid farm program:",n.programId);let f=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],y=this.createTxBuilder(a);y.addCustomComputeBudget(m),y.addTipInstruction(d);let g={};for(let B of this.scope.account.tokenAccounts)if(c){let C=ee(this.scope.ownerPubKey,B.mint).publicKey;B.publicKey&&C.equals(B.publicKey)&&(g[B.mint.toString()]=B.publicKey)}else g[B.mint.toString()]=B.publicKey;if(b!==4){let B=At({programId:new xe(n.programId),poolId:new xe(n.id),owner:this.scope.ownerPubKey,version:b}),C=await this.scope.connection.getAccountInfo(B);if(C)Bi(b).decode(C.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(b!==6){let{instruction:L,instructionType:R}=lo({id:new xe(f.id),programId:new xe(f.programId),version:b,ledger:B,owner:this.scope.ownerPubKey});y.addInstruction({instructions:[L],instructionTypes:[R]})}}r&&r.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let P=f.lpMint.address,k=s&&P===$.toString(),T=g[P.toString()];if(!T){let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.lpMint.programId,mint:new xe(P),notUseTokenAccount:k,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:k?!1:c,checkCreateATAOwner:u});T=B,C&&y.addInstruction(C)}g[P.toString()]=T;let I=[];for(let B of p){let C=s&&B.mint.address===$.toString(),L=g[B.mint.address];if(!L){let{account:R,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:B.mint.programId,mint:new xe(B.mint.address),notUseTokenAccount:C,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!C,associatedOnly:C?!1:c,checkCreateATAOwner:u});L=R,D&&y.addInstruction(D)}g[B.mint.address]=L,I.push(L)}let h=Pa({version:b,rewardInfos:p,rewardTokenAccountsPublicKeys:I});h&&this.logAndCreateError(h);let S={amount:J(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:f,lpAccount:T,rewardAccounts:I,userAuxiliaryLedgers:l==null?void 0:l.map(B=>new xe(B))},x=b===6?mo(S):b===5?po(S):b===4?Uc(S):fo(S),K={3:X.FarmV3Withdraw,4:X.FarmV4Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};return y.addInstruction({instructions:[x],instructionTypes:[K[b]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:i,txTipConfig:r,feePayer:s}){var f;this.scope.checkOwner();let a=Me((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=Et[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(y=>yt(y.mint.address).equals(yt(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=(f=u==null?void 0:u.vault)!=null?f:ut,m=this.createTxBuilder(s),d;if(t.equals(ut)||t.equals(xe.default)){let y=await Fn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:xa(U(v({},u),{openTime:u.openTime,endTime:u.endTime,perSecond:new O(u.perSecond).mul(10**u.mint.decimals).toString()}))});d=y.addresses.newAccount,m.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(d=await this.scope.account.getAssociatedTokenAccount(t),m.addInstruction({instructions:[Wf(this.scope.ownerPubKey,d,this.scope.ownerPubKey,t)],instructionTypes:[X.CreateATA]})):d=y}let{instruction:p,instructionType:b}=qc({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:d,owner:this.scope.ownerPubKey});return m.addCustomComputeBudget(i),m.addTipInstruction(r),m.addInstruction({instructions:[p],instructionTypes:[b]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(i),m={};for(let b of this.scope.account.tokenAccounts)if(r){let f=ee(this.scope.ownerPubKey,b.mint).publicKey;b.publicKey&&f.equals(b.publicKey)&&(m[b.mint.toString()]=b.publicKey)}else m[b.mint.toString()]=b.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(b=>b.id).join(",")})).reduce((b,f)=>U(v({},b),{[f.id]:f}),{});for(let b of Object.values(t)){let{programId:f,lpMint:y,rewardInfos:g,id:P}=b,k=Et[f],T=y.address,I=n&&T===$.toString(),h=m[T];if(!h){let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.programId,mint:new xe(T),notUseTokenAccount:I,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:I?!1:r,checkCreateATAOwner:s});h=L,R&&l.addInstruction(R)}m[T.toString()]=h;let S=[];for(let L of g){let R=n&&L.mint.address===$.toString(),D=m[L.mint.address];if(!D){let{account:F,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:L.mint.programId,mint:new xe(L.mint.address),notUseTokenAccount:R,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!R,associatedOnly:R?!1:r,checkCreateATAOwner:s});D=F,W&&l.addInstruction(W)}m[L.mint.address]=D,S.push(D)}let x=p[P],K={amount:$e,owner:this.scope.ownerPubKey,farmInfo:b,farmKeys:x,lpAccount:h,rewardAccounts:S,userAuxiliaryLedgers:a==null?void 0:a.map(L=>new xe(L))},B=k===6?mo(K):k===5?po(K):fo(K),C={3:X.FarmV3Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};l.addInstruction({instructions:[B],instructionTypes:[C[k]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as Je}from"@solana/web3.js";import{AccountLayout as Ob,NATIVE_MINT as Yr,TOKEN_PROGRAM_ID as Un}from"@solana/spl-token";import{Keypair as Ur,PublicKey as Q,SystemProgram as Bn,TransactionInstruction as ft}from"@solana/web3.js";import Va from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Bo,TOKEN_2022_PROGRAM_ID as qe,TOKEN_PROGRAM_ID as Se}from"@solana/spl-token";import eb from"bn.js";import _t from"bn.js";var ge=new _t(0),Ot=new _t(1),hn=new _t(-1),tt=new _t(1).shln(64),_r=new _t(1).shln(128),yo=tt.sub(Ot),go=64,zc=_r.subn(1),Pt=-443636,Bt=-Pt,Vt=new _t("4295048016"),Ft=new _t("79226673521066979257578248091"),Vr=new _t("4295048017"),Fr=new _t("79226673521066979257578248090"),jc=16,Hc="59543866431248",Yc="184467440737095516",Zc="15793534762490258745",Dr=new _t(10).pow(new _t(6)),qf=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(qf||{}),NT={[500]:10,[3e3]:60,[1e4]:200},OT={version:6,liquidity:ge,tickCurrent:0,feeGrowthGlobalX64A:ge,feeGrowthGlobalX64B:ge,protocolFeesTokenA:ge,protocolFeesTokenB:ge,swapInAmountTokenA:ge,swapOutAmountTokenB:ge,swapInAmountTokenB:ge,swapOutAmountTokenA:ge,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},$c={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},MT=new _t("18446744073700000000");import fe from"bn.js";function Wr(o){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,o,!1),new Uint8Array(e)}function ET(o){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,o,!1),new Uint8Array(e)}function _T(o){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,o,!1),new Uint8Array(e)}function qr(o){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,o,!1),new Uint8Array(e)}function La(o,e){let t=0;for(let n=o-1;n>=0&&!e.testn(n);n--)t++;return t}function Ra(o,e){let t=0;for(let n=0;n<o&&!e.testn(n);n++)t++;return t}function Ao(o,e){for(let t=0;t<o;t++)if(e.testn(t))return!1;return!0}function Jc(o,e){return Ao(o,e)?null:La(o,e)}function el(o,e){return Ao(o,e)?null:Ra(o,e)}var Uf=Buffer.from("amm_config","utf8"),Gf=Buffer.from("pool","utf8"),Xf=Buffer.from("pool_vault","utf8"),Qf=Buffer.from("pool_reward_vault","utf8"),tl=Buffer.from("position","utf8"),zf=Buffer.from("tick_array","utf8"),jf=Buffer.from("operation","utf8"),Hf=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Yf=Buffer.from("observation","utf8");function WT(o,e){return ie([Uf,Wr(e)],o)}function nl(o,e,t,n){return ie([Gf,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function Na(o,e,t){return ie([Xf,e.toBuffer(),t.toBuffer()],o)}function il(o,e,t){return ie([Qf,e.toBuffer(),t.toBuffer()],o)}function Ae(o,e,t){return ie([zf,e.toBuffer(),qr(t)],o)}function en(o,e,t,n){return ie([tl,e.toBuffer(),qr(t),qr(n)],o)}function xt(o,e){return ie([tl,e.toBuffer()],o)}function Tn(o){return ie([Buffer.from("metadata","utf8"),Qt.toBuffer(),o.toBuffer()],Qt)}function Po(o){return ie([jf],o)}function je(o,e){return ie([Hf,e.toBuffer()],o)}function ol(o,e){return ie([Yf,e.toBuffer()],o)}var rl=Buffer.from("locked_position","utf8");function Oa(o,e){return ie([rl,e.toBuffer()],o)}function wo(o,e){return ie([rl,e.toBuffer()],o)}var Zf=Buffer.from("support_mint","utf8");function Ma(o,e){return ie([Zf,e.toBuffer()],o)}import{PublicKey as Mt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as sl}from"@solana/spl-token";import _e from"bn.js";import cn from"bn.js";var ko=class{static getfeeGrowthInside(e,t,n){let i=new cn(0),r=new cn(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,r=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new cn(0),a=new cn(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ue.wrappingSubU128(ue.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),u=ue.wrappingSubU128(ue.wrappingSubU128(e.feeGrowthGlobalX64B,r),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ue.mulDivFloor(ue.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,tt),c=t.tokenFeesOwedA.add(a),u=ue.mulDivFloor(ue.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,tt),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ue.mulDivFloor(ue.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,tt),c=t.tokenFeesOwedA.add(a),u=ue.mulDivFloor(ue.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,tt),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let r=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ue.wrappingSubU128(c,u.growthInsideLastX64),m=ue.mulDivFloor(l,t.liquidity,tt),d=u.rewardAmountOwed.add(m);r.push(d)}return r}static GetPositionRewards(e,t,n,i){let r=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ue.wrappingSubU128(c,u.growthInsideLastX64),m=ue.mulDivFloor(l,t.liquidity,tt),d=u.rewardAmountOwed.add(m);r.push(d)}return r}static getRewardGrowthInside(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new cn(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new cn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ue.wrappingSubU128(ue.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return r}static getRewardGrowthInsideV2(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new cn(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new cn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ue.wrappingSubU128(ue.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return r}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:r,epochInfo:s}){var y,g,P,k;let a=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),c=oe.getSqrtPriceX64FromTick(t.tickLower),u=oe.getSqrtPriceX64FromTick(t.tickUpper),l=r?1+i:1-i,m=Pe.getAmountsFromLiquidity(a,c,u,n,r),[d,p]=[Te(m.amountA,(y=e.mintA.extensions)==null?void 0:y.feeConfig,s,!0),Te(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[b,f]=[Te(new cn(new O(m.amountA.toString()).mul(l).toFixed(0)),(P=e.mintA.extensions)==null?void 0:P.feeConfig,s,!0),Te(new cn(new O(m.amountB.toString()).mul(l).toFixed(0)),(k=e.mintB.extensions)==null?void 0:k.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:b,amountSlippageB:f,expirationTime:Ht(d.expirationTime,p.expirationTime)}}};var $f=15,ke=class{static async getTickArrays(e,t,n,i,r,s,a){let c=[],u=Z.getTickArrayStartIndexByTick(i,r),l=Z.getInitializedTickArrayInRange(s,a,r,u,Math.floor($f/2));for(let p=0;p<l.length;p++){let{publicKey:b}=Ae(t,n,l[p]);c.push(b)}let m=(await Ut(e,c)).map(p=>p!==null?ho.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let b=m[p];b!==null&&(d[b.startTickIndex]=U(v({},b),{address:c[p]}))}return d}static nextInitializedTick(e,t,n,i,r,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,i,r,s);for(;a==null||a.liquidityGross.lten(0);){if(u=Z.getNextTickArrayStartIndex(u,r,s),this.checkIsValidStartIndex(u,r))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,i,r){let s=Math.floor(e/ke.tickCount(t)),a=n?Z.searchLowBitFromStart(i,r,s-1,1,t):Z.searchHightBitFromStart(i,r,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let r;if(i){let a=st-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a-1}}else{let a=0;for(;a<st;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a+1}}let{publicKey:s}=Ae(e,t,n.startTickIndex);return{nextTick:r,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,r,s){let a=Z.getTickArrayStartIndexByTick(i,r),c=Math.floor((i-a)/r),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<st;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=Ae(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(Z.checkIsOutOfBoundary(e)){if(e>Bt)return!1;let n=Z.getTickArrayStartIndexByTick(Pt,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return st*e}};var va=14,In=class{static maxTickInTickarrayBitmap(e){return e*st*ei}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let r=n*i;return e<0?{minValue:-r,maxValue:-r+n}:{minValue:r,maxValue:r+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!ke.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let r=this.maxTickInTickarrayBitmap(n),s=i?t-ke.tickCount(n):t+ke.tickCount(n);if(s<-r||s>=r)return{isInit:!1,tickIndex:t};let a=n*st,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(i){let l=e.shln(1024-u-1),m=Jc(1024,l);if(m!==null){let d=(u-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-r}}else{let l=e.shrn(u),m=el(1024,l);if(m!==null){let d=(u+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:r-ke.tickCount(n)}}}},To=class{static getBitmapOffset(e,t){if(!ke.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=In.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=In.maxTickInTickarrayBitmap(e),n=-t;if(Bt<=t)throw Error(`extensionTickBoundary check error: ${Bt}, ${t}`);if(n<=Pt)throw Error(`extensionTickBoundary check error: ${n}, ${Pt}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),r=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:Z.mergeTickArrayBitmap(i).testn(r),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let r=ke.tickCount(t),s=n?e-r:e+r,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:r,maxValue:s}=In.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let c=Z.mergeTickArrayBitmap(e).shln(ei-1-a),u=Ao(512,c)?null:La(512,c);if(u!==null){let l=t-u*ke.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:r}}else{let c=Z.mergeTickArrayBitmap(e).shrn(a),u=Ao(512,c)?null:Ra(512,c);if(u!==null){let l=t+u*ke.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-ke.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%In.maxTickInTickarrayBitmap(t),i=Math.floor(n/ke.tickCount(t));return e<0&&n!=0&&(i=ei-i),i}};var Ne=class{static getOutputAmountAndRemainAccounts(e,t,n,i,r,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:b,sqrtPriceX64:f,feeAmount:y}=ti.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,l,r,s);return c.push(...b),{allTrade:d,expectedAmountOut:p.mul(hn),remainingAccounts:c,executionPrice:f,feeAmount:y}}static getInputAmountAndRemainAccounts(e,t,n,i,r){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:y}=Ae(e.programId,e.id,f.nextStartIndex);a.push(y)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:b}=ti.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(hn),u,r);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:b}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Ne.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?To.checkTickArrayIsInit(ke.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):Z.checkTickArrayIsInitialized(Z.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=Ae(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:r,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,ke.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(r){let{publicKey:a}=Ae(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/ke.tickCount(e.tickSpacing)),i=t?Z.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):Z.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=ke.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:r}=In.nextInitializedTickArrayStartIndex(Z.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:r};t=r;let{isInit:s,tickIndex:a}=To.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<Pt||t>Bt)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:r}){var a,c,u;let s=[];for(let l=0;l<r.length;l++){let m=r[l],d=(u=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?u:(c=await e.getAccountInfo(m.tokenMint))==null?void 0:c.owner;if(d===void 0)throw Error("get new reward mint info error");let p=U(v({},m),{perSecond:ue.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Mt(d)});if(p.tokenMint.equals(Mt.default))continue;if(n<=p.openTime.toNumber()||i.eq(ge)){s.push(p);continue}let b=new _e(Math.min(p.endTime.toNumber(),n)),f=b.sub(p.lastUpdateTime),y=ue.mulDivFloor(f,p.emissionsPerSecondX64,i),g=p.rewardGrowthGlobalX64.add(y),P=ue.mulDivFloor(f,p.emissionsPerSecondX64,tt),k=p.rewardTotalEmissioned.add(P);s.push(U(v({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:k,lastUpdateTime:b}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let r of t){let s=Z.getTickArrayStartIndexByTick(r,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=In.maxTickInTickarrayBitmap(e),n=-t;return t>Bt&&(t=ke.getArrayStartIndex(Bt,e)+ke.tickCount(e)),n<Pt&&(n=ke.getArrayStartIndex(Pt,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!ke.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/ke.tickCount(t)*ei}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Oe(e,t.map(s=>({pubkey:s})),{batchRequest:n}),r={};for(let s of i)s.accountInfo!==null&&(r[s.pubkey.toString()]=ul.decode(s.accountInfo.data));return r}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},r=[];for(let c of t){let u=Z.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=Z.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=Ae(c.programId,c.id,m);r.push({pubkey:d}),i[d.toString()]=c.id}}let s=await Oe(e,r,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=i[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=ho.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]=U(v({},l),{address:c.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:r=!0}){var a;let s=[];for(let c=0;c<e.length;c++){let u=e[c];u!==null&&(s.find(l=>l.equals(u.state.programId))||s.push(u.state.programId))}if(n){let c=n.tokenAccounts.map(d=>d.accountInfo.mint),u=[];for(let d of c)for(let p of s)u.push(xt(p,d).publicKey);let l=await Ut(t,u,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let p=Io.decode(d.data),b=p.poolId.toString(),f=e.find(x=>x.state.id.toBase58()===b);if(f===void 0)continue;let y=f.state,g=Z._getTickPriceLegacy({poolInfo:y,tick:p.tickLower,baseIn:!0}),P=Z._getTickPriceLegacy({poolInfo:y,tick:p.tickUpper,baseIn:!0}),{amountA:k,amountB:T}=Pe.getAmountsFromLiquidity(y.sqrtPriceX64,g.tickSqrtPriceX64,P.tickSqrtPriceX64,p.liquidity,!1),I=1/(1-Math.sqrt(Math.sqrt(g.price.div(P.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:P.price,amountA:k,amountB:T,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(x=>U(v({},x),{pendingReward:new _e(0)})),leverage:I,tokenFeeAmountA:new _e(0),tokenFeeAmountB:new _e(0)}];let h=await Z.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickLower,f.state.tickSpacing),S=await Z.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=h,m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=S}if(r){let d=Object.values(m),p=await Ut(t,d,{batchRequest:i}),b={};for(let f=0;f<d.length;f++){let y=p[f];if(y===null)continue;let g=d[f].toString();b[g]=ho.decode(y.data)}for(let{state:f,positionAccount:y}of e)if(!!y)for(let g of y){let P=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,k=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,T=b[m[P].toString()],I=b[m[k].toString()],h=T.ticks[Z.getTickOffsetInArray(g.tickLower,f.tickSpacing)],S=I.ticks[Z.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:x,tokenFeeAmountB:K}=await ko.GetPositionFees(f,g,h,S),B=await ko.GetPositionRewards(f,g,h,S);g.tokenFeeAmountA=x.gte(new _e(0))?x:new _e(0),g.tokenFeeAmountB=K.gte(new _e(0))?K:new _e(0);for(let C=0;C<B.length;C++)g.rewardInfos[C].pendingReward=B[C].gte(new _e(0))?B[C]:new _e(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:r,slippage:s,priceLimit:a=new O(0),catchLiquidityInsufficient:c=!1}){var L;let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new O(0))?u=l?Vt.add(new _e(1)):Ft.sub(new _e(1)):u=oe.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=Te(r,m,i,!1),{allTrade:b,expectedAmountOut:f,remainingAccounts:y,executionPrice:g,feeAmount:P}=Ne.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((L=p.fee)!=null?L:ge),u,c),k=Te(f,d,i,!1),T=oe.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),I=l?T:new O(1).div(T),h=f.mul(new _e(Math.floor((1-s)*1e10))).div(new _e(1e10)),S=Te(h,d,i,!1),x=l?e.currentPrice:new O(1).div(e.currentPrice),K=new O(I).sub(x).abs(),B=x,C=new Xe(new O(K).mul(10**15).toFixed(0),new O(B).mul(10**15).toFixed(0));return{allTrade:b,realAmountIn:p,amountOut:k,minAmountOut:S,expirationTime:Ht(p.expirationTime,k.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:C,fee:P,remainingAccounts:y,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:r,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=i.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Be(U(v({},u),{mint:u.address,isToken2022:u.programId===sl.toBase58()})),new Be(U(v({},l),{mint:l.address,isToken2022:l.programId===sl.toBase58()}))],{allTrade:p,realAmountIn:b,amountOut:f,minAmountOut:y,expirationTime:g,currentPrice:P,executionPrice:k,priceImpact:T,fee:I,remainingAccounts:h,executionPriceX64:S}=Ne.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Mt(u.address),amountIn:n,slippage:r,epochInfo:s,catchLiquidityInsufficient:a}),x=U(v({},b),{amount:new he(m,b.amount),fee:b.fee===void 0?void 0:new he(m,b.fee)}),K=U(v({},f),{amount:new he(d,f.amount),fee:f.fee===void 0?void 0:new he(d,f.fee)}),B=U(v({},y),{amount:new he(d,y.amount),fee:y.fee===void 0?void 0:new he(d,y.fee)}),C=new ct({baseToken:m,denominator:new _e(10).pow(new _e(20+m.decimals)),quoteToken:d,numerator:P.mul(new O(10**(20+d.decimals))).toFixed(0)}),L=new ct({baseToken:m,denominator:new _e(10).pow(new _e(20+m.decimals)),quoteToken:d,numerator:k.mul(new O(10**(20+d.decimals))).toFixed(0)}),R=new he(m,I);return{allTrade:p,realAmountIn:x,amountOut:K,minAmountOut:B,expirationTime:g,currentPrice:C,executionPrice:L,priceImpact:T,fee:R,remainingAccounts:h,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:r,slippage:s,priceLimit:a=new O(0)}){var B;let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new O(0))?l=c?Ft.sub(new _e(1)):Vt.add(new _e(1)):l=oe.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=Te(r,u[n.toString()],i,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:b,feeAmount:f}=Ne.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((B=m.fee)!=null?B:ge),l),y=c?e.mintB.address:e.mintA.address,g=Te(d,u[y],i,!1),P=oe.sqrtPriceX64ToPrice(b,e.mintA.decimals,e.mintB.decimals),k=c?P:new O(1).div(P),T=d.mul(new _e(Math.floor((1+s)*1e10))).div(new _e(1e10)),I=Te(T,u[y],i,!0),h=c?e.currentPrice:new O(1).div(e.currentPrice),S=new O(k).sub(h).abs(),x=h,K=new Xe(new O(S).mul(10**15).toFixed(0),new O(x).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:I,realAmountOut:m,expirationTime:Ht(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:K,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var b,f,y;let r=e[t],s=Z.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=Z.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),c=Math.max(s,r.priceMin),l=Math.min(a,r.priceMax)-c,m=a-s,d=r.priceMax-r.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:r.feeApr*p,rewardsApr:[((b=r.rewardApr[0])!=null?b:0)*p,((f=r.rewardApr[1])!=null?f:0)*p,((y=r.rewardApr[2])!=null?y:0)*p],apr:r.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:r,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[yt(e.mintA.address).toString()],d=i[yt(e.mintB.address).toString()],p=e.mintA.decimals,b=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),y=oe.getSqrtPriceX64FromTick(s),g=oe.getSqrtPriceX64FromTick(a),{amountSlippageA:P,amountSlippageB:k}=Pe.getAmountsFromLiquidityWithSlippage(f,y,g,t,!1,!1,0),{amountSlippageA:T,amountSlippageB:I}=Pe.getAmountsFromLiquidityWithSlippage(f,y,g,r,!1,!1,0),h=new O(P.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(k.toString()).div(new O(10).pow(b)).mul(d.value)),S=new O(T.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(I.toString()).div(new O(10).pow(b)).mul(d.value)),x=new O(1).div(h.add(S)),B=new O(l.volumeFee).mul(365).div(u).mul(x).mul(100).toNumber(),C=3600*24*365,L=e.rewardDefaultInfos.map(R=>{var W,Y;let D=R.mint.decimals,F=i[R.mint.address];return c<((W=R.startTime)!=null?W:0)||c>((Y=R.endTime)!=null?Y:0)||!R.perSecond||!F||D===void 0?0:new O(F.value).mul(new O(R.perSecond).mul(C)).div(new O(10).pow(D)).mul(x).mul(100).toNumber()});return{feeApr:B,rewardsApr:L,apr:B+L.reduce((R,D)=>R+D,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:r,slippage:s,add:a,epochInfo:c,amountHasFee:u}){var g,P;let l=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),m=oe.getSqrtPriceX64FromTick(n),d=oe.getSqrtPriceX64FromTick(i),p=Te(r,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,c,!u),b=new _e(new O(p.amount.sub((P=p.fee)!=null?P:ge).toString()).toFixed(0)),f;if(l.lte(m))f=t?Pe.getLiquidityFromTokenAmountA(m,d,b,!a):new _e(0);else if(l.lte(d)){let k=Pe.getLiquidityFromTokenAmountA(l,d,b,!a),T=Pe.getLiquidityFromTokenAmountB(m,l,b);f=t?k:T}else f=t?new _e(0):Pe.getLiquidityFromTokenAmountB(m,d,b);let y=await Ne.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:i,liquidity:f,slippage:s,add:a});return{liquidity:f,amountA:t?p:y.amountA,amountB:t?y.amountB:p,amountSlippageA:t?p:y.amountSlippageA,amountSlippageB:t?y.amountSlippageB:p,expirationTime:y.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:r,slippage:s,add:a}){var y,g,P,k;let c=oe.getSqrtPriceX64FromTick(n),u=oe.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=Pe.getAmountsFromLiquidity(oe.priceToSqrtPriceX64(new O(t.price),t.mintA.decimals,t.mintB.decimals),c,u,r,a),[d,p]=[Te(m.amountA,(y=t.mintA.extensions)==null?void 0:y.feeConfig,e,!0),Te(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[b,f]=[Te(m.amountA.muln(l),(P=t.mintA.extensions)==null?void 0:P.feeConfig,e,!0),Te(m.amountB.muln(l),(k=t.mintB.extensions)==null?void 0:k.feeConfig,e,!0)];return{liquidity:r,amountA:d,amountB:p,amountSlippageA:b,amountSlippageB:f,expirationTime:Ht(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(c=>!n[c.id]).map(c=>new Mt(c.id));(await Ut(e,i)).forEach((c,u)=>{!c||(n[i[u].toBase58()]=ni.decode(c.data))});let s=t.map(c=>je(new Mt(c.programId),new Mt(c.id)).publicKey),a=await Ne.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>U(v({},c),{[u.id]:U(v({},n[u.id]),{id:new Mt(u.id),version:6,programId:new Mt(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:U(v({},u.config),{id:new Mt(u.config.id),fundOwner:""}),currentPrice:new O(u.price),exBitmapAccount:je(new Mt(u.programId),new Mt(u.id)).publicKey,exBitmapInfo:a[je(new Mt(u.programId),new Mt(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function xI({poolInfo:o,tickLower:e,tickUpper:t,amountA:n,amountB:i,slippage:r,add:s,epochInfo:a,amountHasFee:c}){var k,T,I,h;let[u,l,m,d]=e<t?[e,t,n,i]:[t,e,i,n],p=oe.priceToSqrtPriceX64(new O(o.price),o.mintA.decimals,o.mintB.decimals),b=oe.getSqrtPriceX64FromTick(u),f=oe.getSqrtPriceX64FromTick(l),[y,g]=[Te(m,(k=o.mintA.extensions)==null?void 0:k.feeConfig,a,!c),Te(d,(T=o.mintB.extensions)==null?void 0:T.feeConfig,a,!c)],P=Pe.getLiquidityFromTokenAmounts(p,b,f,y.amount.sub((I=y.fee)!=null?I:ge),g.amount.sub((h=g.fee)!=null?h:ge));return Pe.getAmountsOutFromLiquidity({poolInfo:o,tickLower:e,tickUpper:t,liquidity:P,slippage:r,add:s,epochInfo:a,amountAddFee:!c})}var Ea={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function al(o){return U(v({},o),{type:"Concentrated",programId:o.programId.toString(),id:o.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:o.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:o.ammConfig.tradeFeeRate,openTime:o.startTime.toString(),tvl:0,day:Ea,week:Ea,month:Ea,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:U(v({},o.ammConfig),{id:o.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var ue=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),r=i.div(n);return i.mod(n).eq(ge)||(r=r.add(Ot)),r}static mulDivFloor(e,t,n){if(n.eq(ge))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(ge))throw new Error("division by 0");return e.mul(t).add(n.sub(Ot)).div(n)}static x64ToDecimal(e,t){return new O(e.toString()).div(O.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new fe(e.mul(O.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(_r).sub(t).mod(_r)}};function mt(o,e){return _a(o.mul(e),64,256)}function Jf(o,e,t){let n=o.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function _a(o,e,t){let n=o.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var oe=class{static sqrtPriceX64ToPrice(e,t,n){return ue.x64ToDecimal(e).pow(2).mul(O.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ue.decimalToX64(e.mul(O.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(ge))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ge))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(ge))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ge))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(ge))return e;let r=t.shln(go);if(i){let s=r,a=r.add(n.mul(e));return a.gte(s)?ue.mulDivCeil(s,e,a):ue.mulDivRoundingUp(s,Ot,s.div(e).add(n))}else{let s=n.mul(e);if(!r.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=r.sub(s);return ue.mulDivCeil(r,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let r=n.shln(go);if(i)return e.add(r.div(t));{let s=ue.mulDivRoundingUp(r,Ot,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<Pt||e>Bt)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new fe("18445821805675395072"):new fe("18446744073709551616");return(t&2)!=0&&(n=mt(n,new fe("18444899583751176192"))),(t&4)!=0&&(n=mt(n,new fe("18443055278223355904"))),(t&8)!=0&&(n=mt(n,new fe("18439367220385607680"))),(t&16)!=0&&(n=mt(n,new fe("18431993317065453568"))),(t&32)!=0&&(n=mt(n,new fe("18417254355718170624"))),(t&64)!=0&&(n=mt(n,new fe("18387811781193609216"))),(t&128)!=0&&(n=mt(n,new fe("18329067761203558400"))),(t&256)!=0&&(n=mt(n,new fe("18212142134806163456"))),(t&512)!=0&&(n=mt(n,new fe("17980523815641700352"))),(t&1024)!=0&&(n=mt(n,new fe("17526086738831433728"))),(t&2048)!=0&&(n=mt(n,new fe("16651378430235570176"))),(t&4096)!=0&&(n=mt(n,new fe("15030750278694412288"))),(t&8192)!=0&&(n=mt(n,new fe("12247334978884435968"))),(t&16384)!=0&&(n=mt(n,new fe("8131365268886854656"))),(t&32768)!=0&&(n=mt(n,new fe("3584323654725218816"))),(t&65536)!=0&&(n=mt(n,new fe("696457651848324352"))),(t&131072)!=0&&(n=mt(n,new fe("26294789957507116"))),(t&262144)!=0&&(n=mt(n,new fe("37481735321082"))),e>0&&(n=zc.div(n)),n}static getTickFromPrice(e,t,n){return oe.getTickFromSqrtPriceX64(oe.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Ft)||e.lt(Vt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new fe(t-64),i=Jf(n,32,128),r=new fe("8000000000000000","hex"),s=0,a=new fe(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;r.gt(new fe(0))&&s<jc;){c=c.mul(c);let b=c.shrn(127);c=c.shrn(63+b.toNumber()),a=a.add(r.mul(b)),r=r.shrn(1),s+=1}let u=a.shrn(32),m=i.add(u).mul(new fe(Hc)),d=_a(m.sub(new fe(Yc)),64,128).toNumber(),p=_a(m.add(new fe(Zc)),64,128).toNumber();return d==p?d:oe.getSqrtPriceX64FromTick(p).lte(e)?p:d}},ii=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=oe.getTickFromSqrtPriceX64(oe.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let r=ii.getTickWithPriceAndTickspacing(e,t,n,i),s=oe.getSqrtPriceX64FromTick(r);return oe.sqrtPriceX64ToPrice(s,n,i)}},Pe=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ge))throw new Error("sqrtPriceX64A must greater than 0");let r=n.ushln(go),s=t.sub(e);return i?ue.mulDivRoundingUp(ue.mulDivCeil(r,s,t),Ot,e):ue.mulDivFloor(r,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ge))throw new Error("sqrtPriceX64A must greater than 0");return i?ue.mulDivCeil(n,t.sub(e),tt):ue.mulDivFloor(n,t.sub(e),tt)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let r=n.mul(e).mul(t),s=t.sub(e),a=r.div(s);return i?ue.mulDivRoundingUp(a,Ot,yo):a.shrn(go)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ue.mulDivFloor(n,yo,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return Pe.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=Pe.getLiquidityFromTokenAmountA(e,n,i,!1),a=Pe.getLiquidityFromTokenAmountB(t,e,r);return s.lt(a)?s:a}else return Pe.getLiquidityFromTokenAmountB(t,n,r)}static getAmountsFromLiquidity(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:Pe.getTokenAmountAFromLiquidity(t,n,i,r),amountB:new fe(0)};if(e.lt(n)){let s=Pe.getTokenAmountAFromLiquidity(e,n,i,r),a=Pe.getTokenAmountBFromLiquidity(t,e,i,r);return{amountA:s,amountB:a}}else return{amountA:new fe(0),amountB:Pe.getTokenAmountBFromLiquidity(t,n,i,r)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,r,s,a){let{amountA:c,amountB:u}=Pe.getAmountsFromLiquidity(e,t,n,i,s),l=r?1+a:1-a,m=new fe(new O(c.toString()).mul(l).toFixed(0)),d=new fe(new O(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:r,add:s,epochInfo:a,amountAddFee:c}){var P,k,T,I;let u=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),l=oe.getSqrtPriceX64FromTick(t),m=oe.getSqrtPriceX64FromTick(n),d=s?1+r:1-r,p=Pe.getAmountsFromLiquidity(u,l,m,i,s),[b,f]=[Te(p.amountA,(P=e.mintA.extensions)==null?void 0:P.feeConfig,a,c),Te(p.amountB,(k=e.mintB.extensions)==null?void 0:k.feeConfig,a,c)],[y,g]=[Te(new fe(new O(p.amountA.toString()).mul(d).toFixed(0)),(T=e.mintA.extensions)==null?void 0:T.feeConfig,a,c),Te(new fe(new O(p.amountB.toString()).mul(d).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,a,c)];return{liquidity:i,amountA:b,amountB:f,amountSlippageA:y,amountSlippageB:g,expirationTime:Ht(b.expirationTime,f.expirationTime)}}},ti=class{static swapCompute(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f=!1){if(d.eq(ge))throw new Error("amountSpecified must not be 0");if(b||(b=s?Vt.add(Ot):Ft.sub(Ot)),s){if(b.lt(Vt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(b.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(b.gt(Ft))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(b.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let y=d.gt(ge),g={amountSpecifiedRemaining:d,amountCalculated:ge,sqrtPriceX64:m,tick:u>p?Math.min(p+ke.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new fe(0)},P=p,k=n[p],T=0,I=!s&&k.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(ge)&&!g.sqrtPriceX64.eq(b);){T>10;let h={};h.sqrtPriceStartX64=g.sqrtPriceX64;let S=Z.nextInitTick(k,g.tick,l,s,I),x=S||null,K=null;if(!(x!=null&&x.liquidityGross.gtn(0))){let C=Ne.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:r},P,s);if(!C.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}P=C.nextStartIndex;let{publicKey:L}=Ae(e,t,P);K=L,k=n[P];try{x=Z.firstInitializedTick(k,s)}catch{throw Error("not found next tick info")}}h.tickNext=x.tick,h.initialized=x.liquidityGross.gtn(0),p!==P&&K&&(g.accounts.push(K),p=P),h.tickNext<Pt?h.tickNext=Pt:h.tickNext>Bt&&(h.tickNext=Bt),h.sqrtPriceNextX64=oe.getSqrtPriceX64FromTick(h.tickNext);let B;if(s&&h.sqrtPriceNextX64.lt(b)||!s&&h.sqrtPriceNextX64.gt(b)?B=b:B=h.sqrtPriceNextX64,[g.sqrtPriceX64,h.amountIn,h.amountOut,h.feeAmount]=ti.swapStepCompute(g.sqrtPriceX64,B,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(h.feeAmount),y?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(h.amountIn.add(h.feeAmount)),g.amountCalculated=g.amountCalculated.sub(h.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(h.amountOut),g.amountCalculated=g.amountCalculated.add(h.amountIn.add(h.feeAmount))),g.sqrtPriceX64.eq(h.sqrtPriceNextX64)){if(h.initialized){let C=x.liquidityNet;s&&(C=C.mul(hn)),g.liquidity=Pe.addDelta(g.liquidity,C)}I=h.tickNext!=g.tick&&!s&&k.startTickIndex===h.tickNext,g.tick=s?h.tickNext-1:h.tickNext}else if(g.sqrtPriceX64!=h.sqrtPriceStartX64){let C=oe.getTickFromSqrtPriceX64(g.sqrtPriceX64);I=C!=g.tick&&!s&&k.startTickIndex===C,g.tick=C}++T}try{let{nextStartIndex:h,isExist:S}=ke.nextInitializedTickArray(g.tick,l,s,i,r);S&&p!==h&&(g.accounts.push(Ae(e,t,h).publicKey),p=h)}catch{}return{allTrade:!0,amountSpecifiedRemaining:ge,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,r,s){let a={sqrtPriceX64Next:new fe(0),amountIn:new fe(0),amountOut:new fe(0),feeAmount:new fe(0)},c=i.gte(ge);if(c){let l=ue.mulDivFloor(i,Dr.sub(new fe(r.toString())),Dr);a.amountIn=s?Pe.getTokenAmountAFromLiquidity(t,e,n,!0):Pe.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=oe.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?Pe.getTokenAmountBFromLiquidity(t,e,n,!1):Pe.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(hn).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=oe.getNextSqrtPriceX64FromOutput(e,n,i.mul(hn),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=Pe.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=Pe.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:Pe.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:Pe.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(i.mul(hn))&&(a.amountOut=i.mul(hn)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=i.sub(a.amountIn):a.feeAmount=ue.mulDivCeil(a.amountIn,new fe(r),Dr.sub(new fe(r))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var st=60,ei=512,Z=class{static getTickArrayAddressByTick(e,t,n,i){let r=Z.getTickArrayStartIndexByTick(n,i),{publicKey:s}=Ae(e,t,r);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=Z.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=st)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=ke.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*ke.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*st,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*st,r=Math.floor(t/i)+512,s=Math.abs(r);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*st:e+t*st}static mergeTickArrayBitmap(e){let t=new eb(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,r){let s=Math.floor(i/(n*st));return[...Z.searchLowBitFromStart(e,t,s-1,r,n),...Z.searchHightBitFromStart(e,t,s,r,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return Z.searchHightBitFromStart(e,t,-7680,ei,n)}static getAllInitializedTickArrayInfo(e,t,n,i,r){let s=[],a=Z.getAllInitializedTickArrayStartIndex(n,i,r);for(let c of a){let{publicKey:u}=Ae(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>Z.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===i)break}let c=ke.tickCount(r);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>Z.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===i)break}let c=ke.tickCount(r);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<Pt||e>Bt}static nextInitTick(e,t,n,i,r){if(ke.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(r||(a=a+1);a<st;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=st-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<st;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=oe.getSqrtPriceX64FromTick(t),r=oe.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(r),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),r=ii.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=oe.getSqrtPriceX64FromTick(r),a=oe.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new O(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=oe.getSqrtPriceX64FromTick(t),r=oe.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(r),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),r=ii.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=oe.getSqrtPriceX64FromTick(r),a=oe.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new O(1).div(a)}}};var cl=E([Ie(8),q("bump"),$t("index"),N(""),pt("protocolFeeRate"),pt("tradeFeeRate"),$t("tickSpacing"),z(w(),8,"")]),tb=E([pt("blockTimestamp"),hi("tickCumulative"),z(w(),4)]),ll=E([Ie(8),De("initialized"),w("recentEpoch"),$t("observationIndex"),N("poolId"),z(tb,100,"observations"),z(w(),4)]),nb=E([q("rewardState"),w("openTime"),w("endTime"),w("lastUpdateTime"),te("emissionsPerSecondX64"),w("rewardTotalEmissioned"),w("rewardClaimed"),N("tokenMint"),N("tokenVault"),N("creator"),te("rewardGrowthGlobalX64")]),ni=E([Ie(8),q("bump"),N("ammConfig"),N("creator"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("observationId"),q("mintDecimalsA"),q("mintDecimalsB"),$t("tickSpacing"),te("liquidity"),te("sqrtPriceX64"),Ee("tickCurrent"),pt(),te("feeGrowthGlobalX64A"),te("feeGrowthGlobalX64B"),w("protocolFeesTokenA"),w("protocolFeesTokenB"),te("swapInAmountTokenA"),te("swapOutAmountTokenB"),te("swapInAmountTokenB"),te("swapOutAmountTokenA"),q("status"),z(q(),7,""),z(nb,3,"rewardInfos"),z(w(),16,"tickArrayBitmap"),w("totalFeesTokenA"),w("totalFeesClaimedTokenA"),w("totalFeesTokenB"),w("totalFeesClaimedTokenB"),w("fundFeesTokenA"),w("fundFeesTokenB"),w("startTime"),z(w(),15*4-3,"padding")]),ib=E([te("growthInsideLastX64"),w("rewardAmountOwed")]),Io=E([Ie(8),q("bump"),N("nftMint"),N("poolId"),Ee("tickLower"),Ee("tickUpper"),te("liquidity"),te("feeGrowthInsideLastX64A"),te("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),z(ib,3,"rewardInfos"),z(w(),8,"")]),YI=E([Ie(8),q("bump"),N("poolId"),Ee("tickLowerIndex"),Ee("tickUpperIndex"),te("liquidity"),te("feeGrowthInsideLastX64A"),te("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),z(te(),3,"rewardGrowthInside"),z(w(),8,"")]),ob=E([Ee("tick"),Ic("liquidityNet"),te("liquidityGross"),te("feeGrowthOutsideX64A"),te("feeGrowthOutsideX64B"),z(te(),3,"rewardGrowthsOutsideX64"),z(pt(),13,"")]),ho=E([Ie(8),N("poolId"),Ee("startTickIndex"),z(ob,st,"ticks"),q("initializedTickCount"),z(q(),115,"")]),ml=E([Ie(329),z(N(),100,"whitelistMints")]),ul=E([Ie(8),N("poolId"),z(z(w(),8),va,"positiveTickArrayBitmap"),z(z(w(),8),va,"negativeTickArrayBitmap")]),ZI=E([w(),q("bump"),N("owner"),N("poolId"),N("positionId"),N("nftAccount"),z(w(),8)]),$I=E([Ie(8),q("bump"),N("lockOwner"),N("poolId"),N("positionId"),N("nftAccount"),N("lockNftMint"),w("recentEpoch"),z(w(),8)]);ll.span;var dl=be("Raydium_Clmm"),vt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},pl=[188,37,179,131,82,150,84,73],fl=[16,72,250,198,14,162,212,19],Ke=class{static createPoolInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b){let f=E([te("sqrtPriceX64"),w("zero")]),y=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Bn.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},...(b==null?void 0:b.map(k=>({pubkey:k,isSigner:!1,isWritable:!1})))||[]],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,zero:ge},g);let P=Buffer.from([...vt.createPool,...g]);return new ft({keys:y,programId:e,data:P})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:r,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new Q(i.address),new Q(r.address)],{publicKey:m}=nl(t,s,u,l),{publicKey:d}=ol(t,m),{publicKey:p}=Na(t,m,u),{publicKey:b}=Na(t,m,l),f=je(t,m).publicKey,y=[this.createPoolInstruction(t,m,n,s,d,u,p,new Q(i.programId||Se),l,b,new Q(r.programId||Se),f,a,c)];return{signers:[],instructions:y,instructionTypes:[X.CreateAccount,X.ClmmCreatePool],address:{poolId:m,observationId:d,exBitmapAccount:f,mintAVault:p,mintBVault:b},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K,B){let C=E([Ee("tickLowerIndex"),Ee("tickUpperIndex"),Ee("tickArrayLowerStartIndex"),Ee("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),De("withMetadata"),q("optionBaseFlag"),De("baseFlag")]),L=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Bn.programId,isSigner:!1,isWritable:!1},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:Bo,isSigner:!1,isWritable:!1},{pubkey:Qt,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],D=Buffer.alloc(C.span);C.encode({tickLowerIndex:P,tickUpperIndex:k,tickArrayLowerStartIndex:T,tickArrayUpperStartIndex:I,liquidity:h,amountMaxA:S,amountMaxB:x,withMetadata:K==="create",baseFlag:!1,optionBaseFlag:0},D);let F=Buffer.from([...vt.openPosition,...D]);return new ft({keys:R,programId:e,data:F})}static openPositionFromLiquidityInstruction22(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K){let B=E([Ee("tickLowerIndex"),Ee("tickUpperIndex"),Ee("tickArrayLowerStartIndex"),Ee("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),De("withMetadata"),q("optionBaseFlag"),De("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Bn.programId,isSigner:!1,isWritable:!1},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:Bo,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...C],R=Buffer.alloc(B.span);B.encode({tickLowerIndex:g,tickUpperIndex:P,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:T,liquidity:I,amountMaxA:h,amountMaxB:S,withMetadata:x==="create",baseFlag:!1,optionBaseFlag:0},R);let D=Buffer.from([...vt.openPositionWithTokenEx,...R]);return new ft({keys:L,programId:e,data:D})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,b]=[new Q(e.programId),new Q(e.id)],f;if(l)f=new Q((await l(1))[0]);else{let K=Ur.generate();d.push(K),f=K.publicKey}let y=Z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Z.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:P}=Ae(p,b,y),{publicKey:k}=Ae(p,b,g),{publicKey:T}=m?ee(n.wallet,f,qe):ee(n.wallet,f,Se),{publicKey:I}=Tn(f),{publicKey:h}=xt(p,f),{publicKey:S}=en(p,b,i,r),x=m?this.openPositionFromLiquidityInstruction22(p,n.feePayer,b,n.wallet,f,T,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,r,y,g,s,a,c,u,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?je(p,b).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,b,n.wallet,f,T,I,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,r,y,g,s,a,c,u,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?je(p,b).publicKey:void 0);return{signers:d,instructions:[x],instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:P,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,b]=[new Q(e.programId),new Q(e.id)],f;if(l)f=new Q((await l(1))[0]);else{let K=Ur.generate();d.push(K),f=K.publicKey}let y=Z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Z.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:P}=Ae(p,b,y),{publicKey:k}=Ae(p,b,g),{publicKey:T}=m?ee(n.wallet,f,qe):ee(n.wallet,f,Se),{publicKey:I}=Tn(f),{publicKey:h}=xt(p,f),{publicKey:S}=en(p,b,i,r),x=m?this.openPositionFromBaseInstruction22(p,n.feePayer,b,n.wallet,f,T,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,r,y,g,u,s,a,c,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?je(p,b).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,b,n.wallet,f,T,I,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,r,y,g,u,s,a,c,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?je(p,b).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:P,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S},instructions:[x],signers:d,instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K,B){let C=E([Ee("tickLowerIndex"),Ee("tickUpperIndex"),Ee("tickArrayLowerStartIndex"),Ee("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),De("withMetadata"),q("optionBaseFlag"),De("baseFlag")]),L=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Bn.programId,isSigner:!1,isWritable:!1},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:Bo,isSigner:!1,isWritable:!1},{pubkey:Qt,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],D=Buffer.alloc(C.span);C.encode({tickLowerIndex:P,tickUpperIndex:k,tickArrayLowerStartIndex:T,tickArrayUpperStartIndex:I,liquidity:new Va(0),amountMaxA:S==="MintA"?x:K,amountMaxB:S==="MintA"?K:x,withMetadata:h==="create",baseFlag:S==="MintA",optionBaseFlag:1},D);let F=Buffer.from([...vt.openPosition,...D]);return new ft({keys:R,programId:e,data:F})}static openPositionFromBaseInstruction22(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K){let B=E([Ee("tickLowerIndex"),Ee("tickUpperIndex"),Ee("tickArrayLowerStartIndex"),Ee("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),De("withMetadata"),q("optionBaseFlag"),De("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Bn.programId,isSigner:!1,isWritable:!1},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:Bo,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...C],R=Buffer.alloc(B.span);B.encode({tickLowerIndex:g,tickUpperIndex:P,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:T,liquidity:new Va(0),amountMaxA:h==="MintA"?S:x,amountMaxB:h==="MintA"?x:S,withMetadata:I==="create",baseFlag:h==="MintA",optionBaseFlag:1},R);let D=Buffer.from([...vt.openPositionWithTokenEx,...R]);return new ft({keys:L,programId:e,data:D})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d,p=[];if(l)d=new Q((await l(1))[0]);else{let K=Ur.generate();p.push(K),d=K.publicKey}let[b,f]=[new Q(e.programId),new Q(e.id)],y=Z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Z.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:P}=Ae(b,f,y),{publicKey:k}=Ae(b,f,g),{publicKey:T}=m?ee(n.wallet,d,qe):ee(n.wallet,d,Se),{publicKey:I}=Tn(d),{publicKey:h}=xt(b,d),{publicKey:S}=en(b,f,i,r),x=m?this.openPositionFromLiquidityInstruction22(b,n.wallet,f,n.wallet,d,T,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(t.mintA.address),new Q(t.mintB.address),i,r,y,g,s,a,c,u,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?je(b,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(b,n.wallet,f,n.wallet,d,T,I,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(t.mintA.address),new Q(t.mintB.address),i,r,y,g,s,a,c,u,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?je(b,f).publicKey:void 0);return{address:{nftMint:d,tickArrayLower:P,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S},instructions:[x],signers:p,instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,r,s){let a=E([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Bn.programId,isSigner:!1,isWritable:!1},{pubkey:s?qe:Se,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...vt.closePosition,...u]);return new ft({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i,nft2022:r}){let s=new Q(e.programId),a=r?ee(n.wallet,i.nftMint,qe).publicKey:ee(n.wallet,i.nftMint,Se).publicKey,{publicKey:c}=xt(s,i.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,i.nftMint,a,c,r)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[X.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P){let k=E([te("liquidity"),w("amountMaxA"),w("amountMaxB"),q("optionBaseFlag"),De("baseFlag")]),T=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...T],h=Buffer.alloc(k.span);k.encode({liquidity:f,amountMaxA:y,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},h);let S=Buffer.from([...vt.increaseLiquidity,...h]);return new ft({keys:I,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new Q(e.programId),new Q(e.id)],m=Z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=Ae(u,l,m),{publicKey:b}=Ae(u,l,d),{publicKey:f}=c?ee(i.wallet,n.nftMint,qe):ee(i.wallet,n.nftMint,Se),{publicKey:y}=xt(u,n.nftMint),{publicKey:g}=en(u,l,n.tickLower,n.tickUpper),P=this.increasePositionFromLiquidityInstruction(u,i.wallet,f,y,l,g,p,b,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),r,s,a,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?je(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:b,positionNftAccount:f,personalPosition:y,protocolPosition:g},signers:[],instructions:[P],instructionTypes:[X.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:r,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new Q(e.programId),new Q(e.id)],m=Z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=Ae(u,l,m),{publicKey:b}=Ae(u,l,d),{publicKey:f}=c?ee(i.wallet,n.nftMint,qe):ee(i.wallet,n.nftMint,Se),{publicKey:y}=xt(u,n.nftMint),{publicKey:g}=en(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:b,positionNftAccount:f,personalPosition:y,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,f,y,l,g,p,b,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),r,s,a,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?je(u,l).publicKey:void 0)],signers:[],instructionTypes:[X.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P){let k=E([te("liquidity"),w("amountMaxA"),w("amountMaxB"),q("optionBaseFlag"),De("baseFlag")]),T=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...T],h=Buffer.alloc(k.span);k.encode({liquidity:new Va(0),amountMaxA:f==="MintA"?y:g,amountMaxB:f==="MintA"?g:y,baseFlag:f==="MintA",optionBaseFlag:1},h);let S=Buffer.from([...vt.increaseLiquidity,...h]);return new ft({keys:I,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k){let T=E([te("liquidity"),w("amountMinA"),w("amountMinB")]),I=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...f.map(K=>[{pubkey:K.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.rewardMint,isSigner:!1,isWritable:!1}]).flat()],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:lr,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...I],S=Buffer.alloc(T.span);T.encode({liquidity:y,amountMinA:g,amountMinB:P},S);let x=Buffer.from([...vt.decreaseLiquidity,...S]);return new ft({keys:h,programId:e,data:x})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],d=Z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=Z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:b}=Ae(l,m,d),{publicKey:f}=Ae(l,m,p),{publicKey:y}=u?ee(i.wallet,n.nftMint,qe):ee(i.wallet,n.nftMint,c),{publicKey:g}=xt(l,n.nftMint),{publicKey:P}=en(l,m,n.tickLower,n.tickUpper),k=[];for(let h=0;h<e.rewardDefaultInfos.length;h++)k.push({poolRewardVault:new Q(t.rewardInfos[h].vault),ownerRewardVault:i.rewardAccounts[h],rewardMint:new Q(e.rewardDefaultInfos[h].mint.address)});let T=[],I=this.decreaseLiquidityInstruction(l,i.wallet,y,g,m,P,b,f,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),k,r,s,a,Ne.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,p])?je(l,m).publicKey:void 0);return T.push(I),{address:{tickArrayLower:b,tickArrayUpper:f,positionNftAccount:y,personalPosition:g,protocolPosition:P},signers:[],instructions:T,instructionTypes:[X.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amount"),w("otherAmountThreshold"),te("sqrtPriceLimitX64"),De("isBaseInput")]),k=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:lr,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],I=Buffer.alloc(P.span);P.encode({amount:p,otherAmountThreshold:b,sqrtPriceLimitX64:f,isBaseInput:y},I);let h=Buffer.from([...vt.swap,...I]);return new ft({keys:T,programId:e,data:h})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:r,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],[d,p]=[new Q(t.vault.A),new Q(t.vault.B)],[b,f]=[new Q(e.mintA.address),new Q(e.mintB.address)],y=e.mintA.address===r.toString(),g=[this.swapInstruction(l,i.wallet,m,new Q(e.config.id),y?i.tokenAccountA:i.tokenAccountB,y?i.tokenAccountB:i.tokenAccountA,y?d:p,y?p:d,y?b:f,y?f:b,u,n,s,a,c,!0,je(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[X.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:r,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],[d,p]=[new Q(t.vault.A),new Q(t.vault.B)],[b,f]=[new Q(e.mintA.address),new Q(e.mintB.address)],y=e.mintA.address===r.toBase58(),g=[this.swapInstruction(l,i.wallet,m,new Q(e.config.id),y?i.tokenAccountB:i.tokenAccountA,y?i.tokenAccountA:i.tokenAccountB,y?p:d,y?d:p,y?f:b,y?b:f,u,n,s,a,c,!1,je(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[X.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,r,s,a,c,u,l,m,d){let p=E([w("openTime"),w("endTime"),te("emissionsPerSecondX64")]),b=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Bn.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:J(l),endTime:J(m),emissionsPerSecondX64:d},f);let y=Buffer.from([...vt.initReward,...f]);return new ft({keys:b,programId:e,data:y})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new Q(e.programId),new Q(e.id)],a=il(r,s,i.mint).publicKey,c=Po(r).publicKey,u=[this.initRewardInstruction(r,n.wallet,s,c,new Q(e.config.id),n.tokenAccount,i.programId,i.mint,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[X.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,r,s,a,c,u,l,m,d){let p=E([q("rewardIndex"),te("emissionsPerSecondX64"),w("openTime"),w("endTime")]),b=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:J(l),endTime:J(m)},f);let y=Buffer.from([...vt.setRewardEmissions,...f]);return new ft({keys:b,programId:e,data:y})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new Q(e.programId),new Q(e.id)],a,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===i.mint.toString()&&(a=d,c=new Q(t.rewardInfos[d].vault),u=new Q(t.rewardInfos[d].mint.address));(a===void 0||c===void 0)&&dl.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=Po(r).publicKey,m=[this.setRewardInstruction(r,n.wallet,s,l,new Q(e.config.id),n.tokenAccount,c,u,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[X.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,r,s,a){let c=E([q("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:lr,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let m=Buffer.from([...vt.collectReward,...l]);return new ft({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[r,s]=[new Q(e.programId),new Q(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(a=l,c=new Q(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&dl.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(r,n.wallet,s,n.tokenAccount,c,i,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[X.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:r,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new Q((await c(1))[0]);else{let g=Ur.generate();u.push(g),l=g.publicKey}let m=a?ee(r,s,qe).publicKey:ee(r,s,Se).publicKey,{publicKey:d}=xt(n,s),p=wo(e,l).publicKey,b=ee(r,l,Se).publicKey,f=Tn(l).publicKey,y=Ke.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:r,lockOwner:r,positionNftAccount:m,positionId:d,lockPositionId:p,lockNftMint:l,lockNftAccount:b,metadataAccount:f,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:ee(t,s,a?qe:Se).publicKey,positionNftProgram:a?qe:Se});return{address:{positionId:d,lockPositionId:p,lockNftAccount:b,lockNftMint:l,positionNftAccount:m,metadataAccount:f},instructions:[y],signers:u,instructionTypes:[X.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:r,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:m,lockNftMint:d,lockNftAccount:p,metadataAccount:b,withMetadata:f}){let y=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Qt,isSigner:!1,isWritable:!1},{pubkey:Bo,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:Bn.programId,isSigner:!1,isWritable:!1}],g=E([De("withMetadata")]),P=Buffer.alloc(g.span);g.encode({withMetadata:f},P);let k=Buffer.from([...pl,...P]);return new ft({keys:y,programId:e,data:k})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:r}){let{publicKey:s}=ee(i,r,Se),{publicKey:a}=xt(n,r),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Oa(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:Bn.programId,isSigner:!1,isWritable:!1}];return new ft({keys:c,programId:e,data:Buffer.from(pl)})}static harvestLockPositionInstruction(e){let[t,n]=[new Q(e.poolKeys.programId),new Q(e.poolKeys.id)],i=Z.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),r=Z.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=Ae(t,n,i),{publicKey:a}=Ae(t,n,r),{publicKey:c}=ee(e.owner,e.ownerPosition.nftMint,Se),{publicKey:u}=xt(t,e.ownerPosition.nftMint),{publicKey:l}=en(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let b=0;b<e.poolKeys.rewardInfos.length;b++)m.push({poolRewardVault:new Q(e.poolKeys.rewardInfos[b].vault),ownerRewardVault:e.ownerRewardAccounts[b],rewardMint:new Q(e.poolKeys.rewardInfos[b].mint.address)});let d=[...m.map(b=>[{pubkey:b.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:b.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:b.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Oa(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new Q(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new Q(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1},{pubkey:new Q(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new Q(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new ft({keys:p,programId:e.programId,data:Buffer.from(fl)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:r,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:m,vaultA:d,vaultB:p,tickArrayLower:b,tickArrayUpper:f,userVaultA:y,userVaultB:g,mintA:P,mintB:k,rewardAccounts:T,exTickArrayBitmap:I}){let h=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[],...T.map(x=>[{pubkey:x.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.rewardMint,isSigner:!1,isWritable:!1}]).flat()],S=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:Se,isSigner:!1,isWritable:!1},{pubkey:qe,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1},{pubkey:P,isSigner:!1,isWritable:!1},{pubkey:k,isSigner:!1,isWritable:!1},...h];return new ft({keys:S,programId:e,data:Buffer.from(fl)})}};var bl=E([pt("mintAuthorityOption"),N("mintAuthority"),w("supply"),q("decimals"),q("isInitialized"),pt("freezeAuthorityOption"),N("freezeAuthority")]);import{PublicKey as rb}from"@solana/web3.js";import{MintLayout as yl,TOKEN_PROGRAM_ID as sb}from"@solana/spl-token";var BB=async({connection:o,mint:e})=>{let t=await o.getAccountInfo(new rb(e));return!t||t.data.length!==yl.span?void 0:yl.decode(t.data)},xB=({mint:o,decimals:e,programId:t=sb,logoURI:n="",priority:i=3})=>{let r=o.toBase58().substring(0,6);return{address:o.toBase58(),decimals:e,symbol:r,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:r,tags:[],priority:i}},Gr=o=>new Be({mint:o.address,decimals:o.decimals,symbol:o.symbol,name:o.name}),xo=i=>{var r=i,{amount:o,isRaw:e,name:t}=r,n=We(r,["amount","isRaw","name"]);return new he(new Be({mint:yt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),o,e,t)};function SB(o){return o.address===sn.address?at:o}function KB(o){return o.address===at.address?sn:o}var wt=i=>{var r=i,{address:o,programId:e,decimals:t}=r,n=We(r,["address","programId","decimals"]);return v({chainId:101,address:yt(o).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},qn=o=>o?U(v({},o),{transferFeeConfigAuthority:o.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:o.withdrawWithheldAuthority.toBase58(),withheldAmount:o.withheldAmount.toString(),olderTransferFee:U(v({},o.olderTransferFee),{epoch:o.olderTransferFee.epoch.toString(),maximumFee:o.olderTransferFee.maximumFee.toString()}),newerTransferFee:U(v({},o.newerTransferFee),{epoch:o.newerTransferFee.epoch.toString(),maximumFee:o.newerTransferFee.maximumFee.toString()})}):void 0;import gl from"bn.js";var Fa=new gl(25),Xr=new gl(1e4),ab={4:3,5:3};import{PublicKey as Le,SystemProgram as Bl,SYSVAR_RENT_PUBKEY as kb,TransactionInstruction as xn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as hb,TOKEN_PROGRAM_ID as Ci}from"@solana/spl-token";var Da=E([q("instruction"),w("amountIn"),w("minAmountOut")]),Wa=E([q("instruction"),w("maxAmountIn"),w("amountOut")]),FB=E([q("instruction"),q("nonce")]),qa=E([q("instruction"),q("nonce"),w("startTime")]),oi=E([w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalValue"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),te("swapBaseInAmount"),te("swapQuoteOutAmount"),w("swapBase2QuoteFee"),te("swapQuoteInAmount"),te("swapBaseOutAmount"),w("swapQuote2BaseFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("withdrawQueue"),N("lpVault"),N("owner"),w("lpReserve"),z(w(),3,"padding")]),ub=E([w("accountType"),w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalsValue"),w("abortTradeFactor"),w("priceTickMultiplier"),w("priceTick"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),te("swapBaseInAmount"),te("swapQuoteOutAmount"),te("swapQuoteInAmount"),te("swapBaseOutAmount"),w("swapQuote2BaseFee"),w("swapBase2QuoteFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("modelDataAccount"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("owner"),z(w(),64,"padding")]),Ua=E([q("instruction"),w("baseAmountIn"),w("quoteAmountIn"),w("fixedSide"),w("otherAmountMin")]),Ga=E([q("instruction"),w("lpAmount"),w("baseAmountMin"),w("quoteAmountMin")]),DB={4:oi,5:ub},Al=E([w("fee")]);import{PublicKey as cb}from"@solana/web3.js";var Ki=new cb("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),si=5e4,lb=E([w("x"),w("y"),w("price")]),mb=E([w("accountType"),w("status"),w("multiplier"),w("validDataCount"),z(lb,si,"DataElement")]);function db(o,e){return[0,si-2]}function pb(o){return[0,si-2]}function fb(o){return[0,si-2]}function bb(o,e,t){let[n,i]=db(e,t),r=n,s=i,a=0,c=e*o.multiplier/t;for(;r<=s;){if(a=Math.floor((s+r)/2),a===0||a>=si-2)return[a,a,!1];let u=o.DataElement[a].x*o.multiplier/o.DataElement[a].y,l=o.DataElement[a-1].x*o.multiplier/o.DataElement[a-1].y,m=o.DataElement[a+1].x*o.multiplier/o.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===m)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<m)return[a,a+1,!0];r=a+1}}return[a,a,!1]}function Xa(o,e,t){let[n,i,r]=bb(o,e,t);if(!r)return 0;if(n===i){let s=o.DataElement[n].x;return e*o.multiplier/s}else{let s=o.DataElement[n].x,a=o.DataElement[n].y,c=o.DataElement[i].x,u=o.DataElement[i].y,l=t*(c*a-s*u),m=s*l,d=(c-s)*(e*a-s*t)*u,p=m+d;return e*o.multiplier*l/p}}function ri(o,e,t){return e*o.multiplier/t}function Pl(o,e,t){return e*t/o.multiplier}function yb(o,e){let[t,n]=pb(e),i=t,r=n,s=0,a=e;for(;i<r;){if(s=Math.floor((r+i)/2),s<=0||s>si-2)return[s,s,!1];let c=o.DataElement[s].x,u=o.DataElement[s-1].x,l=o.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)r=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];i=s+1}}return[s,s,!1]}function gb(o,e){let[t,n]=fb(e),i=t,r=n,s=0,a=e;for(;i<=r;){if(s=Math.floor((r+i)/2),s<=0||s>=si-2)return[s,s,!1];let c=o.DataElement[s].y,u=o.DataElement[s-1].y,l=o.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)i=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];r=s-1}}return[s,s,!1]}function wl(o,e,t,n){let i=n?e+t:e-t,[r,s,a]=yb(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].y,!1,a];{let c=o.DataElement[r].x,u=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=c&&e<=u)return n?[m,p,!0,a]:[l,d,!0,a];{let b,f;return n?(b=l+(m-l)*(e-c)/(u-c),f=d-(i-c)*o.multiplier/m):(b=l+(m-l)*(e-c)/(u-c),f=p+(u-i)*o.multiplier/l),[b,f,!1,a]}}}function Ab(o,e,t,n){let i=n?e-t:e+t,[r,s,a]=gb(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].x,!1,a];{let c=o.DataElement[r].x,u=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=p&&e<=d)return n?[m,u,!0,a]:[l,c,!0,a];{let b,f;return n?(b=l+(m-l)*(d-e)/(d-p),f=c+m*(d-i)/o.multiplier):(b=l+(m-l)*(d-e)/(d-p),f=u-l*(i-p)/o.multiplier),[b,f,!1,a]}}}function Pb(o,e){let t=wl(o,e,0,!1);return t[3]?t[0]:0}function kl(o,e,t,n){let i=Xa(o,e,t),r=ri(o,e,i),s=ri(o,t,i),a=ri(o,n,i),c=!0,[u,l,m,d]=wl(o,r,a,c);if(!d)return 0;if(m)return n*o.multiplier/u;{let p=s-l;return Pl(o,p,i)}}function hl(o,e,t,n){let i=Xa(o,e,t),r=ri(o,e,i),s=ri(o,t,i),a=ri(o,n,i),c=!1,[u,l,m,d]=Ab(o,s,a,c);if(!d)return 0;if(m)return n*u/o.multiplier;{let p=r-l;return Pl(o,p,i)}}function wb(o){let e=mb.decode(o);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Tl(o,e,t,n){let i=Pb(o,ri(o,e,Xa(o,e,t)))/o.multiplier;return n?i:1/i}var Si=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Ki);e&&(this._layoutData=wb(e==null?void 0:e.data))}}};var Il=be("Raydium_liquidity_instruction");function xl(o){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:r,fixedSide:s,otherAmountMin:a}=o,c=Buffer.alloc(Ua.span);Ua.encode({instruction:3,baseAmountIn:J(i),quoteAmountIn:J(r),otherAmountMin:J(a),fixedSide:s==="base"?$e:Uu},c);let u=[A({pubkey:Ci,isWritable:!1}),A({pubkey:new Le(e.id)}),A({pubkey:new Le(t.authority),isWritable:!1}),A({pubkey:new Le(t.openOrders),isWritable:!1}),A({pubkey:new Le(t.targetOrders)}),A({pubkey:new Le(e.lpMint.address)}),A({pubkey:new Le(t.vault.A)}),A({pubkey:new Le(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(A({pubkey:Ki})),u.push(A({pubkey:new Le(e.marketId),isWritable:!1}),A({pubkey:n.baseTokenAccount}),A({pubkey:n.quoteTokenAccount}),A({pubkey:n.lpTokenAccount}),A({pubkey:n.owner,isWritable:!1,isSigner:!0}),A({pubkey:new Le(t.marketEventQueue),isWritable:!1})),new xn({programId:new Le(e.programId),keys:u,data:c})}function Qa(o){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:i,baseAmountMin:r,quoteAmountMin:s}=o,a=Me(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(Ga.span);Ga.encode({instruction:4,lpAmount:J(i),baseAmountMin:J(r),quoteAmountMin:J(s)},u);let l=[A({pubkey:Ci,isWritable:!1}),A({pubkey:a.id}),A({pubkey:a.authority,isWritable:!1}),A({pubkey:a.openOrders}),A({pubkey:a.targetOrders}),A({pubkey:a.mintLp.address}),A({pubkey:a.vault.A}),A({pubkey:a.vault.B})];return c===5?l.push(A({pubkey:Ki})):(l.push(A({pubkey:a.id})),l.push(A({pubkey:a.id}))),l.push(A({pubkey:a.marketProgramId,isWritable:!1}),A({pubkey:a.marketId}),A({pubkey:a.marketBaseVault}),A({pubkey:a.marketQuoteVault}),A({pubkey:a.marketAuthority,isWritable:!1}),A({pubkey:n.lpTokenAccount}),A({pubkey:n.baseTokenAccount}),A({pubkey:n.quoteTokenAccount}),A({pubkey:n.owner,isWritable:!1,isSigner:!0}),A({pubkey:a.marketEventQueue}),A({pubkey:a.marketBids}),A({pubkey:a.marketAsks})),new xn({programId:a.programId,keys:l,data:u})}return new xn({programId:a.programId,keys:[]})}function za({programId:o,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:r,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:b,userCoinVault:f,userPcVault:y,userLpVault:g,nonce:P,openTime:k,coinAmount:T,pcAmount:I,ammConfigId:h,feeDestinationId:S}){let x=E([q("instruction"),q("nonce"),w("openTime"),w("pcAmount"),w("coinAmount")]),K=[{pubkey:Ci,isSigner:!1,isWritable:!1},{pubkey:hb,isSigner:!1,isWritable:!1},{pubkey:Bl.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:h,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],B=Buffer.alloc(x.span);return x.encode({instruction:1,nonce:P,openTime:k,coinAmount:T,pcAmount:I},B),{instruction:new xn({keys:K,programId:o,data:B}),instructionType:X.AmmV4CreatePool}}function nx(o){let e=E([q("instruction"),q("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[A({pubkey:new Le(o.id),isWritable:!1}),A({pubkey:new Le(o.authority),isWritable:!1}),A({pubkey:new Le(o.openOrders),isWritable:!1}),A({pubkey:new Le(o.vault.A),isWritable:!1}),A({pubkey:new Le(o.vault.B),isWritable:!1}),A({pubkey:new Le(o.mintLp.address),isWritable:!1}),A({pubkey:new Le(o.marketId),isWritable:!1}),A({pubkey:new Le(o.marketEventQueue),isWritable:!1})];return new xn({programId:new Le(o.programId),keys:n,data:t})}function Tb({poolKeys:o,userKeys:e,amountIn:t,minAmountOut:n},i){let r=Me(o),s=Buffer.alloc(Da.span);Da.encode({instruction:9,amountIn:J(t),minAmountOut:J(n)},s);let a=[A({pubkey:Ci,isWritable:!1}),A({pubkey:r.id}),A({pubkey:r.authority,isWritable:!1}),A({pubkey:r.openOrders})];return i===4&&a.push(A({pubkey:r.targetOrders})),a.push(A({pubkey:r.vault.A}),A({pubkey:r.vault.B})),i===5&&a.push(A({pubkey:Ki})),a.push(A({pubkey:r.marketProgramId,isWritable:!1}),A({pubkey:r.marketId}),A({pubkey:r.marketBids}),A({pubkey:r.marketAsks}),A({pubkey:r.marketEventQueue}),A({pubkey:r.marketBaseVault}),A({pubkey:r.marketQuoteVault}),A({pubkey:r.marketAuthority,isWritable:!1}),A({pubkey:e.tokenAccountIn}),A({pubkey:e.tokenAccountOut}),A({pubkey:e.owner,isWritable:!1,isSigner:!0})),new xn({programId:r.programId,keys:a,data:s})}function Ib({poolKeys:o,userKeys:e,maxAmountIn:t,amountOut:n},i){let r=Me(o),s=Buffer.alloc(Wa.span);Wa.encode({instruction:11,maxAmountIn:J(t),amountOut:J(n)},s);let a=[A({pubkey:Ci,isWritable:!1}),A({pubkey:r.id}),A({pubkey:r.authority,isWritable:!1}),A({pubkey:r.openOrders}),A({pubkey:r.targetOrders}),A({pubkey:r.vault.A}),A({pubkey:r.vault.B})];return i===5&&a.push(A({pubkey:Ki})),a.push(A({pubkey:r.marketProgramId,isWritable:!1}),A({pubkey:r.marketId}),A({pubkey:r.marketBids}),A({pubkey:r.marketAsks}),A({pubkey:r.marketEventQueue}),A({pubkey:r.marketBaseVault}),A({pubkey:r.marketQuoteVault}),A({pubkey:r.marketAuthority,isWritable:!1}),A({pubkey:e.tokenAccountIn}),A({pubkey:e.tokenAccountOut}),A({pubkey:e.owner,isWritable:!1,isSigner:!0})),new xn({programId:r.programId,keys:a,data:s})}function Qr(o){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:r,fixedSide:s}=o;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return Tb(U(v({},a),{amountIn:i,minAmountOut:r}),t);if(s==="out")return Ib(U(v({},a),{maxAmountIn:i,amountOut:r}),t);Il.logWithError("invalid params","params",o)}throw Il.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function ix({poolKeys:o,userKeys:e,startTime:t}){let n=Buffer.alloc(qa.span);qa.encode({instruction:0,nonce:5,startTime:J(t)},n);let i=Me(o),r=[A({pubkey:Ci,isWritable:!1}),A({pubkey:Bl.programId,isWritable:!1}),A({pubkey:kb,isWritable:!1}),A({pubkey:i.id}),A({pubkey:i.authority,isWritable:!1}),A({pubkey:i.openOrders}),A({pubkey:i.mintLp.address}),A({pubkey:i.mintA.address,isWritable:!1}),A({pubkey:i.mintB.address,isWritable:!1}),A({pubkey:i.vault.A,isWritable:!1}),A({pubkey:i.vault.B,isWritable:!1}),A({pubkey:i.id}),A({pubkey:i.targetOrders}),A({pubkey:e.lpTokenAccount}),A({pubkey:i.id,isWritable:!1}),A({pubkey:i.marketProgramId,isWritable:!1}),A({pubkey:i.marketId,isWritable:!1}),A({pubkey:e.payer,isSigner:!0})];return new xn({programId:i.programId,keys:r,data:n})}function Sl({poolKeys:o}){let e=E([q("instruction"),q("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[A({pubkey:new Le(o.id),isWritable:!1}),A({pubkey:new Le(o.authority),isWritable:!1}),A({pubkey:new Le(o.openOrders),isWritable:!1}),A({pubkey:new Le(o.vault.A),isWritable:!1}),A({pubkey:new Le(o.vault.B),isWritable:!1}),A({pubkey:new Le(o.mintLp.address),isWritable:!1}),A({pubkey:new Le(o.marketId),isWritable:!1}),A({pubkey:new Le(o.marketEventQueue),isWritable:!1})];return{instruction:new xn({programId:new Le(o.programId),keys:n,data:t})}}import{PublicKey as Ko}from"@solana/web3.js";import So from"bn.js";import{TOKEN_PROGRAM_ID as Sb}from"@solana/spl-token";import{PublicKey as Bb}from"@solana/web3.js";var xb=be("Raydium_liquidity_serum");function Kl({programId:o,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let r=t.concat(Buffer.from([n]),Buffer.alloc(7));i=Bb.createProgramAddressSync(r,o)}catch(r){if(r instanceof TypeError)throw r;n++;continue}return{publicKey:i,nonce:n}}throw xb.logWithError("unable to find a viable program address nonce","params",{programId:o,marketId:e}),new Error("unable to find a viable program address nonce")}function zr({programId:o}){let{publicKey:e}=ie([Buffer.from("amm_config_account_seed","utf-8")],o);return e}function ai({name:o,programId:e,marketId:t}){let{publicKey:n}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(o,"utf-8")],e);return n}function Kb({programId:o,marketId:e}){let{publicKey:t}=ie([o.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],o);return t}function Ya({programId:o}){return ie([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],o)}function Za({version:o,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:r,quoteDecimals:s,programId:a,marketProgramId:c}){let u=ai({name:"amm_associated_seed",programId:a,marketId:t}),l=ai({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=Ya({programId:a}),p=ai({name:"coin_vault_associated_seed",programId:a,marketId:t}),b=ai({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=ai({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),y=Kb({programId:a,marketId:t}),g=ai({name:"target_associated_seed",programId:a,marketId:t}),P=ai({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:k}=Kl({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:r,quoteDecimals:s,lpDecimals:r,version:o,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:b,lpVault:f,openOrders:y,targetOrders:g,withdrawQueue:P,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:k,lookupTableAccount:Ko.default,configId:zr({programId:a})}}var ja;async function Sx({connection:o,poolKeysList:e,config:t}){return e.find(i=>i.modelDataAccount)&&(ja||(ja=new Si({connection:o}),await ja.initStableModelLayout())),await Promise.all(e.map(async i=>{if(i.modelDataAccount){let r=Sl({poolKeys:i});return(await Ju(o,[r.instruction],"GetPoolData")).map(c=>{let u=ec(c,"GetPoolData"),l=new So(An(u,"status")),m=Number(An(u,"coin_decimals")),d=Number(An(u,"pc_decimals")),p=Number(An(u,"lp_decimals")),b=new So(An(u,"pool_coin_amount")),f=new So(An(u,"pool_pc_amount")),y=new So(An(u,"pool_lp_supply")),g="0";try{g=An(u,"pool_open_time")}catch{}return{status:l,baseDecimals:m,quoteDecimals:d,lpDecimals:p,baseReserve:b,quoteReserve:f,lpSupply:y,startTime:new So(g)}})[0]}else{let[r,s,a,c]=await o.getMultipleAccountsInfo([new Ko(i.id),new Ko(i.vault.A),new Ko(i.vault.B),new Ko(i.mintLp.address)]);if(r===null)throw Error("fetch pool error");if(s===null)throw Error("fetch vaultAccA error");if(a===null)throw Error("fetch vaultAccB error");if(c===null)throw Error("fetch mintAccLp error");let u=oi.decode(r.data),l=Jt.decode(s.data),m=Jt.decode(a.data),d=bl.decode(c.data);return{status:u.status,baseDecimals:u.baseDecimal.toNumber(),quoteDecimals:u.quoteDecimal.toNumber(),lpDecimals:d.decimals,baseReserve:l.amount.sub(u.baseNeedTakePnl),quoteReserve:m.amount.sub(u.quoteNeedTakePnl),lpSupply:u.lpReserve,startTime:u.poolOpenTime}}}))}var Ha={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},jr=o=>{let e={},t=Sb.toBase58();return Object.keys(o).map(n=>{let i=o[n],[r,s]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:wt({address:r,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:wt({address:s,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new O(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new O(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new O(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:Ha,week:Ha,month:Ha,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:zr({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:new O(i.lpReserve.toString()).div(10**Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())).toNumber(),lpMint:wt({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};import Ue from"bn.js";import{PublicKey as Co}from"@solana/web3.js";import Lo from"bn.js";import{TOKEN_PROGRAM_ID as Nl}from"@solana/spl-token";import{SystemProgram as ui,SYSVAR_RENT_PUBKEY as Lb,Transaction as Cl,TransactionInstruction as Rb}from"@solana/web3.js";import{createInitializeAccountInstruction as Ll,TOKEN_PROGRAM_ID as Rl}from"@solana/spl-token";function Cb(o="accountFlags"){let e=new Mr(o);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var $a=E([Ie(5),Cb("accountFlags"),N("ownAddress"),w("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),N("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),Ie(7)]);function Nb({programId:o,marketInfo:e}){let t=E([q("version"),pt("instruction"),w("baseLotSize"),w("quoteLotSize"),$t("feeRateBps"),w("vaultSignerNonce"),w("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Lb,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new Rb({keys:n,programId:o,data:i})}async function Hr({connection:o,wallet:e,marketInfo:t}){var s,a,c,u,l,m,d,p;let n=new Cl,i=await o.getMinimumBalanceForRentExemption(165);n.add(ui.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:Rl}),ui.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:Rl}),Ll(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Ll(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),ui.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await o.getMinimumBalanceForRentExemption($a.span),space:$a.span,programId:t.programId}));let r=new Cl;return r.add(ui.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await o.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:t.lowestFeeMarket?764:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),ui.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await o.getMinimumBalanceForRentExemption((c=t.eventQueueSpace)!=null?c:262144+12),space:t.lowestFeeMarket?11308:(u=t.eventQueueSpace)!=null?u:262144+12,programId:t.programId}),ui.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await o.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:t.lowestFeeMarket?14524:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),ui.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await o.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:t.lowestFeeMarket?14524:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),Nb({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[X.CreateAccount,X.CreateAccount,X.InitAccount,X.InitAccount]},{transaction:r,signer:[],instructionTypes:[X.CreateAccount,X.CreateAccount,X.CreateAccount,X.CreateAccount,X.CreateAccount,X.InitMarket]}]}var Li=class extends ve{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:i,dexProgramId:r,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:b}){let f=this.scope.ownerPubKey,y=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=ze({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-market`}),P=ze({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-request`}),k=ze({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-event`}),T=ze({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-bids`}),I=ze({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-asks`}),h=ze({fromPublicKey:f,programId:Nl,assignSeed:y&&`${y}-baseVault`}),S=ze({fromPublicKey:f,programId:Nl,assignSeed:y&&`${y}-quoteVault`}),x=0,K=new Lo(100);function B(){let Y=new Lo(0);for(;;)try{return{vaultOwner:Co.createProgramAddressSync([g.publicKey.toBuffer(),Y.toArrayLike(Buffer,"le",8)],r),vaultSignerNonce:Y}}catch{if(Y.iaddn(1),Y.gt(new Lo(25555)))throw Error("find vault owner error")}}let{vaultOwner:C,vaultSignerNonce:L}=B(),R=new Lo(Math.round(10**e.decimals*n)),D=new Lo(Math.round(n*10**t.decimals*i));if(R.eq($e))throw Error("lot size is too small");if(D.eq($e))throw Error("tick size or lot size is too small");let F=await Hr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:r,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:h,quoteVault:S,vaultOwner:C,requestQueue:P,eventQueue:k,bids:T,asks:I,feeRateBps:x,quoteDustThreshold:K,vaultSignerNonce:L,baseLotSize:R,quoteLotSize:D,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),W=this.createTxBuilder(b);W.addInstruction({instructions:F[0].transaction.instructions,signers:F[0].signer});for await(let Y of F.slice(1,F.length))W.addInstruction({instructions:Y.transaction.instructions,signers:Y.signer,instructionTypes:Y.instructionTypes});return m===0?W.sizeCheckBuildV0({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:P.publicKey,eventQueue:k.publicKey,bids:T.publicKey,asks:I.publicKey,baseVault:h.publicKey,quoteVault:S.publicKey,baseMint:new Co(e.mint),quoteMint:new Co(t.mint)}}):W.sizeCheckBuild({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:P.publicKey,eventQueue:k.publicKey,bids:T.publicKey,asks:I.publicKey,baseVault:h.publicKey,quoteVault:S.publicKey,baseMint:new Co(e.mint),quoteMint:new Co(t.mint)}})}};var Ro=class extends ve{constructor(t){super(t);this.stableLayout=new Si({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:i,baseIn:r}){let s=new Ue(new O(n).mul(10**t[r?"mintA":"mintB"].decimals).toFixed(0)),a=Gr(t[r?"mintB":"mintA"]),[c,u]=[new Ue(new O(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new Ue(new O(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new Ue(new O(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",c.toString(),"quoteReserve:",u.toString()),this.logDebug("tokenIn:",r?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",r?t.mintB.symbol:t.mintA.symbol,"slippage:",`${i.toSignificant()}%`,"baseReserve",c.toString(),"quoteReserve",u.toString());let m=r?"base":"quote";this.logDebug("input side:",m);let d=$e;s.isZero()||(d=m==="base"?pr(s.mul(u),c):pr(s.mul(c),u)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=pr(s.mul(l),m==="base"?c:u);this.logDebug("liquidity:",p.toString());let b=new Xe(new Ue(1)).add(i),f=new Xe(new Ue(1)).sub(i),y=b.mul(d).quotient,g=f.mul(d).quotient,P=new he(a,d),k=new he(a,y),T=new he(a,g);return this.logDebug("anotherAmount:",P.toFixed(),"maxAnotherAmount:",k.toFixed()),{anotherAmount:P,maxAnotherAmount:k,minAnotherAmount:T,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:i,amountInA:r,amountInB:s,otherAmountMin:a,fixedSide:c,config:u,txVersion:l,computeBudgetConfig:m,txTipConfig:d,feePayer:p}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",r,"amountInB:",s),(r.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:s.toFixed()});let{account:b}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:y}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),[g,P]=[r.token,s.token],k=await b.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1}),T=await b.getCreatedTokenAccount({mint:P.mint,associatedOnly:!1});!k&&!T&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",b.tokenAccounts);let I=await b.getCreatedTokenAccount({mint:new Je(n.lpMint.address)}),h=[g,P],S=[k,T],x=[r.raw,s.raw],K=r.token.mint.toBase58()===n.mintA.address?"base":"quote",B="base";["quote","base"].includes(K)||this.logAndCreateError("invalid fixedSide","fixedSide",c),K==="quote"?(h.reverse(),S.reverse(),x.reverse(),B=c==="a"?"quote":"base"):K==="base"&&(B=c==="a"?"base":"quote");let[C,L]=h,[R,D]=S,[F,W]=x,Y=i!=null?i:await this.getAmmPoolKeys(n.id),se=this.createTxBuilder(p),ht=await b.handleTokenAccount({side:"in",amount:F,mint:C.mint,tokenAccount:R,bypassAssociatedCheck:f,checkCreateATAOwner:y}),{tokenAccount:we}=ht,ce=We(ht,["tokenAccount"]);se.addInstruction(ce);let Ge=await b.handleTokenAccount({side:"in",amount:W,mint:L.mint,tokenAccount:D,bypassAssociatedCheck:f,checkCreateATAOwner:y}),{tokenAccount:pe}=Ge,Ce=We(Ge,["tokenAccount"]);se.addInstruction(Ce);let bt=await b.handleTokenAccount({side:"out",amount:0,mint:new Je(n.lpMint.address),tokenAccount:I,bypassAssociatedCheck:f,checkCreateATAOwner:y}),{tokenAccount:nt}=bt,Wt=We(bt,["tokenAccount"]);return se.addInstruction(Wt),se.addInstruction({instructions:[xl({poolInfo:n,poolKeys:Y,userKeys:{baseTokenAccount:we,quoteTokenAccount:pe,lpTokenAccount:nt,owner:this.scope.ownerPubKey},baseAmountIn:F,quoteAmountIn:W,otherAmountMin:a.raw,fixedSide:B})],instructionTypes:[n.pooltype.includes("StablePool")?X.AmmV5AddLiquidity:X.AmmV4AddLiquidity],lookupTableAddress:Y.lookupTableAccount?[Y.lookupTableAccount]:[]}),se.addCustomComputeBudget(m),se.addTipInstruction(d),l===0?await se.buildV0():se.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:i,lpAmount:r,baseAmountMin:s,quoteAmountMin:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=t,p=i!=null?i:await this.getAmmPoolKeys(n.id),[b,f,y]=[new Je(n.mintA.address),new Je(n.mintB.address),new Je(n.lpMint.address)];this.logDebug("lpAmount:",r),this.logDebug("baseAmountMin:",s),this.logDebug("quoteAmountMin:",a),r.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",r.toString());let{account:g}=this.scope,P=await g.getCreatedTokenAccount({mint:y,associatedOnly:!1});P||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",g.tokenAccounts);let k=await g.getCreatedTokenAccount({mint:b}),T=await g.getCreatedTokenAccount({mint:f}),I=this.createTxBuilder(d),{bypassAssociatedCheck:h,checkCreateATAOwner:S}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),L=await g.handleTokenAccount({side:"out",amount:0,mint:b,tokenAccount:k,bypassAssociatedCheck:h,checkCreateATAOwner:S}),{tokenAccount:x}=L,K=We(L,["tokenAccount"]);I.addInstruction(K);let R=await g.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:T,bypassAssociatedCheck:h,checkCreateATAOwner:S}),{tokenAccount:B}=R,C=We(R,["tokenAccount"]);return I.addInstruction(C),I.addInstruction({instructions:[Qa({poolInfo:n,poolKeys:p,userKeys:{lpTokenAccount:P,baseTokenAccount:x,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:r,baseAmountMin:s,quoteAmountMin:a})],lookupTableAddress:p.lookupTableAccount?[p.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?X.AmmV5RemoveLiquidity:X.AmmV4RemoveLiquidity]}),I.addCustomComputeBudget(l),I.addTipInstruction(m),u===0?await I.buildV0():I.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:i,createPositionInfo:r,farmInfo:s,userFarmLpAmount:a,base:c,computeBudgetConfig:u,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=Un,checkCreateATAOwner:p=!0,getEphemeralSigners:b,txVersion:f,feePayer:y}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let g=this.createTxBuilder(y),P={};for(let Y of this.scope.account.tokenAccountRawInfos)(P[Y.accountInfo.mint.toString()]===void 0||ee(this.scope.ownerPubKey,Y.accountInfo.mint,Un).publicKey.equals(Y.pubkey))&&(P[Y.accountInfo.mint.toString()]=Y.pubkey);let k=P[t.lpMint.address];if(k===void 0)throw Error("find lp account error in trade accounts");let T=i.add(a!=null?a:new Ue(0)),I=t.mintA.address===Be.WSOL.mint.toString(),h=t.mintB.address===Be.WSOL.mint.toString(),{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Un,mint:new Je(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(x||{}),S===void 0)throw new Error("base token account not found");let{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Un,mint:new Je(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(B||{}),K===void 0)throw new Error("quote token account not found");if(P[t.mintA.address]=S,P[t.mintB.address]=K,s!==void 0&&!(a!=null&&a.isZero())){let Y=Et[s.programId],se=At({programId:new Je(s.programId),poolId:new Je(s.id),owner:this.scope.ownerPubKey,version:Y}),we,ce=await this.scope.connection.getAccountInfo(se);if(ce&&(we=Bi(Y).decode(ce.data)),Y!==6&&!we){let{instruction:bt,instructionType:nn}=lo({id:new Je(s.id),programId:new Je(s.programId),version:Y,ledger:se,owner:this.scope.ownerPubKey});g.addInstruction({instructions:[bt],instructionTypes:[nn]})}let pe=[];for(let bt of s.rewardInfos){let nn=bt.mint.address===Be.WSOL.mint.toString();if(P[bt.mint.address])pe.push(P[bt.mint.address]);else{let{account:bn,instructionParams:qt}=await this.scope.account.getOrCreateTokenAccount({mint:new Je(bt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!nn,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});bn||this.logAndCreateError("farm reward account not found:",bt.mint.address),qt&&g.addInstruction(qt),pe.push(bn)}}let Ce=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],nt={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:Ce,lpAccount:k,rewardAccounts:pe},Wt=Et[s.programId],ht=Wt===6?mo(nt):Wt===5?po(nt):fo(nt),Ge={3:X.FarmV3Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};g.addInstruction({instructions:[ht],instructionTypes:[Ge[Wt]]})}let C=await this.getAmmPoolKeys(t.id),L=Qa({poolInfo:t,poolKeys:C,userKeys:{lpTokenAccount:k,baseTokenAccount:S,quoteTokenAccount:K,owner:this.scope.ownerPubKey},lpAmount:T,baseAmountMin:0,quoteAmountMin:0});g.addInstruction({instructions:[L],instructionTypes:[t.pooltype.includes("StablePool")?X.AmmV5RemoveLiquidity:X.AmmV4RemoveLiquidity],lookupTableAddress:C.lookupTableAccount?[C.lookupTableAccount]:[]});let[R,D]=t.mintA.address===n.mintA.address?[S,K]:[K,S],F=await this.scope.clmm.getClmmPoolKeys(n.id),W=await Ke.openPositionFromBaseInstructions(U(v({poolInfo:n,poolKeys:F,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:R,tokenAccountB:D},withMetadata:"create"},r),{base:c,getEphemeralSigners:b}));return g.addInstruction({instructions:[...W.instructions],signers:W.signers,instructionTypes:[...W.instructionTypes],lookupTableAddress:F.lookupTableAccount?[F.lookupTableAccount]:[]}),f===0?g.sizeCheckBuildV0({computeBudgetConfig:u}):g.sizeCheckBuild({computeBudgetConfig:u})}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:i,quoteMintInfo:r,baseAmount:s,quoteAmount:a,startTime:c,ownerInfo:u,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:b,computeBudgetConfig:f,txTipConfig:y,feePayer:g}){var D;let P=u.feePayer||((D=this.scope.owner)==null?void 0:D.publicKey),k=u.useSOLBalance&&i.mint.equals(Yr),T=u.useSOLBalance&&r.mint.equals(Yr),I=this.createTxBuilder(g),{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:k?{payer:P,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:l,checkCreateATAOwner:m});I.addInstruction(S||{});let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:T?{payer:P,amount:a}:void 0,notUseTokenAccount:T,skipCloseAccount:!T,associatedOnly:T?!1:l,checkCreateATAOwner:m});if(I.addInstruction(K||{}),h===void 0||x===void 0)throw Error("you don't has some token account");let B=Za({version:4,marketVersion:3,marketId:n.marketId,baseMint:i.mint,quoteMint:r.mint,baseDecimals:i.decimals,quoteDecimals:r.decimals,programId:t,marketProgramId:n.programId}),C={programId:t,ammId:B.id,ammAuthority:B.authority,ammOpenOrders:B.openOrders,lpMint:B.lpMint,coinMint:B.baseMint,pcMint:B.quoteMint,coinVault:B.baseVault,pcVault:B.quoteVault,withdrawQueue:B.withdrawQueue,ammTargetOrders:B.targetOrders,poolTempLp:B.lpVault,marketProgramId:B.marketProgramId,marketId:B.marketId,ammConfigId:B.configId,feeDestinationId:b},{instruction:L,instructionType:R}=za(U(v({},C),{userWallet:this.scope.ownerPubKey,userCoinVault:h,userPcVault:x,userLpVault:ee(this.scope.ownerPubKey,B.lpMint,d).publicKey,nonce:B.nonce,openTime:c,coinAmount:s,pcAmount:a}));return I.addInstruction({instructions:[L],instructionTypes:[R]}),I.addCustomComputeBudget(f),I.addTipInstruction(y),I.versionBuild({txVersion:p,extInfo:{address:C}})}async createMarketAndPoolV4({programId:t=zi,marketProgram:n=zs,feeDestinationId:i=ic,tokenProgram:r,baseMintInfo:s,quoteMintInfo:a,baseAmount:c,quoteAmount:u,startTime:l,ownerInfo:m,lowestFeeMarket:d,assignSeed:p,associatedOnly:b=!1,checkCreateATAOwner:f=!1,lotSize:y=1,tickSize:g=.01,txVersion:P,computeBudgetConfig:k,txTipConfig:T,feePayer:I}){var Vi,Nt,$o;let h=this.scope.ownerPubKey,S=m.feePayer||((Vi=this.scope.owner)==null?void 0:Vi.publicKey),x=m.useSOLBalance&&s.mint.equals(Yr),K=m.useSOLBalance&&a.mint.equals(Yr),B=p?`${s.mint.toBase58().slice(0,7)}-${a.mint.toBase58().slice(0,7)}-${p}`:void 0,C=ze({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-market`}),L=ze({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-request`}),R=ze({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-event`}),D=ze({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-bids`}),F=ze({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-asks`}),W=ze({fromPublicKey:h,programId:Un,assignSeed:B&&`${B}-baseVault`}),Y=ze({fromPublicKey:h,programId:Un,assignSeed:B&&`${B}-quoteVault`}),se=0,we=new Ue(100);function ce(){let on=new Ue(0);for(;;)try{return{vaultOwner:Je.createProgramAddressSync([C.publicKey.toBuffer(),on.toArrayLike(Buffer,"le",8)],n),vaultSignerNonce:on}}catch{if(on.iaddn(1),on.gt(new Ue(25555)))throw Error("find vault owner error")}}let{vaultOwner:pe,vaultSignerNonce:Ce}=ce(),nt=new Ue(Math.round(10**s.decimals*y)),Wt=new Ue(Math.round(y*10**a.decimals*g));if(nt.eq($e))throw Error("lot size is too small");if(Wt.eq($e))throw Error("tick size or lot size is too small");let ht=await Hr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:n,vaultOwner:pe,baseMint:s.mint,quoteMint:a.mint,id:C,baseVault:W,quoteVault:Y,requestQueue:L,eventQueue:R,bids:D,asks:F,feeRateBps:se,quoteDustThreshold:we,vaultSignerNonce:Ce,baseLotSize:nt,quoteLotSize:Wt,lowestFeeMarket:d}}),Ge=this.createTxBuilder(I);Ge.addInstruction({instructions:ht[0].transaction.instructions,signers:ht[0].signer});for await(let on of ht.slice(1,ht.length))Ge.addInstruction({instructions:on.transaction.instructions,signers:on.signer,instructionTypes:on.instructionTypes});let{account:bt,instructionParams:nn}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:x?{payer:S,amount:c}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:b,checkCreateATAOwner:f,assignSeed:x&&B?`${B}-wsol`:void 0});Ge.addInstruction(nn||{});let{account:bn,instructionParams:qt}=await this.scope.account.getOrCreateTokenAccount({mint:a.mint,owner:this.scope.ownerPubKey,createInfo:K?{payer:S,amount:u}:void 0,notUseTokenAccount:K,skipCloseAccount:!K,associatedOnly:K?!1:b,checkCreateATAOwner:f,assignSeed:K&&B?`${B}-wsol`:void 0});if(Ge.addInstruction(qt||{}),bt===void 0)throw Error("you don't has base token account");if(bn===void 0)throw Error("you don't has quote token account");let it=Za({version:4,marketVersion:3,marketId:C.publicKey,baseMint:s.mint,quoteMint:a.mint,baseDecimals:s.decimals,quoteDecimals:a.decimals,programId:t,marketProgramId:n}),pi={programId:t,ammId:it.id,ammAuthority:it.authority,ammOpenOrders:it.openOrders,lpMint:it.lpMint,coinMint:it.baseMint,pcMint:it.quoteMint,coinVault:it.baseVault,pcVault:it.quoteVault,withdrawQueue:it.withdrawQueue,ammTargetOrders:it.targetOrders,poolTempLp:it.lpVault,marketProgramId:it.marketProgramId,marketId:it.marketId,ammConfigId:it.configId,feeDestinationId:i},{instruction:Yo,instructionType:Zo}=za(U(v({},pi),{userWallet:this.scope.ownerPubKey,userCoinVault:bt,userPcVault:bn,userLpVault:ee(this.scope.ownerPubKey,it.lpMint,r).publicKey,nonce:it.nonce,openTime:l,coinAmount:c,pcAmount:u}));Ge.addInstruction({instructions:[Yo],instructionTypes:[Zo]});let _i=x||K?[((Nt=nn==null?void 0:nn.instructions)==null?void 0:Nt[0])||(($o=qt==null?void 0:qt.instructions)==null?void 0:$o[0])].filter(on=>!!on):void 0;return P===0?Ge.sizeCheckBuildV0({computeBudgetConfig:k,splitIns:_i,address:v({requestQueue:L.publicKey,eventQueue:R.publicKey,bids:D.publicKey,asks:F.publicKey,baseVault:W.publicKey,quoteVault:Y.publicKey,baseMint:new Je(s.mint),quoteMint:new Je(a.mint)},pi)}):Ge.sizeCheckBuild({computeBudgetConfig:k,splitIns:_i,address:v({requestQueue:L.publicKey,eventQueue:R.publicKey,bids:D.publicKey,asks:F.publicKey,baseVault:W.publicKey,quoteVault:Y.publicKey,baseMint:new Je(s.mint),quoteMint:new Je(a.mint)},pi)})}async getCreatePoolFee({programId:t}){let n=zr({programId:t}),i=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(i===null)throw Error("get config account error");return Al.decode(i.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:i,mintOut:r,slippage:s}){let[a,c]=[i.toString(),r.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(c!==t.mintA.address&&c!==t.mintB.address)throw new Error("toke not match");let{baseReserve:u,quoteReserve:l}=t,m=[u,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[b,f]=m,[y,g]=d,P=t.version===4,k;if(P)k=new O(f.toString()).div(10**g).div(new O(b.toString()).div(10**y));else{let R=Tl(this.stableLayout.stableModelData,u.toNumber(),l.toNumber(),!1);p==="quote"?k=new O(1e6).div(R*1e6):k=new O(R*1e6).div(1e6)}let T=n,I=new Ue(0),h=new Ue(0);if(!T.isZero())if(P){h=jt(T.mul(Fa),Xr);let R=T.sub(h),D=b.add(R);I=f.mul(R).div(D)}else{h=T.mul(new Ue(2)).div(new Ue(1e4));let R=T.sub(h);p==="quote"?I=new Ue(kl(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),R.toNumber())):I=new Ue(hl(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),R.toNumber()))}let S=new Ue(new O(I.toString()).mul(1-s).toFixed(0)),x=I,K=S,B=new O(I.toString()).div(new O(T.sub(h).toString()).toFixed(0));!T.isZero()&&!I.isZero()&&(B=new O(I.toString()).div(10**g).div(new O(T.sub(h).toString()).div(10**y)));let C=k.sub(B).div(k).mul(100);return{amountOut:x,minAmountOut:K,currentPrice:k,executionPrice:B,priceImpact:C,fee:h}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:i,mintOut:r,slippage:s}){let{baseReserve:a,quoteReserve:c}=t;i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),r.toString()!==t.mintA.address&&r.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",c.toString());let u=i.toString()===t.mintA.address,[l,m]=u?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new O(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,c],p=u?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[b,f]=d,y=new O(f.toString()).div(10**t[u?"mintB":"mintA"].decimals).div(new O(b.toString()).div(10**t[u?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${y.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(y).toString()} ${l.symbol||l.address}`);let g=new Ue(0),P=n;if(!P.isZero()){P.gt(f)&&(P=f.sub(new Ue(1)));let K=f.sub(P);g=b.mul(P).div(K).mul(Xr).div(Xr.sub(Fa))}let k=new Ue(new O(g.toString()).mul(1+s).toFixed(0)),T=g,I=k;this.logDebug("amountIn:",new O(T.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new O(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let h=null;!g.isZero()&&!P.isZero()&&(h=new O(P.toString()).div(10**m.decimals).div(new O(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${h.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(h).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let S=y.mul(T.toString()),x=S.sub(n.toString()).abs().div(S);return this.logDebug("priceImpact:",`${x.toString()}%`),{amountIn:T,maxAmountIn:I,currentPrice:y,executionPrice:h,priceImpact:x}}async swap({poolInfo:t,poolKeys:n,amountIn:i,amountOut:r,inputMint:s,fixedSide:a,txVersion:c,config:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}){let p=this.createTxBuilder(d),{associatedOnly:b=!0,inputUseSolBalance:f=!0,outputUseSolBalance:y=!0}=u||{},[g,P]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],k=f&&g.address===$.toBase58(),T=y&&P.address===$.toBase58(),{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Un,mint:new Je(g.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:b});p.addInstruction(h||{}),I||this.logAndCreateError("input token account not found",{token:g.symbol||g.address,tokenAccountIn:I,inputTokenUseSolBalance:k,associatedOnly:b});let{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Un,mint:new Je(P.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:b});p.addInstruction(x||{}),S===void 0&&this.logAndCreateError("output token account not found",{token:P.symbol||P.address,tokenAccountOut:S,outputTokenUseSolBalance:T,associatedOnly:b});let K=n||await this.getAmmPoolKeys(t.id),B=4;return t.pooltype.includes("StablePool")&&(B=5),p.addInstruction({instructions:[Qr({version:B,poolKeys:K,userKeys:{tokenAccountIn:I,tokenAccountOut:S,owner:this.scope.ownerPubKey},amountIn:i,amountOut:r,fixedSide:a})],instructionTypes:[B===4?X.AmmV4SwapBaseIn:X.AmmV5SwapBaseIn]}),p.addCustomComputeBudget(l),p.addTipInstruction(m),p.versionBuild({txVersion:c})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let i=await Oe(this.scope.connection,t.map(l=>({pubkey:new Je(l)})),n),r={},s=[];for(let l=0;l<t.length;l++){let m=i[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=oi.decode(m.accountInfo.data);r[String(t[l])]=U(v({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},c=await Oe(this.scope.connection,s.map(l=>({pubkey:new Je(l)})),n);for(let l=0;l<s.length;l++){let m=c[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new Ue(Ob.decode(m.data).amount.toString())}let u={};for(let[l,m]of Object.entries(r)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);u[l]=U(v({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new O(p.toString()).div(new O(10).pow(m.quoteDecimal.toString())).div(new O(d.toString()).div(new O(10).pow(m.baseDecimal.toString())))})}return u}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),i=jr({[t]:n}),r=i[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[i[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:r,poolKeys:s[0]}}};import{PublicKey as H}from"@solana/web3.js";import Lt from"bn.js";import{AccountLayout as Ol,TOKEN_2022_PROGRAM_ID as Gn,TOKEN_PROGRAM_ID as No}from"@solana/spl-token";var Oo=class extends ve{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var S;let{programId:t,owner:n=((S=this.scope.owner)==null?void 0:S.publicKey)||H.default,mint1:i,mint2:r,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:m,txTipConfig:d,feePayer:p}=e,b=this.createTxBuilder(p),[f,y,g]=new Lt(new H(i.address).toBuffer()).gt(new Lt(new H(r.address).toBuffer()))?[r,i,new O(1).div(a)]:[i,r,a],P=oe.priceToSqrtPriceX64(g,f.decimals,y.decimals),k=[],T=[];f.programId===Gn.toBase58()&&T.push(Ma(t,new H(f.address)).publicKey),y.programId===Gn.toBase58()&&T.push(Ma(t,new H(y.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(T)).forEach((x,K)=>{x&&k.push(T[K])});let h=await Ke.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:f,mintB:y,ammConfigId:s.id,initialPriceX64:P,forerunCreate:!l&&u,extendMintAccount:k});return b.addInstruction(h),b.addCustomComputeBudget(c),b.addTipInstruction(d),b.versionBuild({txVersion:m,extInfo:{address:U(v({},h.address),{observationId:h.address.observationId.toBase58(),exBitmapAccount:h.address.exBitmapAccount.toBase58(),programId:t.toString(),id:h.address.poolId.toString(),mintA:f,mintB:y,openTime:"0",vault:{A:h.address.mintAVault.toString(),B:h.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:v({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:h.address.poolId.toString(),mintA:f,mintB:y,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},$c),forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,withMetadata:d="create",getEphemeralSigners:p,computeBudgetConfig:b,txTipConfig:f,txVersion:y,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let P=this.createTxBuilder(g),k=null,T=null,I=n.useSOLBalance&&e.mintA.address===$.toString(),h=n.useSOLBalance&&e.mintB.address===$.toString(),[S,x]=s==="MintA"?[a,c]:[c,a],{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new H(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:l,checkCreateATAOwner:m});K&&(k=K),P.addInstruction(B||{});let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new H(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||x.isZero()?{payer:this.scope.ownerPubKey,amount:x}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:l,checkCreateATAOwner:m});C&&(T=C),P.addInstruction(L||{}),(!k||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:k==null?void 0:k.toBase58(),ownerTokenAccountB:T==null?void 0:T.toBase58()});let R=t||await this.getClmmPoolKeys(e.id),D=await Ke.openPositionFromBaseInstructions({poolInfo:e,poolKeys:R,ownerInfo:U(v({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:T}),tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:d,getEphemeralSigners:p,nft2022:u});return P.addInstruction(D),P.addCustomComputeBudget(b),P.addTipInstruction(f),P.versionBuild({txVersion:y,extInfo:v({},D.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:i,amountMaxB:r,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,txTipConfig:b,getEphemeralSigners:f,nft2022:y,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let P=this.createTxBuilder(g),k=null,T=null,I=n.useSOLBalance&&e.mintA.address===$.toBase58(),h=n.useSOLBalance&&e.mintB.address===$.toBase58(),{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new H(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:u,checkCreateATAOwner:l});S&&(k=S),P.addInstruction(x||{});let{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new H(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:u,checkCreateATAOwner:l});K&&(T=K),P.addInstruction(B||{}),(k===void 0||T===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let C=t||await this.getClmmPoolKeys(e.id),L=await Ke.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:T},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:i,amountMaxB:r,withMetadata:m,getEphemeralSigners:f,nft2022:y});return P.addInstruction(L),P.addCustomComputeBudget(p),P.addTipInstruction(b),P.versionBuild({txVersion:d,extInfo:{address:L.address}})}async increasePositionFromLiquidity(e){var B;let{poolInfo:t,poolKeys:n,ownerPosition:i,amountMaxA:r,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:b}=e,f=this.createTxBuilder(b),y,g,P=c.useSOLBalance&&t.mintA.address===$.toString(),k=c.useSOLBalance&&t.mintB.address===$.toString(),{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new H(t.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,createInfo:P||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!P,associatedOnly:P?!1:u,checkCreateATAOwner:l});T&&(y=T),f.addInstruction(I||{});let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new H(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});h&&(g=h),f.addInstruction(S||{}),!y&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let x=n!=null?n:await this.getClmmPoolKeys(t.id),K=Ke.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:x,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:g},liquidity:a,amountMaxA:r,amountMaxB:s,nft2022:(B=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:B.owner.equals(Gn)});return f.addInstruction(K),f.addCustomComputeBudget(m),f.addTipInstruction(d),f.versionBuild({txVersion:p,extInfo:{address:K.address}})}async increasePositionFromBase(e){var K;let{poolInfo:t,ownerPosition:n,base:i,baseAmount:r,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,b=this.createTxBuilder(p),f,y,g=a.useSOLBalance&&t.mintA.address===$.toString(),P=a.useSOLBalance&&t.mintB.address===$.toString(),{account:k,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new H(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(i==="MintA"?r:s).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?r:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});k&&(f=k),b.addInstruction(T||{});let{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new H(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:P||(i==="MintA"?s:r).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?s:r}:void 0,notUseTokenAccount:P,skipCloseAccount:!P,associatedOnly:P?!1:c,checkCreateATAOwner:u});I&&(y=I),b.addInstruction(h||{}),!f&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=await this.getClmmPoolKeys(t.id),x=Ke.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:S,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:y},base:i,baseAmount:r,otherAmountMax:s,nft2022:(K=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:K.owner.equals(Gn)});return b.addInstruction(x),b.addCustomComputeBudget(l),b.addTipInstruction(m),b.versionBuild({txVersion:d,extInfo:{address:x.address}})}async decreaseLiquidity(e){var R;let{poolInfo:t,poolKeys:n,ownerPosition:i,ownerInfo:r,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:b}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let f=this.createTxBuilder(b),y=r.useSOLBalance&&t.mintA.address===$.toString(),g=r.useSOLBalance&&t.mintB.address===$.toString(),P,k,{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new H(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:l});P=T,I&&f.addInstruction(I);let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new H(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});k=h,S&&f.addInstruction(S);let x=[];for(let D of t.rewardDefaultInfos){let F=r.useSOLBalance&&D.mint.address===$.toString(),W;if(D.mint.address===t.mintA.address)W=P;else if(D.mint.address===t.mintB.address)W=k;else{let{account:Y,instructionParams:se}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(D.mint.programId),mint:new H(D.mint.address),notUseTokenAccount:F,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!F,associatedOnly:F?!1:u,checkCreateATAOwner:l});W=Y,se&&f.addInstruction(se)}x.push(W)}!P&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let K=n!=null?n:await this.getClmmPoolKeys(t.id),B=(R=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:R.owner.equals(Gn),C=await Ke.decreaseLiquidityInstructions({poolInfo:t,poolKeys:K,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:P,tokenAccountB:k,rewardAccounts:x},liquidity:c,amountMinA:s,amountMinB:a,nft2022:B});f.addInstruction({instructions:C.instructions,instructionTypes:[X.ClmmDecreasePosition]});let L=v({},C.address);if(r.closePosition){let D=await Ke.closePositionInstructions({poolInfo:t,poolKeys:K,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:i,nft2022:B});f.addInstruction({endInstructions:D.instructions,endInstructionTypes:D.instructionTypes}),L=v(v({},L),D.address)}return f.addCustomComputeBudget(m),f.addTipInstruction(d),f.versionBuild({txVersion:p,extInfo:{address:L}})}async lockPosition(e){var b;let{programId:t=Pi,authProgramId:n=ji,poolProgramId:i=vn,ownerPosition:r,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:m}=e,d=this.createTxBuilder(m),p=await Ke.makeLockPositions({programId:t,authProgramId:n,poolProgramId:i,wallet:this.scope.ownerPubKey,payer:s!=null?s:this.scope.ownerPubKey,nftMint:r.nftMint,getEphemeralSigners:l,nft2022:(b=await this.scope.connection.getAccountInfo(r.nftMint))==null?void 0:b.owner.equals(Gn)});return d.addInstruction(p),d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=Pi,authProgramId:n=ji,clmmProgram:i=vn,poolKeys:r,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,b=r||await this.getClmmPoolKeys(s.poolId.toString()),f=this.createTxBuilder(p),y=await this.scope.connection.getAccountInfo(s.positionId);y||this.logger.logWithError("position not found",s.positionId);let g=Io.decode(y.data),P=a.useSOLBalance&&b.mintA.address===$.toString(),k=a.useSOLBalance&&b.mintB.address===$.toString(),T,I,{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.mintA.programId,mint:new H(b.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!P,associatedOnly:P?!1:c,checkCreateATAOwner:u});T=h,S&&f.addInstruction(S);let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.mintB.programId,mint:new H(b.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:k?!1:c,checkCreateATAOwner:u});I=x,K&&f.addInstruction(K);let B={},C=[];for(let pe of b.rewardInfos){let Ce=a.useSOLBalance&&pe.mint.address===$.toString(),nt=B[pe.mint.address];if(!nt){let{account:Wt,instructionParams:ht}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(pe.mint.programId),mint:new H(pe.mint.address),notUseTokenAccount:Ce,owner:this.scope.ownerPubKey,skipCloseAccount:!Ce,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:Ce?!1:c});nt=Wt,ht&&f.addInstruction(ht)}B[pe.mint.address]=nt,C.push(nt)}let L=wo(t,s.lockNftMint).publicKey,R=ee(this.scope.ownerPubKey,s.lockNftMint,No).publicKey,D=Z.getTickArrayStartIndexByTick(g.tickLower,b.config.tickSpacing),F=Z.getTickArrayStartIndexByTick(g.tickUpper,b.config.tickSpacing),{publicKey:W}=Ae(new H(b.programId),s.poolId,D),{publicKey:Y}=Ae(new H(b.programId),s.poolId,F),{publicKey:se}=en(new H(b.programId),s.poolId,g.tickLower,g.tickUpper),we=[];for(let pe=0;pe<b.rewardInfos.length;pe++)we.push({poolRewardVault:new H(b.rewardInfos[pe].vault),ownerRewardVault:C[pe],rewardMint:new H(b.rewardInfos[pe].mint.address)});let ce=await Ke.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:L,clmmProgram:i,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:R,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:se,vaultA:new H(b.vault.A),vaultB:new H(b.vault.B),tickArrayLower:W,tickArrayUpper:Y,userVaultA:T,userVaultB:I,mintA:new H(b.mintA.address),mintB:new H(b.mintB.address),rewardAccounts:we,exTickArrayBitmap:je(i,s.poolId).publicKey});return f.addInstruction({instructions:[ce],instructionTypes:[X.ClmmHarvestLockPosition]}),f.addCustomComputeBudget(l),f.addTipInstruction(m),f.versionBuild({txVersion:d})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:i,computeBudgetConfig:r,txTipConfig:s,feePayer:a}){var m;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t!=null?t:await this.getClmmPoolKeys(e.id),l=Ke.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(m=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:m.owner.equals(Gn)});return c.addCustomComputeBudget(r),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:i,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===$.toString(),m=n.perSecond.mul(n.endTime-n.openTime),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(n.mint.address),mint:new H(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Lt(new O(m.toFixed(0)).gte(m)?m.toFixed(0):m.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:i,checkCreateATAOwner:r});p&&u.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=await this.getClmmPoolKeys(e.id),f=Ke.initRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{programId:new H(n.mint.programId),mint:new H(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ue.decimalToX64(n.perSecond)}});return u.addInstruction(f),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:f.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of i)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let m=this.createTxBuilder(l),d={};for(let p of i){let b=n.useSOLBalance&&p.mint.address===$.toString(),f=p.perSecond.mul(p.endTime-p.openTime),{account:y,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(p.mint.programId),mint:new H(p.mint.address),notUseTokenAccount:!!b,skipCloseAccount:!b,owner:this.scope.ownerPubKey,createInfo:b?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Lt(new O(f.toFixed(0)).gte(f)?f.toFixed(0):f.add(1).toFixed(0))}:void 0,associatedOnly:b?!1:r,checkCreateATAOwner:s});g&&m.addInstruction(g),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let P=t!=null?t:await this.getClmmPoolKeys(e.id),k=Ke.initRewardInstructions({poolInfo:e,poolKeys:P,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{programId:new H(p.mint.programId),mint:new H(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ue.decimalToX64(p.perSecond)}});d=v(v({},d),k.address),m.addInstruction(k)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),m=t.useSOLBalance&&n.mint.equals($),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Lt(new O(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:i,checkCreateATAOwner:r});p&&l.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=await this.getClmmPoolKeys(e.id),f=Ke.setRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ue.decimalToX64(n.perSecond)}});return l.addInstruction(f),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:f.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let m=this.createTxBuilder(l),d={};for(let p of i){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let b=n.useSOLBalance&&p.mint.address===$.toString(),{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(p.mint.programId),mint:new H(p.mint.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:b?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Lt(new O(p.perSecond.sub(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.sub(p.endTime-p.openTime))?p.perSecond.sub(p.endTime-p.openTime).toFixed(0):p.perSecond.sub(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:b?!1:r,checkCreateATAOwner:s});y&&m.addInstruction(y),f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t!=null?t:await this.getClmmPoolKeys(e.id),P=Ke.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardInfo:{mint:new H(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ue.decimalToX64(p.perSecond)}});m.addInstruction(P),d=v(v({},d),P.address)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let m=this.createTxBuilder(u),d=t.useSOLBalance&&n.equals($),{account:p,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(l.mint.programId),mint:n,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:i,checkCreateATAOwner:r});b&&m.addInstruction(b),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),y=Ke.collectRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return m.addInstruction(y),m.addCustomComputeBudget(s),m.addTipInstruction(a),m.versionBuild({txVersion:c,extInfo:{address:y.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let m of n){let d=e.rewardDefaultInfos.find(P=>P.mint.address===m.toString());if(!d){this.logAndCreateError("reward mint error","not found reward mint",m);continue}let p=t.useSOLBalance&&m.equals($),{account:b,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(d.mint.programId),mint:m,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:i,checkCreateATAOwner:r});b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),f&&u.addInstruction(f);let y=await this.getClmmPoolKeys(e.id),g=Ke.collectRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardMint:m});u.addInstruction(g),l=v(v({},l),g.address)}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:i,amountOutMin:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:b,feePayer:f}){let y=this.createTxBuilder(f),g=n.toString()===e.mintA.address,P=c.useSOLBalance&&e.mintA.address===$.toBase58(),k=c.useSOLBalance&&e.mintB.address===$.toBase58(),T;!s||s.equals(new O(0))?T=g?Vt.add(new Lt(1)):Ft.sub(new Lt(1)):T=oe.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let I;if(!I){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new H(e.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:P||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?i:0}:void 0,associatedOnly:P?!1:l,checkCreateATAOwner:m});I=x,K&&y.addInstruction(K)}let h;if(!h){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new H(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:i}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:m});h=x,K&&y.addInstruction(K)}(!I||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:I,ownerTokenAccountB:h,mintAUseSOLBalance:P,mintBUseSOLBalance:k,associatedOnly:l});let S=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Ke.makeSwapBaseInInstructions({poolInfo:e,poolKeys:S,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:I,tokenAccountB:h},inputMint:new H(n),amountIn:i,amountOutMin:r,sqrtPriceLimitX64:T,remainingAccounts:u})),y.addCustomComputeBudget(p),y.addTipInstruction(b),y.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:i,amountInMax:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:b,feePayer:f}){let y=this.createTxBuilder(f),g=n.toString()===e.mintB.address,P=c.useSOLBalance&&e.mintA.address===$.toBase58(),k=c.useSOLBalance&&e.mintB.address===$.toBase58(),T;!s||s.equals(new O(0))?T=n.toString()===e.mintB.address?Vt.add(new Lt(1)):Ft.sub(new Lt(1)):T=oe.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let I;if(!I){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new H(e.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:P||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?r:0}:void 0,associatedOnly:P?!1:l,checkCreateATAOwner:m});I=x,K&&y.addInstruction(K)}let h;if(!h){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new H(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:r}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:m});h=x,K&&y.addInstruction(K)}(!I||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:I,ownerTokenAccountB:h,mintAUseSOLBalance:P,mintBUseSOLBalance:k,associatedOnly:l});let S=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Ke.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:S,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:I,tokenAccountB:h},outputMint:new H(n),amountOut:i,amountInMax:r,sqrtPriceLimitX64:T,remainingAccounts:u})),y.addCustomComputeBudget(p),y.addTipInstruction(b),y.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){var y,g;let m={};for(let P of this.scope.account.tokenAccountRawInfos)r?ee(this.scope.ownerPubKey,P.accountInfo.mint,a).publicKey.equals(P.pubkey)&&(m[P.accountInfo.mint.toString()]=P.pubkey):m[P.accountInfo.mint.toString()]=P.pubkey;let d=Object.values(t).flat().map(P=>P.nftMint),p=await Oe(this.scope.connection,d.map(P=>({pubkey:P}))),b={};p.forEach(P=>{var k,T;b[P.pubkey.toBase58()]=(T=(k=P==null?void 0:P.accountInfo)==null?void 0:k.owner)!=null?T:null});let f=this.createTxBuilder(l);for(let P of Object.values(e)){if(t[P.id]===void 0||!t[P.id].find(C=>!C.liquidity.isZero()||C.rewardInfos.find(L=>!L.rewardAmountOwed.isZero())))continue;let k=P,T=i.useSOLBalance&&k.mintA.address===$.toString(),I=i.useSOLBalance&&k.mintB.address===$.toString(),h=m[k.mintA.address];if(!h){let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:k.mintA.programId,mint:new H(k.mintA.address),notUseTokenAccount:T,owner:this.scope.ownerPubKey,skipCloseAccount:!T,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:T?!1:r,checkCreateATAOwner:s});h=C,L&&f.addInstruction(L)}let S=m[k.mintB.address];if(!S){let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:k.mintB.programId,mint:new H(k.mintB.address),notUseTokenAccount:I,owner:this.scope.ownerPubKey,skipCloseAccount:!I,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:I?!1:r,checkCreateATAOwner:s});S=C,L&&f.addInstruction(L)}m[k.mintA.address]=h,m[k.mintB.address]=S;let x=[];for(let C of k.rewardDefaultInfos){let L=i.useSOLBalance&&C.mint.address===$.toString(),R=m[C.mint.address];if(!R){let{account:D,instructionParams:F}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(C.mint.programId),mint:new H(C.mint.address),notUseTokenAccount:L,owner:this.scope.ownerPubKey,skipCloseAccount:!L,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:L?!1:r});R=D,F&&f.addInstruction(F)}m[C.mint.address]=R,x.push(R)}let K=await this.getClmmPoolKeys(k.id),B=[];for(let C=0;C<K.rewardInfos.length;C++)B.push({poolRewardVault:new H(K.rewardInfos[C].vault),ownerRewardVault:x[C],rewardMint:new H(K.rewardInfos[C].mint.address)});for(let C of t[P.id]){let L=(y=n==null?void 0:n[P.id])==null?void 0:y[C.nftMint.toBase58()];if(L){let R=ee(this.scope.ownerPubKey,L.lockNftMint,No).publicKey,D=Z.getTickArrayStartIndexByTick(C.tickLower,K.config.tickSpacing),F=Z.getTickArrayStartIndexByTick(C.tickUpper,K.config.tickSpacing),{publicKey:W}=Ae(new H(K.programId),L.poolId,D),{publicKey:Y}=Ae(new H(K.programId),L.poolId,F),{publicKey:se}=en(new H(K.programId),L.poolId,C.tickLower,C.tickUpper),we=wo(Pi,L.lockNftMint).publicKey,ce=Ke.harvestLockPositionInstructionV2({programId:Pi,auth:ji,lockPositionId:we,clmmProgram:vn,lockOwner:this.scope.ownerPubKey,lockNftMint:L.lockNftMint,lockNftAccount:R,positionNftAccount:L.nftAccount,positionId:L.positionId,poolId:L.poolId,protocolPosition:se,vaultA:new H(K.vault.A),vaultB:new H(K.vault.B),tickArrayLower:W,tickArrayUpper:Y,userVaultA:h,userVaultB:S,mintA:new H(K.mintA.address),mintB:new H(K.mintB.address),rewardAccounts:B,exTickArrayBitmap:je(vn,L.poolId).publicKey});f.addInstruction({instructions:[ce],instructionTypes:[X.ClmmHarvestLockPosition],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]})}else{let R=Ke.decreaseLiquidityInstructions({poolInfo:k,poolKeys:K,ownerPosition:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:S,rewardAccounts:x},liquidity:new Lt(0),amountMinA:new Lt(0),amountMinB:new Lt(0),nft2022:(g=b[C.nftMint.toBase58()])==null?void 0:g.equals(Gn)});f.addInstruction(R)}}}return c===0?f.sizeCheckBuildV0({computeBudgetConfig:u}):f.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(Po(e).publicKey);return t?ml.decode(t.data).whitelistMints.filter(i=>!i.equals(H.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new Lt(1))).map(s=>xt(new H(e),s.accountInfo.mint).publicKey),i=await this.scope.connection.getMultipleAccountsInfo(n),r=[];return i.forEach(s=>{if(!s)return;let a=Io.decode(s.data);r.push(a)}),r}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Oe(this.scope.connection,e.map(r=>({pubkey:new H(r)})),t),i={};for(let r=0;r<e.length;r++){let s=n[r];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[r]));let a=ni.decode(s.accountInfo.data),c=oe.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();i[String(e[r])]=U(v({},a),{currentPrice:c,programId:s.accountInfo.owner})}return i}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),i=await Oe(this.scope.connection,Array.from(n).map(c=>({pubkey:new H(c)}))),r={};i.forEach(c=>{!c.accountInfo||(r[c.pubkey.toBase58()]=cl.decode(c.accountInfo.data))});let s=await Ne.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{var m,d,p,b;let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:wt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||No.toBase58(),extensions:{feeConfig:(m=t[u])!=null&&m.feeConfig?qn((d=t[u])==null?void 0:d.feeConfig):void 0}}),mintB:wt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||No.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?qn((b=t[l])==null?void 0:b.feeConfig):void 0}}),price:e[c].currentPrice,config:U(v({},r[e[c].ammConfig.toBase58()]),{id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await Ne.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),i=await fi({connection:this.scope.connection,mints:Array.from(n).map(m=>new H(m))}),{computeClmmPoolInfo:r,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:i}),a=await Oe(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=al(r[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(Ol.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(Ol.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let u=U(v({},r[e]),{exBitmapAccount:r[e].exBitmapAccount.toBase58(),observationId:r[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:r[e].rewardInfos.filter(m=>!m.tokenVault.equals(H.default)).map(m=>({mint:wt({address:m.tokenMint.toBase58(),programId:No.toBase58(),decimals:10}),vault:m.tokenVault.toBase58()}))});return{poolInfo:c,poolKeys:u,computePoolInfo:r[e],tickData:s}}};import{PublicKey as j}from"@solana/web3.js";import{AccountLayout as jb,NATIVE_MINT as rs,TOKEN_PROGRAM_ID as tn}from"@solana/spl-token";import Ja from"bn.js";import es from"decimal.js-light";import Mo from"bn.js";function Zr(o,e){if(e.isZero())throw Error("divisor is zero");return o.mod(e)}function Mb(o,e){if(e.isZero())throw Error("rhs is zero");let t=o.div(e);if(t.isZero())throw Error("quotient is zero");let n=Zr(o,e);return n.gt(Ri)&&(t=t.add(new Mo(1)),e=o.div(t),n=Zr(o,t),n.gt(Ri)&&(e=e.add(new Mo(1)))),[t,e]}var Ri=new Mo(0),$r=class{static swapWithoutFees(e,t,n){let i=t.mul(n),r=t.add(e),[s]=Mb(i,r),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,i,r){let s=e.mul(n).div(t),a=e.mul(i).div(t);if(r===0)return{tokenAmount0:s,tokenAmount1:a};if(r===1)return Zr(e.mul(n),t).gt(Ri)&&s.gt(Ri)&&(s=s.add(new Mo(1))),Zr(e.mul(i),t).gt(Ri)&&a.gt(Ri)&&(a=a.add(new Mo(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var Jr=class{static tradingFee(e,t){return fr(e,t,Yt)}static protocolFee(e,t){return Us(e,t,Yt)}static fundFee(e,t){return Us(e,t,Yt)}};var Ml=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(Ml||{}),ts=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,i){let r=Jr.tradingFee(e,i),s=e.sub(r),{destinationAmountSwapped:a}=$r.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:r}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:i,quoteReserve:r,outputMint:s,outputAmount:a}){let[c,u,l,m,d]=t.address===s.toString()?[i,r,e.decimals,t.decimals,e.address]:[r,i,t.decimals,e.decimals,t.address],p=new es(u.toString()).div(10**m).div(new es(c.toString()).div(10**l)),b=a.gte(u)?u.sub(new Ja(1)):a,f=u.sub(b),y=jt(c.mul(b),f),g=jt(y.mul(new Ja(1e6)),new Ja(1e6).sub(n)),P=g.sub(y),k=new es(b.toString()).div(10**m).div(new es(g.toString()).div(10**l)),T=p.isZero()?0:k.sub(p).div(p).abs().toNumber();return{amountRealOut:b,amountIn:g,amountInWithoutFee:y,tradeFee:P,priceImpact:T}}};import He from"bn.js";import{PublicKey as Eo,TransactionInstruction as ci,Keypair as Gb,SystemProgram as Xb}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as _l,TOKEN_2022_PROGRAM_ID as tu,TOKEN_PROGRAM_ID as Xn}from"@solana/spl-token";var vb=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),Eb=Buffer.from("amm_config","utf8"),_b=Buffer.from("pool","utf8"),Vb=Buffer.from("pool_lp_mint","utf8"),Fb=Buffer.from("pool_vault","utf8"),Db=Buffer.from("observation","utf8");function Ni(o){return ie([vb],o)}function xK(o,e){return ie([Eb,qb(e)],o)}function eu(o,e,t,n){return ie([_b,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function Wb(o,e){return ie([Vb,e.toBuffer()],o)}function vl(o,e,t){return ie([Fb,e.toBuffer(),t.toBuffer()],o)}function vo(o,e){return ie([Db,e.toBuffer()],o)}function qb(o){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,o,!1),new Uint8Array(e)}function El({poolId:o,programId:e,configId:t,mintA:n,mintB:i}){let r=Ni(e).publicKey,s=o||eu(e,t,n,i).publicKey,a=Wb(e,s).publicKey,c=vl(e,s,n).publicKey,u=vl(e,s,i).publicKey,l=vo(e,s).publicKey;return{poolId:s,configId:t,authority:r,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Ub=Buffer.from("locked_liquidity","utf8");function ns(o,e){return ie([Ub,e.toBuffer()],o)}var Qb=be("Raydium_cpmm"),li={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function Vl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k){let T=E([w("amountMaxA"),w("amountMaxB"),w("openTime")]),I=eu(o,t,r,s).publicKey,h=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!i.equals(I),isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Xn,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:_l,isSigner:!1,isWritable:!1},{pubkey:dr,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1}],S=Buffer.alloc(T.span);return T.encode({amountMaxA:g,amountMaxB:P,openTime:k},S),new ci({keys:h,programId:o,data:Buffer.from([...li.initialize,...S])})}function Fl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b){let f=E([w("lpAmount"),w("amountMaxA"),w("amountMaxB")]),y=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Xn,isSigner:!1,isWritable:!1},{pubkey:tu,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return Qb.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:b.toString()}),f.encode({lpAmount:d,amountMaxA:p,amountMaxB:b},g),new ci({keys:y,programId:o,data:Buffer.from([...li.deposit,...g])})}function Dl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b){let f=E([w("lpAmount"),w("amountMinA"),w("amountMinB")]),y=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Xn,isSigner:!1,isWritable:!1},{pubkey:tu,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:an,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:d,amountMinA:p,amountMinB:b},g),new ci({keys:y,programId:o,data:Buffer.from([...li.withdraw,...g])})}function is(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f){let y=E([w("amountIn"),w("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(y.span);return y.encode({amountIn:b,amounOutMin:f},P),new ci({keys:g,programId:o,data:Buffer.from([...li.swapBaseInput,...P])})}function Wl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f){let y=E([w("amountInMax"),w("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(y.span);return y.encode({amountInMax:b,amountOut:f},P),new ci({keys:g,programId:o,data:Buffer.from([...li.swapBaseOutput,...P])})}async function ql(o){var y;let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:i,getEphemeralSigners:r}=o,s=[],[a,c]=[new Eo(t.id),new Eo(t.lpMint.address)],u;if(r)u=new Eo((await r(1))[0]);else{let g=Gb.generate();s.push(g),u=g.publicKey}let{publicKey:l}=ee(i,u,Xn),{publicKey:m}=Tn(u),{publicKey:d}=ns(o.lockProgram,u),{publicKey:p}=ee(e.wallet,c,Xn),{publicKey:b}=ee(o.lockAuthProgram,c,Xn),f=zb({programId:o.lockProgram,auth:o.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:i,nftMint:u,nftAccount:l,poolId:a,lockPda:d,mintLp:c,userLpVault:p,lockLpVault:b,poolVaultA:new Eo(n.vault.A),poolVaultB:new Eo(n.vault.B),metadataAccount:m,lpAmount:o.lpAmount,withMetadata:(y=o.withMetadata)!=null?y:!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:m,lockPda:d,userLpVault:p,lockLpVault:b},instructions:[f],signers:s,instructionTypes:[X.CpmmLockLp],lookupTableAddress:[]}}function zb({programId:o,auth:e,payer:t,liquidityOwner:n,nftOwner:i,nftMint:r,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:m,poolVaultA:d,poolVaultB:p,metadataAccount:b,lpAmount:f,withMetadata:y}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Xb.programId,isSigner:!1,isWritable:!1},{pubkey:Xn,isSigner:!1,isWritable:!1},{pubkey:_l,isSigner:!1,isWritable:!1},{pubkey:Qt,isSigner:!1,isWritable:!1}],P=E([w("lpAmount"),De("withMetadata")]),k=Buffer.alloc(P.span);P.encode({lpAmount:f,withMetadata:y},k);let T=Buffer.from([...li.lockCpLiquidity,...k]);return new ci({keys:g,programId:o,data:T})}function Ul({programId:o,nftOwner:e,auth:t,nftAccount:n,lockPda:i,poolId:r,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:m,mintB:d,lockLpVault:p,lpFeeAmount:b,cpmmProgram:f,cpmmAuthProgram:y}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:f!=null?f:Hi,isSigner:!1,isWritable:!1},{pubkey:y!=null?y:js,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Xn,isSigner:!1,isWritable:!1},{pubkey:tu,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1}],P=E([w("lpFeeAmount")]),k=Buffer.alloc(P.span);P.encode({lpFeeAmount:b},k);let T=Buffer.from([...li.collectCpFee,...k]);return new ci({keys:g,programId:o,data:T})}var Gl=E([Ie(8),q("bump"),De("disableCreatePool"),$t("index"),w("tradeFeeRate"),w("protocolFeeRate"),w("fundFeeRate"),w("createPoolFee"),N("protocolOwner"),N("fundOwner"),z(w(),16)]),os=E([Ie(8),N("configId"),N("poolCreator"),N("vaultA"),N("vaultB"),N("mintLp"),N("mintA"),N("mintB"),N("mintProgramA"),N("mintProgramB"),N("observationId"),q("bump"),q("status"),q("lpDecimals"),q("mintDecimalA"),q("mintDecimalB"),w("lpAmount"),w("protocolFeesMintA"),w("protocolFeesMintB"),w("fundFeesMintA"),w("fundFeesMintB"),w("openTime"),z(w(),32)]);var _o=class extends ve{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await Oe(this.scope.connection,e.map(m=>({pubkey:new j(m)}))),i={},r=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=os.decode(d.accountInfo.data);i[String(e[m])]=U(v({},p),{programId:d.accountInfo.owner}),r.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...r],d=await Oe(this.scope.connection,m.map(p=>({pubkey:new j(p)})));for(let p=0;p<m.length;p++){let b=d[p].accountInfo;if(b===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=Gl.decode(b.data)}}let c={},u=await Oe(this.scope.connection,s.map(m=>({pubkey:new j(m)})));for(let m=0;m<s.length;m++){let d=u[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);c[String(s[m])]=new He(jb.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(i)){let p=c[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),b=c[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=U(v({},d),{baseReserve:p,quoteReserve:b,vaultAAmount:c[d.vaultA.toString()],vaultBAmount:c[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new O(b.toString()).div(new O(10).pow(d.mintDecimalB)).div(new O(p.toString()).div(new O(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,i)=>{var c,u,l,m;let r=e[i],[s,a]=[r.mintA.toBase58(),r.mintB.toBase58()];return U(v({},n),{[i]:U(v({},r),{id:new j(i),configInfo:r.configInfo,version:7,authority:Ni(r.programId).publicKey,mintA:wt({address:s,decimals:r.mintDecimalA,programId:r.mintProgramA.toBase58(),extensions:{feeConfig:(c=t[s])!=null&&c.feeConfig?qn((u=t[s])==null?void 0:u.feeConfig):void 0}}),mintB:wt({address:a,decimals:r.mintDecimalB,programId:r.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?qn((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await fi({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),i=wt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?qn(n[t.mintA.toBase58()].feeConfig):void 0}}),r=wt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?qn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=wt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:tn.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:i,mintB:r,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new O(t.vaultAAmount.toString()).div(10**i.decimals).toNumber(),mintAmountB:new O(t.vaultBAmount.toString()).div(10**r.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:i,mintB:r,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Ni(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:vo(t.programId,new j(e)).publicKey.toBase58()},rpcData:t}}async createPool(b){var f=b,{poolId:e,programId:t,poolFeeAccount:n,startTime:i,ownerInfo:r,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=f,p=We(f,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig","txTipConfig","feePayer"]);var W,Y,se;let y=r.feePayer||((W=this.scope.owner)==null?void 0:W.publicKey),g=new He(new j(p.mintA.address).toBuffer()).lte(new He(new j(p.mintB.address).toBuffer())),[P,k]=g?[p.mintA,p.mintB]:[p.mintB,p.mintA],[T,I]=g?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],h=r.useSOLBalance&&P.address===rs.toBase58(),S=r.useSOLBalance&&k.address===rs.toBase58(),[x,K]=[new j(P.address),new j(k.address)],B=this.createTxBuilder(d),{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:P.programId,owner:this.scope.ownerPubKey,createInfo:h?{payer:y,amount:T}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:s,checkCreateATAOwner:a});B.addInstruction(L||{});let{account:R,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({mint:new j(k.address),tokenProgram:k.programId,owner:this.scope.ownerPubKey,createInfo:S?{payer:y,amount:I}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:s,checkCreateATAOwner:a});if(B.addInstruction(D||{}),C===void 0||R===void 0)throw Error("you don't has some token account");let F=El({poolId:e,programId:t,configId:new j(u.id),mintA:x,mintB:K});return B.addInstruction({instructions:[Vl(t,this.scope.ownerPubKey,new j(u.id),F.authority,F.poolId,x,K,F.lpMint,C,R,ee(this.scope.ownerPubKey,F.lpMint).publicKey,F.vaultA,F.vaultB,n,new j((Y=P.programId)!=null?Y:tn),new j((se=k.programId)!=null?se:tn),F.observationId,T,I,i)],instructionTypes:[X.CpmmCreatePool]}),B.addCustomComputeBudget(l),B.addTipInstruction(m),B.versionBuild({txVersion:c,extInfo:{address:U(v({},F),{mintA:P,mintB:k,programId:t,poolFeeAccount:n,feeConfig:u})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:i,baseIn:r,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:m,feePayer:d}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),i.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:i.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:b,checkCreateATAOwner:f}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},l),y=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:P,anotherAmount:k}=a||this.computePairAmount({poolInfo:U(v({},t),{lpAmount:new O(y.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:y.baseReserve,quoteReserve:y.quoteReserve,slippage:new Xe(0),baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new O(i.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),T=k.amount,I=t.mintA.address===rs.toString(),h=t.mintB.address===rs.toString(),S=this.createTxBuilder(d),[x,K]=[new j(t.mintA.address),new j(t.mintB.address)],{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||(r?i:T).isZero()?{payer:this.scope.ownerPubKey,amount:r?i:T}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!1,checkCreateATAOwner:f});S.addInstruction(C||{});let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||(r?T:i).isZero()?{payer:this.scope.ownerPubKey,amount:r?T:i}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!1,checkCreateATAOwner:f});S.addInstruction(R||{}),!B&&!L&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let D=await p.getCreatedTokenAccount({mint:new j(t.lpMint.address)}),we=await p.handleTokenAccount({side:"out",amount:0,mint:new j(t.lpMint.address),tokenAccount:D,bypassAssociatedCheck:b,checkCreateATAOwner:f}),{tokenAccount:F}=we,W=We(we,["tokenAccount"]);S.addInstruction(W);let Y=n!=null?n:await this.getCpmmPoolKeys(t.id),se=new Xe(new He(1)).sub(s);return S.addInstruction({instructions:[Fl(new j(t.programId),this.scope.ownerPubKey,new j(Y.authority),new j(t.id),F,B,L,new j(Y.vault.A),new j(Y.vault.B),x,K,new j(t.lpMint.address),a?a==null?void 0:a.liquidity:se.mul(g).quotient,r?P.amount:T,r?T:P.amount)],instructionTypes:[X.CpmmAddLiquidity],lookupTableAddress:Y.lookupTableAccount?[Y.lookupTableAccount]:[]}),S.addCustomComputeBudget(c),S.addTipInstruction(u),S.versionBuild({txVersion:m})}async withdrawLiquidity(e){var W,Y;let{poolInfo:t,poolKeys:n,lpAmount:i,slippage:r,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let m=new Xe(new He(1)).sub(r),d=await this.getRpcPoolInfo(t.id),[p,b]=[m.mul(i.mul(d.baseReserve).div(d.lpAmount)).quotient,m.mul(i.mul(d.quoteReserve).div(d.lpAmount)).quotient],f=await this.scope.fetchEpochInfo(),[y,g]=[Te(p,t.mintA.extensions.feeConfig,f,!1),Te(b,t.mintB.extensions.feeConfig,f,!1)],{account:P}=this.scope,k=this.createTxBuilder(u),[T,I]=[new j(t.mintA.address),new j(t.mintB.address)],h=T.equals($),S=I.equals($),x,K,{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(h&&l),associatedOnly:!h,checkCreateATAOwner:!1});x=B,C&&k.addInstruction(C);let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),notUseTokenAccount:S,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(S&&l),associatedOnly:!S,checkCreateATAOwner:!1});K=L,R&&k.addInstruction(R),(!x||!K)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",P.tokenAccounts);let D=await P.getCreatedTokenAccount({mint:new j(t.lpMint.address)});D||this.logAndCreateError("cannot found lp token account","tokenAccounts",P.tokenAccounts);let F=n!=null?n:await this.getCpmmPoolKeys(t.id);return k.addInstruction({instructions:[Dl(new j(t.programId),this.scope.ownerPubKey,new j(F.authority),new j(t.id),D,x,K,new j(F.vault.A),new j(F.vault.B),T,I,new j(t.lpMint.address),i,p.sub((W=y.fee)!=null?W:new He(0)),b.sub((Y=g.fee)!=null?Y:new He(0)))],instructionTypes:[X.CpmmWithdrawLiquidity],lookupTableAddress:F.lookupTableAccount?[F.lookupTableAccount]:[]}),k.addCustomComputeBudget(s),k.addTipInstruction(a),k.versionBuild({txVersion:c})}async swap(e){var C,L,R,D,F,W;let{poolInfo:t,poolKeys:n,baseIn:i,fixedOut:r,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,{bypassAssociatedCheck:b,checkCreateATAOwner:f,associatedOnly:y}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},u),g=this.createTxBuilder(p),[P,k]=[new j(t.mintA.address),new j(t.mintB.address)];r?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new He((1+c)*1e4)).div(new He(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new He((1-c)*1e4)).div(new He(1e4));let T=t.mintA.address===$.toBase58(),I=t.mintB.address===$.toBase58(),{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:P,tokenProgram:new j((C=t.mintA.programId)!=null?C:tn),owner:this.scope.ownerPubKey,createInfo:T||!i?{payer:this.scope.ownerPubKey,amount:i?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:T,skipCloseAccount:!T,associatedOnly:T?!1:y,checkCreateATAOwner:f});S&&g.addInstruction(S);let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:k,tokenProgram:new j((L=t.mintB.programId)!=null?L:tn),owner:this.scope.ownerPubKey,createInfo:I||i?{payer:this.scope.ownerPubKey,amount:i?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:y,checkCreateATAOwner:f});K&&g.addInstruction(K),(!h||!x)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:h,mintBTokenAcc:x,mintAUseSOLBalance:T,mintBUseSOLBalance:I,associatedOnly:y});let B=n!=null?n:await this.getCpmmPoolKeys(t.id);return g.addInstruction({instructions:[r?Wl(new j(t.programId),this.scope.ownerPubKey,new j(B.authority),new j(B.config.id),new j(t.id),i?h:x,i?x:h,new j(B.vault[i?"A":"B"]),new j(B.vault[i?"B":"A"]),new j((F=t[i?"mintA":"mintB"].programId)!=null?F:tn),new j((W=t[i?"mintB":"mintA"].programId)!=null?W:tn),i?P:k,i?k:P,vo(new j(t.programId),new j(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):is(new j(t.programId),this.scope.ownerPubKey,new j(B.authority),new j(B.config.id),new j(t.id),i?h:x,i?x:h,new j(B.vault[i?"A":"B"]),new j(B.vault[i?"B":"A"]),new j((R=t[i?"mintA":"mintB"].programId)!=null?R:tn),new j((D=t[i?"mintB":"mintA"].programId)!=null?D:tn),i?P:k,i?k:P,vo(new j(t.programId),new j(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[r?X.CpmmSwapBaseOut:X.ClmmSwapBaseIn]}),g.addCustomComputeBudget(l),g.addTipInstruction(m),g.versionBuild({txVersion:d})}async lockLp(e){var d,p,b,f,y;let{poolInfo:t,lpAmount:n,computeBudgetConfig:i,txTipConfig:r,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=(d=e.poolKeys)!=null?d:await this.getCpmmPoolKeys(t.id),m=await ql({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:(p=e.feePayer)!=null?p:this.scope.ownerPubKey},feeNftOwner:c!=null?c:this.scope.ownerPubKey,lockProgram:(b=e.programId)!=null?b:Yi,lockAuthProgram:(f=e.authProgram)!=null?f:Zi,lpAmount:n,withMetadata:(y=e.withMetadata)!=null?y:!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(m),u.addCustomComputeBudget(i),u.addTipInstruction(r),u.versionBuild({txVersion:s,extInfo:m.address})}async harvestLockLp(e){var L;let{poolInfo:t,lpFeeAmount:n,nftMint:i,programId:r=Yi,authProgram:s=Zi,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:m=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let d=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(d),[b,f]=[new j(t.mintA.address),new j(t.mintB.address)],y=b.equals($),g=f.equals($),P,k,{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(y&&m),associatedOnly:!y,checkCreateATAOwner:!1});P=T,I&&p.addInstruction(I);let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&m),associatedOnly:!g,checkCreateATAOwner:!1});k=h,S&&p.addInstruction(S),(!P||!k)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:P,tokenAccountB:k});let x=(L=e.poolKeys)!=null?L:await this.getCpmmPoolKeys(t.id),{publicKey:K}=ee(d,i,tn),{publicKey:B}=ns(r,i),{publicKey:C}=ee(s,new j(t.lpMint.address),tn);return p.addInstruction({instructions:[Ul({programId:r!=null?r:Yi,nftOwner:this.scope.ownerPubKey,auth:s!=null?s:Zi,nftMint:i,nftAccount:K,lockPda:B,poolId:new j(t.id),mintLp:new j(x.mintLp.address),userVaultA:P,userVaultB:k,poolVaultA:new j(x.vault.A),poolVaultB:new j(x.vault.B),mintA:b,mintB:f,lockLpVault:C,lpFeeAmount:n,cpmmProgram:a==null?void 0:a.programId,cpmmAuthProgram:a==null?void 0:a.authProgram})],instructionTypes:[X.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:i}){let r=n.toString()===e.mintB.address,s=ts.swap(t,r?e.baseReserve:e.quoteReserve,r?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new O(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new He((1-i)*1e4)).div(new He(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:i,slippage:r,epochInfo:s,baseIn:a}){var T,I,h,S,x,K,B,C,L;let c=1-Number(r.toSignificant())/100,u=new He(new O(i).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=Te(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=u.sub((T=l.fee)!=null?T:new He(0)),d=new He(new O(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",(h=(I=l.fee)==null?void 0:I.toString())!=null?h:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${r.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let b=m.mul(d).div(p==="base"?t:n),f={amount:$e,fee:void 0,expirationTime:void 0};if(!m.isZero()){let R=Hb(b,t,n,d);this.logDebug("lpAmountData:",{amountA:R.amountA.toString(),amountB:R.amountB.toString()}),f=Te(R[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let y=new Xe(new He(1)).add(r),g=new Xe(new He(1)).sub(r),P=Te(y.mul(f.amount.sub((S=f.fee)!=null?S:new He(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),k=Te(g.mul(f.amount.sub((x=f.fee)!=null?x:new He(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",(B=(K=f.fee)==null?void 0:K.toString())!=null?B:0,"maxAnotherAmount:",P.amount.toString(),"maxAnotherAmountFee:",(L=(C=P.fee)==null?void 0:C.toString())!=null?L:0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:P,minAnotherAmount:k,liquidity:b}}};function Hb(o,e,t,n){let i=o.mul(e).div(n);!i.isZero()&&!o.mul(e).mod(n).isZero()&&(i=i.add(new He(1)));let r=o.mul(t).div(n);return!r.isZero()&&!o.mul(t).mod(n).isZero()&&(r=r.add(new He(1))),{amountA:i,amountB:r}}import{PublicKey as mi}from"@solana/web3.js";import{createTransferInstruction as Yl,TOKEN_PROGRAM_ID as Ye,TOKEN_2022_PROGRAM_ID as us}from"@solana/spl-token";import cs from"bn.js";var Xl={[wr.toBase58()]:3},Ql={3:wr};var nu=E([Ie(5),Ie(8),N("ownAddress"),w("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),N("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),Ie(7)]),zl={3:nu};import{PublicKey as jl}from"@solana/web3.js";var ss=be("Serum"),as=class{static getProgramId(e){let t=Ql[e];return t||ss.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Xl[t];return n||ss.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=zl[e];return t||ss.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,r;for(;i<100;){try{let s=n.concat(Buffer.from([i]),Buffer.alloc(7));r=jl.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;i++;continue}return{publicKey:r,nonce:i}}return ss.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:jl.default,nonce:i}}};import{PublicKey as M,SystemProgram as Vo,TransactionInstruction as Fo}from"@solana/web3.js";import ln from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as iu,TOKEN_2022_PROGRAM_ID as ou,TOKEN_PROGRAM_ID as Qn}from"@solana/spl-token";function zC(o,e,t,n,i,r,s,a,c,u,l,m){let d=E([q("instruction"),w("amountIn"),w("amountOut")]),p=[{pubkey:Vo.programId,isSigner:!1,isWritable:!1},{pubkey:Qn,isSigner:!1,isWritable:!1},{pubkey:new M(t.programId),isSigner:!1,isWritable:!1},{pubkey:new M(t.id),isSigner:!1,isWritable:!0},{pubkey:new M(n.id),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Me(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...m.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Me(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new M("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Me(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let b=Buffer.alloc(d.span);return d.encode({instruction:4,amountIn:u,amountOut:l},b),new Fo({keys:p,programId:o,data:b})}function jC(o,e,t,n,i,r,s,a,c,u){let l=E([q("instruction")]),m=[{pubkey:Vo.programId,isSigner:!1,isWritable:!1},{pubkey:Qn,isSigner:!1,isWritable:!1},{pubkey:new M(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new M(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new M(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Me(n);m.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...u.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Me(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new M("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Me(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let d=Buffer.alloc(l.span);return l.encode({instruction:5},d),new Fo({keys:m,programId:o,data:d})}function Yb(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b){var h;let f=[],y=[A({pubkey:Qn,isWritable:!1}),A({pubkey:ou,isWritable:!1}),A({pubkey:iu,isWritable:!1}),A({pubkey:Vo.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})];y.push(A({pubkey:t})),y.push(A({pubkey:i}));let g=[c,u],P=[l,m],k=[r,s,a];for(let S=0;S<g.length;S++){let x=g[S],K=k[S]===x.mintA.address;if(y.push(A({pubkey:new M(x.programId),isWritable:!1})),S===g.length-1?y.push(A({pubkey:i})):y.push(A({pubkey:n})),y.push(A({pubkey:new M(k[S])})),y.push(A({pubkey:new M(k[S+1])})),x.version===6){let B=P[S];y.push(A({pubkey:new M(B.config.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(K?B.vault.A:B.vault.B)})),y.push(A({pubkey:new M(K?B.vault.B:B.vault.A)})),y.push(A({pubkey:new M(x.observationId)})),y.push(A({pubkey:an})),y.push(A({pubkey:je(new M(x.programId),new M(x.id)).publicKey})),f.push(ru(x.sqrtPriceX64.toString(),K));for(let C of(h=b[S])!=null?h:[])y.push(A({pubkey:new M(C)}))}else if(x.version===5){let B=P[S];y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.authority),isWritable:!1})),y.push(A({pubkey:new M(B.marketProgramId)})),y.push(A({pubkey:new M(B.marketAuthority)})),y.push(A({pubkey:kr,isWritable:!1})),y.push(A({pubkey:new M(B.openOrders)})),y.push(A({pubkey:new M(B.vault.A)})),y.push(A({pubkey:new M(B.vault.B)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.marketId)})),y.push(A({pubkey:new M(B.marketBids)})),y.push(A({pubkey:new M(B.marketAsks)})),y.push(A({pubkey:new M(B.marketEventQueue)})),y.push(A({pubkey:new M(B.marketBaseVault)})),y.push(A({pubkey:new M(B.marketQuoteVault)}))}else if(x.version===4){let B=P[S],C=x.status!==1;y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.authority),isWritable:!1})),y.push(A({pubkey:new M(C?B.id:B.marketProgramId)})),y.push(A({pubkey:new M(C?B.id:B.marketAuthority)})),y.push(A({pubkey:new M(C?B.id:B.openOrders)})),y.push(A({pubkey:new M(B.vault.A)})),y.push(A({pubkey:new M(B.vault.B)})),y.push(A({pubkey:new M(C?B.id:B.marketId)})),y.push(A({pubkey:new M(C?B.id:B.marketBids)})),y.push(A({pubkey:new M(C?B.id:B.marketAsks)})),y.push(A({pubkey:new M(C?B.id:B.marketEventQueue)})),y.push(A({pubkey:new M(C?B.id:B.marketBaseVault)})),y.push(A({pubkey:new M(C?B.id:B.marketQuoteVault)}))}else if(x.version===7){let B=P[S];y.push(A({pubkey:new M(B.authority)})),y.push(A({pubkey:new M(B.config.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(K?B.vault.A:B.vault.B)})),y.push(A({pubkey:new M(K?B.vault.B:B.vault.A)})),y.push(A({pubkey:new M(x.observationId)}))}else throw Error("pool type error")}let T=E([q("insId"),w("amountIn"),w("amountOut"),z(te(),f.length,"clmmPriceLimit")]),I=Buffer.alloc(T.span);return T.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:f},I),new Fo({keys:y,programId:o,data:I})}function ru(o,e){if(o)if(e){let t=new ln(o).div(new ln(25));return t.gt(Vr)?t:Vr}else{let t=new ln(o).mul(new ln(25));return t.lt(Fr)?t:Fr}else return e?Vr:Fr}function Hl({routeProgram:o,ownerInfo:e,inputMint:t,swapInfo:n}){var i,r,s,a,c,u,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=Me(m),p=t.equals(d.mintA.address)?Vt.add(Ot):Ft.sub(Ot);return Ke.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((r=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?r:new ln(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[is(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new M(m[d?"mintA":"mintB"].address),new M(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?X.CpmmSwapBaseIn:X.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[Qr({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((c=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?c:new ln(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?X.AmmV5SwapBaseIn:X.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],b=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Yb(o,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,b,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?l:new ln(0)),n.remainingAccounts)],instructionTypes:[X.RouteSwap],lookupTableAddress:[p.lookupTableAccount,b.lookupTableAccount].filter(f=>f!==void 0),address:{}}}else throw Error("route type error")}function HC({programId:o,wallet:e,amount:t,inputAccount:n,outputAccount:i,routeInfo:r,poolKeys:s}){var d;if(r.success===!1)throw Error("route info error");let a=[],c=[A({pubkey:Qn,isWritable:!1}),A({pubkey:ou,isWritable:!1}),A({pubkey:iu,isWritable:!1}),A({pubkey:Vo.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})],u={[r.data.inputMint]:n,[r.data.outputMint]:i};c.push(A({pubkey:u[r.data.inputMint]})),c.push(A({pubkey:u[r.data.outputMint]}));for(let p=0;p<s.length;p++){let b=r.data.routePlan[p],f=s[p],y=b.inputMint===f.mintA.address;if(c.push(A({pubkey:new M(f.programId),isWritable:!1})),p===s.length-1)c.push(A({pubkey:u[b.outputMint]}));else{let g=b.outputMint;if(u[g]===void 0){let P=ee(e,new M(g),f.programId===Tt.CLMM_PROGRAM_ID.toBase58()||f.programId===Tt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new M(y?f.mintB.programId:f.mintA.programId):Qn).publicKey;u[g]=P}c.push(A({pubkey:u[g]}))}if(c.push(A({pubkey:new M(b.inputMint)})),c.push(A({pubkey:new M(b.outputMint)})),f.programId===Tt.CLMM_PROGRAM_ID.toBase58()){let g=f;c.push(A({pubkey:new M(g.config.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(y?g.vault.A:g.vault.B)})),c.push(A({pubkey:new M(y?g.vault.B:g.vault.A)})),c.push(A({pubkey:new M(g.observationId)})),c.push(A({pubkey:an,isWritable:!1})),c.push(A({pubkey:new M(g.exBitmapAccount)})),a.push(ru(b.lastPoolPriceX64,y));for(let P of(d=b.remainingAccounts)!=null?d:[])c.push(A({pubkey:new M(P)}))}else if(f.programId===Tt.AMM_STABLE.toBase58()){let g=f;c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.authority),isWritable:!1})),c.push(A({pubkey:new M(g.marketProgramId),isWritable:!1})),c.push(A({pubkey:new M(g.marketAuthority),isWritable:!1})),c.push(A({pubkey:kr,isWritable:!1})),c.push(A({pubkey:new M(g.openOrders)})),c.push(A({pubkey:new M(g.vault.A)})),c.push(A({pubkey:new M(g.vault.B)})),c.push(A({pubkey:new M(g.marketId)})),c.push(A({pubkey:new M(g.marketBids)})),c.push(A({pubkey:new M(g.marketAsks)})),c.push(A({pubkey:new M(g.marketEventQueue)})),c.push(A({pubkey:new M(g.marketBaseVault)})),c.push(A({pubkey:new M(g.marketQuoteVault)}))}else if(f.programId===Tt.AMM_V4.toBase58()){let g=f;c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.authority),isWritable:!1})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.vault.A)})),c.push(A({pubkey:new M(g.vault.B)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)}))}else if(f.programId===Tt.CREATE_CPMM_POOL_PROGRAM.toBase58()){let g=f;c.push(A({pubkey:new M(g.authority)})),c.push(A({pubkey:new M(g.config.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(y?g.vault.A:g.vault.B)})),c.push(A({pubkey:new M(y?g.vault.B:g.vault.A)})),c.push(A({pubkey:new M(g.observationId)}))}else throw Error("pool type error")}let l=E([q("insId"),w("amountIn"),w("amountOut"),z(te(),a.length,"clmmPriceLimit")]),m=Buffer.alloc(l.span);return l.encode({insId:0,amountIn:t,amountOut:new ln(r.data.otherAmountThreshold),clmmPriceLimit:a},m),new Fo({keys:c,programId:o,data:m})}function YC({programId:o,wallet:e,inputAccount:t,outputAccount:n,routeInfo:i,poolKeys:r}){var m;if(i.success===!1)throw Error("route info error");let s=[],a=[A({pubkey:Qn,isWritable:!1}),A({pubkey:ou,isWritable:!1}),A({pubkey:iu,isWritable:!1}),A({pubkey:Vo.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})],c={[i.data.inputMint]:t,[i.data.outputMint]:n};for(let d=r.length-1;d>=0;d--){let p=i.data.routePlan[d],b=r[d],f=p.inputMint===b.mintA.address;if(a.push(A({pubkey:new M(b.programId)})),d===0)a.push(A({pubkey:c[p.inputMint]}));else{let y=p.inputMint;if(c[y]===void 0){let g=ee(e,new M(y),b.programId===Tt.CLMM_PROGRAM_ID.toBase58()||b.programId===Tt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new M(f?b.mintA.programId:b.mintB.programId):Qn).publicKey;c[y]=g}a.push(A({pubkey:c[y]}))}if(d===r.length-1)a.push(A({pubkey:c[p.outputMint]}));else{let y=p.outputMint;if(c[y]===void 0){let g=ee(e,new M(y),b.programId===Tt.CLMM_PROGRAM_ID.toBase58()||b.programId===Tt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new M(f?b.mintB.programId:b.mintA.programId):Qn).publicKey;c[y]=g}a.push(A({pubkey:c[y]}))}if(a.push(A({pubkey:new M(p.inputMint)})),a.push(A({pubkey:new M(p.outputMint)})),b.programId===Tt.CLMM_PROGRAM_ID.toBase58()){let y=b;a.push(A({pubkey:new M(y.config.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(f?y.vault.A:y.vault.B)})),a.push(A({pubkey:new M(f?y.vault.B:y.vault.A)})),a.push(A({pubkey:new M(y.observationId)})),a.push(A({pubkey:an,isWritable:!1})),a.push(A({pubkey:new M(y.exBitmapAccount)})),s.push(ru(p.lastPoolPriceX64,f));for(let g of(m=p.remainingAccounts)!=null?m:[])a.push(A({pubkey:new M(g)}))}else if(b.programId===Tt.AMM_STABLE.toBase58()){let y=b;a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.authority),isWritable:!1})),a.push(A({pubkey:new M(y.marketProgramId),isWritable:!1})),a.push(A({pubkey:new M(y.marketAuthority),isWritable:!1})),a.push(A({pubkey:kr,isWritable:!1})),a.push(A({pubkey:new M(y.openOrders)})),a.push(A({pubkey:new M(y.vault.A)})),a.push(A({pubkey:new M(y.vault.B)})),a.push(A({pubkey:new M(y.marketId)})),a.push(A({pubkey:new M(y.marketBids)})),a.push(A({pubkey:new M(y.marketAsks)})),a.push(A({pubkey:new M(y.marketEventQueue)})),a.push(A({pubkey:new M(y.marketBaseVault)})),a.push(A({pubkey:new M(y.marketQuoteVault)}))}else if(b.programId===Tt.AMM_V4.toBase58()){let y=b;a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.authority),isWritable:!1})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.vault.A)})),a.push(A({pubkey:new M(y.vault.B)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)}))}else if(b.programId===Tt.CREATE_CPMM_POOL_PROGRAM.toBase58()){let y=b;a.push(A({pubkey:new M(y.authority)})),a.push(A({pubkey:new M(y.config.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(f?y.vault.A:y.vault.B)})),a.push(A({pubkey:new M(f?y.vault.B:y.vault.A)})),a.push(A({pubkey:new M(y.observationId)}))}else throw Error("pool type error")}let u=E([q("insId"),w("amountIn"),w("amountOut"),z(te(),s.length,"clmmPriceLimit")]),l=Buffer.alloc(u.span);return u.encode({insId:1,amountIn:new ln(i.data.otherAmountThreshold),amountOut:new ln(i.data.outputAmount),clmmPriceLimit:s},l),new Fo({keys:a,programId:o,data:l})}var Sn=new cs(0),Do=class extends ve{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals($));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1,feePayer:r}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(r);a.addCustomComputeBudget(e.computeBudgetConfig);let c=J(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[kn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[kn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:i})}async wrapWSol(e,t,n,i){let r=this.createTxBuilder(i),s=await Fn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return r.addInstruction(s),r.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:r,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,m=u.amount.token.mint.equals($),d=l.amount.token.mint.equals($),p=u.amount.token.mint,b=l.amount.token.mint,{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?us:Ye,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:m?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(y&&c.addInstruction(y),f===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!d)g=this.scope.account.getAssociatedTokenAccount(b,l.amount.token.isToken2022?us:Ye);else{let{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?us:Ye,mint:b,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=I,h&&c.addInstruction(h)}d&&c.addInstruction({endInstructions:[kn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:Ye})],endInstructionTypes:[X.CloseAccount]});let P;if(e.routeType==="route"){let I=e.middleToken;P=this.scope.account.getAssociatedTokenAccount(I.mint,I.isToken2022?us:Ye)}let k=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),T=Hl({routeProgram:r,inputMint:p,swapInfo:U(v({},e),{poolInfo:[...e.poolInfoList],poolKey:k,outputMint:b}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:P,destinationToken:g}});if(e.feeConfig!==void 0){let I=this.createTxBuilder();I.addInstruction({instructions:[Yl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[X.TransferAmount]}),I.addInstruction(T);let{transactions:h}=s===0?await I.sizeCheckBuildV0():await I.sizeCheckBuild();h.length<2&&c.addInstruction({instructions:[Yl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[X.TransferAmount]})}return c.addInstruction(T),s===0?c.sizeCheckBuildV0({computeBudgetConfig:i,address:T.address}):c.sizeCheckBuild({computeBudgetConfig:i,address:T.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=zi,clmm:n=vn,cpmm:i=Hi}=e||{},r=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:oi.offsetOf("baseMint"),length:64}}),s=E([N("baseMint"),N("quoteMint")]),a=r.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=E([N("mintA"),N("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:ni.span}],dataSlice:{offset:ni.offsetOf("mintA"),length:64}})).map(p=>{let b=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:b.mintA,mintB:b.mintB}}),d=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:os.offsetOf("mintA"),length:64}})).map(p=>{let b=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:b.mintA,mintB:b.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:r}){e=e.toString()===mi.default.toString()?$:e,t=t.toString()===mi.default.toString()?$:t;let s={},a={},c={},u=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of r)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),c[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Ye,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let b of p.in)for(let f of p.out)b.version===6&&a[b.id.toString()]===void 0?a[b.id.toString()]=b:b.version===7&&c[b.id.toString()]===void 0?c[b.id.toString()]=b:(b.version===4||b.version===5)&&s[b.id.toString()]===void 0&&(s[b.id.toString()]=b),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:u,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let r=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=jr(r),a={};Object.values(s).forEach(f=>{i.delete(f.mintA.address),a[f.mintA.address]={address:new mi(f.mintA.address),programId:Ye,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(f.mintB.address),a[f.mintB.address]={address:new mi(f.mintB.address),programId:Ye,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(c).forEach(f=>{let[y,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(Ye)?(i.delete(y),a[y]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(y),f.mintProgramB.equals(Ye)?(i.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let u=await fi({connection:this.scope.connection,mints:Array.from(i).map(f=>new mi(f))});a=v(v({},a),u);let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),b=Object.keys(e.routePathDict).reduce((f,y)=>U(v({},f),{[y]:U(v({},e.routePathDict[y]),{mintProgram:a[y].programId,mDecimals:a[y].decimals,in:e.routePathDict[y].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[y].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:r,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:b}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:r,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){var g,P,k,T,I,h,S,x,K;let m=l===void 0?new cs(0):e.raw.mul(new cs(l.feeBps.toNumber())).div(new cs(1e4)),d=e.raw.sub(m),p=new he(e.token,d),b=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},f=U(v({},t),{address:yt(t.address).toString()}),y=[];for(let B of n)try{y.push(U(v({},this.computeAmountOut({itemPool:B,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:p})),{feeConfig:b}))}catch(C){this.logDebug("direct error",B.version,B.id.toString(),C.message)}this.logDebug("direct done");for(let[B,C]of Object.entries(i)){let L={chainId:101,address:B,programId:C.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:C.mDecimals,tags:[],extensions:{}},R=C.in.map(F=>{try{return{pool:F,data:this.computeAmountOut({itemPool:F,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:L,amountIn:p})}}catch(W){this.logDebug("route in error",F.version,F.id.toString(),W.message);return}}).sort((F,W)=>{var we,ce,pe,Ce;let Y=F===void 0?Sn:F.data.amountOut.amount.raw.sub((ce=(we=F.data.amountOut.fee)==null?void 0:we.raw)!=null?ce:Sn),se=W===void 0?Sn:W.data.amountOut.amount.raw.sub((Ce=(pe=W.data.amountOut.fee)==null?void 0:pe.raw)!=null?Ce:Sn);return Y.lt(se)?1:-1})[0];if(R===void 0)continue;let D=new he(Gr(L),R.data.amountOut.amount.raw.sub((P=(g=R.data.amountOut.fee)==null?void 0:g.raw)!=null?P:Sn));for(let F of C.out)try{let W=this.computeAmountOut({itemPool:F,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:D});y.push(U(v({},W),{allTrade:!!(R.data.allTrade&&W.allTrade),amountIn:R.data.amountIn,amountOut:W.amountOut,minAmountOut:W.minAmountOut,currentPrice:void 0,executionPrice:new O(new ct({baseToken:R.data.amountIn.amount.token,denominator:R.data.amountIn.amount.raw,quoteToken:W.amountOut.amount.token,numerator:W.amountOut.amount.raw.sub((T=(k=W.amountOut.fee)==null?void 0:k.raw)!=null?T:Sn)}).toFixed()),priceImpact:new O(R.data.priceImpact.add(W.priceImpact).toFixed()),fee:[R.data.fee[0],W.fee[0]],routeType:"route",poolInfoList:[R.pool,F],remainingAccounts:[R.data.remainingAccounts[0],W.remainingAccounts[0]],minMiddleAmountFee:(I=W.amountOut.fee)!=null&&I.raw?new he(R.data.amountOut.amount.token,((S=(h=R.data.amountOut.fee)==null?void 0:h.raw)!=null?S:Sn).add((K=(x=W.amountOut.fee)==null?void 0:x.raw)!=null?K:Sn)):void 0,middleToken:R.data.amountOut.amount.token,poolReady:R.data.poolReady&&W.poolReady,poolType:[R.data.poolType,W.poolType],feeConfig:b,expirationTime:Ht(R.data.expirationTime,W.expirationTime)}))}catch(W){this.logDebug("route out error",F.version,F.id.toString(),W.message)}}return y.filter(B=>(B.allTrade||this.logDebug(`pool ${B.poolInfoList.map(C=>C.id.toString()).join(",")} filter out since not all trade`),B.allTrade)).sort((B,C)=>B.amountOut.amount.raw.sub(C.amountOut.amount.raw).gt(Sn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:r,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:b,executionPrice:f,priceImpact:y,fee:g,remainingAccounts:P,executionPriceX64:k}=Ne.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:r,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new O(b.toFixed()),executionPrice:new O(f.toFixed()),priceImpact:new O(y.toFixed()),fee:[g],remainingAccounts:[P],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:s,clmmExPriceX64:[k],expirationTime:Ht(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:b}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:xo(U(v({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:xo(U(v({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new he(c.token,b)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:b}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:xo(U(v({},a),{amount:u})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:xo(U(v({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new he(c.token,b)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(i.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let r=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(r.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(r));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Oe(this.scope.connection,Array.from(s).map(l=>({pubkey:new mi(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=nu.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:as.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],m={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:U(v({},u.ammConfig),{id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(m)}else if(u.version===4){let l=n[u.id.toString()],m=v({programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:Ya({programId:new mi(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint},a[u.marketId]);c.push(m)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Ni(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:wt({address:u.mintLp.toBase58(),programId:Ye.toBase58(),decimals:u.lpDecimals}),config:U(v({id:u.configId.toBase58()},u.configInfo),{protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()})})}),c}};import{PublicKey as Zb,Transaction as su,TransactionInstruction as $b}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Jb}from"@solana/spl-token";import Zl from"bn.js";var kt=class extends ve{static getPdaPoolId(e,t){return ie([kt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,i){return ie([kt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Zl(i).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:i,chainTime:r}){if(n.length===0)return[];let s=n.map(l=>kt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<kt.VERSION_PROJECT.length;l++)a.push(...s.map(m=>kt.getPdaOwnerId(t,m,i,l).publicKey));let c=await Ut(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],b=a[l],f=c[d],y=c[n.length+l];if(!(f&&y)||f.data.length!==kt.POOL_LAYOUT.span||y.data.length!==kt.OWNER_LAYOUT.span)continue;let g=kt.POOL_LAYOUT.decode(f.data),P=kt.OWNER_LAYOUT.decode(y.data),k=g.openTime.toNumber(),T=g.endTime.toNumber(),I=P.tokenInfo.map(x=>x.debtAmount.gt(new Zl(0))).filter(x=>!x).length!==3,h=r>k&&r<T&&g.status===1,S=I&&h;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:b,snapshotLpAmount:P.lpAmount,project:kt.VERSION_PROJECT[m],openTime:k,endTime:T,canClaim:S,canClaimErrorType:I?h?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((x,K)=>({mintAddress:x.mintAddress,mintVault:x.mintVault,mintDecimals:x.mintDecimals,perLpLoss:x.perLpLoss,debtAmount:P.tokenInfo[K].debtAmount.add(P.tokenInfo[K].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let i=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Be.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!u.mintAddress.equals(Be.WSOL.mint),associatedOnly:u.mintAddress.equals(Be.WSOL.mint)?!1:t.associatedOnly});m&&i.addInstruction(m),s.push(l)}i.addInstruction({instructions:[kt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:r,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=i.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let i=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let m=[];for(let d of l.tokenInfo){let{account:p,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({mint:d.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:d.mintAddress.equals(Be.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!d.mintAddress.equals(Be.WSOL.mint),associatedOnly:d.mintAddress.equals(Be.WSOL.mint)?!1:t.associatedOnly});b&&i.addInstruction(b),p&&(s[d.mintAddress.toString()]=p,m.push(p))}i.addInstruction({instructions:[kt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:r,ownerPda:l.ownerAccountId,claimAddress:m}})]})}let{transaction:a,signers:c}=i.build(),u=i.allInstructions;return Pr(u,[r,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new su().add(...u.slice(0,i.AllTxData.instructions.length-1)),signer:c},{transaction:new su().add(...u.slice(i.AllTxData.instructions.length-1)),signer:[]},{transaction:new su().add(...i.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let i=E([]),r=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:Jb,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new $b({keys:r,programId:e,data:a})}},Dt=kt;Dt.CLAIMED_NUM=3,Dt.POOL_LAYOUT=E([Ie(8),q("bump"),q("status"),w("openTime"),w("endTime"),N("ammId"),z(E([q("mintDecimals"),N("mintAddress"),N("mintVault"),w("perLpLoss"),w("totalClaimedAmount")]),kt.CLAIMED_NUM,"tokenInfo"),z(w(),10,"padding")]),Dt.OWNER_LAYOUT=E([Ie(8),q("bump"),q("version"),N("poolId"),N("owner"),w("lpAmount"),z(E([N("mintAddress"),w("debtAmount"),w("claimedAmount")]),kt.CLAIMED_NUM,"tokenInfo"),z(w(),4,"padding")]),Dt.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Zb(e)),Dt.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},Dt.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as qo}from"@solana/web3.js";import $l from"bn.js";import{SYSVAR_CLOCK_PUBKEY as ey,TransactionInstruction as uu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as cu}from"@solana/spl-token";var au=E([q("instruction"),Ac("amount")]),Wo=E([q("instruction")]);function U0({programId:o,amount:e,instructionKeys:t}){let n=[{pubkey:dr,isSigner:!1,isWritable:!1},{pubkey:cu,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Es,isSigner:!1,isWritable:!1},...Object.entries(t).map(([r,s])=>({pubkey:s,isSigner:r==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(r)}))],i=Buffer.alloc(au.span);return au.encode({instruction:1,amount:Number(e)},i),new uu({keys:n,programId:o,data:i})}function ls({programId:o},e){let t=[{pubkey:cu,isSigner:!1,isWritable:!1},{pubkey:Es,isSigner:!1,isWritable:!1},...Object.entries(e).map(([i,r])=>({pubkey:r,isSigner:i==="userOwner",isWritable:!["authority","userOwner"].includes(i)}))],n=Buffer.alloc(Wo.span);return Wo.encode({instruction:2},n),new uu({keys:t,programId:o,data:n})}function lu(o){let{poolConfig:e,userKeys:t,side:n}=o,i=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,r=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Wo.span);Wo.encode({instruction:2},s);let a=[{pubkey:cu,isWritable:!1,isSigner:!1},{pubkey:ey,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new uu({programId:e.programId,keys:a,data:s})}var ty={[$i.IDO_PROGRAM_ID_V1.toString()]:1,[$i.IDO_PROGRAM_ID_V2.toString()]:2,[$i.IDO_PROGRAM_ID_V3.toString()]:3,[$i.IDO_PROGRAM_ID_V4.toString()]:4},Oi=class extends ve{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:i=!1,txVersion:r,feePayer:s}){let a=this.createTxBuilder(s),c=ty[t.programId];c||this.logAndCreateError("invalid version",c);let u=Me(t),[l,m]=[!new $l(e.coin).isZero(),!new $l(e.pc).isZero()],d=u.projectInfo.mint.address.equals($),{account:p,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,notUseTokenAccount:d,associatedOnly:d?!1:n,checkCreateATAOwner:i});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&a.addInstruction(b);let f=u.buyInfo.mint.address.equals($),{account:y,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:n,checkCreateATAOwner:i});if(!p&&m&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),m&&g&&a.addInstruction(g),(!p||!y)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[ls({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new qo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...m?[ls({programId:new qo(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:y,userIdoInfo:new qo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:r});if(c<3)return!l&&!m&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[ls({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:y,userBaseTokenAccount:p,userIdoInfo:new qo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:r});let P={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:y,ledgerAccount:new qo(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[lu(U(v({},P),{side:"base"}))]:[],...m?[lu(U(v({},P),{side:"quote"}))]:[]]}).versionBuild({txVersion:r})}};var ny=Buffer.from("vault_auth_seed","utf8"),iy=Buffer.from("global_config","utf8"),oy=Buffer.from("pool","utf8"),ry=Buffer.from("pool_vault","utf8"),sy=Buffer.from("pool_vesting","utf8"),ay=Buffer.from("platform_config","utf8");function Uo(o){return ie([ny],o)}function u1(o,e,t,n){return ie([iy,e.toBuffer(),uy(t),Wr(n)],o)}function ms(o,e,t){return ie([oy,e.toBuffer(),t.toBuffer()],o)}function mu(o,e,t){return ie([ry,e.toBuffer(),t.toBuffer()],o)}function uy(o){let e=new ArrayBuffer(1);return new DataView(e).setUint8(0,o),new Uint8Array(e)}function Mi(o){return ie([Buffer.from("__event_authority","utf8")],o)}function du(o,e){return ie([ay,e.toBuffer()],o)}function Jl(o,e,t){return ie([sy,e.toBuffer(),t.toBuffer()],o)}import{SystemProgram as Go,TransactionInstruction as mn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as em}from"@solana/spl-token";import ds from"bn.js";var dn={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function tm(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I){let h=E([q("decimals"),Vn("name"),Vn("symbol"),Vn("uri")]),S=E([w("totalLockedAmount"),w("cliffPeriod"),w("unlockPeriod")]),x=E([q("index"),w("supply"),w("totalFundRaisingB"),q("migrateType")]),K=E([q("index"),w("supply"),w("totalSellA"),w("totalFundRaisingB"),q("migrateType")]),B=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Qt,isSigner:!1,isWritable:!1},{pubkey:Go.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Mi(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}],C=Buffer.alloc(Buffer.from(f,"utf-8").length+Buffer.from(y,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),L=Buffer.alloc(S.span),R=Buffer.alloc(P.type==="ConstantCurve"?K.span:x.span);return h.encode({decimals:b,name:f,symbol:y,uri:g},C),P.type==="ConstantCurve"?K.encode(U(v({index:0},P),{migrateType:P.migrateType==="amm"?0:1}),R):P.type==="FixedCurve"?x.encode(U(v({index:1},P),{migrateType:P.migrateType==="amm"?0:1}),R):P.type==="LinearCurve"&&x.encode(U(v({index:2},P),{migrateType:P.migrateType==="amm"?0:1}),R),S.encode({totalLockedAmount:k,cliffPeriod:T,unlockPeriod:I},L),new mn({keys:B,programId:o,data:Buffer.from([...dn.initialize,...C,...R,...L])})}function nm(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amountB"),w("minAmountA"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mi(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:b.toString(),minAmountA:f.toString()});let T=Buffer.alloc(P.span);return P.encode({amountB:b,minAmountA:f,shareFeeRate:y!=null?y:new ds(0)},T),new mn({keys:k,programId:o,data:Buffer.from([...dn.buyExactIn,...T])})}function A1(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amountA"),w("maxAmountB"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mi(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(P.span);return P.encode({amountA:b,maxAmountB:f,shareFeeRate:y!=null?y:new ds(0)},T),new mn({keys:k,programId:o,data:Buffer.from([...dn.buyExactOut,...T])})}function im(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amountA"),w("minAmountB"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mi(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(P.span);return P.encode({amountA:b,minAmountB:f,shareFeeRate:y!=null?y:new ds(0)},T),new mn({keys:k,programId:o,data:Buffer.from([...dn.sellExactIn,...T])})}function P1(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amountB"),w("maxAmountA"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mi(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(P.span);return P.encode({amountB:b,maxAmountA:f,shareFeeRate:y!=null?y:new ds(0)},T),new mn({keys:k,programId:o,data:Buffer.from([...dn.sellExactOut,...T])})}function w1(o,e,t,n,i,r,s,a,c){let u=E([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:Go.programId,isSigner:!1,isWritable:!1},{pubkey:em,isSigner:!1,isWritable:!1}],m=Buffer.alloc(u.span);return u.encode({},m),new mn({keys:l,programId:o,data:Buffer.from([...dn.claimVestedToken,...m])})}function om(o,e,t,n,i,r){let s=E([w("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Go.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:r},c),new mn({keys:a,programId:o,data:Buffer.from([...dn.createVestingAccount,...c])})}function rm(o,e,t,n,i,r,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Go.programId,isSigner:!1,isWritable:!0},{pubkey:em,isSigner:!1,isWritable:!0}];return new mn({keys:u,programId:o,data:dn.claimPlatformFee})}function sm(o,e,t,n,i,r,s,a,c,u){let l=E([w("platformScale"),w("creatorScale"),w("burnScale"),w("feeRate"),Vn("name"),Vn("web"),Vn("img")]),m=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Go.programId,isSigner:!1,isWritable:!1}],d=Buffer.alloc(8*4+Buffer.from(a,"utf-8").length+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+4*3);return l.encode({platformScale:r.platformScale,creatorScale:r.creatorScale,burnScale:r.burnScale,feeRate:s,name:a,web:c,img:u},d),new mn({keys:m,programId:o,data:Buffer.from([...dn.createPlatformConfig,...d])})}function am(o,e,t,n){let i=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],r;if(n.type==="updateClaimFeeWallet"){let s=E([q("index"),N("value")]);r=Buffer.alloc(s.span),s.encode({index:0,value:n.value},r)}else if(n.type==="updateLockNftWallet"){let s=E([q("index"),N("value")]);r=Buffer.alloc(s.span),s.encode({index:1,value:n.value},r)}else if(n.type==="migrateCpLockNftScale"){let s=E([q("index"),w("platformScale"),w("creatorScale"),w("burnScale")]);r=Buffer.alloc(s.span),s.encode(v({index:2},n.value),r)}else if(n.type==="updateFeeRate"){let s=E([q("index"),w("value")]);r=Buffer.alloc(s.span),s.encode({index:3,value:n.value},r)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=E([q("index"),Vn("value")]);r=Buffer.alloc(s.span),n.type==="updateName"?s.encode({index:4,value:n.value},r):n.type==="updateWeb"?s.encode({index:5,value:n.value},r):n.type==="updateImg"&&s.encode({index:6,value:n.value},r)}else throw Error("updateInfo params type error");return new mn({keys:i,programId:o,data:Buffer.from([...dn.updatePlaformConfig,...r])})}import{NATIVE_MINT as gs,TOKEN_PROGRAM_ID as Kn,createAssociatedTokenAccountIdempotentInstruction as cm}from"@solana/spl-token";import ye from"bn.js";import{PublicKey as lm}from"@solana/web3.js";var vi=E([w(),w("epoch"),q("curveType"),$t("index"),w("migrateFee"),w("tradeFeeRate"),w("maxShareFeeRate"),w("minSupplyA"),w("maxLockRate"),w("minSellRateA"),w("minMigrateRateA"),w("minFundRaisingB"),N("mintB"),N("protocolFeeOwner"),N("migrateFeeOwner"),N("migrateToAmmWallet"),N("migrateToCpmmWallet"),z(w(),16)]),cy=E([w("totalLockedAmount"),w("cliffPeriod"),w("unlockPeriod"),w("startTime"),w("totalAllocatedShare")]),Xo=E([w(),w("epoch"),q("bump"),q("status"),q("mintDecimalsA"),q("mintDecimalsB"),q("migrateType"),w("supply"),w("totalSellA"),w("virtualA"),w("virtualB"),w("realA"),w("realB"),w("totalFundRaisingB"),w("protocolFee"),w("platformFee"),w("migrateFee"),cy.replicate("vestingSchedule"),N("configId"),N("platformId"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("creator"),z(w(),8)]),T1=E([w(),w("epoch"),N("poolId"),N("beneficiary"),w("claimedAmount"),w("tokenShareAmount"),z(w(),8)]),ps=E([w(),w("epoch"),N("platformClaimFeeWallet"),N("platformLockNftWallet"),w("platformScale"),w("creatorScale"),w("burnScale"),w("feeRate"),z(q(),64,"name"),z(q(),256,"web"),z(q(),256,"img"),z(q(),256)]);import pn from"bn.js";import Qo from"bn.js";var zn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:r,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:r}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var fs=class extends zn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(t.toString()).div(e.toString()).mul(10**(n-i))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:r,decimalA:s,decimalB:a}){return new O(i.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB.add(r)).toString()).div(e.virtualA.sub(e.realA.add(i)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:r}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(i);if(s.lte(new Qo(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(r);if(a.lte(new Qo(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new Qo(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),m=t.mul(t).div(u);if(l.lt(new Qo(0))||m.lt(new Qo(0)))throw Error("invalid input 0");return{a:l,b:m,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let i=e.mul(n),r=t.add(e);return i.div(r)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let i=t.mul(e),r=n.sub(e);return hr(i,r)}};import um from"bn.js";var bs=class extends zn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(t.toString()).div(e.toString()).mul(10**(n-i))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:r,decimalA:s,decimalB:a}){return new O(i.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB).add(r).toString()).div(e.virtualA.sub(e.realA).add(i).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:r}){let s=e.sub(i);if(s.lte(new um(0)))throw Error("invalid input 1");let a=new um(2).mul(t).sub(r),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let i=t.mul(e);return hr(i,n)}};import Rt from"bn.js";import Ei from"bn.js";var zo=class{static _multipler(e){return new O(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new O(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let i=e.mul(this._multipler(n)).div(this._multipler(t));return new Ei(i.mul(this._Q64).toFixed(0))}};zo._Q64=new O(new Ei(1).shln(64).toString());function W1({supply:o,totalFundRaisingB:e,totalLockedAmount:t,totalSellA:n,migrateType:i,decimalsA:r}){let s=o.sub(n).sub(t),a=new Ei(new O(s.mul(e).toString()).sqrt().toFixed(0));if(i==="amm"){if(a.gt(new Ei(10).pow(new Ei(r))))return!0}else if(i==="cpmm"){if(a.gt(new Ei(100)))return!0}else throw Error("migrate type error");return!1}var ys=class extends zn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualA.mul(e.realA).toString()).div(zo._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:r,decimalA:s,decimalB:a}){return new O(i.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB).add(r).toString()).div(e.virtualA.sub(e.realA).add(i).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:r}){let s=e.sub(i);if(s.lte(new Rt(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new Rt(3)).sub(r),u=t.mul(new Rt(2)).mul(s).div(a),l=u.mul(u),m=t.mul(new Rt(2)).mul(tt).div(l);if(!m.gt(new Rt(0)))throw Error("a need gt 0");if(!yo.gt(m))throw Error("a need lt u64 max");return{a:m,b:new Rt(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),i=new Rt(2).mul(n).mul(tt).div(e.virtualA);return new Rt(new O(i.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),i=n.mul(n),{div:r,mod:s}=e.virtualA.mul(i).divmod(new Rt(2).mul(tt));return(s.isZero()?r:r.add(new Rt(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),i=n.mul(n),{div:r,mod:s}=e.virtualA.mul(i).divmod(new Rt(2).mul(tt)),a=s.isZero()?r:r.add(new Rt(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),i=new Rt(2).mul(n).mul(tt).div(e.virtualA),r=new Rt(new O(i.toString()).sqrt().toFixed(0));return e.realA.sub(r)}};var fn=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:i,totalSell:r,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),m=l.getInitParam({supply:n,totalFundRaising:i,totalSell:r,totalLockedAmount:s,migrateFee:a}),d=l.getPoolInitPriceByInit(U(v({},m),{decimalA:c,decimalB:u})),p=i.div(new pn(t-1)),b=new pn(0),f=[{price:d,totalSellSupply:0}],{a:y,b:g}=m,P=b,k=b;for(let T=1;T<t;T++){let I=T!==t-1?p:i.sub(k),h=this.buyExactIn({poolInfo:{virtualA:y,virtualB:g,realA:P,realB:k,totalFundRaisingB:i,totalSellA:r},amountB:I,protocolFeeRate:b,platformFeeRate:b,curveType:e,shareFeeRate:b});P=P.add(h.amountA),k=k.add(h.amountB);let S=this.getPrice({poolInfo:{virtualA:y,virtualB:g,realA:P,realB:k},decimalA:c,decimalB:u,curveType:e});f.push({price:S,totalSellSupply:new O(P.toString()).div(10**c).toNumber()})}return f}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:i}){return this.getCurve(i).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i,curveType:r}){return this.getCurve(r).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:i})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:i})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:i})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,decimals:r,config:s,migrateType:a}){if(Number(r)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(Yt).lt(i))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new pn(10**r))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(Yt);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(i),m=e.mul(s.minMigrateRateA).div(Yt);if(l.lt(m))throw Error("migrate lt min migrate amount");let d=e.sub(n).sub(i),p=new pn(new O(d.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let b=new pn(10).pow(new pn(r));if(p.lte(b))throw Error("check migrate lp error")}else if(a==="cpmm"){let b=new pn(100);if(p.lte(b))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:i,curveType:r,shareFeeRate:s}){let a=n.add(s).add(i),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(r),m=l.buyExactIn({poolInfo:e,amount:u}),d=e.totalSellA.sub(e.realA),p,b,f;if(m.gt(d)){p=d;let g=l.buyExactOut({poolInfo:e,amount:p});b=this.calculatePreFee({postFeeAmount:g,feeRate:a}),f=b.sub(g)}else p=m,b=t,f=c;let y=this.splitFee({totalFee:f,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:p,amountB:b,splitFee:y}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:i,curveType:r,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(r).buyExactOut({poolInfo:e,amount:t}),m=n.add(s).add(i),d=this.calculatePreFee({postFeeAmount:l,feeRate:m}),p=d.sub(l),b=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:c,amountB:d,splitFee:b}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:i,curveType:r,shareFeeRate:s}){let c=this.getCurve(r).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(i)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:i,curveType:r,shareFeeRate:s}){let a=n.add(s).add(i),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),m=fn.getCurve(r).sellExactOut({poolInfo:e,amount:c});if(m.gt(e.realA))throw Error();let d=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:m,amountB:t,splitFee:d}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:i}){let r=t.add(n).add(i),s=r.isZero()?new pn(0):e.mul(n).div(r),a=r.isZero()?new pn(0):e.mul(i).div(r),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return fr(e,t,Yt)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(Yt),i=Yt.sub(t);return n.add(i).sub(new pn(1)).div(i)}static getCurve(e){switch(e){case 0:return fs;case 1:return bs;case 2:return ys}throw Error("find curve error")}};var di={initPriceX64:new ye("515752397214619"),supply:new ye(1e15),totalSellA:new ye(7931e11),totalFundRaisingB:new ye(85e9),totalLockedAmount:new ye("0"),cliffPeriod:new ye("0"),unlockPeriod:new ye("0"),decimals:6,virtualA:new ye("1073471847374405"),virtualB:new ye("30050573465"),realA:new ye(0),realB:new ye(0),protocolFee:new ye(0),platformId:new lm("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new ye(0),cliffPeriod:new ye(0),unlockPeriod:new ye(0),startTime:new ye(0),totalAllocatedShare:new ye(0)}},As=new ye(1e4),jo=class extends ve{constructor(e){super(e)}async createLaunchpad(K){var B=K,{programId:e=Pn,authProgramId:t,platformId:n=di.platformId,mintA:i,decimals:r=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:m,configInfo:d,platformFeeRate:p,txVersion:b,computeBudgetConfig:f,txTipConfig:y,feePayer:g,buyAmount:P,minMintAAmount:k,slippage:T,associatedOnly:I=!0,checkCreateATAOwner:h=!1,extraSigners:S}=B,x=We(B,["programId","authProgramId","platformId","mintA","decimals","mintBDecimals","name","symbol","uri","migrateType","configId","configInfo","platformFeeRate","txVersion","computeBudgetConfig","txTipConfig","feePayer","buyAmount","minMintAAmount","slippage","associatedOnly","checkCreateATAOwner","extraSigners"]);var it,pi,Yo,Zo,_i,Vi;let C=this.createTxBuilder(g);t=t!=null?t:Uo(e).publicKey;let L=d;if(!L&&m){let Nt=await this.scope.connection.getAccountInfo(m);Nt&&(L=vi.decode(Nt.data))}L||this.logAndCreateError("config not found");let R=L.mintB,D=L.curveType,{publicKey:F}=ms(e,i,R),{publicKey:W}=mu(e,F,i),{publicKey:Y}=mu(e,F,R),{publicKey:se}=Tn(i);console.log(`create token: ${i.toBase58()}, mintB: ${R.toBase58()}, decimals A:${r}/B:${s}, config:${m.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),P.lte(new ye(0))&&this.logAndCreateError("buy amount should gt 0:",P.toString());let we=(it=x==null?void 0:x.supply)!=null?it:di.supply,ce=(pi=x==null?void 0:x.totalSellA)!=null?pi:di.totalSellA,pe=(Yo=x==null?void 0:x.totalFundRaisingB)!=null?Yo:di.totalFundRaisingB,Ce=(Zo=x==null?void 0:x.totalLockedAmount)!=null?Zo:new ye(0),nt=p;if(!p){let Nt=await this.scope.connection.getAccountInfo(n);Nt||this.logAndCreateError("platform id not found:",n.toString()),nt=ps.decode(Nt.data).feeRate}let ht=fn.getCurve(L.curveType).getInitParam({supply:we,totalFundRaising:pe,totalSell:ce,totalLockedAmount:Ce,migrateFee:L.migrateFee}),Ge={epoch:new ye(896),bump:254,status:0,mintDecimalsA:r,mintDecimalsB:s,supply:we,totalSellA:ce,mintA:new lm(i),mintB:R,virtualA:ht.a,virtualB:ht.b,realA:di.realA,realB:di.realB,migrateFee:L.migrateFee,migrateType:l==="amm"?0:1,protocolFee:di.protocolFee,platformFee:nt,platformId:n,configId:m,vaultA:W,vaultB:Y,creator:this.scope.ownerPubKey,totalFundRaisingB:pe,vestingSchedule:{totalLockedAmount:Ce,cliffPeriod:new ye(0),unlockPeriod:new ye(0),startTime:new ye(0),totalAllocatedShare:new ye(0)}},bt=fn.getCurve(L.curveType),{c:nn}=bt.getInitParam({supply:Ge.supply,totalFundRaising:Ge.totalFundRaisingB,totalLockedAmount:Ce,totalSell:L.curveType===0?Ge.totalSellA:new ye(0),migrateFee:L.migrateFee});try{fn.checkParam({supply:Ge.supply,totalFundRaising:Ge.totalFundRaisingB,totalSell:nn,totalLockedAmount:Ce,decimals:Ge.mintDecimalsA,config:L,migrateType:l}),console.log("check init params success")}catch(Nt){this.logAndCreateError(`check create mint params failed, ${Nt.message}`)}C.addInstruction({instructions:[tm(e,g!=null?g:this.scope.ownerPubKey,this.scope.ownerPubKey,m,n,t,F,i,R,W,Y,se,Kn,Kn,r,a,c,u||"https://",{type:D===0?"ConstantCurve":D===1?"FixedCurve":D===2?"LinearCurve":"ConstantCurve",totalSellA:ce,migrateType:l,supply:we,totalFundRaisingB:pe},Ce,(_i=x==null?void 0:x.cliffPeriod)!=null?_i:new ye(0),(Vi=x==null?void 0:x.unlockPeriod)!=null?Vi:new ye(0))]});let bn=new ye(0),qt;if(S!=null&&S.length&&C.addInstruction({signers:S}),!x.createOnly){let{builder:Nt,extInfo:$o}=await this.buyToken({programId:e,authProgramId:t,mintA:i,mintB:R,poolInfo:Ge,buyAmount:P,minMintAAmount:k,shareFeeRate:x.shareFeeRate,shareFeeReceiver:x.shareFeeReceiver,configInfo:L,platformFeeRate:nt,slippage:T,associatedOnly:I,checkCreateATAOwner:h});C.addInstruction(v({},Nt.AllTxData)),bn=$o.outAmount,qt=(this.scope.cluster==="devnet"||b===1)&&x.shareFeeReceiver?[Nt.allInstructions[0]]:void 0}return C.addTipInstruction(y),b===0?C.sizeCheckBuildV0({computeBudgetConfig:f,outAmount:bn,splitIns:qt,address:U(v({},Ge),{poolId:F})}):C.sizeCheckBuild({computeBudgetConfig:f,outAmount:bn,splitIns:qt,address:U(v({},Ge),{poolId:F})})}async buyToken({programId:e=Pn,authProgramId:t,mintA:n,mintB:i=gs,poolInfo:r,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,buyAmount:d,minMintAAmount:p,slippage:b,shareFeeRate:f=new ye(0),shareFeeReceiver:y,associatedOnly:g=!0,checkCreateATAOwner:P=!1}){d.lte(new ye(0))&&this.logAndCreateError("buy amount should gt 0:",d.toString());let k=this.createTxBuilder(m),{publicKey:T}=ms(e,n,i);t=t!=null?t:Uo(e).publicKey;let I=null,h=null,S=i.equals(gs),{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:P});x&&(I=x),k.addInstruction(K||{}),I===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:i,owner:this.scope.ownerPubKey,createInfo:S?{payer:this.scope.ownerPubKey,amount:d}:void 0,skipCloseAccount:!S,notUseTokenAccount:S,associatedOnly:S?!1:g,checkCreateATAOwner:P});B&&(h=B),k.addInstruction(C||{}),h===void 0&&this.logAndCreateError(`cannot found mintB(${i.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let L=r;if(!L){let ce=await this.scope.connection.getAccountInfo(T,{commitment:"confirmed"});ce||this.logAndCreateError("cannot found pool:",T.toBase58()),L=Xo.decode(ce.data)}let R=s,D=await Oe(this.scope.connection,[R?void 0:L.configId,a?void 0:L.platformId].filter(Boolean).map(ce=>({pubkey:ce})));if(!R){let ce=D.find(pe=>pe.pubkey.equals(L.configId));(!ce||!ce.accountInfo)&&this.logAndCreateError("config not found: ",L.configId.toBase58()),R=vi.decode(ce.accountInfo.data)}if(!a){let ce=D.find(pe=>pe.pubkey.equals(L.platformId));(!ce||!ce.accountInfo)&&this.logAndCreateError("platform info not found: ",L.configId.toBase58()),a=ps.decode(ce.accountInfo.data).feeRate}let F=fn.buyExactIn({poolInfo:L,amountB:d,protocolFeeRate:R.tradeFeeRate,platformFeeRate:a,curveType:R.curveType,shareFeeRate:f}),W=new O(F.amountA.toString()),Y=b?new O(As.sub(b).toNumber()/As.toNumber()).clampedTo(0,1):new O(1),se=p!=null?p:b?new ye(W.mul(Y).toFixed(0)):F.amountA;F.amountB.lt(d)&&console.log(`maximum ${n.toBase58()} amount can buy is ${F.amountA.toString()}, input ${i.toBase58()} amount: ${F.amountB.toString()}`);let we=y?ee(y,i,Kn).publicKey:void 0;return we&&k.addInstruction({instructions:[cm(this.scope.ownerPubKey,we,y,i)]}),k.addInstruction({instructions:[nm(e,this.scope.ownerPubKey,t,L.configId,L.platformId,T,I,h,L.vaultA,L.vaultB,n,i,Kn,Kn,F.amountB.lt(d)?F.amountB:d,se,f,we)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:se}})}async sellToken({programId:e=Pn,authProgramId:t,mintA:n,mintB:i=gs,poolInfo:r,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,sellAmount:d,minAmountB:p,slippage:b,shareFeeRate:f=new ye(0),shareFeeReceiver:y,associatedOnly:g=!0,checkCreateATAOwner:P=!1}){t=t!=null?t:Uo(e).publicKey;let k=this.createTxBuilder(m);d.lte(new ye(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:T}=ms(e,n,i),I=null,h=null,S=i.equals(gs),{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:P});x&&(I=x),k.addInstruction(K||{}),I===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:i,owner:this.scope.ownerPubKey,createInfo:S?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!S,notUseTokenAccount:S,associatedOnly:S?!1:g,checkCreateATAOwner:P});B&&(h=B),k.addInstruction(C||{}),h===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let L=r;if(!L){let ce=await this.scope.connection.getAccountInfo(T);ce||this.logAndCreateError("cannot found pool",T.toBase58()),L=Xo.decode(ce.data)}let R=s,D=await Oe(this.scope.connection,[R?void 0:L.configId,a?void 0:L.platformId].filter(Boolean).map(ce=>({pubkey:ce})));if(!R){let ce=D.find(pe=>pe.pubkey.equals(L.configId));(!ce||!ce.accountInfo)&&this.logAndCreateError("config not found: ",L.configId.toBase58()),R=vi.decode(ce.accountInfo.data)}if(!a){let ce=D.find(pe=>pe.pubkey.equals(L.platformId));(!ce||!ce.accountInfo)&&this.logAndCreateError("platform info not found: ",L.configId.toBase58()),a=ps.decode(ce.accountInfo.data).feeRate}let F=fn.sellExactIn({poolInfo:L,amountA:d,protocolFeeRate:R.tradeFeeRate,platformFeeRate:a,curveType:R.curveType,shareFeeRate:f}),W=new O(F.amountB.toString()),Y=b?new O(As.sub(b).toNumber()/As.toNumber()).clampedTo(0,1):new O(1),se=p!=null?p:b?new ye(W.mul(Y).toFixed(0)):F.amountB;se.lte(new ye(0))&&this.logAndCreateError(`out ${i.toBase58()} amount should be gt 0`);let we=y?ee(y,i,Kn).publicKey:void 0;return we&&k.addInstruction({instructions:[cm(this.scope.ownerPubKey,we,y,i)]}),k.addInstruction({instructions:[im(e,this.scope.ownerPubKey,t,L.configId,L.platformId,T,I,h,L.vaultA,L.vaultB,n,i,Kn,Kn,F.amountA.lt(d)?F.amountA:d,se,f,we)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:se}})}async createPlatformConfig({programId:e=Pn,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:i,migrateCpLockNftScale:r,feeRate:s,name:a,web:c,img:u,txVersion:l,computeBudgetConfig:m,txTipConfig:d,feePayer:p}){let b=this.createTxBuilder(p),{publicKey:f}=du(e,t);return b.addInstruction({instructions:[sm(e,t,n,i,f,r,s,a,c,u)]}),b.addCustomComputeBudget(m),b.addTipInstruction(d),b.versionBuild({txVersion:l,extInfo:{platformId:f}})}async updatePlatformConfig({programId:e=Pn,platformAdmin:t,platformId:n,updateInfo:i,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n!=null?n:du(e,t).publicKey;return u.addInstruction({instructions:[am(e,t,l,i)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:r})}async claimPlatformFee({programId:e=Pn,authProgramId:t,platformId:n,poolId:i,platformClaimFeeWallet:r,mintB:s,vaultB:a,mintBProgram:c=Kn,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d,associatedOnly:p=!0,checkCreateATAOwner:b=!1}){var I;let f=this.createTxBuilder(d);t=t!=null?t:Uo(e).publicKey;let y=s,g=a;if(!y){let h=await this.scope.connection.getAccountInfo(i,{commitment:"confirmed"});h||this.logAndCreateError("cannot found pool:",i.toBase58());let S=Xo.decode(h.data),x=await this.scope.connection.getAccountInfo(S.configId);x||this.logAndCreateError("cannot found config:",S.configId.toBase58()),y=vi.decode(x.data).mintB,g=g!=null?g:S.vaultB}(!y||!g)&&this.logAndCreateError("cannot found mint info, mintB: ",y.toBase58(),", vaultB: ",(I=g==null?void 0:g.toBase58())!=null?I:"");let P=null,{account:k,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:p,checkCreateATAOwner:b});return k&&(P=k),f.addInstruction(T||{}),f.addInstruction({instructions:[rm(e,r,t,i,n,g,P,y,c)]}),f.addCustomComputeBudget(l),f.addTipInstruction(m),f.versionBuild({txVersion:u})}async createVesting({programId:e=Pn,poolId:t,beneficiary:n,shareAmount:i,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=Jl(e,t,n).publicKey;return u.addInstruction({instructions:[om(e,this.scope.ownerPubKey,n,t,l,i)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:r})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Oe(this.scope.connection,e.map(c=>({pubkey:c})),t),i={},r=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=Xo.decode(u.accountInfo.data);i[e[c].toBase58()]=U(v({},l),{poolId:u.accountInfo.owner}),r.push(l.configId)}let s=await Oe(this.scope.connection,r.map(c=>({pubkey:c})),t),a={};for(let c=0;c<r.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+r[c].toBase58());let l=vi.decode(u.accountInfo.data);a[r[c].toBase58()]=U(v({},l),{configId:u.accountInfo.owner})}return{poolInfoMap:Object.keys(i).reduce((c,u)=>U(v({},c),{[u]:U(v({},i[u]),{configInfo:a[i[u].configId.toBase58()]})}),{})}}};import{PublicKey as ly}from"@solana/web3.js";import{MintLayout as my,TOKEN_2022_PROGRAM_ID as pu,TOKEN_PROGRAM_ID as fu}from"@solana/spl-token";var Ho=class extends ve{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Set;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:i="strict"}=t||{},{mintList:r,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),c=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(s),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(sn.address,sn),this._mintGroup.official.add(sn.address),r.forEach(u=>{var l;this._blackTokenMap.has(u.address)||(this._tokenMap.set(u.address,U(v({},u),{type:"raydium",priority:2,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?pu.toBase58():fu.toBase58()})),this._mintGroup.official.add(u.address))}),c.forEach(u=>{var l;this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,U(v({},u),{type:"jupiter",priority:1,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?pu.toBase58():fu.toBase58(),tags:u.freezeAuthority?[...u.tags||[],"hasFreeze"]:u.tags})),this._mintGroup.jup.add(u.address))}),this._extraTokenList.forEach(u=>{this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,U(v({},u),{type:"extra",priority:1,programId:u.programId||u.tags.includes("token-2022")?pu.toBase58():fu.toBase58()})),this._mintGroup.extra.add(u.address))}),this._tokenList=Array.from(this._tokenMap).map(u=>u[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),i=this._tokenMap.get(n);if(i)return i;if(n.toLocaleUpperCase()==="SOL")return sn;let r=(await this.scope.api.getTokenInfo([n]))[0];if(r)return this._mintGroup.extra.add(n),this._tokenMap.set(n,U(v({},r),{priority:2})),r;let s=await this.scope.connection.getAccountInfo(new ly(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=my.decode(s.data),c=n.toString().substring(0,6),u={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:c,name:c,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,u),u}};var Ps=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:i,api:r,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=i?new zt(i):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=r,this._apiCacheTime=c||5*60*1e3,this.logger=be("Raydium"),this.farm=new bo({scope:this,moduleName:"Raydium_Farm"}),this.account=new oo({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new Ro({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Ho({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new Do({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new Oo({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new _o({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Dt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Li({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new Oi({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new jo({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let m=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:m,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=dy({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:i,logCount:r,logRequests:s,urlConfigs:a}=t,c=new Kr({cluster:n,timeout:i,urlConfigs:a,logCount:r,logRequests:s}),u=new Ps(U(v({},t),{api:c}));return await u.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(Cr);return this._owner.publicKey}setOwner(e){return this._owner=e?new zt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(cc);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(Cr),new Error(Cr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(i=>U(v({},i),{mintAuthority:i.mint_authority||void 0,freezeAuthority:i.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var iR=o=>o;export{Iy as ACCOUNT_TYPE_SIZE,Tt as ALL_PROGRAM_ID,Uf as AMM_CONFIG_SEED,Ud as AMM_STABLE,zi as AMM_V4,dg as ANAMint,lt as API_URLS,wm as AccountType,Kr as Api,jc as BIT_PRECISION,jt as BNDivCeil,$n as BNLayout,PA as BN_100,wA as BN_1000,kA as BN_10000,AA as BN_FIVE,Uu as BN_ONE,Hn as BN_TEN,gA as BN_THREE,yA as BN_TWO,$e as BN_ZERO,Nw as BitStructure,gc as Blob,ji as CLMM_LOCK_AUTH_ID,Pi as CLMM_LOCK_PROGRAM_ID,vn as CLMM_PROGRAM_ID,Es as CLOCK_PROGRAM_ID,js as CREATE_CPMM_POOL_AUTH,Hd as CREATE_CPMM_POOL_FEE_ACC,Hi as CREATE_CPMM_POOL_PROGRAM,Oo as Clmm,cl as ClmmConfigLayout,Ke as ClmmInstrument,$r as ConstantProductCurve,Gl as CpmmConfigInfoLayout,Jr as CpmmFee,os as CpmmPoolInfoLayout,Gi as Currency,jn as CurrencyAmount,fn as Curve,zn as CurveBase,ts as CurveCalculator,ZA as DEVNET_PROGRAM_ID,DP as DEV_API_URLS,Zd as DEV_CREATE_CPMM_POOL_AUTH,$d as DEV_CREATE_CPMM_POOL_FEE_ACC,Yd as DEV_CREATE_CPMM_POOL_PROGRAM,ip as DEV_LAUNCHPAD_AUTH,np as DEV_LAUNCHPAD_PROGRAM,ep as DEV_LOCK_CPMM_AUTH,Jd as DEV_LOCK_CPMM_PROGRAM,lb as DataElement,pg as ETHMint,va as EXTENSION_TICKARRAY_BITMAP_SIZE,vc as FARM_LOCK_MINT,Ec as FARM_LOCK_VAULT,Xs as FARM_PROGRAM_ID_V3,nc as FARM_PROGRAM_ID_V4,Qs as FARM_PROGRAM_ID_V5,Ai as FARM_PROGRAM_ID_V6,Et as FARM_PROGRAM_TO_VERSION,Vc as FARM_VERSION_TO_LEDGER_LAYOUT,_c as FARM_VERSION_TO_STATE_LAYOUT,ic as FEE_DESTINATION_ID,Dr as FEE_RATE_DENOMINATOR,Yt as FEE_RATE_DENOMINATOR_VALUE,$f as FETCH_TICKARRAY_COUNT,qf as Fee,bs as FixedPriceCurve,de as Fraction,$i as IDO_ALL_PROGRAM,Xd as IDO_PROGRAM_ID_V1,Qd as IDO_PROGRAM_ID_V2,zd as IDO_PROGRAM_ID_V3,jd as IDO_PROGRAM_ID_V4,mr as INSTRUCTION_PROGRAM_ID,X as InstructionType,rc as JupTokenType,tp as LAUNCHPAD_AUTH,ny as LAUNCHPAD_AUTH_SEED,iy as LAUNCHPAD_CONFIG_SEED,ay as LAUNCHPAD_POOL_PLATFORM_SEED,oy as LAUNCHPAD_POOL_SEED,ry as LAUNCHPAD_POOL_VAULT_SEED,sy as LAUNCHPAD_POOL_VESTING_SEED,Pn as LAUNCHPAD_PROGRAM,Xr as LIQUIDITY_FEES_DENOMINATOR,Fa as LIQUIDITY_FEES_NUMERATOR,kr as LIQUIDITY_POOL_PROGRAM_ID_V5_MODEL,ab as LIQUIDITY_VERSION_TO_SERUM_VERSION,DB as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Zi as LOCK_CPMM_AUTH,Yi as LOCK_CPMM_PROGRAM,Ub as LOCK_LIQUIDITY_SEED,Hc as LOG_B_2_X32,Yc as LOG_B_P_ERR_MARGIN_LOWER_X64,Zc as LOG_B_P_ERR_MARGIN_UPPER_X64,Ir as LOOKUP_TABLE_CACHE,fs as LaunchPadConstantProductCurve,vi as LaunchpadConfig,Xo as LaunchpadPool,di as LaunchpadPoolInitParam,T1 as LaunchpadVesting,cy as LaunchpadVestingSchedule,no as Layout,ys as LinearPriceCurve,Pe as LiquidityMath,$I as LockClPositionLayoutV2,ZI as LockPositionLayout,bm as LogLevel,ks as Logger,$a as MARKET_STATE_LAYOUT_V2,nu as MARKET_STATE_LAYOUT_V3,zl as MARKET_VERSION_TO_STATE_LAYOUT,$u as MAX_BASE64_SIZE,Ft as MAX_SQRT_PRICE_X64,Fr as MAX_SQRT_PRICE_X64_SUB_ONE,Bt as MAX_TICK,lr as MEMO_PROGRAM_ID,an as MEMO_PROGRAM_ID2,Qt as METADATA_PROGRAM_ID,Vt as MIN_SQRT_PRICE_X64,Vr as MIN_SQRT_PRICE_X64_ADD_ONE,Pt as MIN_TICK,Ki as MODEL_DATA_PUBKEY,as as Market,zo as MathLaunch,ue as MathUtil,yo as MaxU64,zc as MaxUint128,hn as NEGATIVE_ONE,mg as NRVMint,Yf as OBSERVATION_SEED,Ot as ONE,zs as OPEN_BOOK_PROGRAM,jf as OPERATION_SEED,ll as ObservationInfoLayout,tb as ObservationLayout,ml as OperationLayout,aa as OptionLayout,zt as Owner,og as PAIMint,rl as POOL_LOCK_ID_SEED,Qf as POOL_REWARD_VAULT_SEED,Gf as POOL_SEED,Hf as POOL_TICK_ARRAY_BITMAP_SEED,Xf as POOL_VAULT_SEED,tl as POSITION_SEED,Xe as Percent,ps as PlatformConfig,sc as PoolFetchType,ni as PoolInfoLayout,Ne as PoolUtils,Io as PositionInfoLayout,ib as PositionRewardInfoLayout,ko as PositionUtils,ct as Price,YI as ProtocolPositionLayout,_r as Q128,tt as Q64,ig as RAYMint,et as RENT_PROGRAM_ID,Ps as Raydium,nb as RewardInfo,Ml as RoundDirection,Rs as Rounding,Gd as Router,Xl as SERUM_PROGRAMID_TO_VERSION,wr as SERUM_PROGRAM_ID_V3,Ql as SERUM_VERSION_TO_PROGRAMID,ac as SESSION_KEY,ut as SOLMint,sn as SOL_INFO,bl as SPL_MINT_LAYOUT,rg as SRMMint,Zs as STORAGE_KEY,Zf as SUPPORT_MINT_SEED,dr as SYSTEM_PROGRAM_ID,oe as SqrtPriceMath,Si as StableLayout,ua as Structure,ti as SwapMath,ei as TICK_ARRAY_BITMAP_SIZE,zf as TICK_ARRAY_SEED,st as TICK_ARRAY_SIZE,NT as TICK_SPACINGS,at as TOKEN_WSOL,In as TickArrayBitmap,ul as TickArrayBitmapExtensionLayout,To as TickArrayBitmapExtensionUtils,ho as TickArrayLayout,ob as TickLayout,ii as TickMath,ke as TickQuery,Z as TickUtils,Be as Token,he as TokenAmount,xr as TxBuilder,Mn as TxVersion,go as U64Resolution,MT as U64_IGNORE_RANGE,oa as UInt,sg as USDCMint,lg as USDHMint,ag as USDTMint,qd as UTIL1216,ca as Union,Oc as Voter,Sf as VoterDepositEntry,xf as VoterLockup,Nc as VoterRegistrar,Bf as VoterVotingMintConfig,$ as WSOLMint,Mr as WideBits,wn as WrappedLayout,ge as ZERO,Fu as _100_PERCENT,A as accountMeta,Zg as add,gr as addComputeBudget,Ua as addLiquidityLayout,dn as anchorDataBuf,yk as array,pa as associatedLedgerAccountLayout,ra as bits,Ie as blob,De as bool,nm as buyExactInInstruction,A1 as buyExactOutInstruction,xa as calFarmRewardAmount,fr as ceilDiv,hr as ceilDivBN,Xi as checkLegacyTxSize,W1 as checkPoolToAmm,Qi as checkV0TxSize,Is as chunkArray,Wo as claimLayout,rm as claimPlatformFee,w1 as claimVestedToken,al as clmmComputeInfoToApiInfo,kn as closeAccountInstruction,Ul as collectCpFeeInstruction,Os as commonSystemAccountMeta,Ar as confirmTransaction,zb as cpmmLockPositionInstruction,lo as createAssociatedLedgerAccountInstruction,be as createLogger,sm as createPlatformConfig,Al as createPoolFeeLayout,za as createPoolV4InstructionV2,FB as createPoolV4Layout,om as createVestingAccount,Fn as createWSolAccountInstructions,sk as cstr,hg as currencyEquals,Od as decimalToFraction,rf as decodeBool,zg as div,pr as divCeil,It as dwLayout,sf as encodeBool,aw as endlessRetry,Kd as eq,tk as f32,nk as f32be,ik as f64,ok as f64be,ga as farmAddRewardLayout,lh as farmLedgerLayoutV3_1,so as farmLedgerLayoutV3_2,mh as farmLedgerLayoutV5_1,Lc as farmLedgerLayoutV5_2,Rc as farmLedgerLayoutV6_1,Dc as farmRewardInfoToConfig,ba as farmRewardLayout,ya as farmRewardRestartLayout,If as farmRewardTimeInfoLayout,Kc as farmStateV3Layout,Cc as farmStateV5Layout,ro as farmStateV6Layout,Eh as fetchMultipleFarmInfoAndUpdate,Sx as fetchMultipleInfo,fi as fetchMultipleMintInfos,ie as findProgramAddress,Da as fixedSwapInLayout,Wa as fixedSwapOutLayout,Us as floorDiv,Pr as forecastTransactionSize,wb as formatLayout,ze as generatePubKey,ee as getATAAddress,Fc as getAssociatedAuthority,zr as getAssociatedConfigId,At as getAssociatedLedgerAccount,uo as getAssociatedLedgerPoolAccount,Kb as getAssociatedOpenOrders,Za as getAssociatedPoolKeys,ns as getCpLockPda,xK as getCpmmPdaAmmConfigId,eu as getCpmmPdaPoolId,El as getCreatePoolKeys,Qu as getDate,Sa as getDepositEntryIndex,hl as getDxByDyBaseIn,kl as getDyByDxBaseIn,UA as getEpochInfo,Bi as getFarmLedgerLayout,Kf as getFarmStateLayout,Ya as getLiquidityAssociatedAuthority,ai as getLiquidityAssociatedId,xI as getLiquidityFromAmounts,Yg as getMax,Ut as getMultipleAccountsInfo,Oe as getMultipleAccountsInfoWithCustomFlags,Hs as getMultipleLookupTableInfo,WT as getPdaAmmConfigId,Mi as getPdaCpiEvent,je as getPdaExBitmapAccount,Uo as getPdaLaunchpadAuth,u1 as getPdaLaunchpadConfigId,ms as getPdaLaunchpadPoolId,mu as getPdaLaunchpadVaultId,wo as getPdaLockClPositionIdV2,Oa as getPdaLockPositionId,Wb as getPdaLpMint,Tn as getPdaMetadataKey,Ma as getPdaMintExAccount,ol as getPdaObservationAccount,vo as getPdaObservationId,Po as getPdaOperationAccount,xt as getPdaPersonalPositionAddress,du as getPdaPlatformId,Ni as getPdaPoolAuthority,nl as getPdaPoolId,il as getPdaPoolRewardVaulId,Na as getPdaPoolVaultId,en as getPdaProtocolPositionAddress,Ae as getPdaTickArrayAddress,vl as getPdaVault,Jl as getPdaVestId,gi as getRecentBlockHash,wa as getRegistrarAddress,ap as getSessionKey,Tl as getStablePrice,vd as getTime,iA as getTimestamp,Ba as getTokenOwnerRecordAddress,eP as getTransferAmountFee,Te as getTransferAmountFeeV2,Ta as getVoterAddress,Ia as getVoterWeightRecordAddress,ha as getVotingMintAuthority,ka as getVotingTokenMint,_f as governanceCreateTokenOwnerRecord,Ow as greedy,Sd as gt,Qg as gte,Ic as i128,ET as i16ToBytes,qr as i32ToBytes,hi as i64,Tc as i8,qa as initPoolLayout,ma as initTokenAccountInstruction,tm as initialize,Nb as initializeMarket,KA as intersection,ju as isDateAfter,zu as isDateBefore,Md as isDecimal,Hg as isMeaningfulNumber,Xu as isNumber,Aa as isValidFarmVersion,Ao as isZero,Me as jsonInfo2PoolKeys,_h as judgeFarmType,La as leadingZeros,el as leastSignificantBit,oi as liquidityStateV4Layout,ub as liquidityStateV5Layout,Gg as lt,Xg as lte,ug as mSOLMint,Qr as makeAMMSwapInstruction,xl as makeAddLiquidityInstruction,Ca as makeAddNewRewardInstruction,ls as makeClaimInstruction,lu as makeClaimInstructionV4,ql as makeCpmmLockInstruction,Vl as makeCreateCpmmPoolInInstruction,Wc as makeCreateFarmInstruction,Hr as makeCreateMarketInstruction,qc as makeCreatorWithdrawFarmRewardInstruction,Fl as makeDepositCpmmInInstruction,Gc as makeDepositInstructionV3,Xc as makeDepositInstructionV5,Qc as makeDepositInstructionV6,Jh as makeDepositTokenInstruction,tT as makeDepositWithdrawInstruction,ix as makeInitPoolInstructionV4,U0 as makePurchaseInstruction,Ka as makeRestartRewardInstruction,Sl as makeSimulatePoolInfoInstruction,is as makeSwapCpmmBaseInInstruction,Wl as makeSwapCpmmBaseOutInstruction,Tb as makeSwapFixedInInstruction,Ib as makeSwapFixedOutInstruction,Hl as makeSwapInstruction,Sc as makeTransferInstruction,Dl as makeWithdrawCpmmInInstruction,fo as makeWithdrawInstructionV3,Uc as makeWithdrawInstructionV4,po as makeWithdrawInstructionV5,mo as makeWithdrawInstructionV6,eT as makeWithdrawTokenInstruction,Ht as minExpirationTime,OT as mockCreatePoolInfo,$c as mockV3CreatePoolInfo,mb as modelDataInfoLayout,Jc as mostSignificantBit,Ws as mul,qs as notInnerObject,jw as ns64,ek as ns64be,Ac as nu64,qw as nu64be,sa as offset,xA as offsetDateTime,dk as option,J as parseBigNumberish,Yn as parseNumberInfo,ec as parseSimulateLogToJson,An as parseSimulateValue,xc as parseTokenAccountResp,BB as parseTokenInfo,Wn as poolTypeV6,Zn as printSimulate,N as publicKey,au as purchaseLayout,kf as realFarmStateV3Layout,hf as realFarmStateV5Layout,Tf as realFarmV6Layout,qu as recursivelyDecimalToFraction,Qa as removeLiquidityInstruction,Ga as removeLiquidityLayout,zC as route1Instruction,jC as route2Instruction,Yb as routeInstruction,bk as rustEnum,Gw as s16,Hw as s16be,Xw as s24,Yw as s24be,Ee as s32,Zw as s32be,Qw as s40,$w as s40be,zw as s48,Jw as s48be,Uw as s8,im as sellExactInInstruction,P1 as sellExactOut,z as seq,by as setLoggerLevel,Rd as shakeFractionDecimal,Ju as simulateMultipleInstruction,nx as simulatePoolInfoInstruction,Vd as simulateTransaction,Du as sleep,yt as solToWSol,SB as solToWSolToken,Jt as splAccountLayout,Eu as splitNumber,cg as stSOLMint,Vn as str,E as struct,jg as sub,HC as swapBaseInAutoAccount,YC as swapBaseOutAutoAccount,fk as tagged,Ds as tenExponential,jr as toAmmComputePoolInfo,wt as toApiV3Token,Nd as toBN,tc as toBuffer,qn as toFeeConfig,Gu as toFraction,Ug as toFractionWithDecimals,hA as toPercent,Gr as toToken,xo as toTokenAmount,xB as toTokenInfo,TA as toTokenPrice,IA as toTotalPrice,Wu as toUsdCurrency,Ra as trailingZeros,GA as transformTxToBase64,vs as tryParsePublicKey,Fd as txToBase64,te as u128,$t as u16,Wr as u16ToBytes,_w as u16be,Mw as u24,Vw as u24be,pt as u32,_T as u32ToBytes,Fw as u32be,vw as u40,Dw as u40be,Ew as u48,Ww as u48be,w as u64,q as u8,uy as u8ToBytes,gk as union,iR as unionArr,rk as unionLayoutDiscriminator,LA as uniq,Cf as updateFarmPoolInfo,am as updatePlatformConfig,Sr as updateReqHistory,ak as utf8,Ms as validateAndParsePublicKey,Pa as validateFarmRewards,pk as vec,af as vecU8,Ff as voterStakeRegistryCreateDepositEntry,Vf as voterStakeRegistryCreateVoter,Mf as voterStakeRegistryDeposit,vf as voterStakeRegistryUpdateVoterWeightRecord,Ef as voterStakeRegistryWithdraw,KB as wSolToSolToken,fa as withdrawRewardLayout,CA as xor,Ak as zeros};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map