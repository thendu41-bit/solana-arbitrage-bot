{"version":3,"file":"state.js","sourceRoot":"","sources":["../../../src/accounts/state.ts"],"names":[],"mappings":"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","sourcesContent":["import { getNodePayer } from '../utils/index.js';\n\nimport { Queue } from './queue.js';\n\nimport type { BN, Program } from '@coral-xyz/anchor-31';\nimport { web3 } from '@coral-xyz/anchor-31';\nimport { Buffer } from 'buffer';\n\nexport interface StateData {\n  bump: number;\n  testOnlyDisableMrEnclaveCheck: boolean;\n  enableStaking: boolean;\n  // padding1\n  authority: web3.PublicKey;\n  guardianQueue: web3.PublicKey;\n  // reserved1\n  epochLength: BN;\n  // reserved2\n  switchMint: web3.PublicKey;\n  advisories: Uint16Array;\n  advisoriesLen: number;\n  // padding2\n  flatRewardCutPercentage: number;\n  enableSlashing: boolean;\n  // padding3\n  lutSlot: BN;\n  baseReward: number;\n  // padding4\n  subsidyAmount: BN;\n  // ebuf6\n  // ebuf5\n  // ebuf4\n  // ebuf3\n  // ebuf2\n  costWhitelist: web3.PublicKey[];\n}\n\n/**\n *  Abstraction around the Switchboard-On-Demand State account\n *\n *  This account is used to store the state data for a given program.\n */\nexport class State {\n  public pubkey: web3.PublicKey;\n\n  /**\n   * Derives a state PDA (Program Derived Address) from the program.\n   *\n   * @param {Program} program - The Anchor program instance.\n   * @returns {web3.PublicKey} The derived state account's public key.\n   */\n  static keyFromSeed(program: Program): web3.PublicKey {\n    const [state] = web3.PublicKey.findProgramAddressSync(\n      [Buffer.from('STATE')],\n      program.programId\n    );\n    return state;\n  }\n\n  /**\n   * Initializes the state account.\n   *\n   * @param {Program} program - The Anchor program instance.\n   * @returns {Promise<[State, string]>} A promise that resolves to the state account and the transaction signature.\n   */\n  static async create(program: Program): Promise<[State, string]> {\n    const payer = getNodePayer(program);\n    const sig = await program.rpc.stateInit(\n      {},\n      {\n        accounts: {\n          state: State.keyFromSeed(program),\n          payer: payer.publicKey,\n          systemProgram: web3.SystemProgram.programId,\n        },\n        signers: [payer],\n      }\n    );\n\n    return [new State(program), sig];\n  }\n\n  /**\n   * Constructs a `State` instance.\n   *\n   * @param {Program} program - The Anchor program instance.\n   */\n  constructor(readonly program: Program) {\n    const pubkey = State.keyFromSeed(program);\n    this.pubkey = pubkey;\n  }\n\n  /**\n   * Set program-wide configurations.\n   *\n   * @param {object} params - The configuration parameters.\n   * @param {web3.PublicKey} [params.guardianQueue] - The guardian queue account.\n   * @param {web3.PublicKey} [params.newAuthority] - The new authority account.\n   * @param {BN} [params.minQuoteVerifyVotes] - The minimum number of votes required to verify a quote.\n   * @param {number} [params.permitAdvisory] - The permit advisory value.\n   * @param {number} [params.denyAdvisory] - The deny advisory value.\n   * @param {boolean} [params.testOnlyDisableMrEnclaveCheck] - A flag to disable MrEnclave check for testing purposes.\n   * @param {web3.PublicKey} [params.switchMint] - The switch mint account.\n   * @returns {Promise<web3.TransactionInstruction>} A promise that resolves to the transaction instruction.\n   */\n  async setConfigsIx(params: {\n    guardianQueue?: web3.PublicKey;\n    newAuthority?: web3.PublicKey;\n    minQuoteVerifyVotes?: BN;\n    permitAdvisory?: number;\n    denyAdvisory?: number;\n    testOnlyDisableMrEnclaveCheck?: boolean;\n    subsidyAmount?: BN;\n    switchMint?: web3.PublicKey;\n    addCostWl?: web3.PublicKey;\n    rmCostWl?: web3.PublicKey;\n  }): Promise<web3.TransactionInstruction> {\n    const state = await this.loadData();\n    const queue = params.guardianQueue ?? state.guardianQueue;\n    const payer = getNodePayer(this.program);\n    const testOnlyDisableMrEnclaveCheck =\n      params.testOnlyDisableMrEnclaveCheck ??\n      state.testOnlyDisableMrEnclaveCheck;\n    const ix = await this.program.instruction.stateSetConfigs(\n      {\n        newAuthority: params.newAuthority ?? state.authority,\n        testOnlyDisableMrEnclaveCheck: testOnlyDisableMrEnclaveCheck ? 1 : 0,\n        addAdvisory: params.permitAdvisory,\n        rmAdvisory: params.denyAdvisory,\n        lutSlot: state.lutSlot,\n        subsidyAmount: params.subsidyAmount ?? state.subsidyAmount,\n        switchMint: params.switchMint ?? state.switchMint,\n        authority: params.newAuthority ?? state.authority,\n        addCostWl: params.addCostWl ?? web3.PublicKey.default,\n        rmCostWl: params.rmCostWl ?? web3.PublicKey.default,\n      },\n      {\n        accounts: {\n          state: this.pubkey,\n          authority: state.authority,\n          queue,\n          payer: payer.publicKey,\n          systemProgram: web3.SystemProgram.programId,\n        },\n      }\n    );\n    return ix;\n  }\n\n  /**\n   * Register a guardian with the global guardian queue.\n   *\n   * @param {object} params - The parameters object.\n   * @param {PublicKey} params.guardian - The guardian account.\n   * @returns {Promise<TransactionInstruction>} A promise that resolves to the transaction instruction.\n   */\n  async registerGuardianIx(params: {\n    guardian: web3.PublicKey;\n  }): Promise<web3.TransactionInstruction> {\n    const state = await this.loadData();\n    const payer = getNodePayer(this.program);\n    const ix = await this.program.instruction.guardianRegister(\n      {},\n      {\n        accounts: {\n          oracle: params.guardian,\n          state: this.pubkey,\n          guardianQueue: state.guardianQueue,\n          authority: state.authority,\n        },\n        signers: [payer],\n      }\n    );\n    return ix;\n  }\n\n  /**\n   * Unregister a guardian from the global guardian queue.\n   *\n   * @param {object} params - The parameters object.\n   * @param {web3.PublicKey} params.guardian - The guardian account.\n   * @returns {Promise<web3.TransactionInstruction>} A promise that resolves to the transaction instruction.\n   */\n  async unregisterGuardianIx(params: {\n    guardian: web3.PublicKey;\n  }): Promise<web3.TransactionInstruction> {\n    const state = await this.loadData();\n    const guardianQueue = new Queue(this.program, state.guardianQueue);\n    const queueData = await guardianQueue.loadData();\n    const idx = queueData.oracleKeys.findIndex(key =>\n      key.equals(params.guardian)\n    );\n    const payer = getNodePayer(this.program);\n    const ix = await this.program.instruction.guardianUnregister(\n      { idx },\n      {\n        accounts: {\n          oracle: params.guardian,\n          state: this.pubkey,\n          guardianQueue: state.guardianQueue,\n          authority: state.authority,\n        },\n        signers: [payer],\n      }\n    );\n    return ix;\n  }\n\n  /**\n   *  Loads the state data from on chain.\n   *\n   *  @returns A promise that resolves to the state data.\n   *  @throws if the state account does not exist.\n   */\n  async loadData(): Promise<StateData> {\n    return await this.program.account['state'].fetch(this.pubkey);\n  }\n\n  /**\n   *  Loads the state data from on chain.\n   *\n   *  @returns A promise that resolves to the state data.\n   *  @throws if the state account does not exist.\n   */\n  static async loadData(program: Program) {\n    return await new State(program).loadData();\n  }\n}\n"]}